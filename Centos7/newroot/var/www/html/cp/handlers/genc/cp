#!/usr/bin/perl

#   Copyright (c) 2006-2025 Alex Shevlakov alex@motivation.ru
#   All Rights Reserved.

#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.

use 5.006;
use CGI qw(-no_debug :standard);
use DBI;
BEGIN {push @INC, '/var/www/html/cp/handlers/genc/'}; use TClubMD5;
use Socket;
use Fcntl ':flock';
use Time::HiRes qw(gettimeofday);

use List::Util qw( min max );
use Digest::SHA;
use MIME::Base64::URLSafe;
use Date::Calc qw(Day_of_Week);
use LWP::UserAgent;
use HTTP::Request::Common qw(POST);

use Encode;
use URI::Encode qw{ uri_decode };
use File::Copy qw(copy);
use File::Basename;
use JSON;

my $debug = 0;

print STDERR "Here begin, develop is $develop!\n" 
if ($debug)
;

my $script_start_time = time;

my $scriptURL = CGI::url();  # the http url of the script 

my $addr=$ENV{'REMOTE_ADDR'};
my $prefix 	= "/var/www/html/cp";

#ddos checker
my $checkstr = $addr."_".$scriptURL;

unless ($addr eq "10.0.2.2") { # use "vboxmanage modifyvm --nataliasmode1 proxyonly" to get real $addr
 if ( open(OUT, ">>$prefix/handlers/checklist")) {
	print OUT $checkstr."\n";
	close(OUT);
 }
}

my $indexing = 0;

unless ($indexing) {

my $ddositsuko = TClubMD5::ddos_check($scriptURL);

my $par = 67;

 if ($ddositsuko > $par && 0) { #disable because proxy is blocked instead of the bad guy 
	exit if ($ddositsuko > $par+1);
	my $applied = TClubMD5::apply_firewall();
	
	if ($applied) {

		&write_log_notification("$addr: DDOS firewall applied",'12');
	}
 }

}

my $sb = 1;
my $wtag_alive = 0;
my $wtagcheck = 1; #do that ape-chi stuff
my $wtag_limit = 7;
my $wtag_limit_token = "getchat";
$wtag_limit_token = "httpd" if ($use_server);
$wtag_limit = 72 if ($use_server);

my $http_prefix = $scriptURL =~ /^https:\/\// ? "https" : "http";

#we don't want to run bogus CONNECT tries
exit unless ($scriptURL =~ /^$http_prefix:\/\/\d+\.\d+\.\d+\.\d+/ || $scriptURL =~ /xter\.tech/ || $scriptURL =~ /room-house\.com/ || $scriptURL =~ /validate\.guru/ || $scriptURL =~ /\/\/localhost/);

my %vars = CGI::Vars();      # use CGI.pm to grab CGI parameters

# Good-Bye!
if ( $vars{Submit} eq 'Logout' ) {
	
     print TClubMD5::ClearAllCookies($scriptURL);
   
     exit;
}

my $query = new CGI;
#my $json = new JSON;

#checked in &conntest
my $good_connect = 0; 
my $default_on_no_connect = 2; #the server to be used if the one checked in conntest fails

my $ip_addr = $addr;
my $home_addr = "81.13.45.90";
$home_addr = "81.25.50.12";

my $from_home = ($ip_addr == $home_addr ) ? 1 : 0;
#$from_home = 0; #testing

my $user_agent=$ENV{'HTTP_USER_AGENT'};
my $chars=$ENV{'CHARSET'};

my $ajax_for_everyone = 1;

my $google = 1;
my $new_lounges_announce = 1;

my $blacklist_string = '';
my $spe = '';

my $off_dayly_ccard = 0;

$club_name = "Match Machine";

my $randomNumber =  $vars{random} ? $vars{random} : int( rand(4294967296) );

my $gplus = 1;

	my $live_in = 0;
	my $repl = `take -O a.html -T 1 -t 1 http://counter.yadro.ru 2>&1`;
	$live_in = 1 if ($repl =~ /connected/);

	my $fb_plugged = 0;
	
	my $mailru = 0;
	$mailru = 1 if ($ru_en =~ /^ru/ || $ru_en =~ /^ua/);

#determines the way we export/import photos from/to Postgres
my $export_mode = 0;

#some important flags (defaults)

my $with_trigger = 0;

my $lr;
my $nmembers = 0;
my $nbadguys = 0;

my $courts;
my $ncourts = 0;

my $is_pizza = 1;
my $with_selector = 0;

my $ncycles = 0;
my $golds_rock = 0;
my $what_current_date = 0;
$with_trigger = 1 if $export_mode;
	
my $member = $query->param('member');

my $with_scrolling_logo = 0;

my $mBox = 1;
my $n_archived_messages = 0;
my $n_forum = 10;
my $num_new_messages = 0;
my $default_price = 1;

my $with_sensors = (-f "/etc/sysconfig/sensors") ? 1 : 0;

my @wrapper_colors = ('#369',#bright blue
'#487', #
'#976b92',   #dark magenta
#'#eee'  #white
);

#CHANGE THESE

#this guy adds/edits matches

my $club_admin	= "admin";

my $_descr_filter = '';
my $_sort = '';

#PostgreSQL

my $server	= $primary_server;
my $port	= $primary_port;
my $dbase  	= $primary_dbase;
my $user  	= $primary_user;
my $passwd	= $primary_passwd;

my $server_out = $server;
my $port_out = $port;
my $user_out = $user;
my $passwd_out = $passwd;
my $dbase_out = $dbase;

my $hourshift = '0 hours';

my $primary_server_available = 0;#banners from other sites accounted in primary?
$primary_server_available = conntest2($primary_server,5432) if ($use_server && $server ne $primary_server);

my $upload_dir 	= $prefix."/up_d";
my $psql = '/usr/local/pgsql/bin/psql';
my $prog_export = $prefix."/bin/prog_export";
my $prog_import = $prefix."/bin/prog_import";
my $prog_unlink = $prefix."/bin/prog_unlink";

my $dnldscript =$url_prefix."/cgi/download.cgi";	

my $tmp_doc = $prefix."/tmp";

my $sendch = '/wtag/sendchat.php';
my $getch = '/wtag/getchat.php';

my $if_utf = 'utf/';

my $actv = '/cgi/genc/'.$if_utf.'show_active.pl';
my $srch = '/cgi/genc/'.$if_utf.'search_player.pl';
my $show_act = '/cgi/genc/'.$if_utf.'active_players.pl';
my $show_new = '/cgi/genc/'.$if_utf.'new_players.pl';
my $show_tourn = '/cgi/genc/'.$if_utf.'show_tourn.pl';
my $show_kl = '/cgi/genc/'.$if_utf.'show_kl.pl';
my $read_stats = '/cgi/genc/'.$if_utf.'read_stats.pl';
my @chk = ('',
'',
'/cgi/genc/'.$if_utf.'check_alert.pl',
'/cgi/genc/'.$if_utf.'update_alert.pl',
'/cgi/genc/'.$if_utf.'req_ccard.pl',
'/cgi/genc/'.$if_utf.'read_mails.pl',
'/cgi/genc/'.$if_utf.'read_photo_comments.pl',
'/cgi/genc/'.$if_utf.'read_polls.pl',
'/cgi/genc/'.$if_utf.'read_film.pl');

my $get_response = '/cgi/genc/'.$if_utf.'get_response.pl';

my $ins_ban = '/cgi/genc/ins_ban.pl';
my $ins_vote = '/cgi/genc/ins_vote.pl';

my $grey_shado = "-webkit-box-shadow: 1px 1px 3px #ccc;-moz-box-shadow: 1px 1px 3px #ccc;box-shadow: 1px 1px 3px #ccc";
my $blu_shado = ($develop > 2) ? "-webkit-box-shadow: 1px 1px 3px #9cf;-moz-box-shadow: 1px 1px 3px #9cf;box-shadow: 1px 1px 3px #9cf" : $grey_shado;

my $gmtimeshift = 10800; # you're not in Greenwich
my $n_user_world = "moscow4";
my $mapw = 710;
my $maph = 850;
my $start_page_left_col_margin_top = '';
my $offset_members_per_page = 0;
my $num_members_per_page = 100;

my $displayable_reg_field = 1;

my @cmetro = @{$cmetro_generic{$ru_en}};
my %hmetro = ();
my @metro_array = ();
my $counter = 0;
foreach my $metro_i (@cmetro) {
	push @metro_array,$counter;
	push @metro_array,$metro_i;
$counter++;
}
%hmetro = @metro_array;

#server-dependent constants come here

$tmp_doc = $prefix."/cp/tmp" if ($develop == 12 || $develop >= 14);

my $tag = defined($query->param('tag')) ? $query->param('tag') : '';
my $tagtable = defined($query->param('tagtable')) ? $query->param('tagtable') : 0;

my $curr_sport_local = defined($query->param('cat')) ? $query->param('cat') : -1;
my $not_main = $curr_sport_local >= 0 ? 1 : 0;

#print STDERR "Here curr_sport is $curr_sport!\n";

$curr_sport = $curr_sport_local if (isint($curr_sport_local) && $not_main);

($dbase,$server,$port,$user,$passwd,$hourshift) = TClubMD5::get_connect_req($ru_en);

$extra_admin = "alex" if ($develop == 12 || ($develop == 15 || $develop == 16) );

my $xmapmargin = 20;
my $ymapmargin = 20;

my $mw = $mapw + 2*$xmapmargin;
my $mh = $maph + 2*$ymapmargin;

$pnmdir = "/usr/local/netpbm/bin";

my $htdocs	= $prefix.'/public_html';
my $video_doc = $tmp_doc."/video";
my $import_dir = $tmp_doc."/up_import";#used only if export_mode

my %Cookies = TClubMD5::GetCookies('LANG','WallPpr_Ind','IfNoOpenNewWindows','MOBILE','SPORT','ROUNDS','ScreenResW','RESIZE','WHS');
my $lang = $Cookies{'LANG'};

my $default_wallppr_ind = 0  ? 3 : 0;

my $wallpaper_ind = defined($Cookies{'WallPpr_Ind'}) ? $Cookies{'WallPpr_Ind'} : $default_wallppr_ind;

my $if_no_open_new_windows = $Cookies{'IfNoOpenNewWindows'} ? 1 : 0;

my $ie_add = ($browser=~/msie/i) ? "_ie" : '';

my $genericjs = $if_no_open_new_windows ? 'generic_no_open.js' : 'generic'.$ie_add.'.js';

if (length($lang) == 0) {
	$lang = substr($language,0,2);
}

my $messages_log = $prefix.'/handlers/static/messages';

my $squares = ( defined($Cookies{'ROUNDS'}) && $Cookies{'ROUNDS'} == 0)   ? 1 : 0;

my $num_order_default = 20;
$num_order_default = defined($query->param('mode')) && $query->param('mode') eq "stockmybuys_panel" ? 40 : $num_order_default;

#print STDERR "Here num_order_default is $num_order_default!\n";

my $ncha_limit_default = 10;

my $ncha_limit = defined($query->param('requested_num_cha')) ? $query->param('requested_num_cha') : $ncha_limit_default;
my $num_order = defined($query->param('num_order')) ? $query->param('num_order') : $num_order_default;


#print STDERR "Here num_order is $num_order!\n";
############# defaults

my $berkley_db_addon = $develop == 14 ? "_uma24" : '';
my $uma24 = $develop == 14 ? " uma24" : '';

my $user_database = $prefix."/handlers/users$berkley_db_addon.db";
#$user_database = $prefix."/handlers/users_uma24.db" if ($develop == 14);

print STDERR "cp: db_file is $user_database!\n" if ($debug);

# must be read/writeable by web server user group
my $session_database = $prefix."/handlers/sessions$berkley_db_addon.db";
#$session_database = $prefix."/handlers/sessions_uma24.db" if ($develop == 14);

my $seed_sessionFile = $prefix.'/handlers/seeds.db.'.$ip_addr;

print STDERR "Here sess is $seed_sessionFile!\n" if ($debug);

#AUTHENTICATION GOES HERE
#####################

my ($r_user,$header, $result_message, $reg_passwd,  $reg_user, $reg_email, $reg_cookie);
my $mode = '';
my $token;

my $cool_auth_cookies = 1;
my %Coo = TClubMD5::GetCookies('wtUser','cdAuth','User','v','PROFILE','IQS');
$cool_auth_cookies = 1 if ( ($Coo{'wtUser'} && $Coo{'cdAuth'} && $Coo{'User'}) || $Coo{'v'});
$cool_auth_cookies = 1 if ( length($vars{Submit}) );

unless (defined($query->param('mode')) || length($vars{Submit})) {
	$query->param(-name=>'mode', -value=>'demo');
	$mode="empty";
}

my $nologin = 1;

my $check_response_delta = 0;
my $generate_static_page = 0;

my $demo_mode = 0;

$demo_mode = 1 if ( ($ENV{SERVER_NAME} =~ /^xetr/ || $ENV{SERVER_NAME} =~ /^antitor/) && !$from_home );

my $help_site_url = $language eq "russian" ? "https://xter.tech/newsite/help.html" : "http://www.safe2b.net/editions";
#$scriptname?mode=h_panel
my $users_menu_str = $language eq "russian" ? koitoutf8("����") : "Users";
my $logs_menu_str = $language eq "russian" ? koitoutf8("����") : "Logs";
my $video_menu_str = $language eq "russian" ? koitoutf8("�����") : "Video";
my $info_menu_str = $language eq "russian" ? koitoutf8("����") : "Info";
my $settings_menu_str = $language eq "russian" ? koitoutf8("���������") : "Settings";
my $settings_menu_str_short = $language eq "russian" ? koitoutf8("���������") : "Setup";
my $help_menu_str = $language eq "russian" ? koitoutf8("������") : "Help";
my $antitor_menu_str = "<s>TOR</s>";

my $stockboard_menu_str = $language eq "russian" ? koitoutf8("�����") : "Board";
my $u_buys_menu_str = $language eq "russian" ? koitoutf8("�������") : "Buys";
my $u_profile_menu_str = $language eq "russian" ? koitoutf8("�������") : "Profile";
my $u_buyers_menu_str = $language eq "russian" ? koitoutf8("����������") : "Clients";
my $u_partners_menu_str = $language eq "russian" ? koitoutf8("��������") : "Partners";
my $u_sells_menu_str = $language eq "russian" ? koitoutf8("�������") : "Sells";
my $polka_menu_str = "Coins";

my $stats_menu_str = "Stats";

my $users_menu = "<li class='nav-item'>
<a class='nav-link' href='?mode=w_uc_panel'>
<i class='fas fa-users'></i>
$users_menu_str
</a>
</li>";

my $users_menu2 = "<li class='nav-item'>
<a class='nav-link active' href='?mode=w_uc_panel'>
<i class='fas fa-users'></i>
$users_menu_str
<span class='sr-only'>(current)</span>
</a>
</li>";

my $logs_menu = "<li class='nav-item'>
<a class='nav-link' href='?mode=w_ls_panel'>
<i class='fas fa-file-alt'></i>
$logs_menu_str
</a>
</li>";

my $logs_menu2 = "<li class='nav-item'>
<a class='nav-link active' href='?mode=w_ls_panel'>
<i class='fas fa-chart-bar'></i>
$logs_menu_str
<span class='sr-only'>(current)</span>
</a>
</li>";

my $stats_menu = "<li class='nav-item'>
<a class='nav-link' href='?mode=w_uc_stats'>
<i class='fas fa-chart-bar'></i>
$stats_menu_str
</a>
</li>";

my $stats_menu2 = "<li class='nav-item'>
<a class='nav-link active' href='?mode=w_uc_stats'>
<i class='fas fa-chart-bar'></i>
$stats_menu_str
<span class='sr-only'>(current)</span>
</a>
</li>";

my $polka_menu = "<li class='nav-item'>
<a class='nav-link' href='?mode=w_uc_polka'>
<i class='fas fa-coins'></i>
$polka_menu_str
</a>
</li>";

my $polka_menu2 = "<li class='nav-item'>
<a class='nav-link active' href='?mode=w_uc_polka'>
<i class='fas fa-coins'></i>
$polka_menu_str
<span class='sr-only'>(current)</span>
</a>
</li>";

my $users_menu_mob = "<a class=mob_nav href='?mode=w_uc_panel'>$users_menu_str</a>";
my $users_menu_mob_active = "<span class=mob_nav_active>$users_menu_str</span>";

my $logs_menu_mob = "<a class=mob_nav href='?mode=w_ls_panel'>$logs_menu_str</a>";
my $logs_menu_mob_active = "<span class=mob_nav_active>$logs_menu_str</span>";

my $stats_menu_mob = "<a class=mob_nav href='?mode=w_uc_stats'>$stats_menu_str</a>";
my $stats_menu_mob_active = "<span class=mob_nav_active>$stats_menu_str</span>";

my $polka_menu_mob = "<a class=mob_nav href='?mode=w_uc_polka'>$polka_menu_str</a>";
my $polka_menu_mob_active = "<span class=mob_nav_active>$polka_menu_str</span>";

my $softpac = 0; 
if (-f "/etc/sysconfig/softpac") {
	$softpac = `cat /etc/sysconfig/softpac`; $softpac =~ s/(\r|\n)//g;
}

my $cli = `cat /etc/sysconfig/interfaces | grep CLIENTNAME | awk -F '=' '{print \$2}'`;$cli =~ s/(\r|\n)//g;
my $vg_owner = $cli =~ /^vg_(\d+)$/ ? 1 : 0; my $rh_owner = $cli =~ /^rh_(\d+)$/ ? 1 : 0;

my $unique_xter_id = `cat /etc/sysconfig/interfaces | grep UNIQUE_XTER_ID | awk -F '=' '{print \$2}'`;$unique_xter_id =~ s/(\r|\n)//g;
my $xtertech = `cat /etc/sysconfig/interfaces | grep XTERTECH | awk -F '=' '{print \$2}'`;$xtertech =~ s/(\r|\n)//g; 
#$xtertech .= ":8443"; #hack ash

my $polka = $softpac eq '6' ? 1 : 0;

my $free_media = ( $softpac eq '5' && ($cli eq "demo" || $cli eq "jaja" || $cli eq "rhplus")) || $softpac eq '7' ? 1 : 0;
#my $free_media = $softpac eq '5' && ($cli eq "demo" || $cli eq "jaja" || $cli eq "rhplus") ? 1 : 0;

my $certs_change_permitted = 1;
my $png_change_permitted = 1;
my $mp3_change_permitted = 1;
my $jpg_change_permitted = 1;

my $super_free_media = ( $softpac eq '5' && ($cli eq "demo" || $cli eq "jaja") ) ? 1 : 0;

my $not_so_free_media = ( $softpac eq '5' && $cli eq "off") ? 1 : 0;

if ($free_media && $develop != 16) {
	$users_menu = $stats_menu;
	$users_menu2 = $stats_menu2;
	$users_menu_mob = $stats_menu_mob;
	$users_menu_mob_active = $stats_menu_mob_active;
	
}

if ($free_media && $develop == 16) {
	$logs_menu = $stats_menu;
	$logs_menu2 = $stats_menu2;
	$logs_menu_mob = $stats_menu_mob;
	$logs_menu_mob_active = $stats_menu_mob_active;
	
}

if ($polka) {
	$users_menu = $polka_menu;
	$users_menu2 = $polka_menu2;
	$users_menu_mob = $polka_menu_mob;
	$users_menu_mob_active = $polka_menu_mob_active;
	
}

#print STDERR "1: Here nologin is $nologin!\n";

if ($cool_auth_cookies && !$indexing && !$demo_mode) {
 
print STDERR "Into login: scriptUrl is $scriptURL, user_database is $user_database, session_database is $session_database!\n" if ($debug);

($r_user, $header, $result_message, $reg_passwd, $reg_user, $reg_email, $reg_cookie) = TClubMD5::login($scriptURL,$user_database,$session_database,\%vars,$randomNumber,$d, $n, $g, $e, $c, $cid, $ct,$develop);

print STDERR "Here message is $result_message, header is $header!\n" if ($debug);

my $i_coo = defined($Coo{'IQS'}) ? $Coo{'IQS'} : '';

#print STDERR "Here i_coo is $i_coo!\n";

if (length($i_coo) && 0) {
	
print STDERR "Redirect to intre!\n";	

	$mode = "intre";
	
}

$r_user = "visitatore" if ($r_user eq 'visiteur');
$nologin = 0 if ( length($r_user) && $r_user ne "guest" );

$token = TClubMD5::md5_hex($r_user.$salt);
print STDERR "Here who is $r_user, salt is $salt, token is $token!\n" if ($debug);

my $now_time  = time;
my $tt = $now_time - $script_start_time;

print STDERR "Debug: after login, time is $tt\n" if ($debug);

} else {

$r_user = (defined ($Coo{'wtUser'}) && length($Coo{'wtUser'})) ? $Coo{'wtUser'} : 'visitatore';
$nologin = (defined ($Coo{'wtUser'}) && length($Coo{'wtUser'})) ? 0 : 1;

#print STDERR "1a: Here nologin is $nologin!\n";
if ($demo_mode) {
	$r_user = "alex";
	$nologin = 0;
}
}
#print STDERR "2: Here nologin is $nologin, $demo_mode!\n";
#ddos primitives -- checklist must be flushed from crontab each minute

my $def_user = $nologin ? "alex" : $r_user; #global def_user

my $with_friend_invite = 0;

my $opera = 0;
$opera = 1 if ($browser=~/Opera/i);

my $now_time  = time;
my $tt = $now_time - $script_start_time;
print STDERR "Debug: after setting dbase, etc through get_connect_req, time is $tt\n" if ($debug);

#####################

my $mark = substr(TClubMD5::md5_hex(time()),0,8);

#####################

my $current_credit = 0;
my $current_status = '';

#sleep param used to limit traffic to some users (particularly to non-members)
my $sleep_param = 60;
my $sleep_imitate = 1;

my $tclub_card_classic=0;

my $result_of_toss = get_random(0);
my $showing_icons_bar = 0; $showing_icons_bar = 1 if ((int($result_of_toss/2))*2 == $result_of_toss);

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday) = gmtime(time+$gmtimeshift); #should be seen universal
$squares = 0 if ($wday > 5 || $wday == 0); #roundish on weekends
$squares = 0 if (!$showing_icons_bar); #roundish on showing big_google_banner

if ($sleep_imitate && !$sleep_param) {


	if (($hour > 9 && $hour < 18) && $wday && $wday != 6) {
		$sleep_param = 1 if ((int($result_of_toss/2))*2 < $result_of_toss);
	}
}


$video_menu_str = $softpac eq '5' ? "Home" :$video_menu_str;

my $noheader = 0;

my $is_admin  = ($r_user eq $extra_admin || $r_user eq $club_admin) ? 1 : 0;
my $disp_class = ( ($softpac eq '5' || $softpac eq '2') && !$free_media && !($not_so_free_media && !$is_admin) ) ? '' : " style=\"display:none;\"";

#print STDERR "Here header is $header!\n";

if ($header && $header ne "Bad_Register" && $header ne "Cont_Register" && $header ne "Good_Register") 
{
		print $header;

} 
        elsif ($header eq "Bad_Register"){
		$noheader = 1; 
		$mode="new_register";}
	elsif ($header eq "Cont_Register"){
		$noheader = 1; 
		$mode="cont_register";}
	elsif ($header eq "Good_Register"){
		$noheader = 1; 
		$mode="done_register";
	} else {$noheader = 1;}


my $now_time  = time;
my $tt = $now_time - $script_start_time;
print STDERR "Debug: after print header1, time is $tt\n" if ($debug);

my $toss_result; my $time_of_toss; my $f_number;
					
my $qp = 	$query->param('orderby');
my $order      = GetOrderBy($qp);
my $type_of_cat = $query->param('type_of_cat');

my $table      = $r_user . "__list";
$table = lc $table;

my $oid        = $query->param('oid');
my $search     = $query->param('search');

$mode       = $query->param('mode') if !$mode;
$mode  	    = decode_local($mode);

print STDERR "Here mode is $mode!\n" 
unless ($mode =~ /ajax/ || $mode =~ /print_/)
;

#only these mode available to normal users in develop

my @permitted_modes = ('',"empty","clear_cookies","system_panel",
"ls_panel", "ls_graph", "ls_topsites", "ls_bigfiles", "ls_group_detail", "ls_month_detail", "ls_day_detail", "ls_user_detail", "ls_whousesite", "ls_user_month", "ls_user_time",
"nw_panel", "w_ls_panel", "w_h_panel", "h_panel",
"h_a_user", "h_b_user", "h_c_user", "h_d_user", "h_e_user", "h_f_user", "h_g_user", "h_h_user", "h_i_user", "h_j_user", "h_k_user", "h_l_user", "h_m_user", 
"h_n_user", "h_o_user", "h_p_user", "h_q_user", "h_r_user", "h_s_user", 
"print_ur", "js_ctrl", "js_chip", "js_edit_bl", "js_change_value", "work_polka", "change_object", "change_action") if ($develop == 12);

@permitted_modes = ('',"empty","clear_cookies","start_od","stop_od","check_streaming","print_events","list_rec_files","system_panel", "video_panel", 
"add_certs", "upload_certs", "add_png", "upload_png", "add_jpg", "hi_res", "set_hi_res", "upload_jpg", "add_mp3", "upload_mp3", 
"save_rec", "store_rec", "delete_vmail", "buf_vmail", "check_vmail", "reload_rlist", 
"ls_panel", "ls_graph", "ls_topsites", "ls_bigfiles", "ls_group_detail", "ls_month_detail", "ls_day_detail", "ls_user_detail", "ls_whousesite", "ls_user_month", "ls_user_time",
"nw_panel", "w_ls_panel", "w_uc_panel", "w_uc_panel_old", "w_uc_stats", "w_uc_polka", "w_h_panel", "h_panel",  "users_control", "videos_page", "stats_mode", "polka_mode",
"h_a_user", "h_b_user", "h_c_user", "h_d_user", "h_e_user", "h_f_user", "h_g_user", "h_h_user", "h_i_user", "h_j_user", "h_k_user", "h_l_user", "h_m_user", 
"h_n_user", "h_o_user", "h_p_user", "h_q_user", "h_r_user", "h_s_user", 
"print_ur", "js_ctrl", "js_chip", "js_edit_bl", "js_change_value", 
"uc_panel", "uc_smlight", "uc_mailq", "uc_spam", "uc_whitelist", "uc_traff", "uc_traff_yota",
"uc_restart", "uc_ntpdate", 
"uc_add_user", "uc_del_user", "uc_inst_win", "uc_run_win", "uc_files_win", "uc_stop_win", "uc_deinst_win", "change_object", "change_action") 
if ( $develop == 12 && $softpac eq '5');

@permitted_modes = ('',"empty","clear_cookies", "w_uc_panel", "w_uc_stats", "w_uc_polka", "users_mode", "videos_page","save_rec", "store_rec", "delete_vmail", "buf_vmail", "check_vmail", "reload_rlist")
if ( ($develop == 12 && ($softpac eq '5' || $softpac eq '6')) && !$is_admin);

@permitted_modes = ('',"empty","clear_cookies", "w_uc_panel", "users_mode", "interprete", "intre", "js_guru_ctrl", "js_radio_av", "js_change_logo", "js_ctrl", "users_control", "add_jpg", "hi_res", "set_hi_res", "upload_jpg", "do_add_member", "do_del_member", "do_ch_pass", "do_add_room", "do_del_room", "do_sel_room", "do_toggle_rm", "js_change_value") 
if ( ($develop == 15 || $develop == 16) && !$is_admin);

@permitted_modes = ('',"empty","clear_cookies","start_od","stop_od","check_streaming","print_events","list_rec_files","system_panel", "video_panel",
"ls_panel", "ls_graph", "ls_topsites", "ls_bigfiles", "ls_group_detail", "ls_month_detail", "ls_day_detail", "ls_user_detail", "ls_whousesite", "ls_user_month", "ls_user_time",
"nw_panel", "w_ls_panel", "w_h_panel", "h_panel", 
"h_a_user", "h_b_user", "h_c_user", "h_d_user", "h_e_user", "h_f_user", "h_g_user", "h_h_user", "h_i_user", "h_j_user", "h_k_user", "h_l_user", "h_m_user", 
"h_n_user", "h_o_user", "h_p_user", "h_q_user", "h_r_user", "h_s_user",
"print_ur", "js_ctrl", "js_chip", "js_edit_bl", "js_change_value", "change_object", "change_action") if ($develop == 12 && $softpac eq '2');

@permitted_modes = ('',"empty","clear_cookies","stockboard_panel","stockusers_panel","stockpartners_panel","stocksells_panel","stockhelp_panel",
"stockmyprofile_panel","stockmybuys_panel",
"list_challenges", "list_controls", "list_tags", "edit_challenge", "update_challenge", "add_ad", "add_challenge","color_chal","hide_record",
"confirm_yourself", "do_confirm_yourself", "confirm_yourself_juma", "do_confirm_yourself_juma", "remove_yourself", "do_remove_yourself", "select_candidate", "edit_member", "update_member", "add_member", "do_add_member",
"post_forum", "repl_forum", "rm_record","new_register","cont_register","done_register") if ($develop == 14);

my $coid = $query->param('coid');

my $alternate_table = defined($query->param('alternate_table')) ? $query->param('alternate_table') : '';


my $multicabo = 0; my $mycabo_master = 0;
my $mycabo = defined($query->param('mycabo')) ? $query->param('mycabo') : '';

unless (length($mycabo)) {
	my @c = split('\.',$ENV{SERVER_NAME});
	$mycabo  = $c[0];
	#print STDERR "now mycabo is $mycabo!\n";
};

my $hidden_class = $multicabo || ($not_so_free_media && !$is_admin) ? " style=\"visibility:hidden;\"" : '';

my $maxwidth   = 39;                       # maximum width of an automatically generated text field
my $maxfieldwidth   = 35;                       # maximum width of an automatically generated text field

my @ccateg = ();

my $uniqOID    = "id";

my $ntuples=0; my $result; my $listresult; my $u_admin = ''; my $au = ''; my $line; my $column;
my @clook = my @ctm = my @cdt = ();
my $comm = '';my $time_of_match; my $place_of_match; my $old_time_of_match; 
my $old_place_of_match; my $condition_of_match; my $is_new_mail = 0; my $nchallenges = 0; my $storeys = 0;
my $thisyear; my $thisdate; my $thistime; my $thissec; my $thismin; my $thishour;my $current_date;

my $ie = 0;
$ie = 1 if ($browser=~/msie/i);
$ie = 1 if ($browser=~/Trident\/7\.0/ && $browser=~/rv\:11\.0/);

my $ie6 = 0;
$ie6 = 1 if ($ie && ($vers<=7.0));

my $ie7 = 0;
$ie7 = 1 if ($ie && ($vers>=7.0));

my $ie8 = 0;
$ie8 = 1 if ($ie && ($vers>=8.0));

my $ie9 = 0;
$ie9 = 1 if ($ie && ($vers>=9.0));

my $ie10 = 0;
$ie10 = 1 if ($ie && ($vers>=10.0));

my $ie11 = 0;
$ie11 = 1 if ($ie && ($vers>=11.0));
$ie11 = 1 if ($browser=~/Trident\/7\.0/ && $browser=~/rv\:11\.0/);
$ie10 = 1 if ($ie11);

my $browser_supports_fading = 1;
$browser_supports_fading = 0 if ($ie && !$ie9);#? ie9 supports mootools fading? check it

$ie9 = 1 if ($ie8);#?
$ie9 = 1 if ($ie7);

my $old_moz = 0;
$old_moz = 1 if ( ($browser=~/Mozilla/i)&&($browser=~/Gecko\/2006/i) );

my $downgraded = 0;

my $safari = 0;
$safari = 1 if ($browser=~/Safari/i);

my $chrome = 0;
$chrome = 1 if ($browser=~/Chrome/i || $safari);

my $firefox = 0;
$firefox = 1 if ($browser=~/Firefox/i);

my $touch_specific_bro = 0; #pads ~ 800px wide
my $desktop = 1;
my $mobile_bro = 0; #phones ~ 480px wide

$touch_specific_bro = 1 
if ( $browser=~/Silk/ || $browser=~/iPhone/ || $browser=~/iPad/ || $browser=~/Android/ || $browser=~/Mobile/)
;

my $srw = defined($Cookies{'ScreenResW'}) ? $Cookies{'ScreenResW'} : 1280;

$touch_specific_bro = ($srw <= 1024) ? 1 : $touch_specific_bro;
$mobile_bro = ($srw <= 480) ? 1 : $mobile_bro;

#$touch_specific_bro = 1 if ($from_home);
my $stdn = $touch_specific_bro ? " style=\"display:none;\"" : '';

my $bubbles_css = 
$touch_specific_bro ? '' : 
"<link rel='stylesheet' href='/css_cp/bubbles.css'>";

$desktop = 0 if ($touch_specific_bro);

my $wider = $touch_specific_bro ? 0 : 1;
my $initial_scale= $wider ? "0.9" : "0.9";

my $android = 0; $android = 1 if ($browser=~/Android/i);
my $mac = 0; $mac = 1 if ($browser=~/iPhone/i || $browser=~/iPad/i);
my $kindlefire = 0; $kindlefire = 1 if ($browser=~/Silk/);

$maxfieldwidth = 16 if ($android || $mobile_bro || $touch_specific_bro);

my $first_time = 0;
$first_time = 1 if ($Cookies{'MOBILE'} eq '' && $nologin );

$browser=~/Firefox\/(\d+)/i;
$chrome = 1 if ($1>=4);

$browser=~/Version\/(\d+)/i;
if ($1 < 12 && $opera) {
	$chrome = 1;
} else {
	$downgraded = 1 if ($opera);
}

$chrome = 0 if ($ie10);

$downgraded = 1 if ( $old_moz || ($safari && $browser=~/Version\/3/) ); #old and/or unreliable stuff
$downgraded = 1 if ( $old_moz || ($safari && $browser=~/Version\/5\.1\.9/ && $browser=~/Macintosh/) ); #old and/or unreliable stuff

my $new_profile_format = 1;

my $cpu_default_overload_value = 50;

my $fs10 = "10px";
my $fs11 = "11px";
my $fs12 = "12px";
my $fs14 = "14px";
my $fs16 = "15px";
my $fs18 = "18px;font-family:Courier;";
my $fs24 = "20px;font-family:Courier;";
my $fs30 = "24px";
my $fs36 = "36px;font-family:Courier;";
my $fs48 = "48px";

$query->delete('orderby');

my $output = new CGI('');
print $query->header('text/html; charset='.$default_charset) if $noheader;

my $now_time  = time;
my $tt = $now_time - $script_start_time;

print STDERR "Debug: before pg_connect, dbase is $dbase, server is $server, port is $port, $user, $passwd, good_connect is $good_connect, time is $tt\n" if ($debug);

my $dbconn = DBI->connect("dbi:Pg:dbname=$dbase;port=$port;host=$server", $user, $passwd) if (!$good_connect);

my $now_time  = time;
my $tt = $now_time - $script_start_time;

print STDERR "Debug: after dbconn, time is $tt\n" if ($debug);

if (!defined($dbconn)) {
my $n_no_connect = "loading_image";
print qq{
<script type="text/javascript">
var n_user_world = '$n_no_connect';
};
print q{
    document.write ('<img src="/icon/'+n_user_world+'.gif" style="padding:10px;left:10px; top:10px;">');
 </script>
};

print qq{
<script type="text/javascript">
location.reload();
</script>
};

}

$dbconn->{LongReadLen} = 16384;

#now we can work with DB

my $nikname = &nkname_lookup($r_user);
#print STDERR "Here nk is $nikname!\n";

#first time check_user
my $curr_balance = 0;
$denga = "RUR" if ($develop == 14);

if ($is_admin) { 
	#($mycabo, $mycabo_master) =  &check_user(0) if (!$nologin && $develop == 16);
	$mycabo_master = 1; #hack ash
 }
else {
	($curr_sport, $curr_balance) = &check_user(0) unless ($nologin || $develop == 16);
	($mycabo, $mycabo_master) =  &check_user(0) if (!$nologin && $develop == 16);
	
	my $curr_sport_local = defined($query->param('cat')) && $is_admin ? $query->param('cat') : -1;
	my $not_main = $curr_sport_local >= 0 ? 1 : 0;
	$curr_sport = $curr_sport_local if (isint($curr_sport_local) && $not_main);
print STDERR "Here curr_sport is $curr_sport, local_sport is $curr_sport_local, r_user is $r_user, nologin is $nologin!\n" if ($debug);
}

#print STDERR "Here mycabo is $mycabo!\n";

my $y = $year+1900;
my $m = $mon+1;
my $d = $mday;


if ($develop && $ie11) {
	$ie = 0;$ie6 = 0;$ie7 = 0;$ie8 = 0;$ie9 = 0;$ie10 = 0; $ie11 = 0;
}

my $cool_browser = 1;
$cool_browser = 0 if ($downgraded || $ie6 || $opera);

my $new_style_boxes = 0;
$new_style_boxes = 1 if ($cool_browser);

my $left_spinner_mg = 138;
$left_spinner_mg = 72 if ($develop > 1);

my $top_spinner_mg = 88;
$top_spinner_mg = 196 if ((0));

my ($crl,$crt) = ('71','15');
$left_spinner_mg = $crl;
$top_spinner_mg = $crt;

#my $copyright_str = "Just Machine";
#my $copyright_str = "https://xter.tech";
my $copyright_str = '';

my $site_keywords = $__99b;
my $site_description = $__99bb;
$__3a = koitoutf8("�� ����");
if ($develop == 12 || $develop >= 14) {

	$copyright_str = "http://xetr.ru" if ($scriptURL =~ /xetr/);
	$copyright_str = "http://antitor.ru" if ($scriptURL =~ /antitor/);
	$copyright_str = "http://uma24.ru" if ($scriptURL =~ /uma24\./);
	$copyright_str = "http://juma24.com" if ($scriptURL =~ /juma24/);
	$site_keywords = $__99l;
	$site_description = $__99ll;

#print STDERR "Here url is $scriptURL, copystr is $copyright_str!\n";

}

my @num_offers = ();
my @num_buyers = ();
my @num_sells = ();
my @num_mybuys = ();
my $curr_hashsum = 0;
my $curr_num_challenges = 0;
my $curr_num_buyers = 0;
my $curr_num_sells = 0;
my $curr_num_mybuys = 0;

if ($develop == 14) {

my $sel = "select sport, count(sport) from challenges where date_and_time > current_timestamp+'$hourshift' group by sport order by sport";

my $res = $dbconn->prepare($sel);
$res->execute ;
&dBaseError($res, $sel."  (".$res->rows()." rows found)") if ($res->rows() == -2);

my $r = $res->fetchall_arrayref;
my $ntpls = $res->rows();

my @c = ();
$c[0] = koitoutf8("��� �������");
$c[1] = koitoutf8("������");
$c[2] = koitoutf8("�����");
$c[3] = koitoutf8("���������");
$c[4] = koitoutf8("��������");
$c[5] = koitoutf8("�������������");
$c[6] = koitoutf8("������������");
$c[7] = koitoutf8("������������");
$c[8] = koitoutf8("������������");
$c[9] = koitoutf8("��������");
$c[10] = koitoutf8("�������");
$c[11] = koitoutf8("������������");
$c[12] = koitoutf8("�������������");
$c[13] = koitoutf8("�����������");
$c[14] = koitoutf8("�����������");
$c[15] = koitoutf8("��������");
$c[16] = koitoutf8("���������");
$c[17] = koitoutf8("�������������");
$c[18] = koitoutf8("���������");
$c[19] = koitoutf8("���������");
$c[20] = koitoutf8("����������");
$c[21] = koitoutf8("���������-����������");
$c[22] = koitoutf8("���������������");
$c[23] = koitoutf8("��������");
$c[24] = koitoutf8("���������");
$c[25] = koitoutf8("����������");
$c[26] = koitoutf8("���������-����������");
$c[27] = koitoutf8("�������");
$c[28] = koitoutf8("�����������");
$c[29] = koitoutf8("���������");
$c[30] = koitoutf8("����");
$c[31] = koitoutf8("�����������");
$c[32] = koitoutf8("�������������");
$c[33] = koitoutf8("������������");
$c[34] = koitoutf8("����");
$c[35] = koitoutf8("����������");
$c[36] = koitoutf8("�������");
$c[37] = koitoutf8("��������");
$c[38] = koitoutf8("�����������");
$c[39] = koitoutf8("����� ��");
$c[40] = koitoutf8("��������");
$c[41] = koitoutf8("������");
$c[42] = koitoutf8("����������");
$c[43] = koitoutf8("��������");
$c[44] = koitoutf8("�������������");
$c[45] = koitoutf8("������������");
$c[46] = koitoutf8("�������������");
$c[47] = koitoutf8("������");
$c[48] = koitoutf8("������������");
$c[49] = koitoutf8("���������");
$c[50] = koitoutf8("����������");
$c[51] = koitoutf8("��������");
$c[52] = koitoutf8("����������");
$c[53] = koitoutf8("���������");
$c[54] = koitoutf8("�����-��������");
$c[55] = koitoutf8("�����������");
$c[56] = koitoutf8("����������");
$c[57] = koitoutf8("���������");
$c[58] = koitoutf8("���� (������)");
$c[59] = koitoutf8("�����������");
$c[60] = koitoutf8("���������");
$c[61] = koitoutf8("�����-���������");
$c[62] = koitoutf8("�����������");
$c[63] = koitoutf8("�������� ������");
$c[64] = koitoutf8("����������");
$c[65] = koitoutf8("��������������");
$c[66] = koitoutf8("������������");
$c[67] = koitoutf8("���������");
$c[68] = koitoutf8("����������");
$c[69] = koitoutf8("���������");
$c[70] = koitoutf8("�������");
$c[71] = koitoutf8("��������");
$c[72] = koitoutf8("��������");
$c[73] = koitoutf8("����");
$c[74] = koitoutf8("��������");
$c[75] = koitoutf8("�����������");
$c[76] = koitoutf8("�����������");
$c[77] = koitoutf8("�������");
$c[78] = koitoutf8("�����-����������");
$c[79] = koitoutf8("�����������");
$c[80] = koitoutf8("���������");
$c[81] = koitoutf8("���������");
$c[82] = koitoutf8("���������");
$c[83] = koitoutf8("������..");

my @m_array = ();
my $counter = 0;

foreach my $m (@c) {
	push @m_array,$counter;
	push @m_array,$m;
#print STDERR "[ $counter ]: [ $m ]\n";
$counter++;
}

%sport_labels = @m_array;

$num_sports = $counter;

for (my $i = 0; $i < $num_sports; $i++) {
	push @num_offers, 0;
}
my $tot = 0;
for (my $i = 0; $i < $ntpls; $i++) {
	$num_offers[${${$r}[$i]}[0]] = ${${$r}[$i]}[1];
	$tot += $num_offers[${${$r}[$i]}[0]];
}

$num_offers[0] = $tot;
$curr_num_challenges = $num_offers[$curr_sport];

my $sport_and = $curr_sport eq '0' ? '' : " sport = $curr_sport and ";
my $sel = "select sum(hex_to_int(substr(md5(concat(partner,status::text,date_and_time::text,price::text,place,condition)),0,3))) from challenges, members where$sport_and members.proj_code=challenges.owner and date_and_time > current_timestamp+'$hourshift'";
#print STDERR "Here sel is $sel!\n";
my $res = $dbconn->prepare($sel);
$res->execute;
&dBaseError($res, $sel."  (".$res->rows()." rows found)") if ($res->rows() == -2);

my $r = $res->fetchall_arrayref;
$curr_hashsum = ${${$r}[0]}[0] > 0 ? ${${$r}[0]}[0] : 0;

#### buyers
my $sel = "select city, count(city) from members where u_admin = '' group by city order by city";

my $res = $dbconn->prepare($sel);
$res->execute ;
&dBaseError($res, $sel."  (".$res->rows()." rows found)") if ($res->rows() == -2);

my $r = $res->fetchall_arrayref;
my $ntpls = $res->rows();

for (my $i = 0; $i < $num_sports; $i++) {
	push @num_buyers, 0;
}
my $tot = 0;
for (my $i = 0; $i < $ntpls; $i++) {
	$num_buyers[${${$r}[$i]}[0]] = ${${$r}[$i]}[1];
	$tot += $num_buyers[${${$r}[$i]}[0]];
}

$num_buyers[0] = $tot;
$curr_num_buyers = $num_buyers[$curr_sport];

#### sells

my $f = defined($query->param('tag')) ? $query->param('tag') : ''; $f =~ s/\s//g;

my $filter = length($f) ? " lower(tags.tag) ~ lower('$f') and tags.match_oid=challenges.ID and" : '';
my $taddon = length($f) ? ", tags" : '';

if ($tagtable eq '1') {$f = nkname_lookup($f,1); $filter = length($f) ? " partner = '$f' and" : ''; $taddon = '';}
if ($tagtable eq '2') {$filter = $f eq "yesterday" ? " challenges.time_of_selection < current_date and challenges.time_of_selection > current_date-1 and" : $f eq "today" ? " challenges.time_of_selection > current_date and" :''; $taddon = '';}

my $sel = "select sport, count(sport) from challenges$taddon where$filter challenges.status = 'f' and length(challenges.partner) > 0 group by sport order by sport";

my $res = $dbconn->prepare($sel);
$res->execute ;
&dBaseError($res, $sel."  (".$res->rows()." rows found)") if ($res->rows() == -2);

my $r = $res->fetchall_arrayref;
my $ntpls = $res->rows();

for (my $i = 0; $i < $num_sports; $i++) {
	push @num_sells, 0;
}
my $tot = 0;
for (my $i = 0; $i < $ntpls; $i++) {
	$num_sells[${${$r}[$i]}[0]] = ${${$r}[$i]}[1];
	$tot += $num_sells[${${$r}[$i]}[0]];
}

$num_sells[0] = $tot;
$curr_num_sells = $num_sells[$curr_sport];

#### my buys

unless ($is_admin) {

my $f = defined($query->param('tag')) ? $query->param('tag') : ''; $f =~ s/\s//g;

my $filter = length($f) ? " lower(tags.tag) ~ lower('$f') and tags.match_oid=challenges.ID and" : '';
my $taddon = length($f) ? ", tags" : '';

my $sel = "select sport, count(sport) from challenges$taddon where$filter challenges.status = 'f' and challenges.partner = '$r_user' group by sport order by sport";

#print STDERR "Here sel is $sel!\n";

my $res = $dbconn->prepare($sel);
$res->execute ;
&dBaseError($res, $sel."  (".$res->rows()." rows found)") if ($res->rows() == -2);

my $r = $res->fetchall_arrayref;
my $ntpls = $res->rows();

for (my $i = 0; $i < $num_sports; $i++) {
	push @num_mybuys, 0;
}
my $tot = 0;
for (my $i = 0; $i < $ntpls; $i++) {
	$num_mybuys[${${$r}[$i]}[0]] = ${${$r}[$i]}[1];
	$tot += $num_mybuys[${${$r}[$i]}[0]];
}

$num_mybuys[0] = $tot;
$curr_num_mybuys = $num_mybuys[$curr_sport];
} #not admin

} #develop == 14

$mode = "w_uc_panel" if ( ($develop == 12 || ($develop == 15 || $develop == 16) ) && !($is_admin || in_array($mode, @permitted_modes))); #hack ash
$mode = "w_uc_panel" if ( $develop == 16 && $is_admin && in_array($mode, ("system_panel","w_ls_panel","nw_panel")) && $multicabo); #dont't permit multicab gurus be sysadmins

my $x_screen_offset = ($touch_specific_bro) ? 210 : 240;
my $x_screen_offset_high = ($touch_specific_bro) ? 190 : 234;

my $x_screen_offset_mailbox = ($touch_specific_bro) ? 180 : 220;

my $y_screen_offset = 270;
$y_screen_offset = 210 if ($touch_specific_bro);

my $y_screen_offset_high = 315;

my $y_screen_offset_mailbox = 315;
$y_screen_offset_mailbox = ($mobile_bro) ? 60 : $y_screen_offset_mailbox;

$x_screen_offset = ($mobile_bro) ? 84 : $x_screen_offset;
$x_screen_offset_high = ($mobile_bro) ? 72 : $x_screen_offset_high;
$x_screen_offset_mailbox = ($mobile_bro) ? 60 : $x_screen_offset_mailbox;

$y_screen_offset = ($mobile_bro) ? 30 : $y_screen_offset;
$y_screen_offset_high = ($mobile_bro) ? 60 : $y_screen_offset_high;

$x_screen_offset = 420; $y_screen_offset = 450; #hack ash
if ($touch_specific_bro) {$x_screen_offset = 240; $y_screen_offset = 240;} #hack ash
#my $l = "var a = (screen.width/2)-$x_screen_offset;var b = (screen.height/2)-$y_screen_offset;";


my $off_mbox_notice = ($touch_specific_bro) ? 30 : $develop ? 365 : 365;
$off_mbox_notice = "screen.width/2-270";$off_mbox_notice = "screen.width/2-228" if ($touch_specific_bro);

my $now_time  = time;
my $tt = $now_time - $script_start_time;

# develop == 12 specific params
# ffmpeg -f alsa -i hw:0 -f video4linux2 -i /dev/video2 -vcodec libvpx -b:v 1M -acodec libvorbis /opt/nvme/videos/o.webm

#my $int_ip = "10.0.2.15";
#my $ext_ip = "81.25.50.12";

my $int_ip = `cat /etc/sysconfig/interfaces | grep PRI | grep -v PRI_ | awk -F '=' '{print \$2}'`;$int_ip =~ s/(\r|\n)//g;
my $ext_ip = `cat /etc/sysconfig/interfaces | grep EXT | awk -F '=' '{print \$2}'`;$ext_ip =~ s/(\r|\n)//g;

$scriptURL =~ /:\/\/(.+?):(\d+)/;

my $if_port = $2;

my $suffix = length($if_port) ? ":".$if_port : '';
#$suffix = ''; #ash

my $local_call = $ip_addr =~ /^192\.168/ ? 1 : 0;

print STDERR "here env_server_name is $ENV{SERVER_NAME} !\n" if ($debug);

my $my_ip = $local_call ? $int_ip : $ext_ip;
$my_ip = $ENV{SERVER_NAME}; # es mejor
#$my_ip = $ext_ip if ($int_ip eq "10.0.2.15" && !($my_ip =~ /xter\.tech/) ); #VB hack

my $ajaxed = 1;
my $ajval = 1000; #1sec
my $ie_no_cache = $ie ? "noCache:true, ": '';

my $privet = $language eq "russian" ? koitoutf8("������") : "Hello";
my $working = $language eq "russian" ? koitoutf8("..���������..") : "Turning on";
my $logout = $language eq "russian" ? koitoutf8("�����") : "Logout";
my $journal_events = $language eq "russian" ? koitoutf8("������ �������") : "Events Journal";
my $hover_mouse = $language eq "russian" ? koitoutf8("��������<br>�� ������ \"camera\"<br>� ���� ������") : "hover mouse<br>on event journal<br>\"camera\" tag";

my $xetr_version = "v1.42";

my $xter_main_unreach = `cat /etc/sysconfig/counter`; $xter_main_unreach =~ s/(\r|\n)//g;

my $onlo = $xter_main_unreach > 2 && $super_free_media ? " onload=\"alert('Problem with accessing your static IP - please check internet!')\"" : '';

my $edition = $softpac eq '0' ? "Router" : $softpac eq '5' ? ($free_media ? "KMS" : "Office") : $softpac eq '2' ? "Home" : $softpac eq '3' ? "Ether" : $softpac eq '6' ? "Staker" : $softpac eq '7' ? $vg_owner ? "VG" : "RH" : "Unofficial";

$edition = "Safe2B" if ($softpac eq '0' &&  $cli eq "demo");

$edition .= " Edition" unless ($edition eq "Router");

#print STDERR "Here disp is $disp_class, edition is $edition!\n";

my $copy_str = "&copy; $copyright_str xTER&nbsp;SafeContainer&nbsp;$xetr_version&nbsp;";
$copy_str = "Copyright 2008-2025 ". $copy_str unless ($touch_specific_bro);

my $copy_str2 = "Admin web interface";
$copy_str2 = "Juma Web Interface" if ($develop == 14);
$copy_str2 = "User web interface" unless $is_admin;

my $xTER = $language eq "russian" ? koitoutf8("������") : "xTER";
$xTER = $language eq "russian" ? koitoutf8("�������") : "AntiTor" if ($scriptURL =~ /antitor/);
$xTER = $language eq "russian" ? koitoutf8("Juma") : "Juma" if ($scriptURL =~ /uma24/);

my $do_logout = $touch_specific_bro ? " href='$scriptURL?Submit=Logout'" : " href='https://room-house.com/space/'";
my $do_logout_text = $touch_specific_bro ? $logout : $xetr_version;

my $foo_addon = $touch_specific_bro ?  " style=\"position:fixed;width:110%;bottom:0px;height:50px;padding:10px;color:#fff;\"" : " style=\"position:fixed;width:110%;bottom:0px;\"";
$foo_addon = $ie ? "" : $foo_addon;

#v1.0 beta to v1.01:
#16-17.04 -- added admin/wifi keys edit/save to Settings panel, values saved in interfaces file
#17.04 -- saving LS reports on the hidden flash drive /mnt/sda1 in case of empty storage NUC
#18.04 -- streaming video to runtime "hash".mjpeg (instead of cam.mjpeg), against unauth viewing
#v1.02
#19.04 -- blacklist in Settings panel added (initial layout and forms to write in file /etc/sysconfig/blacklist)
#20.04 -- blacklist functions for IP4 with iptables
#      -- using gzip + cpio to hide text in files on flash drive [interfaces and blacklist]
#v1.03
#24/25.04 -- new interface for recording and playing video
#26.04 -- added blacklist with squid https filtering
#26.04 -- good config for squid transparent proxy v3.5.27 built from source
#27.04 -- switch to use ffmpeg theora/vorbis .ogv instead of gstreamer and .mp4 on REC
#28-29.04 css cleanup v1.03
#v1.04
#3.05 -- fix google fonts search path for offline site work
#4.05 -- controls buttons up screen in video frames
#3-4.05 -- stream interface with ffserver
#v1.05
#6-7.05 -- https for xTER UI and all streams
#8-10.05 -- mod_proxy apache for tagging other workports to 443
#11.05 -- fix Firefox error on start_od
#12.05 -- fix hd720 audio sync error replacing ogv with mp4 for mpeg
#v1.06
#16.05	-- Users added to menu;run.cgi wrapped in
#17.05	-- smlight.cgi wrapped in; named and sendmail conf rework
#18.05  -- mailq.cgi, whitelist.cgi, spam.cgi wrapped in;
#19-20.05  -- add_user, del_user wrapped in and saving/encrypting new users worked out
#v1.07
#22.05 -- whitelist added
#23.05 -- http/https conf selection with http default due to bro's concern of self-signed cert
#24.05 -- whitelist in squid with tcp_outgoing_address/iptables;QUIC and Tor issues
#25-26.05 -- whitelist against tor with ipv4/ipv6
#27-28.05 -- HELP + fix/cleanup
#v1.08
#29-30.05 -- HELP + fix/cleanup css
#31.05 -- interface for HTTP/HTTPS server type and domain name switching
#01-02.06 -- "op" user working with PG and Apache; interface for services restart
#05.06 -- start_ scripts without mics; "op" user http folder on /mnt/sda2;
#06.06 -- home/office packs check and initwritten in interfaces; removing squid2, smb/nmb and imap from home pack;
#07.06 -- fixing eth0/eth1 order by blacklisting ax88 module on boot (usb eth) and later enabling it in start_GT.sh
#08.06 -- fixing cam1/cam2 usb order by assess_dev.pl
#v1.09
#13.06 -- remove hard-coded object from OD and interface; select where monitored = 't' instead;
#06.07 -- v1.10 split to office/home/free depending on softpac param
#21-22.07 -- CSS cleanup and setup/config scripts fixes for "direct without router" type of internet connection
#23.07 -- replacing mac addr with netmask in settings (as weird cifra1 has made us to); adding dhclient checkbox to settings panel, again because of cifra1 weird static ip setup
#24.07 -- v.1.11 with "bubbles" on background; ethernet auth-based squid2 revisited (blacklist issues)
#27.07 -- added working object selector in OD
#28.07 -- added multiple objects detection simultaneously
#31.07 -- fixed OD utils on incorrect handling simultaneous OD; replaced ssdlite-mobilenet with frozen of 20MB instead of 29MB.
#01.08 -- v1.12 adding sms and email notifications to OD
#02-03.08 -- figuring out the interface, objDet_utils.py and email/sms send scripts
#04.08 -- fix error in jittering detection
#08.08 -- using object coors to filter objects leaving the frame as events of disappearing (objDet_utils.py); fix error with RECs
#29.08 -- Telegrqam support in squid.conf
#01.09 -- packing v1.13
#15.09 -- start juma: $develop == 14
#22.09 -- 1.14 packed; concept and working demo for Juma finished; old tclub code cleanup
#27.09 -- Juma with sorting and ajax fetching new rows on scroll down; damn tricky stuff
#17.10 -- 1.15 packed: xTER scripts cleanup and fixes; mobile cp xTER cleanup
#06.11 -- 1.16 packed: Silver Level 1 Security (SLS-1); rewritten in 20 days setup; encryption added
#12.11 -- cleaned CSS for phones; "Settings" menu remodeled with bookmarks.
#25.11 -- 1.17 packed; integrated Windows10 in cp; checkbox in settings to allow set eth1 as default route; http_prefix issues cleaned as moving to https mode in most cases.
#28.11.19 -- added stronger password; added two scripts on cron to report on mail and Juma's xform.pl on the node's working status; moved videos to /opt/nvme/ssd; added certbot certs to xetr and antitor
#29.05 -- 1.18 Router packed
#23.08 -- 1.19 Miner packed
#25.10 -- 1.20 Home/Miner single distro packed, choose from /etc/sysconfig/softpac
#05.11 -- 1.21 Home ported to VirtualBox on 5G RAM; this file is one for all editions; major bufix/css work done in Home; sound now working with alsa in VB; Router with proxy on 8081 for jaja user.
#11.12 -- began users version; added check /var/log/streaming.log to /usr/local/bin/cp_new.sh to avoid mess with start_OD
#28.12 -- packed 1.22 with php/wtag/kurento as addon for Office edition/ softpac = 1
#30.12.20 -- added videochat java applet
#10.01 -- 1.23; added kurento js recorder/player to Office
#16.01 -- added new https upload_certs mode and servers restart script; ajax box interface added to nw_panel; couple of fixes in cp/css
#17.01 -- re-done create SATA drive partition, need to format and /opt/nvme-symlink for the virtual; fixes on save when both ssd and flash are present
#18.01 -- added mBox to Settings page; alerts replaced with mBox.Notice or Modal; dimmed internal IP/net edit for virtual;
#31.01 -- 1.24; video mail ajaxed full engine&interface
#06.03 -- 1.25; Cyrus-imapd as cy.tar.gz addon in Office; pass-through to pre-auth link by cookie set in Login page; develop = 15 for "target" CRM and Translit.
#25.05 -- starting 1.26; node checking scripts and stats
#03.06 -- 1.26 free KMS Edition with disabled Cyrus/PHP
#04.06 -- apo2 changing turnserver in Kurento(report_to_center.sh)
#05.06 -- put back ipcad to softpac=5 and added ipaudit report to Postgres and processing with report_to_center.sh/apo2, other new scripts, to report every minute Kurento traffic growth diff to center
#15.07 -- room-house.com HTML site => scripts URLs fixes
#09.08 -- 1.27; Polka interface
#31.10 -- packed 1.27 and downsized payouts coeff to 0.04
#08.11 -- vlibs with newer JS to autorefresh waiting channel
#20.11 -- prepared beta xTER for VG with cabinet
#24.12 -- scripts for restart_maven on errors for R-H
#28.12.21 -- fixed iptables issues, for VB and Kurento
#14.02 -- packed 1.29 with newer Java server;VG and R-H trimmed based on ~2,000 visits in Google Ads campaigns in Dec-Feb
#01.03 -- fixed joinRoom bug (double add and re-negotiating); added logs and write to log, etc. to VG according to February Google Ads results
#03.05 -- get mycabo from splitting env{server};adding one2many
#17.05 -- packed 1.30 with initial one-to-many
#27.05 -- signals check_connection added to one-to-many
#08.06 -- SP account binding with 0.01 transfer
#01.08 -- v1.31 packed; users controls/ added demo mode / multicab improved / stall pages, etc.
#13.09.22 -- v1.32 packed; rewritten CSS users_controls; chairs added; fix addUser.pl condition; R-H finalized to a12.js
#15.04 -- v1.33 packed; IP-based Room-House available on change EXT in settings; new certs upload allowed to everyone; domain change working
#28.04 -- v1.34 packed; changed daemon from 'nobody' to 'apache'; permissions for 'nobody' restricted
#04.05 -- v1.34 fixed CINEMA and added nodejs 16.14 in vlibs for queries in tester.pl
#15.05 -- v1.34 cleanup; sound on/off listening while streaming from ff
#09.06 -- v1.35 server/client re-connect fixes; re-design for cinemas
#10.11 -- v1.36 latest R-H with aparts and 3d textures; tables rooms, sessions and joins modified for R-H
#27.11.23 -- added re-streaming to vlibs; proxy vchat port 18443 with apache on 8443; added folder /opt/nvme/site_rh/ to vlibs
#19.01.24 -- v1.37 with rooms/users in admin interface; fixes
#18.05.24 -- v1.38 fixes in 3d; video for re-stream
#13.06.24 -- v1.39; 3 cinema halls to each tower
#25.08.24 -- v1.40 revamp sound controls on 3d button; css for shopping center and aggregator; connection handler fixes
#04.10.24 -- v1.41 individual xTER boot loading; individual audit root passwords; change pass for apart owner;
#28.11.24 -- v1.42 fix R-H browser memory leaks; cinema roll-up and revamp to multi-tracking; tickets revamp; ubuntu xTER with kurento 7.1.

if ( ($mode ne $buttons{'add'} && $mode ne decode_local($buttons{'add'}) 
&& $mode ne $buttons{'delete'} && $mode ne decode_local($buttons{'delete'}) 
&& $mode ne "start_od" && $mode ne "stop_od" && $mode ne "check_streaming" && $mode ne "print_events" && $mode ne "list_rec_files" 
&& $mode ne "system_panel" && $mode ne "video_panel" && $mode ne "videos_page" && $mode ne "save_rec" && $mode ne "store_rec" 
&& $mode ne "add_certs" && $mode ne "upload_certs" && $mode ne "add_png" && $mode ne "upload_png" && $mode ne "hi_res" && $mode ne "set_hi_res" && $mode ne "add_jpg" && $mode ne "upload_jpg" && $mode ne "add_mp3" && $mode ne "upload_mp3" 
&& $mode ne "delete_vmail" && $mode ne "buf_vmail" && $mode ne "check_vmail" && $mode ne "reload_rlist" 
&& $mode ne "ls_panel" && $mode ne "ls_graph" && $mode ne "ls_topsites" && $mode ne "ls_bigfiles" && $mode ne "ls_whousesite" 
&& $mode ne "ls_day_detail" && $mode ne "ls_month_detail" && $mode ne "ls_group_detail" && $mode ne "ls_user_detail" && $mode ne "ls_user_month" && $mode ne "ls_user_time" 
&& $mode ne "nw_panel" && $mode ne "w_ls_panel" && $mode ne "w_uc_stats" && $mode ne "w_uc_polka" && $mode ne "w_uc_panel" && $mode ne "w_uc_panel_old" && $mode ne "uc_panel" 
&& $mode ne "users_control" && $mode ne "users_mode" 
&& $mode ne "interprete" && $mode ne "intre" && $mode ne "list_conferences" && $mode ne "conf_list_create" && $mode ne "conf_edit"
&& $mode ne "w_h_panel" && $mode ne "h_panel" && $mode ne "stats_mode" && $mode ne "polka_mode" 
&& $mode ne "h_a_user" && $mode ne "h_b_user" && $mode ne "h_c_user" && $mode ne "h_d_user" && $mode ne "h_e_user" && $mode ne "h_f_user" && $mode ne "h_g_user" 
&& $mode ne "h_h_user" && $mode ne "h_i_user" && $mode ne "h_j_user" && $mode ne "h_k_user" && $mode ne "h_l_user" && $mode ne "h_m_user" && $mode ne "h_n_user" 
&& $mode ne "h_o_user" && $mode ne "h_p_user" && $mode ne "h_q_user" && $mode ne "h_r_user" && $mode ne "h_s_user" 
&& $mode ne "uc_smlight" && $mode ne "uc_mailq" && $mode ne "uc_spam" && $mode ne "uc_whitelist" 
&& $mode ne "uc_traff" && $mode ne "uc_traff_yota" && $mode ne "uc_restart" && $mode ne "uc_ntpdate" 
&& $mode ne "uc_add_user" && $mode ne "uc_del_user" && $mode ne "uc_inst_win" && $mode ne "uc_run_win" && $mode ne "uc_stop_win" && $mode ne "uc_files_win" && $mode ne "uc_deinst_win"
&& $mode ne "print_ur" && $mode ne "js_ctrl" && $mode ne "js_chip" && $mode ne "js_edit_bl" && $mode ne "js_change_value" && $mode ne "work_polka" && $mode ne "js_guru_ctrl" 
&& $mode ne "js_add_block" && $mode ne "js_remove_block" && $mode ne "js_radio_av"&& $mode ne "js_radio_oc" && $mode ne "js_change_logo" && $mode ne "change_object" && $mode ne "change_action"
&& $mode ne "stockboard_panel" && $mode ne "stockusers_panel" && $mode ne "stockpartners_panel" && $mode ne "stocksells_panel" && $mode ne "stockhelp_panel" 
&& $mode ne "stockmyprofile_panel" && $mode ne "stockmybuys_panel" 
&& $mode ne "list_challenges" && $mode ne "list_controls" && $mode ne "list_tags" && $mode ne "edit_challenge" && $mode ne "update_challenge" && $mode ne "add_ad" && $mode ne "add_challenge"
&& $mode ne "color_chal" && $mode ne "hide_record" && $mode ne "confirm_yourself" && $mode ne "do_confirm_yourself" && $mode ne "remove_yourself" && $mode ne "do_remove_yourself" 
&& $mode ne "select_candidate" && $mode ne "edit_member" && $mode ne "update_member" && $mode ne "add_member" && $mode ne "do_add_member" && $mode ne "do_del_member" && $mode ne "do_ch_pass" && $mode ne "do_add_room" && $mode ne "do_del_room" 
&& $mode ne "do_sel_room" && $mode ne "do_toggle_rm" 
&& $mode ne "post_forum" && $mode ne "repl_forum" && $mode ne "rm_record" && $mode ne "confirm_yourself_juma" && $mode ne "do_confirm_yourself_juma"
&& $mode ne "new_register" && $mode ne "cont_register" && $mode ne "done_register" )
|| $mode eq '') {

&start_page;

} elsif($mode eq decode_local($buttons{'search'}) || $mode eq $buttons{'search'} || $mode eq "search") {

} elsif($mode eq $buttons{'demo'} || $mode eq "demo") {

} elsif ($mode eq "send_sms" && $is_admin) {

	my $p = $query->param('phone');
	my $c = $query->param('tel');

	&do_send_sms ($p,$c,1);

} elsif($mode eq "clear_cookies") {

	TClubMD5::ClearCookies('wtUser','cdAuth');

	&close_and_reload;

} elsif($mode eq decode_local($buttons{'add'}) || $mode eq $buttons{'add'} || $mode eq "add") {
    
	$table = $alternate_table if ($alternate_table ne '');
	$table = "gallery" if $table eq '';
    
	my $d_vote = $query->param('d_vote');
	$mode = "add";
	&psupload ($query,$upload_dir,500);
	
	&tclub_doAddRecord ($query, $output);
 
	&write_log_notification('Table '.$table.' added by '.$r_user.' at '.$ru_en.'!','12') unless ($table eq "challenges");

	$query->delete_all;
    	
	if($table eq 'gallery' and $r_user ne $extra_admin) {
	print qq{
	<script>
		str = '$v_zga';
		alert(str);
	</script>
	};
	}

	&close_and_reload;                   

} elsif($mode eq "new_register" ) {


     &print_reg_notice;

} elsif($mode eq "cont_register" ) {

    my $screen_t = TClubMD5::getHashValue($seed_sessionFile,$result_message) or TClubMD5::errorExit($__7);

    TClubMD5::deleteHashValue($seed_sessionFile,$result_message);

   if ($screen_t ne '')
   {
     $table = "members";
     &tclub_create_Dialog;
   } else {
     TClubMD5::errorExit($__8);
   }


} elsif($mode eq "done_register" ) {

    $table = "members";

    my $screen_t = TClubMD5::getHashValue($seed_sessionFile,$result_message) or TClubMD5::errorExit($__7);

    TClubMD5::deleteHashValue($seed_sessionFile,$result_message);   

  if ($screen_t ne '') {
  
    my $who = $query->param('proj_code');
    
    $query->param(-name=>'pass', -value=>$vars{regcookie}) if ($develop);   
    
    my $_email = $query->param(-name=>'g_email');
    
    &tclub_doAddRecord ($query, $output);
	
    $query->delete_all;
    
    TClubMD5::errorExit($__9,'',1);
  } else {
    	TClubMD5::errorExit($__8);
  }

} elsif($mode eq "start_od")  {

	&make_date($gmtimeshift);
	my $n = defined($query->param('n')) ? $query->param('n') : 0;
	my $t = defined($query->param('type')) ? $query->param('type') : 0;
	my $r = -1;
	if ($t == 0) {
	   if ($n > 0) {

		my @newhashcam = ();
		my $hstr = TClubMD5::md5_hex(gettimeofday()); $newhashcam[0] = substr($hstr,0,16); $newhashcam[1] = substr($hstr,16,16);
		print STDERR "Just starting OD at $thisdate, $thistime!\n" if ($debug);
		$r = `/usr/local/bin/start_OD$n.sh $newhashcam[$n-1]`;	
	   }
	} elsif ($t == 1) {
	   if ($n > 0) {
	   	my $nme = $n.'_'.$thisdate.'_'.$thistime.'_'.$thissec.".webm";
		$nme =~ s/\///g;
		print STDERR "Just starting REC$n to file $nme!\n" if ($debug);
		$r = `/usr/local/bin/start_REC$n.sh $nme`;

	   }
	} elsif ($t == 2) {
	   if ($n > 0) {
		my @newhashcam = ();
		my $hstr = TClubMD5::md5_hex(gettimeofday()); $newhashcam[0] = substr($hstr,0,16); $newhashcam[1] = substr($hstr,16,16);
		print STDERR "Just starting STREAM$n to file $newhashcam[$n-1]!\n" if ($debug);
		$r = `/usr/local/bin/start_ST$n.sh $newhashcam[$n-1]`;

	   }
	} elsif ($t == 3) {
	   if ($n > 0) {
		my @newhashcam = ();
		my $hstr = TClubMD5::md5_hex(gettimeofday()); $newhashcam[0] = substr($hstr,0,16); $newhashcam[1] = substr($hstr,16,16);
		print STDERR "Just starting HD720$n to file $newhashcam[$n-1]!\n" if ($debug);
		$r = `/usr/local/bin/start_HD$n.sh $newhashcam[$n-1]`;

	   }
	}
	return $r;

		
} elsif($mode eq "stop_od")  {

	&make_date($gmtimeshift);
	my $n = defined($query->param('n')) ? $query->param('n') : 0;
	my $t = defined($query->param('type')) ? $query->param('type') : 0;	
	my $r = -1;	
	
	my $do = $t == 1 ? "REC" : $t == 2 ? "LIVE" : "OD";
	
	if ($n > 0) {

		$r = `/usr/local/bin/stop_OD$n.sh $t`;
		
		print STDERR "Just stopped $do at $thisdate, $thistime!\n" if ($debug);
	}
	
	return $r;

} elsif($mode eq "check_streaming")  {

	my $cam = defined($query->param('cam')) ? $query->param('cam') : 0;
	my $type = defined($query->param('type')) ? $query->param('type') : 0;
	exit  unless ($cam);
	
	my $s = int(`/usr/local/bin/check_stream.sh $cam $type`);
	
	print $s;
	exit;

} elsif($mode eq "list_rec_files")  {

	my $file = defined($query->param('file')) ? $query->param('file') : '';
	my $cam = defined($query->param('cam')) ? $query->param('cam') : 0;
	
	my $meta = ($file ne "cam") ? "<meta http-equiv=\"refresh\" content=\"3\" >" : '';

	exit unless ($cam);
	
	print qq{
		<html>
		<head>
		$meta
		</head>
		<body>
		<table>
	};
	
	my $fi = `find /opt/nvme/videos/ -type f`;
	
	my @strs = length ($fi) ? `ls -la \`find /opt/nvme/videos/ -type f\` | awk '{print \$9,\$5}'` : ();


$my_ip .= $suffix 
#if ($http_prefix eq "http")
;#hack ash
	
	foreach my $l (@strs) {
	   my ($f,$fs) = split(' ',$l);
	   $f =~ s/\/opt\/nvme\/videos\///g;
	   my $st = $file eq $f ? " style=\"color:#fee;font-weight:bold;\"" : '';

	   print qq{
		<tr style="line-height:32px;">
		<td><a href="$http_prefix://$my_ip/videos/$f"$st>$f</a></td>
		<td$st>$fs</td>
		</tr>
	   };
	}
	
	print qq{<tr><td>NOTHING YET</td></tr>} unless (length($fi));
	print qq{
		</table>
		</body>
		</html>
	};
	exit;
	
} elsif($mode eq "print_events")  {

	my $obj = $query->param('obj');	
	&print_events($obj);

} elsif($mode eq "print_ur")  {
	
	if ($softpac ne '3') {
		&print_ur;
	} else {
		&print_ur_miner;	
	}

} elsif($mode eq "js_ctrl")  {
	
	exit if ($demo_mode);
	
	my $ret = '';
	
	my $par = defined($query->param('par')) ? $query->param('par') : -1;
	exit if ($par < 0);
	
	if ($par == 0 ) {
		if ($free_media || $not_so_free_media){
			$ret = `sudo /usr/local/bin/stop_kurento.sh`;
		} else {
			$ret = `sudo /usr/local/bin/i0.sh`;		
		}
	} elsif ($par == 1) {
		$ret = `sudo /usr/local/bin/freesp.sh`;
	} elsif ($par == 2) {
		$ret = `sudo /usr/local/bin/sech.sh`;
	} elsif ($par == 3) {
		$ret = `sudo /usr/local/bin/replace_with_new.sh`;
	} elsif ($par == 4) {
		$ret = `sudo /usr/local/bin/replace_with_new.sh && sudo /usr/local/bin/i6.sh`;
	} elsif ($par == 5) {
		$ret = `sudo /usr/local/bin/reset_to_factory.sh`;
	} elsif ($par == 6) {
		if ($free_media || $not_so_free_media){
			$ret = `sudo /usr/local/bin/restart_kurento.sh`;
		} else {
			$ret = `sudo /usr/local/bin/i6.sh`;		
		}
	} elsif ($par == 7) {
		$ret = `sudo /usr/local/bin/lp.sh`;
	} elsif ($par == 8) {
		$ret = `sudo /usr/local/bin/change_policy.sh 0`;
	} elsif ($par == 9) {
		$ret = `sudo /usr/local/bin/change_policy.sh 1`;
	} elsif ($par == 10) {
		$ret = `sudo /usr/local/bin/return_to_saved.sh`;
	} elsif ($par == 11) {
		$ret = `sudo /usr/local/bin/change_policy.sh 2`;
	} elsif ($par == 12) {
		$ret = `sudo /usr/local/bin/change_policy.sh 3`;
	} elsif ($par == 13) {
		$ret = `sudo /usr/local/bin/start_ethmi.sh`;
	} elsif ($par == 14) {
		$ret = `sudo /usr/local/bin/stop_ethmi.sh`;
	} elsif ($par == 15) {
		$ret = `sudo /usr/local/bin/oh.sh 0`;
	} elsif ($par == 16) {
		$ret = `sudo /usr/local/bin/oh.sh 1`;
	} elsif ($par == 17) {
		$ret = `sudo /usr/local/bin/oh.sh 2`;
	} elsif ($par == 18) {
		$ret = `sudo /usr/local/bin/oh.sh 3`;
	} elsif ($par == 19) {
		$ret = `sudo /usr/local/bin/oh.sh 4`;
	} elsif ($par == 20) {
		$ret = `sudo /usr/local/bin/oh.sh 5`;
	} elsif ($par == 21) {
		if ($free_media || $not_so_free_media || $develop == 16){
			 my $par = $develop == 16 ? "video" : "audio";
			 $ret = `sudo /usr/local/bin/restart_maven.sh $par`;
		} else {
			$ret = `sudo /usr/local/bin/restart_gexp.sh`;		
		}	
		
	} elsif ($par == 22) {
		$ret = `sudo /usr/local/bin/toggle_bc_mode.sh 1`;
	} elsif ($par == 23) {
		$ret = `sudo /usr/local/bin/toggle_bc_mode.sh 2`;
	} elsif ($par == 24) {
		$ret = `sudo /usr/local/bin/toggle_bc_mode.sh 3`;
	} elsif ($par == 25) {
		$ret = `sudo /usr/local/bin/toggle_bc_mode.sh 4`;
	} elsif ($par == 26) {
		$ret = `sudo /usr/local/bin/toggle_bc_mode.sh 5`;
	} elsif ($par == 27) {
		$ret = `sudo /usr/local/bin/toggle_bc_mode.sh 6`;

	} else {
		$ret = "js_ctrl called with no just params";
	}
	
	print STDERR $ret."\n" if ($debug);
	
	exit;

} elsif ($mode eq "js_chip")  {
	
	
	my $ret = '';
	
	my $par = defined($query->param('par')) ? length($query->param('par')) : -1;
	exit unless ($par > 0);

	my $str = $query->param('par');
	my $c = MIME::Base64::decode_base64($str);
	$ret = `sudo /usr/local/bin/chip8.sh $c`;
	$ret = MIME::Base64::encode_base64($ret);
	
	print $ret;
	
	exit;

} elsif($mode eq "js_edit_bl")  {
	
	my $ret = 0;
	my $type = defined($query->param('type')) ? $query->param('type') : -1;
	exit unless ($type > 0);
	
	my $pol = defined($query->param('pol')) ? $query->param('pol') : 0;

	my $str = $query->param('str');
	my $blip = MIME::Base64::decode_base64($str);
	
	my $list = $pol == 1 ? "whitelist" : "blacklist";
	my $suff = $pol == 1 ? "wl" : "bl";
	
	my $file = "/etc/sysconfig/$list";
	my @bips = ();

	if (open my $info, $file) {

		while( my $line = <$info>)  {
			$line =~ s/(\r|\n)//g;  
    			push @bips,$line;    
		}

		close $info;
	} #if open
	
	if ($type == 1 && !in_array($blip, @bips)) {
		$ret = `sudo /usr/local/bin/add_$suff.sh $blip`;
		$ret = 1;
	} elsif ($type == 2 && in_array($blip, @bips)) {
		$ret = `sudo /usr/local/bin/rm_$suff.sh $blip`;
		$ret = 2;
	}

	print $ret;
	
	exit;

} elsif ($mode eq "work_polka")  {
	
	my $par = defined($query->param('par')) ? $query->param('par') : -1;
#print STDERR "Here par is $par, is_admin is $is_admin, softpac is $softpac!\n";
	my $PS_STR = `ps aux | grep polka_binary | grep -v interfaces | grep -v grep | awk '{print \$11}'`;
	$PS_STR =~ s/(\r|\n)//g;

	my $node_is_running = $PS_STR eq "/opt/nvme/ssd/polka/polka_binary" ? 1 : 0;

	unless ($is_admin  && $softpac eq '6' && $par) {
		print "N/A";
	} else {
		my $ret = 'no data received';
		$ret = `/usr/local/bin/start_polka.sh` if ($par eq '1');
		$ret = `/usr/local/bin/stop_polka.sh` if ($par eq '2');
		$ret = `/usr/local/bin/stop_sync_polka.sh` if ($par eq '5');
		$ret = `/usr/local/bin/resync_polka.sh` if ($par eq '3');
		$ret = `/usr/local/bin/curl_req_keys_polka.sh` if ($par eq '4'); 
#print STDERR "Here ret is $ret!\n";		
		$ret =~ s/(\r|\n)//g;
		#my $ret = `echo ha!`;
		#sleep(5) if ($par eq '1');
		print $ret;
	}
	
	exit;

} elsif($mode eq "js_change_logo")  {

	my $dbao = defined($query->param('dbao')) ? $query->param('dbao') : '';
	my $l = length($dbao);
	$dbao = "<span></span>" unless ($l);
	
	#unless ( $l && ($is_admin || ($develop == 16 && $mycabo_master && $mycabo == $query->param('mycabo')) ) ) {
	unless ( $is_admin || ($develop == 16 && $mycabo_master && $mycabo == $query->param('mycabo') ) ) {
		#print "No text given";
		exit;
	}
	
	$dbao =~ s/\//\\\//g;
	my $r = `sudo /usr/local/bin/change_target_mod.sh`;
	my $r = `sed -E -i 's/(class=dbao>)..*(<\\\/div>)/\\1$dbao\\2/g' /home/nobody/vchat/target/classes/static/index.html && sed -E -i 's/(class=dbao>)..*(<\\\/div>)/\\1$dbao\\2/g' /home/nobody/vchat/src/main/resources/static/index.html`;

	print STDERR "Changed dbao to $dbao";
	
} elsif($mode eq "js_radio_av")  {

	my $t = defined($query->param('type')) ? $query->param('type') : '';

	#print STDERR "Here t is $t!\n";

	if ($develop != 16) { 
		exit unless ( ($t eq '0' || $t eq '1' ) && $is_admin );
	} else {
		exit if (!($t eq '0' || $t eq '1' ) || !$mycabo_master || ($mycabo_master && defined($query->param('mycabo')) && $mycabo != $query->param('mycabo')));
	}

	if ($t eq '1') {
	   #my $r = `sed -i "s/var aonly = 1/var aonly = 0/g" /home/nobody/vchat/target/classes/static/index.html && sed -i "s/var aonly = 1/var aonly = 0/g" /home/nobody/vchat/src/main/resources/static/index.html`;
	   #print "Changed to video";
	   my $r = `sed -i "s/var one_to_many = 1/var one_to_many = 0/g" /home/nobody/vchat/target/classes/static/index.html && sed -i "s/var one_to_many = 1/var one_to_many = 0/g" /home/nobody/vchat/src/main/resources/static/index.html`;
	   print "Changed to Many";
	} elsif ($t eq '0') {
	   #my $r = `sed -i "s/var aonly = 0/var aonly = 1/g" /home/nobody/vchat/target/classes/static/index.html && sed -i "s/var aonly = 0/var aonly = 1/g" /home/nobody/vchat/src/main/resources/static/index.html`;
	   #print "Changed to audio";
	   my $r = `sed -i "s/var one_to_many = 0/var one_to_many = 1/g" /home/nobody/vchat/target/classes/static/index.html && sed -i "s/var one_to_many = 0/var one_to_many = 1/g" /home/nobody/vchat/src/main/resources/static/index.html`;
	   print "Changed to One";
	}

} elsif($mode eq "js_radio_oc")  {

	my $t = defined($query->param('type')) ? $query->param('type') : '';

	#print STDERR "Here t is $t!\n";

	exit unless ( ($t eq '0' || $t eq '1' ) && $is_admin );
	if ($t eq '1') {
	   foreach my $c ('en','ru','cn','es','fr','pt') {
	      #my $r = `sed -i --follow-symlinks "s/{pointer-events: none;display:none;}/{pointer-events: none;}/g" /var/www/html/cp/public_html/join_$c.html`;
	      #$r = `sed -i --follow-symlinks "s/id=roomName type=text/id=roomName type=hidden/g" /var/www/html/cp/public_html/join_$c.html`;
	   }
	   print "Changed to closed";
	} elsif ($t eq '0') {
	   foreach my $c ('en','ru','cn','es','fr','pt') {
	      #my $r = `sed -i --follow-symlinks "s/{pointer-events: none;}/{pointer-events: none;display:none;}/g" /var/www/html/cp/public_html/join_$c.html`;
	      #$r = `sed -i --follow-symlinks "s/id=roomName type=hidden/id=roomName type=text/g" /var/www/html/cp/public_html/join_$c.html`;
	   }
	   print "Changed to open";
	}
	
} elsif($mode eq "js_add_block")  {
	
	my $perv = defined($query->param('perv')) ? $query->param('perv') : '';
	my $l = length($perv);
	
	unless ( $l && $is_admin ) {
		print "No name given";
		exit;
	}
	
	        my $p_ip = `grep curip /home/nobody/vchat/lastlog | grep joinRoom | awk '{print \$14}' | grep $perv | jq -r '.curip'`;

#print STDERR "Here pip is $p_ip!\n";

		my @p = split('\n',$p_ip);

		if ($p[0] =~ /\d+\.\d+\.\d+\.\d+/) {
			my $applied = TClubMD5::apply_firewall($p[0]);
	
			if ($applied) {
				print "Ok, blocked ".$perv."!";
				#create table blocked (ip text, dte timestamp);
				my $cmd = "insert into blocked (ip, dte) values('".$p[0]."',current_timestamp)";
				my $result=$dbconn->prepare($cmd);
     				$result->execute;
        			&dBaseError($dbconn, $cmd) if (!defined($result));
			}		
			my $str = "/usr/bin/curl --silent -X POST --header 'Content-type: application/json' --data '{\"unique_xter_id\":\"$unique_xter_id\", \"status\":\"1\", \"softpac\":\"$softpac\", \"client\":\"$cli\", \"pip\":\"$p[0]\"}' https://dussel.room-house.com/cgi/genc/blocker";
			print STDERR "Blocking a perv IP on proxy with curl: ".$str."\n";
			$str = `$str`;
			
		} else {
			print "Name $perv not found!"
		}

} elsif($mode eq "js_remove_block")  {
	
	my $perv = defined($query->param('perv')) ? $query->param('perv') : '';
	my $l = length($perv);
	
	unless ( $l && $is_admin ) {
		print "No name given";
		exit;
	}
	
	        my $p_ip = `grep curip /home/nobody/vchat/lastlog | grep joinRoom | awk '{print \$14}' | grep $perv | jq -r '.curip'`;

#print STDERR "Here pip is $p_ip!\n";

		my @p = split('\n',$p_ip);

		if ($p[0] =~ /\d+\.\d+\.\d+\.\d+/) {
			my $applied = TClubMD5::unapply_firewall($p[0]);
	
			if ($applied) {
				print "Ok, unblocked ".$perv."!";

				my $cmd = "delete from blocked where ip = '$p[0]'";
				my $result=$dbconn->prepare($cmd);
     				$result->execute;
        			&dBaseError($dbconn, $cmd) if (!defined($result));
			}		
			my $str = "/usr/bin/curl --silent -X POST --header 'Content-type: application/json' --data '{\"unique_xter_id\":\"$unique_xter_id\", \"status\":\"1\", \"softpac\":\"$softpac\", \"client\":\"$cli\", \"pip\":\"$p[0]\"}' https://dussel.room-house.com/cgi/genc/unblocker";
			print STDERR "Unblocking an IP on proxy with curl: ".$str."\n";
			$str = `$str`;
			
		} else {
			print "Name $perv not found!"
		}
	
	
} elsif($mode eq "js_guru_ctrl")  {
	
	my $par = defined($query->param('par')) ? $query->param('par') : -1;
	
	my @c = split('\.',$ENV{SERVER_NAME}); my $mycar  = $c[0];
	
	#exit if ($par < 0 || !$mycabo_master || ($mycabo_master && $mycabo ne $mycar));
	exit if ($par < 0 || !$mycabo_master);	
	
#print STDERR "js_guru_ctrl mode: par is $par, mycabo is $mycabo, master is $mycabo_master, mycar is $mycar!\n";
	my $cmd = '';

	my $chu = TClubMD5::md5_hex(time());
	$chu =~ y/0-9//cd;
	my $r = substr($chu,0,4);
	
	my $multicab_addon = $multicabo ? length($mycabo) ? " and room = '$mycabo'" : '' : '';
	
	if ($par eq '0') {
		$cmd = "delete from wtagshoutbox where ctid in (select ctid from wtagshoutbox where name = '$nikname'$multicab_addon order by date desc limit 1)";
	} elsif ($par eq '1') {
		$cmd = "delete from wtagshoutbox where true$multicab_addon";
	} elsif ($par eq '2' && length($mycabo)) {

		$cmd = "update rooms set status = 1 where name = '$mycabo'";

		#change open to close:
		#my $res = `/usr/bin/sed -i "s/open_cabo pblue/closed_cabo pred/g" /var/www/html/cp/public_html/join_$mycabo.html && sed -i -E "s/128275; $door_is_unlocked/128273; $must_have_a_key/g" /var/www/html/cp/public_html/join_$mycabo.html`;
		
		my $res = `/usr/local/bin/change_pholder.pl $mycabo 1`;
		
	} elsif ($par eq '3' && length($mycabo)) {

		$cmd = "update rooms set status = 0 where name = '$mycabo'";
		
		#back to open:
		#my $res = `/usr/bin/sed -i "s/closed_cabo pred/open_cabo pblue/g" /var/www/html/cp/public_html/join_$mycabo.html && sed -i -E "s/128273; $must_have_a_key/128275; $door_is_unlocked/g" /var/www/html/cp/public_html/join_$mycabo.html`;

		my $res = `/usr/local/bin/change_pholder.pl $mycabo 0`;
	}  elsif ($par eq '4' && length($mycabo)) {
		my $cab = $mycabo eq "GREENHALL" || $mycabo eq "REDHALL" || $mycabo eq "BLUEHALL" ? $mycar : $mycabo;
		my $res = `/usr/bin/sed -i "s/true/false/g" /var/www/html/cp/public_html/join_$cab.html && /usr/bin/sed -i "s/true/false/g" /home/nobody/vchat/target/classes/static/joins//join_$cab.html`;
		$ret = `sudo /usr/local/bin/change_val.sh 28 \"$cab\"`;
		my $a = $mycabo."_room_limit"; $res = `echo 0 > /home/nobody/$a`; #need to zero guests or they may show up (while none must be seen in cinema)
	}  elsif ($par eq '5' && length($mycabo)) {
		my $cab = $mycabo eq "GREENHALL" || $mycabo eq "REDHALL" || $mycabo eq "BLUEHALL" ? $mycar : $mycabo;
		my $res = `/usr/bin/sed -i "s/false/true/g" /var/www/html/cp/public_html/join_$cab.html && /usr/bin/sed -i "s/false/true/g" /home/nobody/vchat/target/classes/static/joins//join_$cab.html`;
		$ret = `sudo /usr/local/bin/change_val.sh 29 \"$cab\"`;
	}  elsif ($par eq '6' && length($mycabo) && 0) { # do it manually until we're sure
		my $name = defined($query->param('name')) ? $query->param('name') : '';
		
		my $res = length($name) ? `sudo /usr/local/bin/add_cabo.sh $name` : '';
	}
	
	if (length($cmd)) {
		my $result=$dbconn->prepare($cmd);
     		$result->execute;
        	&dBaseError($dbconn, $cmd) if (!defined($result));	
	}

} elsif($mode eq "js_change_value")  {

	my $par = defined($query->param('par')) ? $query->param('par') : -1;
	my $val = defined($query->param('val')) ? $query->param('val') : "undef";
#print STDERR "par is $par, val is $val, is_admin is $is_admin, mycabo_master is $mycabo_master!\n";	
	exit if ($par < 0 || $val eq "undef");
	exit if (!$is_admin && !$mycabo_master && $develop == 16);
		
	if ($par && !$demo_mode && $par ne '21' && $par ne '22' && $par ne '24' && $par ne '30') { #js_change_chairs here
	
		my $str = "sudo /usr/local/bin/change_val.sh $par \"$val\" \"$mycabo\"";
		print STDERR $str;
		
		my $ret = `sudo /usr/local/bin/change_val.sh $par \"$val\" \"$mycabo\"`;
		print STDERR $ret if ($debug);

	} elsif ($par eq '21') {
		my $moid = defined($query->param('moid')) ? $query->param('moid') : -1;
     		my $cmd = "update members set a_nkname= '$val' where proj_code = '$moid'";
		my $result=$dbconn->prepare($cmd);
     		$result->execute;
        	&dBaseError($dbconn, $cmd) if (!defined($result));	
	} elsif ($par eq '22' || $par eq '30') {
		my $moid = defined($query->param('moid')) ? $query->param('moid') : -1;
		#can't update if there's owner
		$comm = "select members.id from members,rooms where members.room = rooms.name and rooms.id = '$moid'";
		&getTable;
		my $cnt = $ntuples;
		unless ($ntuples) {
     			my $cmd = $par eq '22' ? "update rooms set name = ? where id = ?" : "update rooms set num_rooms = ? where id = ?";
			my $result=$dbconn->prepare($cmd);
     			$result->execute($val,$moid);
        		&dBaseError($dbconn, $cmd) if (!defined($result));
		}	
	} elsif ($par eq '24') {
		my $str = "/usr/bin/curl --silent -X POST --header 'Content-type: application/json' --data '{\"unique_xter_id\":\"$unique_xter_id\", \"status\":\"1\", \"softpac\":\"$softpac\", \"client\":\"$cli\"}' https://cube.$xtertech/cgi/genc/apo4";
print STDERR "Polka apo4 curl: ".$str."\n";
		$str = `$str`;
	} elsif ($par eq '25') { #unreacheable - moved to change_val.sh
		#my $file = "/home/nobody/".$mycabo."_room_limit";
		
		#check what setting
		#$val = $val =~ m/[0-9]/ ? $val : 0;
		#$val = $val > 9 ? 10 : $val;
		#my $str = `echo $val > $file`;
#print STDERR "Trying to change with: echo $val > $file\n";
		#print $val;
	} elsif ($par eq '27') {

	} else {}
	
	exit;

} elsif($mode eq "change_object")  {

	my $nobj  = $query->param('obj');
	&print_od_header($nobj);


} elsif($mode eq "change_action")  {

	my $nobj  = $query->param('obj');
	my $nact  = $query->param('act');

	my $cmd = "update objects set monitor_type = $nact where object = '$nobj'";
	my $result=$dbconn->prepare($cmd);
     	$result->execute;&dBaseError($dbconn, $cmd) if (!defined($result));

} elsif($mode eq "system_panel")  {

	if ($softpac ne '3') {
		&print_system_panel if ($develop == 12);
		&print_conferences if ($develop == 15);
		&print_system_panel if ($develop == 16 && $is_admin);
		#&print_users_panel if ($develop == 16 && $multicabo);
		&print_users_panel if ($develop == 16 && !$is_admin);
		
	} else {
		&print_system_panel_miner;
	}

} elsif($mode eq "stockboard_panel")  {

	&print_stockboard_panel(0);
	
} elsif($mode eq "stockusers_panel")  {

	&print_stockboard_panel(1);

} elsif($mode eq "stockpartners_panel")  {

	&print_stockboard_panel(2);

} elsif($mode eq "stocksells_panel")  {

	&print_stockboard_panel(3);

} elsif($mode eq "stockhelp_panel")  {

	&print_stockboard_panel(4);

} elsif($mode eq "stockmybuys_panel")  {

	&print_stockboard_panel(5);

} elsif($mode eq "stockmyprofile_panel")  {

	&print_stockboard_panel(6);

} elsif($mode eq "list_challenges")  {

my $cat = defined($query->param('cat')) && $is_admin ? $query->param('cat') : 0;
my $type = defined($query->param('type')) ? $query->param('type') : 0;

	&list_challenges($cat,$ncha_limit,$type,1,$tag,$tagtable);

} elsif($mode eq "list_controls")  {

my $cat = defined($query->param('cat')) && $is_admin ? $query->param('cat') : 0;
my $type = defined($query->param('type')) ? $query->param('type') : 0;

	&list_controls($cat,$type,1,$tag,$tagtable);

} elsif ($mode eq "list_tags" ) {

	
	my $o = defined($query->param('mesoid')) ? $query->param('mesoid') : 0;
	my $c = defined($query->param('categ')) ? $query->param('categ') : 0;
	my $newtag = defined($query->param('newtag')) ? $query->param('newtag') : '';
	my $remove = defined($query->param('rm')) ? $query->param('rm') : 0;
	my $type = defined($query->param('type')) ? $query->param('type') : 5;

#print STDERR "Here tag is $newtag, rm is $remove!\n";
 	
	if (length($newtag)) {
		
	   unless($remove) {
		$newtag =~ s/\s//g;$newtag =~ s/\'//g;$newtag =~ s/\"//g;$newtag =~ s/\;//g;
		
		$comm = "select partner from challenges where ID = $o";
		&getTable;
		if ($r_user eq ${${$listresult}[0]}[0]) {
			
			my $cmd = "insert into tags (tag,match_oid, category) values ('$newtag',$o, $c)";
			my $result=$dbconn->prepare($cmd);$result->execute;
        		&dBaseError($dbconn, $cmd) if (!defined($result));
		}
	   } else {
	   	$comm = "select partner from challenges where ID = $o";
		&getTable;
		if ($r_user eq ${${$listresult}[0]}[0]) {
			
			my $cmd = "delete from tags where match_oid=$o and tag='$newtag'";
			my $result=$dbconn->prepare($cmd);$result->execute;
        		&dBaseError($dbconn, $cmd) if (!defined($result));
		}
	   }	
	}
	&print_tags($o, $type, $c);

} elsif($mode eq "color_chal" ) {

     my $oid = $coid; 
     my $cmd;
     if ($is_admin) {
     	$cmd = "update challenges set place=concat('<div class=colored>',place,'</div>') where ID = $oid";

	my $result=$dbconn->prepare($cmd);
     	$result->execute;
        &dBaseError($dbconn, $cmd) if (!defined($result));	
     }


} elsif($mode eq "hide_record" ) {


     my $oid = $coid;

    
     if ($is_admin) {
     	my $cmd = "update challenges set date_and_time=current_date where ID = $oid";
	my $result=$dbconn->prepare($cmd);
     	$result->execute;
        &dBaseError($dbconn, $cmd) if (!defined($result));
	&write_event('challenges','d');
	print "Hidden..";

     }  
} elsif( $mode eq "remove_yourself") {


	my $mmbr = &nkname_lookup(oid_lookup($member));

	my $c = $coid."_".$member;
	
	
	print qq{
	  <form id="myForm_do_remove_$c" action="$scriptname?mode=do_remove_yourself&coid=$coid" method="get">
	  </form>
	};

	my $umrgn = ($touch_specific_bro) ? "48px" : "48px";
	my $warn7 = koitoutf8("�� ���������� ����������� � ���� ����� ����?");
	my $warn8 = koitoutf8("�������� ��� ���� ��� ����������:");
	
	print qq{<div id=main_container style="margin:$umrgn 12px; border:solid 0px #963;width:420px;text-align:center;font-size:16px;">
		<div style="width:400px;text-align:center;">$warn7<br>$warn8</div>
	};
	
	$lh = "var counterRect = \$('ncha_div').getBoundingClientRect();var a = counterRect.left-71;var b = counterRect.top-15;";	
		
	print qq{
		<div class="twobuttonwrap" style="margin:36px auto;">
		<div class="button" onclick="\$('myForm_do_remove_$c').set('send', {onComplete: function(response) { 
		\$('ajax_0').fade(0);
		$lh;
		var this_cell_location = \$('ask_$c').getBoundingClientRect();
		var this_row_y_coor = this_cell_location.top;
		var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		selrow=$coid;from_interact=1;r(current_sport,num_open_cha,num_order,type,tag,tagtable);\$('myForm_list_challenges').send();
		}});
		\$('myForm_do_remove_$c').send();return false;\"><a href="#" style="font-size:16px;">$buttons{'remove_candidate'}</a></div>
		<div class="button" onClick="document.getElementById('ajax_0').fade(0)"><a href="#" style="font-size:16px;">$__3ad</a></div>
		</div> 
	} ;
		
	print "</div>"; #main_container remove_yr


} elsif( $mode eq "do_remove_yourself") {

     $table = "challenges"; my $cmd;

     $comm = "select partner, status, owner, date_and_time, place, condition from $table where ID = '$coid'";
     &getTable;
     my $p_string = ${${$listresult}[0]}[0];
     my $cur_status = ${${$listresult}[0]}[1];
     my $owner = ${${$listresult}[0]}[2];
     my $time_of_match = ${${$listresult}[0]}[3];
     my $place_of_match = ${${$listresult}[0]}[4];
     my $condition_of_match = ${${$listresult}[0]}[5];
          
     my @p_array = split(',',$p_string);
     @p_array = &xDel($r_user,@p_array);
     $p_string  = '';
     foreach my $pline (@p_array) {
     	
	$p_string = $p_string.$pline.",";

     }

     
     if (length($p_string)) {
     $cmd = "update $table set partner='$p_string', status='t' where ID='$coid'";
     } else {
     $cmd = "update $table set partner='', status=null where ID='$coid'";
     }
     
     if ($cur_status  != 0 ) {
     	my $result=$dbconn->prepare($cmd);
     	$result->execute;
        &dBaseError($dbconn, $cmd) if (!defined($result));
	
		my $cmd = "delete from comments where author= '$r_user' and match_oid = '$coid'";
		my $result=$dbconn->prepare($cmd);
		$result->execute;
		&dBaseError($dbconn, $cmd) if (!defined($result));	

     }
	
	exit;

} elsif( $mode eq "select_candidate") {

my $touch_specific_bro = 0; #hack ash

   $table = "challenges";
   $oid = $coid;

   $comm = "select condition, place, date_and_time, owner, partner from challenges where ID = $coid";
   &getTable;
   my $cond = ${${$listresult}[0]}[0];
   my $place = ${${$listresult}[0]}[1];
   my $dtm = ${${$listresult}[0]}[2];
   my $who = ${${$listresult}[0]}[3];
   my $partn = ${${$listresult}[0]}[4];

	
   if ($who eq $r_user) { #owner

	if ($touch_specific_bro) {	
		print qq{<html><head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		};

		&begin_decor(1);
	}

	my $wdth = ($touch_specific_bro) ? "100%" : "420px"; 
	my $umrgn = "0px"; $umrgn = "33%" if ($touch_specific_bro);
	my $lmrg = "12px"; $lmrg = "0" if ($touch_specific_bro);

	my $mb = "5px"; $mb = "25px" if ($touch_specific_bro);

	my $vybor = koitoutf8("����� ���������� ��� ���������:");

	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">
	<div style="width:240px;margin: 5px auto $mb auto;">$vybor</div>};

	print qq{<FORM METHOD=POST ACTION=$scriptURL ENCTYPE='application/x-www-form-urlencoded'>}  if ($touch_specific_bro);

	my $place_d = $place;
	my $cond_d = $cond;

	print qq{<div id=tarea2 style="width:240px;height:45px;position:relative;margin:5px auto;background:#fafac0;">
	<TEXTAREA id=cond_id NAME="condition" 
	style="position:absolute;top:0px;left:0px;width:230px;height:35px;padding:5px;background:#f0f0f0;color:#222;">$cond_d</TEXTAREA></div>
	};

	my $mb = "5px"; $mb = "15px" if ($touch_specific_bro);

	print qq{<div id=sel_div style="padding:5px;width:300px;color:#222;margin:5px auto $mb auto;">};

				@clook = sort split(',',$partn);
				@clook = (@clook,'' ); #no need any more

				print "<SELECT id=partner NAME=partner SIZE=1>";
				
				foreach my $cline (@clook) {
					
					my $pseudo = &nkname_lookup($cline);

					$pseudo = '-' if ($cline eq '');
					print "<OPTION VALUE=\"$cline\">$pseudo\n";
				}
				print "</SELECT>";

	print "</div>"; #sel_div

	unless ($touch_specific_bro) {
	print qq{
	  <form id="myForm_select_candidate_$coid" action="$scriptname?mode=update_challenge&oid=$coid&owner=$r_user&status=f&time_of_selection=current_timestamp" method="get">
	  </form>
	};

	$lh = "var counterRect = \$('ncha_div').getBoundingClientRect();var a = counterRect.left-71;var b = counterRect.top-15;";
	
	print qq{	
	<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  
		onclick="var c = \$('cond_id').value;\$('myForm_select_candidate_$coid').action=\$('myForm_select_candidate_$coid').action +'&partner='+\$('partner').value+'&condition='+c;
		\$('myForm_select_candidate_$coid').set('send', {onComplete: function(response) {
		\$('ajax_0').fade(0);
		$lh;var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		selrow=$coid;from_interact=1;r(current_sport,num_open_cha,num_order,type,tag,tagtable);\$('myForm_list_challenges').send();
		}});
		\$('myForm_select_candidate_$coid').send();return false;\"><a href="#">$t_s</a></div>		
		<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">$__3a</a></div>
	</div>	
	};


	} else { # touch
		print qq{<div style="width:360px;height:30px;margin:35px auto;background:#eee;padding-top:3px;text-align:center;">};
		print  "<INPUT id=mode type=submit name=mode value=update_challenge style=\"width:240px;height:40px;margin:10px auto;\" onclick=\"this.style.visibility='hidden';\"><br><br>" if ($is_admin);

		print qq{
		<input type=hidden name=oid value=$coid>
		<input type=hidden name=status value='f'>
		<input type=hidden name=owner value=$r_user>
		<input type=hidden name=time_of_selection value='current_timestamp'>
		};
	
		print "</div>";
		print  "<INPUT style=\"width:240px;margin:10px auto;\" TYPE=button onClick=history.go(-1) VALUE=$__3h>";

		print "</form>";
	}

	print "</div>"; #main_container select_candidate

	&end_decor if ($touch_specific_bro);
	print "</body></html>" if ($touch_specific_bro);

   } #if owner

   exit;
     
} elsif( $mode eq "do_confirm_yourself") {

     $table = "challenges";
     my $counterattack = $query->param('cntr');
     $counterattack =~ s/\'//g;$counterattack =~ s/&apos;//g;

     $comm = "select partner, status, owner, date_and_time, place, condition, price from $table where ID = '$coid'";
     &getTable;
     my $p_string = ${${$listresult}[0]}[0];
     my $p_stat = ${${$listresult}[0]}[1];
     my $owner = ${${$listresult}[0]}[2];
     my $time_of_match = ${${$listresult}[0]}[3];
     my $place_of_match = ${${$listresult}[0]}[4];
     my $condition_of_match = ${${$listresult}[0]}[5];
     my $price = ${${$listresult}[0]}[6];
     
     my $found = index($p_string,',');
     
    	my $ow = 0;
     	$owner = $ow eq '0' ? $owner : $ow;


if ( ($found ne '-1' || ($p_string eq '' && $p_stat ne 'f') ) && $price  > 1) {
     my @p_array = split(',',$p_string);
     my $sig = 0;
     
     foreach my $pline (@p_array) {
     	$sig = 1 if ($pline eq $r_user);
     }
     
     if (!$sig) {
	$p_string = $p_string.$r_user.",";
     
	my $cmd = "update $table set partner='$p_string', status='t' where ID='$coid'";
     
	my $result=$dbconn->prepare($cmd);
	$result->execute;
        &dBaseError($dbconn, $cmd) if (!defined($result));
	

	if ( length($counterattack) ) {

		my $cmd = "insert into comments (author, p_vremya_z, match_oid, comment, who_read) values (?,current_timestamp,?,?,?)";
			
		my $result=$dbconn->prepare($cmd);
		$result->execute($r_user,$coid,$counterattack,$r_user);
		&dBaseError($dbconn, $cmd) if (!defined($result));	
	}
	
	
     }

} elsif ($price == 1 && $p_string eq '' && $p_stat ne 'f' && $curr_balance >= $price) { #then buying straight ahead
     
     
	my $cmd = "update $table set partner='$r_user', status='f', time_of_selection=current_timestamp where ID='$coid'";
     
	my $result=$dbconn->prepare($cmd);
	$result->execute;
     
	$cmd = "update members set k_kredit=k_kredit-$price where proj_code='$r_user'";
     
	$result=$dbconn->prepare($cmd);
	$result->execute;
       
	$cmd = "insert into tags (tag,match_oid,category) values (current_date::text,$coid,1)";
	$result=$dbconn->prepare($cmd);$result->execute;
	&dBaseError($dbconn, $cmd) if (!defined($result));
}

} elsif( $mode eq "do_confirm_yourself_juma") {

     $table = "challenges";
     my $counterattack = $query->param('cntr');$counterattack =~ s/\'//g;$counterattack =~ s/&apos;//g;
     my $comp = $counterattack;$comp =~ s/\s//g;$comp =~ s/(-|\.|,)//g;

     $comm = "select partner, status, price, answer from $table where ID = '$coid'";
     &getTable;
     
     my $p_string = ${${$listresult}[0]}[0];
     my $p_stat = ${${$listresult}[0]}[1];
     my $price = ${${$listresult}[0]}[2];
     my $ans = ${${$listresult}[0]}[3]; $ans =~ s/\s//g;$ans =~ s/(-|\.|,)//g;

#print STDERR "Here ans is $ans, comp is $comp!\n";

if ( $ans ne $comp && $curr_balance >= $price) { # taking price from unsuccessful buyer into bank

	my @p_array = split(',',$p_string);
	my $sig = 0;
     
	foreach my $pline (@p_array) {
		$sig = 1 if ($pline eq $r_user);
	}
     	
	my $cmd = "update $table set price=price+$price where ID='$coid'";
	
	if (!$sig) {
		
		$p_string = $p_string.$r_user.",";
     
		$cmd = "update $table set partner='$p_string', status='t', price=price+$price where ID='$coid'";
     
	} 

	my $result=$dbconn->prepare($cmd);
	$result->execute;
 	&dBaseError($dbconn, $cmd) if (!defined($result));	
     
     	$cmd = "update members set k_kredit=k_kredit-$price where proj_code='$r_user'";
     
	$result=$dbconn->prepare($cmd);
	$result->execute;
	
	if ( length($comp) ) {

		my $cmd = "insert into comments (author, p_vremya_z, match_oid, comment, who_read) values (?,current_timestamp,?,?,?)";
			
		my $result=$dbconn->prepare($cmd);
		$result->execute($r_user,$coid,$counterattack,$r_user);
		&dBaseError($dbconn, $cmd) if (!defined($result));	
	}

} elsif ($ans eq $comp && $curr_balance >= $price) { # success buyer takes the bank
     
     
	my $cmd = "update $table set partner='$r_user', status='f', time_of_selection=current_timestamp where ID='$coid'";
     
	my $result=$dbconn->prepare($cmd);
	$result->execute;
     
	$cmd = "update members set k_kredit=k_kredit+$price where proj_code='$r_user'";
     
	$result=$dbconn->prepare($cmd);
	$result->execute;
       
	$cmd = "insert into tags (tag,match_oid,category) values (current_date::text,$coid,1)";
	$result=$dbconn->prepare($cmd);$result->execute;
	&dBaseError($dbconn, $cmd) if (!defined($result));

} #endif

} elsif($mode eq "confirm_yourself" ) {

	my $mmbr = &nkname_lookup(oid_lookup($member));
	
	my $c = $coid."_".$member;
	
	my $umrgn = ($touch_specific_bro) ? "24px" : "20px";
	
	$comm = "select price from challenges where ID = $coid";

	&getTable;
	my $curr_price = ${${$listresult}[0]}[0];
	
	my $warn4 = koitoutf8("�� �������� ������ ���� ��� �� <span style=\"font-weight:bold;color:#369;\">RUR&nbsp;$curr_price</span>?");
	my $warn5 = koitoutf8("����������� ��� ����������:");
		
	print qq{<div id=main_container style="margin:$umrgn 12px; width:420px;text-align:center;">
		<div style="width:400px;margin:5px auto;font-size:16px;">$warn4  $warn5</div>
	};
		
	my $t =  "text";
	my $counter_cond = koitoutf8(" ��� ����� ����");
	$counter_cond = $curr_price;
	
	my $d = $curr_price == 1 ? "visibility:hidden" : '';
		
	print qq{
		<input type=$t style="text-align:right;margin:10px auto;width:90px;padding-left:5px;height:24px;background:#f0f0f0;color:#000;font-size:16px;$d" id="cntr_$c" name="cntr_$c" value="$counter_cond" onclick="this.value='';" />
	};

	
	print qq{
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button" onclick="var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_do_confirm_$c');
		document.body.appendChild(form); var v = (\$('cntr_$c').value == '$counter_cond') ? '' : \$('cntr_$c').value;
		var rowTest = new RegExp(';','g');v = v.replace(rowTest,',');	
		\$('myForm_do_confirm_$c').action = '$scriptname?mode=do_confirm_yourself&coid=$coid' + '&cntr=' + v;		
		\$('myForm_do_confirm_$c').set('send', {onComplete: function(response) { 
		\$('ajax_0').fade(0);
		var this_cell_location = \$('ask_$c').getBoundingClientRect();
		var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		\$('log_spinning').setStyles({'position': pos });
		\$('log_spinning').setStyles({'left': this_cell_location.left });
		\$('log_spinning').setStyles({'top': this_cell_location.top });
		//\$('log_spinning').setStyles({'display': 'block' });
		\$('log_spinning').fade(1);	
		selrow=$coid;from_interact=1;r(current_sport,num_open_cha,num_order,type,tag,tagtable);\$('myForm_list_challenges').send();
		}});
		\$('myForm_do_confirm_$c').send();\$('myForm_do_confirm_$c').dispose();return false;">
		<a href="#" style="font-size:16px;">$__3ac</a></div>
		<div class="button" onClick="document.getElementById('ajax_0').fade(0);return false;"><a href="javascript:void(0);" style="font-size:16px;">$__3ab</a></div>
		</div>
	};
	print "</div>"; #main_container confirm_yr
  
} elsif($mode eq "confirm_yourself_juma" ) {

	my $mmbr = &nkname_lookup(oid_lookup($member));
	
	my $c = $coid."_".$member;
	
	my $umrgn = ($touch_specific_bro) ? "24px" : "20px";
	
	$comm = "select price from challenges where ID = $coid";

	&getTable;
	my $curr_price = ${${$listresult}[0]}[0];
	
	my $warn4 = koitoutf8("�� �������� ����������� �� <span style=\"font-weight:bold;color:#369;\">RUR&nbsp;$curr_price</span>?");
	my $warn5 = koitoutf8("����������� ��� ����������:");
		
	print qq{<div id=main_container style="margin:$umrgn 12px; width:420px;text-align:center;">
		<div style="width:400px;margin:5px auto;font-size:16px;">$warn4<br>$warn5</div>
	};
		
	my $counter_cond = koitoutf8("�����");
		
	print qq{
		<input type=text style="text-align:right;margin:10px auto;width:90px;padding-left:5px;height:24px;background:#f0f0f0;color:#000;font-size:16px;" id="cntr_$c" name="cntr_$c" value="$counter_cond" onclick="this.value='';" />
	};

	
	print qq{
		<div class="twobuttonwrap" style="margin:36px auto 15px auto;">
		<div class="button" onclick="var str=\$('cntr_$c').value;str=str.toLowerCase();\$('cntr_$c').value=str;
		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_do_confirm_$c');
		document.body.appendChild(form); var v = (\$('cntr_$c').value == '$counter_cond') ? '' : \$('cntr_$c').value;
		var rowTest = new RegExp(';','g');v = v.replace(rowTest,',');	
		\$('myForm_do_confirm_$c').action = '$scriptname?mode=do_confirm_yourself_juma&coid=$coid' + '&cntr=' + v;		
		\$('myForm_do_confirm_$c').set('send', {onComplete: function(response) { 
		\$('ajax_0').fade(0);
		var this_cell_location = \$('ask_$c').getBoundingClientRect();
		var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		\$('log_spinning').setStyles({'position': pos });
		\$('log_spinning').setStyles({'left': this_cell_location.left });
		\$('log_spinning').setStyles({'top': this_cell_location.top });
		//\$('log_spinning').setStyles({'display': 'block' });
		\$('log_spinning').fade(1);	
		selrow=$coid;from_interact=1;r(current_sport,num_open_cha,num_order,type,tag,tagtable);\$('myForm_list_challenges').send();
		}});
		\$('myForm_do_confirm_$c').send();\$('myForm_do_confirm_$c').dispose();return false;">
		<a href="#" style="font-size:16px;">$__3ac</a></div>
		<div class="button" onClick="document.getElementById('ajax_0').fade(0);return false;"><a href="javascript:void(0);" style="font-size:16px;">$__3ab</a></div>
		</div>
	};
	print "</div>"; #main_container confirm_yr

} elsif($mode eq "add_challenge")  {


     exit unless ($is_admin);

     $table = "challenges";

     my $chal_id = $query->param('challenge_id');
	
     $comm = "select count(challenge_id) from challenges where challenge_id = '$chal_id'";

     &getTable;
     exit if (${${$listresult}[0]}[0]);

     my $r  = &tclub_doAddRecord ($query, $output); 

     $r =~ /^(\d+)$/;my $cntr = ($1>0) ? $1 : 0;
     
     print $cntr unless ($touch_specific_bro); #sending to mBox.Notice
     
     $query->delete_all;
    
     &_and_reload; #needed for touch  

} elsif($mode eq "add_member") {
my $touch_specific_bro = 0; #hack ash
	$table = "members";

   if ($is_admin) { #ok new chal

		my $who = &nkname_lookup($r_user);

	if ($touch_specific_bro) {

			print qq{<html><head>
			<meta charset="UTF-8" />
			<meta name="viewport" content="width=device-width, initial-scale=1.0" />
			<meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
			<meta http-equiv="Pragma" content="no-cache">
			<meta http-equiv="Expires" content="0">
			<meta http-equiv="Vary" content="*">    
			<meta http-equiv="X-UA-Compatible" content="ie=edge" />
			<title>Add</title>
		};	

	print qq{<script language="JavaScript" type="text/javascript" src="/js_cp/$genericjs"></script>};
	unless ($chrome) {
		print q{<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-1.2.4-core.js"></script>
	        <script language="JavaScript" type="text/javascript" src="/js_cp/mootools-1.2.4.2_a-more.js"></script>        
	};
	} else {
		&print_current_moo;
	}

	&begin_decor(1) ;
	}

	my $wdth = ($touch_specific_bro) ? "100%" : "420px"; 
	my $umrgn = "0px";$umrgn = "25%" if ($touch_specific_bro);
	my $lmrg = "12px"; $lmrg = "0" if ($touch_specific_bro);

	my $dm = "10px";

	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">
	};



	if ($touch_specific_bro) {
		print qq{
		<FORM METHOD=POST ACTION=$scriptURL ENCTYPE='application/x-www-form-urlencoded'>
		};
	}
	
	my $w0 = koitoutf8("�����");
	my $w1 = koitoutf8("������");
	my $w2 = koitoutf8("�����������");
	my $pri = koitoutf8("������");

	print qq{
	<div id=tinput0 style="width:220px;height:20px;position:relative;margin:10px auto;background:#fafac0;">
	<INPUT id=kredit_id NAME="k_kredit" value="$pri:" type=text style="position:absolute;top:0px;left:0px;width:210px;height:20px;padding:5px;background:#f0f0f0;color:#222;" onmousedown="this.value='0';">
	</div>
	};
	print qq{
	<div id=tinput1 style="width:220px;height:20px;position:relative;margin:10px auto;background:#fafac0;">
	<INPUT id=login_id NAME="proj_code" value="$w0:" type=text style="position:absolute;top:0px;left:0px;width:210px;height:20px;padding:5px;background:#f0f0f0;color:#222;" 
	onkeypress="function isOk(e) {var allowedCode = [8, 13, 44, 45, 46, 95]; var charCode = (e.charCode) ? e.charCode : ((e.keyCode) ? e.keyCode : ((e.which) ? e.which : 0)); 
if (charCode > 31 && (charCode < 64 || charCode > 90) && (charCode < 97 || charCode > 122) && (charCode < 48 || charCode > 57) && (allowedCode.indexOf(charCode) == -1)) return false;
return true;} return isOk(event);" onmousedown="this.value='';">
	</div>
	};
	
	print qq{
	<div id=tinput2 style="width:220px;height:20px;position:relative;margin:10px auto;background:#fafac0;">
	<INPUT id=passw_id NAME="pass" value="$w1:" type=text style="position:absolute;top:0px;left:0px;width:210px;height:20px;padding:5px;background:#f0f0f0;color:#222;" 
	onkeypress="function isOk(e) {var allowedCode = [8, 13, 44, 45, 46, 95]; var charCode = (e.charCode) ? e.charCode : ((e.keyCode) ? e.keyCode : ((e.which) ? e.which : 0)); 
if (charCode > 31 && (charCode < 64 || charCode > 90) && (charCode < 97 || charCode > 122) && (charCode < 48 || charCode > 57) && (allowedCode.indexOf(charCode) == -1)) return false;
return true;} return isOk(event);" onmousedown="this.value='';">
	</div>
	};

	print qq{<div id=tarea1 style="width:220px;height:30px;position:relative;margin:5px auto;background:#fafac0;">};

	print "<SELECT id=city_id NAME=city style=\"width:210px;\">";
	
	my @skeys = sort { $sport_labels{$a} cmp $sport_labels{$b} } keys(%sport_labels);
			
	foreach my $index (@skeys) {
		print "<OPTION VALUE=\"$index\">$sport_labels{$index}\n" if ($index =~ m/[0-9]/) ;
	}
	print "</SELECT>";
	print qq{</div>};

	print qq{
	<div id=tarea2 style="width:220px;height:45px;position:relative;margin:5px auto 20px auto;background:#fafac0;">
	<TEXTAREA id=d_spec_id NAME="d_spec" rows="7" cols="35" style="position:absolute;top:0px;left:0px;width:210px;height:35px;padding:5px;background:#f0f0f0;color:#222;" onmousedown="this.innerHTML='';">$w2:</TEXTAREA>
	</div>
	};


	my $but = "do_add_member";

	unless ($touch_specific_bro) { 

		my $lh = "var counterRect = \$('ncha_div').getBoundingClientRect();var a = counterRect.left-71;var b = counterRect.top-15;";

		print qq{	
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  onclick="\$('ajax_0').fade(0);
			var form = document.createElement('form');
			form.setAttribute('method', 'get');
			form.setAttribute('id', 'myForm_add_member');
			document.body.appendChild(form);
			\$('myForm_add_member').action = '$scriptname?mode=$but&proj_code='+\$('login_id').value+'&city='+\$('city_id').value+'&a_nkname='+\$('login_id').value+'&pass='+\$('passw_id').value+'&k_kredit='+\$('kredit_id').value+'&d_spec='+ \$('d_spec_id').value ;
		\$('myForm_add_member').set('send', {onComplete: function(response) {		
		$lh;
		var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		\$('log_spinning').setStyles({'position': pos });
		\$('log_spinning').setStyles({'left': a });	
		\$('log_spinning').setStyles({'top': b });
		\$('log_spinning').setStyles({'display': 'block' });
		\$('log_spinning').fade(1);
		\$('myForm_list_challenges').send();	
		}});\$('myForm_add_member').send();\$('myForm_add_member').dispose();return false;"><a href="#">$buttons{'new'}</a></div>		
		<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">$__3a</a></div>
		</div>	
		};

	} else { #touch
		my $random_value = substr(TClubMD5::md5_hex(gettimeofday()),16,4);	
		print "<input type=hidden name=a_nkname value=$random_value>";
		print  "<INPUT id=$but type=submit name=mode value=$but style=\"width:240px;height:40px;margin:10px auto;\" onclick=\"this.style.visibility='hidden';\"><br><br>";
		print  "<INPUT TYPE=button onClick=history.go(-1) VALUE=$__3h>";
		print "</form>";

	} #touch
 
	print "</div>";	#main_container add_ad

	&end_decor if ($touch_specific_bro);

	if ($touch_specific_bro) {
		print qq{</body></html>};
	}
	
   } #admin   

} elsif($mode eq "post_forum" || $mode eq "repl_forum") {

  $table = "forum";
     
  my $top = $query->param('a_topic');
  my $parent = $query->param('who_author');

#checking for dups

  my $d = $query->param('url_picture');
  my $rndtm = defined($query->param('randomtime')) ? $query->param('randomtime') : 0;
  $d = $rndtm if ($d eq "url_picture" || $d eq '');
  
  $comm = "select count(*) from forum where url_picture='$d'";
  &getTable;
  my $count = ${${$listresult}[0]}[0]; 
  if ($count > 0 ) {
  	&print_stockboard_panel(4);
  	exit;
  }
  
# end check
	
  if ($mode eq "repl_forum") { #empty repl

	my $r = $query->param('contents');
	my $aa = $query->param('a_topic');
		
	&print_stockboard_panel(4) if ($aa =~ "^Re:" && length($r) == 0);		
  }
     
  if ( $query->param('contents') eq '' && $query->param('a_topic') eq $query->param('re_topic')  && $query->param('url_picture') eq '' ) {

	#do nothing on empty input

  } else {
    	
   if ($mode eq "repl_forum") {

    my $o = $query->param('reply_to_num'); $o =~ /^(\d+)$/; my $o = $1;
 
    $comm = "select forum.author, forum.vrem_txt, forum.a_topic, forum.contents, forum.who_read, forum.url_picture, forum.z_destination,
    forum.parent, members.blacklist from forum, members where forum.ID=$o and members.proj_code=forum.author";

    &getTable;
    
    my $auth_string = ${${$listresult}[0]}[0];
    my $read_string = ${${$listresult}[0]}[4];
    my $url_picture_string = ${${$listresult}[0]}[5] eq 'url_picture' ? '' : ${${$listresult}[0]}[5];

    my @privat = split(",",${${$listresult}[0]}[6]);
    my $old_zdest = ${${$listresult}[0]}[6];
    my $parent_oid = ${${$listresult}[0]}[7]; $parent_oid = $o if ($parent_oid eq 'parent');
    
   if ($r_user ne ${${$listresult}[0]}[0] && !in_array($r_user,@privat) && ${${$listresult}[0]}[6] ne '' && ${${$listresult}[0]}[6] ne 'z_destination') { 
    	print "Your hostile activity has been logged! -- You Lose!<br>";
    	return;
   }
    
    unless ($read_string =~ /^$r_user,/ || $read_string =~ /,$r_user,/ || $r_user eq 'visitatore') {
    	$read_string .= $r_user.",";
    	my $cmd = "update forum set who_read='$read_string' where ID=$o";
    	my $result=$dbconn->prepare($cmd);
	$result->execute;
    }
   }

   &tclub_doAddRecord ($query, $output);


   $query->delete_all;

   &print_stockboard_panel(4);

  } #do something

} elsif($mode eq "do_add_member") {


    exit if (!$is_admin && (!$mycabo_master || ($mycabo_master && defined($query->param('mycabo')) && $mycabo != $query->param('mycabo'))));

     $table = "members";

     my $r  = &tclub_doAddRecord ($query, $output); 

     $query->delete_all;
    
     &_and_reload; #needed for touch  

} elsif($mode eq "do_del_member") {

    exit if (!$is_admin && (!$mycabo_master || ($mycabo_master && defined($query->param('mycabo')) && $mycabo != $query->param('mycabo'))));
    
	my $moid = defined($query->param('moid')) ? $query->param('moid') : -1;
     	my $cmd = "delete from members where proj_code = '$moid'";
#print STDERR "Here cmd is $cmd!\n";

	my $result=$dbconn->prepare($cmd);
     	$result->execute;
        &dBaseError($dbconn, $cmd) if (!defined($result));
	
	my $sys_cmd = `sudo /var/www/html/cp/controls/removeUser.pl $moid$uma24`;
    
     &_and_reload; #needed for touch  

} elsif($mode eq "do_add_room") {


    exit if (!$is_admin || !$vg_owner);

     $table = "rooms";

     my $r  = &tclub_doAddRecord ($query, $output); 

     $query->delete_all;
    
     &_and_reload; #needed for touch  

} elsif($mode eq "do_ch_pass") {

	my $n_pass = defined($query->param('n_pass')) ? local2SQLformat(&checkFieldContent($query->param('n_pass'), 'n_pass'), 'n_pass') : '';
	$n_pass =~ s/\'//g;
	
	exit unless (length($n_pass));
	
	my $cmd = "update members set pass = ? where proj_code = ?";
	my $result=$dbconn->prepare($cmd);
     	$result->execute($n_pass, $r_user);
        &dBaseError($dbconn, $cmd) if (!defined($result));
		
	my $sys_cmd = `sudo /var/www/html/cp/controls/removeUser.pl $r_user$uma24`; #or may get creation error in the next; make sure
	my $ret = `sudo /var/www/html/cp/controls/addUser.pl $r_user $n_pass a\@b.com$uma24`;

	$query->delete_all;
    
	&_and_reload; #needed for touch  

} elsif($mode eq "do_sel_room") {

    exit if (!$is_admin);
    
	my $moid = defined($query->param('moid')) ? $query->param('moid') : -1;
	my $u = defined($query->param('u')) ? $query->param('u') : -1;
	
	exit unless ($moid =~ /^\d+$/ && $u =~ /^\d+$/);
 	
	#can't assign if there's a master already
	$comm = "select members.id, rooms.name from members, rooms where members.room = rooms.name and members.room_master = 't' and rooms.id = '$moid'";
	&getTable;
	my $cnt = $ntuples;
	unless ($ntuples) {
		$comm = "select name from rooms where id = $moid";
		&getTable;
		my $r = ${${$listresult}[0]}[0];
#print STDERR "Here u is $u, r is $r!\n";   		
		my $cmd = "update members set room_master='t', room = ? where id = ?";
		my $result=$dbconn->prepare($cmd);
     		$result->execute($r,$u);
        	&dBaseError($dbconn, $cmd) if (!defined($result));
	}
   
     &_and_reload; #needed for touch  

} elsif($mode eq "do_del_room") {

    exit if (!$is_admin);
    
	my $moid = defined($query->param('moid')) ? $query->param('moid') : -1;
     	
	#can't delete if there're users
	$comm = "select members.id from members, rooms where members.room = rooms.name and rooms.id = '$moid'";
	&getTable;
	my $cnt = $ntuples;
	unless ($ntuples) {
		my $cmd = "delete from rooms where id = ?";
		my $result=$dbconn->prepare($cmd);
     		$result->execute($moid);
        	&dBaseError($dbconn, $cmd) if (!defined($result));
	}
   
     &_and_reload; #needed for touch  

} elsif($mode eq "do_toggle_rm") {

	exit if (!$is_admin);
	my $val = defined($query->param('val')) ? $query->param('val') : "undef"; exit if ($val eq "undef");
	my $moid = defined($query->param('moid')) ? $query->param('moid') : -1;
	my $rm = $val eq 'false' ? 'f' : 't';

     	my $cmd = "update members set room_master = '$rm' where proj_code = '$moid'";
#print STDERR "Here cmd is $cmd!\n";

	my $result=$dbconn->prepare($cmd);
     	$result->execute;
        &dBaseError($dbconn, $cmd) if (!defined($result));
    
     &_and_reload; #needed for touch  

} elsif($mode eq "rm_record" ) {

     my $ctable = $query->param('ctable');
     my $oid = $coid;
     if ($is_admin) {
     	my $cmd = "delete from $ctable where ID = $oid";
	my $result=$dbconn->prepare($cmd);
     	$result->execute;
        &dBaseError($dbconn, $cmd) if (!defined($result));

	print "Deleted.."
     }
} elsif($mode eq "upload_jpg") {

my %hash = ('result' => "Wrong file type");
my $j = encode_json(\%hash);

my $maxsize = 10;
my $upload_folder = "/opt/nvme/ssd/upload";
my $counter = 0;

foreach my $l ('jpgfile1','jpgfile2','jpgfile3','jpgfile4','jpgfile5','jpgfile6') {
my @files = $query->param($l);
my @io_handles=$query->upload($l);

my %file_hash;

foreach my $item(@files){

next unless $item =~ /(.*\.jpg)/;
    foreach my $sub_item(@io_handles){
        if($item eq $sub_item){
            $file_hash{$item} = $sub_item;
        }
    }
}

chdir $upload_folder or die "Cannot chdir to upload destination directory: $!\n";

foreach my $key(keys %file_hash){
    my $base = basename($file_hash{$key});#    
    my $tmpfilename = $query->tmpFileName($file_hash{$key});
    if($maxsize > 0) {
	
	if( (-s "$tmpfilename") > ($maxsize * 1024 * 1024)) {
		unlink("$tmpfilename");
print STDERR "The uploaded file $tmpfilename was too big and has been removed.\n";
		next;
	}
    }

    my $f = $l eq "jpgfile1" ? "jpg1.jpg" : $l eq "jpgfile2" ? "jpg2.jpg" : $l eq "jpgfile3" ? "jpg3.jpg" : $l eq "jpgfile4" ? "jpg4.jpg" : $l eq "jpgfile5" ? "jpg5.jpg" : $l eq "jpgfile6" ? "jpg6.jpg" : $base;

    
    my $destFile = File::Spec->catfile($upload_folder, $f);
  
    copy( $tmpfilename, $destFile ) or die "Copy to ($destFile) failed: $!\n";
#print STDERR "Sucessfully uploaded ".CGI->escapeHTML(basename($key));
    $counter++;
}

if ($counter) {

	my $ret = `sudo /usr/local/bin/new_jpg_texture.sh $mycabo`;
	%hash = ('result' => $ret);
	$j = encode_json(\%hash);
}
} #foreach

print $j; #returning to fetch

} elsif($mode eq "upload_png") {

my %hash = ('result' => "Wrong file type");
my $j = encode_json(\%hash);

my $maxsize = 10;
my $upload_folder = "/opt/nvme/ssd/upload";
my $counter = 0;

foreach my $l ('pngfile1','pngfile2') {
my @files = $query->param($l);
my @io_handles=$query->upload($l);

my %file_hash;

foreach my $item(@files){
next unless $item =~ /(.*\.png)/;
    foreach my $sub_item(@io_handles){
        if($item eq $sub_item){
            $file_hash{$item} = $sub_item;
        }
    }
}

chdir $upload_folder or die "Cannot chdir to upload destination directory: $!\n";

foreach my $key(keys %file_hash){
    my $base = basename($file_hash{$key});#    
    my $tmpfilename = $query->tmpFileName($file_hash{$key});
    if($maxsize > 0) {
	
	if( (-s "$tmpfilename") > ($maxsize * 1024 * 1024)) {
		unlink("$tmpfilename");
print STDERR "The uploaded file $tmpfilename was too big and has been removed.\n";
		next;
	}
    }
    my $f = $l eq "pngfile1" ? "png1.png" : $l eq "pngfile2" ? "png2.png" : $base;
    
    my $destFile = File::Spec->catfile($upload_folder, $f);
    copy( $tmpfilename, $destFile ) or die "Copy to ($destFile) failed: $!\n";
#print STDERR "Sucessfully uploaded ".CGI->escapeHTML(basename($key));
    $counter++;
}

if ($counter) {

	my $ret = `sudo /usr/local/bin/new_png_covers.sh $ENV{SERVER_NAME}`;
	%hash = ('result' => $ret);
	$j = encode_json(\%hash);
}
} #foreach

print $j; #returning to fetch

} elsif($mode eq "upload_mp3") {

my %hash = ('result' => "Wrong file type");
my $j = encode_json(\%hash);

my $maxsize = 1;
my $upload_folder = "/opt/nvme/ssd/upload";
my $counter = 0;

foreach my $l ('mp3file1') {
my @files = $query->param($l);
my @io_handles=$query->upload($l);

my %file_hash;

foreach my $item(@files){
next unless $item =~ /(.*\.mp3)/;
    foreach my $sub_item(@io_handles){
        if($item eq $sub_item){
            $file_hash{$item} = $sub_item;
        }
    }
}

chdir $upload_folder or die "Cannot chdir to upload destination directory: $!\n";

foreach my $key(keys %file_hash){
    my $base = basename($file_hash{$key});#    
    my $tmpfilename = $query->tmpFileName($file_hash{$key});
    if($maxsize > 0) {
	
	if( (-s "$tmpfilename") > ($maxsize * 1024 * 1024)) {
		unlink("$tmpfilename");
print STDERR "The uploaded file $tmpfilename was too big and has been removed.\n";
		next;
	}
    }
    my $f = $l eq "mp3file1" ? "mp31.mp3" : $l eq "mp3file2" ? "mp32.mp3" : $base;
    
    my $destFile = File::Spec->catfile($upload_folder, $f);
    copy( $tmpfilename, $destFile ) or die "Copy to ($destFile) failed: $!\n";
#print STDERR "Sucessfully uploaded ".CGI->escapeHTML(basename($key));
    $counter++;
}

if ($counter) {

	my $ret = `sudo /usr/local/bin/new_mp3_ringtones.sh $ENV{SERVER_NAME}`;
	%hash = ('result' => $ret);
	$j = encode_json(\%hash);
}
} #foreach

print $j; #returning to fetch

} elsif($mode eq "upload_certs") {
#https://stackoverflow.com/questions/42772245/multiple-file-uploads-with-perl-cgi

my %hash = ('result' => "Wrong file type");
my $j = encode_json(\%hash);

my $maxsize = 10;
my $upload_folder = "/opt/nvme/ssd/upload";
my $counter = 0;

foreach my $l ('certfile','keyfile') {
my @files = $query->param($l);
my @io_handles=$query->upload($l);

my %file_hash;

foreach my $item(@files){
next unless $item =~ /(.*(cert|key).*\.pem)/;
    foreach my $sub_item(@io_handles){
        if($item eq $sub_item){
            $file_hash{$item} = $sub_item;
        }
    }
}

chdir $upload_folder or die "Cannot chdir to upload destination directory: $!\n";

foreach my $key(keys %file_hash){
    my $base = basename($file_hash{$key});#    
    my $tmpfilename = $query->tmpFileName($file_hash{$key});
    if($maxsize > 0) {
	
	if( (-s "$tmpfilename") > ($maxsize * 1024)) {
		unlink("$tmpfilename");
print STDERR "The uploaded file $tmpfilename was too big and has been removed.\n";
		next;
	}
    }
    my $f = $l eq "certfile" ? "cert.pem" : $l eq "keyfile" ? "key.pem" : $base;
    
    my $destFile = File::Spec->catfile($upload_folder, $f);
    copy( $tmpfilename, $destFile ) or die "Copy to ($destFile) failed: $!\n";
print STDERR "Sucessfully uploaded ".CGI->escapeHTML(basename($key));
    $counter++;
}

if ($counter == 2) {

	my $ret = `sudo /usr/local/bin/new_https_certs.sh`;
	%hash = ('result' => $ret);
print STDERR "Done https certs : $ret!\n";
	$j = encode_json(\%hash);
}
} #foreach

print $j; #returning to fetch

} elsif($mode eq "set_hi_res") {

	my %hash = ('result' => "Wrong type");

	my $param = defined($query->param('param')) ? $query->param('param') : 0;
	my $ret = `sudo /usr/local/bin/restart_kurento.sh $param`;
	%hash = ('result' => $ret);
	my $j = encode_json(\%hash);
	print $j; #returning to fetch

} elsif($mode eq "hi_res") {

   if ($is_admin){ #ok

	my $wdth = "420px"; 
	my $umrgn = "60px";
	my $lmrg = "12px";
	
	my $axl = `grep ";outputBitrate" /etc/kurento/modules/kurento/MediaElement.conf.ini`; $axl =~ s/(\r|\n)//g;
	my $ch0 = length($axl) ? " checked" : ''; my $ch1 = length($axl) ? '' : " checked";	
			
	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">
				<div style="font-size:14px;">Please select HI-RES mode ONLY if your tower has good network connection and CPU!</div>
				<div id="radio_hr">
					<INPUT style="margin:5px 3px;" TYPE=radio name="hr" VALUE=0$ch0 /><span style="color:#444;">NORMAL</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name="hr" VALUE=1$ch1 /><span style="color:#444;">HI_RES</span>
				</div>
	};		 
	
	print qq{	
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  onclick="\$('ajax_0').fade(0);
		let hr = document.querySelector('input[name=hr]:checked').value;
		console.log('hr is', hr);
		let formData = new FormData();
		if (hr) formData.append('param', hr);			
		formData.append('mode', 'set_hi_res');
		fetch('/cgi/genc/cp',{body: formData, method: 'post', credentials: 'include'}).then(		
    function(response) {
    	//console.log('response is',response);
      if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
          response.status);
        return;
      }
        response.json().then(function(data) {
        	console.log(data);
		let mytype = data.result.substring(0,2) == 'OK' ? 'ok' : data.result.substring(0,3) == 'ERR' ? 'error' : 'info';
		new mBox.Notice({type: mytype, position: {
				x: 'center',
				y: 'center'
			},
			move: false, delayClose: 4000,width: 420, content: data.result});
        });
    }).catch(function(err) {console.log('Fetch Error', err);});return false;">
    		<a href="#">Go</a></div>		
		<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">Cancel</a></div>
		</div>	
		};
		
	print "</div>";	#main_container

	
   } #admin 
   else {
   	print qq{<div id=main_container style="margin:60px $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">Option disabled in this Edition.<br>Please upgrade to Pro Editions</div>};
   }  

} elsif($mode eq "add_jpg") {

   if ($jpg_change_permitted){ #ok

	my $wdth = "420px"; 
	my $umrgn = "30px";
	my $lmrg = "12px";

	my $dm = "10px";
	
	$comm = "select num_rooms from rooms where name = ?";
	my $result=$dbconn->prepare($comm);
    	$result->execute($mycabo);
	&dBaseError($dbconn, $comm) if (!defined($result));
	
	$listresult = $result->fetchall_arrayref;
	$ntuples = $result->rows();
	my $nrooms = $ntuples == 1 ? ${${$listresult}[0]}[0] : 0;
	
	my $nodisp1 = $nrooms < 1 ? "display:none;" : '';
	my $nodisp2 = $nrooms < 2 ? "display:none;" : '';
	my $nodisp3 = $nrooms < 3 ? "display:none;" : '';
	my $nodisp4 = $nrooms < 4 ? "display:none;" : '';
	my $nodisp5 = $nrooms < 5 ? "display:none;" : '';
	my $nodisp6 = $nrooms < 6 ? "display:none;" : '';
	
	#$umrgn = $nrooms < 4 ? $umgrn : "10px";
	#$umrgn = $nrooms < 5 ? $umgrn : "-10px";
			
	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">
	<div style="padding-left:10px;$nodisp1">Your jpg1:&nbsp;<input type="file" id="jpgfilee1" name="jpgfilee1"></div>
	<div style="padding-left:10px;$nodisp2">Your jpg2:&nbsp;<input type="file" id="jpgfilee2" name="jpgfilee2"></div>
	<div style="padding-left:10px;$nodisp3">Your jpg3:&nbsp;<input type="file" id="jpgfilee3" name="jpgfilee3"></div>
	<div style="padding-left:10px;$nodisp4">Your jpg4:&nbsp;<input type="file" id="jpgfilee4" name="jpgfilee4"></div>
	<div style="padding-left:10px;$nodisp5">Your jpg5:&nbsp;<input type="file" id="jpgfilee5" name="jpgfilee5"></div>
	<div style="padding-left:10px;$nodisp6">Your jpg6:&nbsp;<input type="file" id="jpgfilee6" name="jpgfilee6"></div>
	};		 
		
		print qq{	
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  onclick="\$('ajax_0').fade(0);
		let gf1 = document.getElementById('jpgfilee1') ? document.getElementById('jpgfilee1').files[0] : null;
		let gf2 = document.getElementById('jpgfilee2') ? document.getElementById('jpgfilee2').files[0] : null;
		let gf3 = document.getElementById('jpgfilee3') ? document.getElementById('jpgfilee3').files[0] : null;
		let gf4 = document.getElementById('jpgfilee4') ? document.getElementById('jpgfilee4').files[0] : null;
		let gf5 = document.getElementById('jpgfilee5') ? document.getElementById('jpgfilee5').files[0] : null;
		let gf6 = document.getElementById('jpgfilee6') ? document.getElementById('jpgfilee6').files[0] : null;

		//console.log('gf1 is',gf1);
		let formData = new FormData();
		if (gf1) formData.append('jpgfile1', gf1);
		if (gf2) formData.append('jpgfile2', gf2);
		if (gf3) formData.append('jpgfile3', gf3);
		if (gf4) formData.append('jpgfile4', gf4);
		if (gf5) formData.append('jpgfile5', gf5);
		if (gf6) formData.append('jpgfile6', gf6);
				
		formData.append('mode', 'upload_jpg');
		fetch('/cgi/genc/cp',{body: formData, method: 'post', credentials: 'include'}).then(		
    function(response) {
    	//console.log('response is',response);
      if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
          response.status);
        return;
      }
        response.json().then(function(data) {
        	console.log(data);
		let mytype = data.result.substring(0,2) == 'OK' ? 'ok' : data.result.substring(0,3) == 'ERR' ? 'error' : 'info';
		new mBox.Notice({type: mytype, position: {
				x: 'center',
				y: 'center'
			},
			move: false, delayClose: 7000,width: 420, content: data.result});
        });
    }).catch(function(err) {console.log('Fetch Error', err);});return false;"><a href="#">$buttons{'new'}</a></div>		
		<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">Cancel</a></div>
		</div>	
		};
		
	print "</div>";	#main_container

	
   } #admin 
   else {
   	print qq{<div id=main_container style="margin:60px $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">Option disabled in this Edition.<br>Please upgrade to Pro Editions</div>};
   }  

} elsif($mode eq "add_png") {

   if (($is_admin && ($softpac eq '5' || $softpac eq '7') && !$free_media) || $png_change_permitted){ #ok

	my $wdth = "420px"; 
	my $umrgn = "30px";
	my $lmrg = "12px";

	my $dm = "10px";

	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">
	<div style="padding-left:10px;">Your PNG1:<br><input type="file" id="pngfilee1" name="pngfilee1"></div>
	<div style="padding-left:10px;">Your PNG2:<br><input type="file" id="pngfilee2" name="pngfilee2"></div>
	};		 
		
		print qq{	
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  onclick="\$('ajax_0').fade(0);
		let gf1 = document.getElementById('pngfilee1').files[0];
		let gf2 = document.getElementById('pngfilee2').files[0];
		//console.log('gf1 is',gf1,'gf2 is',gf2);
		let formData = new FormData();
		formData.append('pngfile1', gf1);
		formData.append('pngfile2', gf2);
		formData.append('mode', 'upload_png');
		fetch('/cgi/genc/cp',{body: formData, method: 'post', credentials: 'include'}).then(		
    function(response) {
    	//console.log('response is',response);
      if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
          response.status);
        return;
      }
        response.json().then(function(data) {
        	console.log(data);
		let mytype = data.result.substring(0,2) == 'OK' ? 'ok' : data.result.substring(0,3) == 'ERR' ? 'error' : 'info';
		new mBox.Notice({type: mytype, position: {
				x: 'center',
				y: 'center'
			},
			move: false, delayClose: 7000,width: 420, content: data.result});
		//if (data.result.substring(0,2) == 'OK') location.reload();
        });
    }).catch(function(err) {console.log('Fetch Error', err);});return false;"><a href="#">Go!</a></div>		
		<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">Cancel</a></div>
		</div>	
		};
		
	print "</div>";	#main_container

	
   } #admin 
   else {
   	print qq{<div id=main_container style="margin:60px $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">Option disabled in this Edition.<br>Please upgrade to Pro Editions</div>};
   }  

} elsif($mode eq "add_mp3") {

   if (($is_admin && ($softpac eq '5' || $softpac eq '7') && !$free_media) || $mp3_change_permitted){ #ok

	my $wdth = "420px"; 
	my $umrgn = "30px";
	my $lmrg = "12px";

	my $dm = "10px";

	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">
	<div style="padding-left:10px;">Your MP3:<br><input type="file" id="mp3filee1" name="mp3filee1"></div>
	};		 
		
		print qq{	
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  onclick="\$('ajax_0').fade(0);
		let gf1 = document.getElementById('mp3filee1').files[0];
		//console.log('gf1 is',gf1,'gf2 is',gf2);
		let formData = new FormData();
		formData.append('mp3file1', gf1);
		formData.append('mode', 'upload_mp3');
		fetch('/cgi/genc/cp',{body: formData, method: 'post', credentials: 'include'}).then(		
    function(response) {
    	//console.log('response is',response);
      if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
          response.status);
        return;
      }
        response.json().then(function(data) {
        	console.log(data);
		let mytype = data.result.substring(0,2) == 'OK' ? 'ok' : data.result.substring(0,3) == 'ERR' ? 'error' : 'info';
		new mBox.Notice({type: mytype, position: {
				x: 'center',
				y: 'center'
			},
			move: false, delayClose: 7000,width: 420, content: data.result});
		//if (data.result.substring(0,2) == 'OK') location.reload();
        });
    }).catch(function(err) {console.log('Fetch Error', err);});return false;"><a href="#">Go!</a></div>		
		<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">Cancel</a></div>
		</div>	
		};
		
	print "</div>";	#main_container

	
   } #admin 
   else {
   	print qq{<div id=main_container style="margin:60px $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">Option disabled in this Edition.<br>Please upgrade to Pro Editions</div>};
   }  

} elsif($mode eq "add_certs") {

   
   if (($is_admin && ($softpac eq '5' || $softpac eq '7') && !$free_media) || $certs_change_permitted){ #ok

	my $wdth = "420px"; 
	my $umrgn = "30px";
	my $lmrg = "12px";

	my $dm = "10px";

	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">
	<div style="padding-left:10px;">Your cert.pem:<br><input type="file" id="certfilee" name="certfilee"></div>
	<div style="padding-left:10px;margin-bottom:20px;">Your key.pem:<br><input type="file" id="keyfilee" name="keyfilee"></div>
	};		 
		
		print qq{	
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  onclick="\$('ajax_0').fade(0); \$('settingsPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });
		let cf = document.getElementById('certfilee').files[0];
		let kf = document.getElementById('keyfilee').files[0];
		//console.log('cf is',cf, 'kf is ',kf);
		let formData = new FormData();
		formData.append('certfile', cf);
		formData.append('keyfile', kf);
		formData.append('mode', 'upload_certs');
		fetch('/cgi/genc/cp',{body: formData, method: 'post', credentials: 'include'}).then(		
    function(response) {
    	//console.log('response is',response);
      if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
          response.status);
        return;
      }
        response.json().then(function(data) {
        	//console.log(data);
		//alert(data.result);
		let mytype = data.result.substring(0,2) == 'OK' ? 'ok' : data.result.substring(0,3) == 'ERR' ? 'error' : 'info';
		new mBox.Notice({type: mytype, position: {
				x: 'center',
				y: 'center'
			},
			move: false, delayClose: 7000,width: 420, content: data.result});
		if (data.result.substring(0,2) == 'OK') location.reload();
        });
    }).catch(function(err) {console.log('Fetch Error', err);});return false;"><a href="#">Go!</a></div>		
		<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">Cancel</a></div>
		</div>	
		};
		
	print "</div>";	#main_container

	
   } #admin 
   else {
   	print qq{<div id=main_container style="margin:60px $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">Option disabled in this Edition.<br>Please upgrade to Pro Editions</div>};
   }  

} elsif($mode eq "buf_vmail") {

my %Coo = TClubMD5::GetCookies('cdAuth');
my $str = substr($Coo{'cdAuth'},8,8);

my $id = defined($query->param('id')) ? $query->param('id') : 0;
my $t = defined($query->param('t')) ? $query->param('t') : 0;
#print STDERR "in buf_vmail: str is $str, id is $id, t is $t!\n";

if ($id) {
	
	$comm = "select author, store_url, z_destination, id::text from vmails where id = ?";
	my $result=$dbconn->prepare($comm);
    	$result->execute($id);
	&dBaseError($dbconn, $comm) if (!defined($result));
	
	$listresult = $result->fetchall_arrayref;
	$ntuples = $result->rows();
	my $o = substr(TClubMD5::md5_hex($r_user),0,8);
		
	exit unless ($r_user eq ${${$listresult}[0]}[0] || $o eq ${${$listresult}[0]}[2] || ${${$listresult}[0]}[2] eq ''); #cheat
	
	my @fi = split('/',${${$listresult}[0]}[1]);my $fil=$fi[$#fi];#my $au = $fi[$#fi-1];
	
	my $cmd = '';
	if ($t) {
		$cmd = "mkdir -p /tmp/$o/ && ln -s ${${$listresult}[0]}[1] /tmp/$o/$str.$fil 2>&1";
	} else {
		$cmd = "rm -f /tmp/$o/$str.$fil 2>&1";	
	}
	
	my $ret = `$cmd`;
	
	$ret = length($ret) ? $ret : "OK";
	
	if ( ($o eq ${${$listresult}[0]}[2] || ${${$listresult}[0]}[2] eq '') && $t) {
		
		my $v = ${${$listresult}[0]}[3];
		my $cmd = "insert into views (z,v,t) values (?,?,current_timestamp)";
		my $result=$dbconn->prepare($cmd);
     		$result->execute($o, $v);
        	&dBaseError($dbconn, $cmd) if (!defined($result));
	}
#print STDERR "inserted views\n";
	
	my %hash = ('result' => $ret);
	$j = encode_json(\%hash);
	print $j; #returning to form
	
	
} else {
	exit;
}

} elsif($mode eq "reload_rlist") { #count new mails
	&print_rlist;
} elsif($mode eq "check_vmail") { #count new mails

my $o = substr(TClubMD5::md5_hex($r_user),0,8);
$comm = "select count(id) from vmails where (z_destination = '$o' or z_destination='') and author != '$r_user' and (select count(*) from views where views.z = '$o' and views.v=vmails.id::text) = 0";
&getTable;
my $c = ${${$listresult}[0]}[0];
$comm = "select count(id) from vmails where (z_destination = '$o' or z_destination='') and author != '$r_user'";
&getTable;
my $f = ${${$listresult}[0]}[0];

my %hash = ('new' => $c, 'total' => $f);
print encode_json(\%hash); #returning to form

} elsif($mode eq "delete_vmail") {
#print STDERR "Here in delete_vmail!\n";

my $id = defined($query->param('id')) ? $query->param('id') : 0;

if ($id) {
	
	$comm = "select author, store_url from vmails where id = ?";
	my $result=$dbconn->prepare($comm);
    	$result->execute($id);
	&dBaseError($dbconn, $cmd) if (!defined($result));
	
	$listresult = $result->fetchall_arrayref;
	$ntuples = $result->rows();	
	exit if ($r_user ne ${${$listresult}[0]}[0]); #cheat
	
	my $uri = ${${$listresult}[0]}[1];
	my $cmd = "delete from vmails where id = ? and author = ?";
	my $result=$dbconn->prepare($cmd);
     	$result->execute($id, $r_user);
        &dBaseError($dbconn, $cmd) if (!defined($result));
	
	my $ret = `rm -f $uri 2>&1`;
	&print_llist;
		
#	$ret = length($ret) ? $ret : "OK";	
#	my %hash = ('result' => $ret);
#	$j = encode_json(\%hash);
#	print $j; #returning to form
	
	
} else {
	exit;
}

} elsif($mode eq "store_rec") {

	my $ret = "ERR";
	my $rc = defined($query->param('recipient')) ? $query->param('recipient') : '';
	my $to = defined($query->param('topic')) ? $query->param('topic') : '';
	
	my $folder = substr(TClubMD5::md5_hex($r_user),0,8);
	my $store_prefix= "/opt/nvme/vmail_store/".$folder;
	my $cdt = gettimeofday();
	my $u = $store_prefix.'/'.$cdt.".webm";
	my %Coo = TClubMD5::GetCookies('cdAuth');
	my $c = substr($Coo{'cdAuth'},8,8);
	my $f = $c.$folder."rec.webm";
	
	my $res = `mkdir -p $store_prefix && mv /tmp/$f $u 2>&1`;

	unless (length($res)) {
	  eval {
	  #CREATE TABLE vmails (id serial, author text, a_topic text, z_destination text, store_url text, vremya_z timestamp, status bool default null);
		my $cmd = "insert into vmails (author, a_topic, z_destination, store_url, vremya_z \) values (?, ?, ?, ?, current_timestamp)";
		my $result=$dbconn->prepare($cmd);
		$result->execute($r_user, $to, $rc, $u);
		&dBaseError($dbconn, $cmd) if (!defined($result));
		$ret="OK";
	  } or do {
		my $e = $@;
		$ret = "Something went wrong: $e";
	  };
	} else {
		$ret = "Buffer is empty";
	}
	
	my %hash = ('result' => $ret);
	$j = encode_json(\%hash);
	print $j; #returning to fetch

} elsif($mode eq "save_rec") {

#print STDERR "in save_rec\n";
	my $ty = defined($query->param('t')) ? $query->param('t') : 1;
	
   if ($ty) {
	
	my @cl = ('',"all");

	$comm = "select substring(md5(proj_code),0,9), a_nkname from members";
	&getTable;
	
	for (my $i = 0; $i < $ntuples; $i++) {
		push @cl, ${${$listresult}[$i]}[0];
		push @cl, ${${$listresult}[$i]}[1];
	}

	my %hl = @cl;
	
	my $wdth = "420px"; 
	my $umrgn = "30px";
	my $lmrg = "12px";

	my $dm = "10px";

	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:18px;font-family:Tahoma;">
	<div style="padding-left:0px;margin-left:-24px;">To:
	};
	print "<SELECT id=recip NAME=recipient style=\"width:190px;\">";
				
	foreach my $c (keys %hl) {
		print "<OPTION VALUE=\"$c\">$hl{$c}\n";
	}
	print "</SELECT>";	
	
	print qq{
	</div>
	};		 
	print qq{
	<div id=tinput style="width:230px;height:30px;position:relative;margin:15px auto;background:transparent;"><span style="position:absolute;top:5px;left:-22px;">Subj:</span>
	<INPUT id=subj NAME="topic" value='' type=text style="position:absolute;top:5px;left:21px;width:192px;height:24px;padding:5px;background:#f0f0f0;color:#222;line-height:24px;">
	</div>
	<br>
	};
			
	print qq{	
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  onclick="\$('#ajax_0').fadeOut('slow');
		var e = document.getElementById('recip');
		let rc = e.value;
		let to = document.getElementById('subj').value;
		console.log('rc', rc);
		let formData = new FormData();
		formData.append('recipient', rc);
		formData.append('topic', to);
		formData.append('mode', 'store_rec');
		fetch('/cgi/genc/cp',{body: formData, method: 'post', credentials: 'include'}).then(		
    		function(response) {
      			if (response.status !== 200) {
        			console.log('Looks like there was a problem. Status Code: ' + response.status);
        			return;
      			}
        		response.json().then(function(data) {
        			console.log(data);
				if (data.result.substring(0,2) == 'OK') {bu=2;location.reload();}
			});
		}).catch(function(err) {console.log('Fetch Error', err);});return false;"><a href="#">Save</a></div>		
		<div class="button" onClick="\$('#ajax_0').fadeOut('slow');return false;"><a href="javascript:void(0);">Cancel</a></div>
		</div>	
		};
		
	print "</div>";	#main_container
} else {
#empty buffer
my %Coo = TClubMD5::GetCookies('cdAuth');
my $c = substr($Coo{'cdAuth'},8,8);
my $real_o = substr(TClubMD5::md5_hex($r_user),0,8);

my $f = "/tmp/".$c.$real_o."rec.webm";
my $ret = `rm -f $f 2>&1`;
} 

} elsif($mode eq "add_ad") {

my $touch_specific_bro = 0; #hack ash

	my $chid = gettimeofday();

	$table = "challenges";

	my %Coo = TClubMD5::GetCookies('SPORT');
	$curr_sport = $Coo{'SPORT'} ? $Coo{'SPORT'}  : 0;
	my $curr_sport_local = defined($query->param('cat')) && $is_admin ? $query->param('cat') : -1;
	my $not_main = $curr_sport_local >= 0 ? 1 : 0;
	$curr_sport = $curr_sport_local if (isint($curr_sport_local) && $not_main);

   if ($is_admin) { #ok new chal

		my $who = &nkname_lookup($r_user);

	if ($touch_specific_bro) {

			print qq{<html><head>
			<meta charset="UTF-8" />
			<meta name="viewport" content="width=device-width, initial-scale=1.0" />
			<meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
			<meta http-equiv="Pragma" content="no-cache">
			<meta http-equiv="Expires" content="0">
			<meta http-equiv="Vary" content="*">
			<meta http-equiv="X-UA-Compatible" content="ie=edge" />
			<title>Add</title>
		};	

	print qq{<script language="JavaScript" type="text/javascript" src="/js_cp/$genericjs"></script>};
	unless ($chrome) {
		print q{<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-1.2.4-core.js"></script>
	        <script language="JavaScript" type="text/javascript" src="/js_cp/mootools-1.2.4.2_a-more.js"></script>        
	};
	} else {
		&print_current_moo;
	}

	&begin_decor(1) ;
	}

	my $wdth = ($touch_specific_bro) ? "100%" : "420px"; 
	my $umrgn = "0px";$umrgn = "25%" if ($touch_specific_bro);
	my $lmrg = "12px"; $lmrg = "0" if ($touch_specific_bro);

	my $dm = "10px";

	print qq{<div id=main_container style="margin:$umrgn $lmrg; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;font-family:Tahoma;">
	};

			
	$comm  = "select current_date, current_date+1, current_date+2, current_date+3, current_date+4, current_date+5";
	
	&getTable;
	
	@cdt = (${${$listresult}[0]}[0], ${${$listresult}[0]}[1], ${${$listresult}[0]}[2],
		${${$listresult}[0]}[3], ${${$listresult}[0]}[4], ${${$listresult}[0]}[5]);

	my @ctm = ('06:00', '06:30','07:00', '07:30',
		'08:00', '08:30','09:00', '09:30','10:00', '10:30','11:00', '11:30',
		'12:00', '12:30','13:00', '13:30','14:00', '14:30','15:00', '15:30',
		'16:00', '16:30','17:00', '17:30','18:00', '18:30','19:00', '19:30',
		'20:00', '20:30','21:00', '21:30', '22:00', '22:30','23:00', '23:30');

	if ($touch_specific_bro) {
		print qq{
		<FORM METHOD=POST ACTION=$scriptURL ENCTYPE='application/x-www-form-urlencoded'>
		<input type=hidden name=cat value=$curr_sport>
		<input type=hidden name=challenge_id value=$chid>
		};
	}

	my $w1 = koitoutf8("���������");
	my $w2 = koitoutf8("�����������");
	my $pri = koitoutf8("����");

	print qq{
	<div id=tinput style="width:220px;height:30px;position:relative;margin:5px auto;background:#fafac0;">
	<INPUT id=price_id NAME="price" value="$pri:" type=text style="position:absolute;top:0px;left:0px;width:210px;height:20px;padding:5px;background:#f0f0f0;color:#222;" onmousedown="this.value='';">
	</div>
	};

	print qq{<div id=tarea1 style="width:220px;height:45px;position:relative;margin:5px auto;background:#fafac0;">};
	my @cl = (koitoutf8("����������"),koitoutf8("�����"),koitoutf8("���������������� �����"),koitoutf8("�����"),koitoutf8("������������"),koitoutf8("�������"),koitoutf8("������"),
	koitoutf8("�����"),koitoutf8("�����"),koitoutf8("�������� �������"));

	print "<SELECT id=place_id NAME=place style=\"width:210px;\">";
				
	foreach my $cline (@cl) {
		print "<OPTION VALUE=\"$cline\">$cline\n";
	}
	print "</SELECT>";
	print qq{</div>};

	print qq{
	<div id=tarea2 style="width:220px;height:45px;position:relative;margin:5px auto;background:#fafac0;">
	<TEXTAREA id=cond_id NAME="condition" rows="7" cols="35" style="position:absolute;top:0px;left:0px;width:210px;height:35px;padding:5px;background:#f0f0f0;color:#222;" onmousedown="this.innerHTML='';">$w2:</TEXTAREA>
	</div>
	};

	my $mt = $touch_specific_bro ? "20px" : "10px";
	my $mg = "15px";
	my $mgd = "15px";

	print qq {<div id=sel_date style="padding-top:0px;width:240px;color:#000;margin:$mg auto $mgd auto;font-size:16px;">};


				@clook = @cdt;

				print "<SELECT id=dtm_date NAME=dtm_date SIZE=1>";
				
				foreach my $cline (@clook) {

					print "<OPTION VALUE=\"$cline\">$cline\n";
				}
				print "</SELECT>";			

				@clook = @ctm;
				@clook = &xDel('21:00',@clook);
				@clook = ('21:00', @clook);

								
				print "<SELECT id=dtm_time NAME=dtm_time SIZE=1>";
				
				foreach my $cline (@clook) {

					print "<OPTION VALUE=\"$cline\">$cline\n";
				}
				print "</SELECT>";


	print "</div>"; #sel_date

	my $but = "add_challenge";

	unless ($touch_specific_bro) { 

		my $lh = "var counterRect = \$('ncha_div').getBoundingClientRect();var a = counterRect.left-71;var b = counterRect.top-15;";

		print qq{	
		<div class="twobuttonwrap" style="margin:15px auto;">
		<div class="button"  onclick="\$('ajax_0').fade(0);var dev=$develop;
			var form = document.createElement('form');
			form.setAttribute('method', 'get');
			form.setAttribute('id', 'myForm_add_challenge');
			document.body.appendChild(form);
			\$('myForm_add_challenge').action = '$scriptname?mode=$but&cat=$curr_sport&price='+\$('price_id').value+'&dtm_date='+\$('dtm_date').value+'&dtm_time='+\$('dtm_time').value+'&condition='+ \$('cond_id').value + '&place='+ \$('place_id').value+ '&challenge_id=$chid';
		\$('myForm_add_challenge').set('send', {onComplete: function(response) {		
		$lh;
		var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		\$('log_spinning').setStyles({'position': pos });
		\$('log_spinning').setStyles({'left': a });	
		\$('log_spinning').setStyles({'top': b });
		\$('log_spinning').setStyles({'display': 'block' });
		\$('log_spinning').fade(1);
		\$('myForm_list_challenges').send();	
		}});\$('myForm_add_challenge').send();\$('myForm_add_challenge').dispose();return false;"><a href="#">$buttons{'new'}</a></div>		
		<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">$__3a</a></div>
		</div>	
		};

	} else { #touch
	

		print  "<INPUT id=$but type=submit name=mode value=$but style=\"width:240px;height:40px;margin:10px auto;\" onclick=\"this.style.visibility='hidden';\"><br><br>" if ($is_admin);
		print  "<INPUT TYPE=button onClick=history.go(-1) VALUE=$__3h>";
		print "</form>";

	} #touch
 
	print "</div>";	#main_container add_ad

	&end_decor if ($touch_specific_bro);

	if ($touch_specific_bro) {
		print qq{</body></html>};
	}
	
   } #admin   

} elsif ($mode eq "edit_challenge") {

my $touch_specific_bro = 0; #hack ash

	$comm = "select condition, place, date_and_time, owner, price from challenges where ID = $coid";
	&getTable;
	my $cond = ${${$listresult}[0]}[0];
	my $place = ${${$listresult}[0]}[1];
	my $dtm = ${${$listresult}[0]}[2];
	my $who = ${${$listresult}[0]}[3];
	my $price = ${${$listresult}[0]}[4];
	
   if ($who eq $r_user) { #check ownership
	
	$comm  = "select current_date, current_date+1, current_date+2, current_date+3, current_date+4, current_date+5"; #shorter
	&getTable;
	@cdt = (${${$listresult}[0]}[0], ${${$listresult}[0]}[1], ${${$listresult}[0]}[2],
		${${$listresult}[0]}[3], ${${$listresult}[0]}[4], ${${$listresult}[0]}[5]); #shorter
		
		@ctm = ('06:00', '06:30','07:00', '07:30',
		'08:00', '08:30','09:00', '09:30','10:00', '10:30','11:00', '11:30',
		'12:00', '12:30','13:00', '13:30','14:00', '14:30','15:00', '15:30',
		'16:00', '16:30','17:00', '17:30','18:00', '18:30','19:00', '19:30',
		'20:00', '20:30','21:00', '21:30', '22:00', '22:30','23:00', '23:30');
		
		my ($ch1,$ch2) = split(' ',$dtm);
				my @clook = @cdt;				
				@clook = &xDel($ch1,@clook);
				@clook = ($ch1, @clook);

	print qq{<html><head><meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Edit</title>} if ($touch_specific_bro);
    					
	&begin_decor(1) if ($touch_specific_bro);

	my $wdth = ($touch_specific_bro) ? "100%" : "420px"; 
	my $umrgn = ($touch_specific_bro) ? "60px" : "0px";

	print qq{<div id=main_container style="margin:$umrgn 12px; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;">
	};
      
	if ($touch_specific_bro) {
		print qq{<FORM METHOD=POST ACTION=$scriptURL ENCTYPE='application/x-www-form-urlencoded'>};
	}

	print qq{
	<div id=tinput style="width:220px;height:30px;position:relative;margin:5px auto;background:#fafac0;">
	<INPUT id=price_id NAME="price" value="$price" type=text style="position:absolute;top:0px;left:0px;width:210px;height:20px;padding:5px;background:#f0f0f0;color:#222;">
	</div>
	};
     
	print qq{<div id=tarea1 style="width:220px;height:45px;position:relative;margin:5px auto;background:#fafac0;">};
	my @cl = (koitoutf8("����������"),koitoutf8("�����"),koitoutf8("���������������� �����"),koitoutf8("�����"),koitoutf8("������������"),koitoutf8("�������"),koitoutf8("������"),
	koitoutf8("�����"),koitoutf8("�����"),koitoutf8("�������� �������"));
	@cl = &xDel($place,@cl);
	@cl = ($place, @cl);

	print "<SELECT id=place_id NAME=place style=\"width:210px;\">";
				
	foreach my $cline (@cl) {
		print "<OPTION VALUE=\"$cline\">$cline\n";
	}
	print "</SELECT>";
	print qq{</div>};

	print qq{
	<div id=tarea2 style="width:240px;height:45px;position:relative;margin:5px auto;background:#fafac0;">
	<TEXTAREA id=cond_id NAME="condition" rows="7" cols="35" style="position:absolute;top:0px;left:0px;width:230px;height:35px;padding:5px;background:#f0f0f0;color:#222;">$cond</TEXTAREA>
	</div>
	<div id=sel_date style="padding-top:5px;width:240px;color:#000;margin:5px auto;">
	};


				print "<SELECT id=dtm_date NAME=dtm_date SIZE=1>";
				
				foreach my $cline (@clook) {

					print "<OPTION VALUE=\"$cline\">$cline\n";
				}
				print "</SELECT>";

				
				@clook = @ctm;
				$ch2 =~ /^(\d\d)\:(\d\d)/;
				$ch2 = $1.':'.$2;				
				@clook = &xDel($ch2,@clook);
				@clook = ($ch2, @clook);
				print "<SELECT id=dtm_time NAME=dtm_time SIZE=1>";
				
				foreach my $cline (@clook) {

					print "<OPTION VALUE=\"$cline\">$cline\n";
				}
				print "</SELECT>";

	print "</div>"; #sel_date

	unless ($touch_specific_bro) {
		print qq{
	  		<form id="myForm_update_challenge_$coid" action="$scriptname?mode=update_challenge&oid=$coid" method="get"></form>
		};
			
		my $lh = "var counterRect = \$('ncha_div').getBoundingClientRect();var a = counterRect.left-71;var b = counterRect.top-15;";

		print qq{	
			<div class="twobuttonwrap" style="margin:15px auto;">
			<div class="button"  
			onclick="\$('myForm_update_challenge_$coid').action=\$('myForm_update_challenge_$coid').action +'&price='+\$('price_id').value+'&dtm_date='+\$('dtm_date').value+'&dtm_time='+\$('dtm_time').value+'&place='+\$('place_id').value+'&condition='+\$('cond_id').value;
			\$('myForm_update_challenge_$coid').set('send', {onComplete: function(response) {
			\$('ajax_0').fade(0);
			$lh;

				var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
				\$('log_spinning').setStyles({'position': pos });
				\$('log_spinning').setStyles({'left': a });	
				\$('log_spinning').setStyles({'top': b });
				\$('log_spinning').setStyles({'display': 'block' });
				\$('log_spinning').fade(1);

			selrow=$coid;from_interact=1;r(current_sport,num_open_cha,num_order,type,tag,tagtable);\$('myForm_list_challenges').send();
			}});
			\$('myForm_update_challenge_$coid').send();return false;\"><a href="#">$buttons{'edit_challenge'}</a></div>		
			<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">$__3a</a></div>
			</div>	
		};
	} else {
		print "<input type=hidden name=oid value=$coid>";
		print  "<INPUT id=mode type=submit name=mode value=update_challenge style=\"width:240px;height:40px;margin:10px auto;\" onclick=\"this.style.visibility='hidden';\"><br><br>" if ($is_admin);
		print  "<input type=reset value=\"Reset\"><br><br>";
		print  "<INPUT style=\"width:240px;margin:10px auto;\" TYPE=button onClick=history.go(-1) VALUE=$__3h>";
		print "</form>";
	}

	print "</div>"; #main_container edit_challenge

	&end_decor if ($touch_specific_bro);
	print "</body></html>" if ($touch_specific_bro);
		
   } #if owner

} elsif($mode eq "edit_member") {

my $touch_specific_bro = 0; #hack ash

if ($is_admin) {

	$comm = "select k_kredit, d_spec, a_nkname, proj_code, city from members where ID = $coid";
	&getTable;

	my $kredit = ${${$listresult}[0]}[0];
	my $d_spec = ${${$listresult}[0]}[1];
	my $nkname = ${${$listresult}[0]}[2];
	my $who = ${${$listresult}[0]}[3];
	my $city = ${${$listresult}[0]}[4];
	

	print qq{<html><head><meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Edit</title>} if ($touch_specific_bro);
    					
	&begin_decor(1) if ($touch_specific_bro);

	my $wdth = ($touch_specific_bro) ? "100%" : "420px"; 
	my $umrgn = ($touch_specific_bro) ? "60px" : "0px";

	print qq{<div id=main_container style="margin:$umrgn 12px; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;">
	};
      
	if ($touch_specific_bro) {
		print qq{<FORM METHOD=POST ACTION=$scriptURL ENCTYPE='application/x-www-form-urlencoded'>
		<input type=hidden name=proj_code value='$who'>};
	}

	my $w1 = koitoutf8("����� ������");

	print qq{
	<div id=tinput style="width:220px;height:20px;position:relative;margin:10px auto;background:#fafac0;">
	<INPUT id=kredit_id NAME="k_kredit" value="$kredit" type=text style="position:absolute;top:0px;left:0px;width:210px;height:20px;padding:5px;background:#f0f0f0;color:#222;">
	</div>
	};
	
	print qq{
	<div id=tinput1 style="width:220px;height:20px;position:relative;margin:10px auto;background:#fafac0;">
	<input id=pc_id type=hidden name=proj_code value='$who'>
	<INPUT id=nkname_id NAME="a_nkname" value="$nkname" type=text style="position:absolute;top:0px;left:0px;width:210px;height:20px;padding:5px;background:#f0f0f0;color:#222;">
	</div>
	};
	
	print qq{
	<div id=tinput2 style="width:220px;height:20px;position:relative;margin:10px auto;background:#fafac0;">
	<INPUT id=passw_id NAME="newpass" value="$w1" type=text style="position:absolute;top:0px;left:0px;width:210px;height:20px;padding:5px;background:#f0f0f0;color:#222;" 
	onkeypress="function isOk(e) {var allowedCode = [8, 13, 44, 45, 46, 95]; var charCode = (e.charCode) ? e.charCode : ((e.keyCode) ? e.keyCode : ((e.which) ? e.which : 0)); 
if (charCode > 31 && (charCode < 64 || charCode > 90) && (charCode < 97 || charCode > 122) && (charCode < 48 || charCode > 57) && (allowedCode.indexOf(charCode) == -1)) return false;
return true;} return isOk(event);" onmousedown="this.value='';">
	</div>
	};
	
	print qq{<div id=tarea1 style="width:220px;height:30px;position:relative;margin:5px auto;background:#fafac0;">};

	print "<SELECT id=city_id NAME=city style=\"width:210px;\">";
	print "<OPTION VALUE=\"$city\">$sport_labels{$city}\n";
	
	my @skeys = sort { $sport_labels{$a} cmp $sport_labels{$b} } keys(%sport_labels);
		
	foreach my $index (@skeys) {
		print "<OPTION VALUE=\"$index\">$sport_labels{$index}\n" if ($index =~ m/[0-9]/ && $index ne $city) ;
	}
	print "</SELECT>";
	print qq{</div>};
	
	print qq{
	<div id=tarea2 style="width:240px;height:45px;position:relative;margin:5px auto;background:#fafac0;">
	<TEXTAREA id=d_spec_id NAME="d_spec" rows="7" cols="35" style="position:absolute;top:0px;left:0px;width:230px;height:35px;padding:5px;background:#f0f0f0;color:#222;">$d_spec</TEXTAREA>
	</div>
	};


	unless ($touch_specific_bro) {
		print qq{
	  		<form id="myForm_update_member_$coid" action="$scriptname?mode=update_member&oid=$coid" method="get"></form>
		};
			
		my $lh = "var counterRect = \$('ncha_div').getBoundingClientRect();var a = counterRect.left-71;var b = counterRect.top-15;";

		print qq{	
			<div class="twobuttonwrap" style="margin:15px auto;">
			<div class="button"  
			onclick="\$('myForm_update_member_$coid').action=\$('myForm_update_member_$coid').action +'&city='+\$('city_id').value +'&k_kredit='+\$('kredit_id').value+'&proj_code='+\$('pc_id').value+'&a_nkname='+\$('nkname_id').value+'&newpass='+\$('passw_id').value+'&d_spec='+\$('d_spec_id').value;
			\$('myForm_update_member_$coid').set('send', {onComplete: function(response) {
			\$('ajax_0').fade(0);
			$lh;

				var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
				\$('log_spinning').setStyles({'position': pos });
				\$('log_spinning').setStyles({'left': a });	
				\$('log_spinning').setStyles({'top': b });
				\$('log_spinning').setStyles({'display': 'block' });
				\$('log_spinning').fade(1);

			selrow=$coid;from_interact=1;r(current_sport,num_open_cha,num_order,type,tag,tagtable);\$('myForm_list_challenges').send();
			}});
			\$('myForm_update_member_$coid').send();return false;\"><a href="#">$buttons{'edit_challenge'}</a></div>		
			<div class="button" onClick="\$('ajax_0').fade(0);return false;"><a href="javascript:void(0);">$__3a</a></div>
			</div>	
		};
	} else {
		print "<input type=hidden name=oid value=$coid>";
		my $save = koitoutf8("���������");
		#print  "<INPUT id=mode type=submit name=mode value=update_member style=\"width:240px;height:40px;margin:10px auto;\" onclick=\"this.style.visibility='hidden';\"><br><br>";
		print "<button type=\"submit\" name=\"mode\" value=\"update_member\" style=\"width:240px;height:40px;margin:10px auto;\">$save</button><br><br>";
		#print  "<input type=reset value=\"Reset\"><br><br>";
		print  "<INPUT style=\"width:240px;margin:10px auto;\" TYPE=button onClick=history.go(-1) VALUE=$__3h>";
		print "</form>";
	}

	print "</div>"; #main_container edit_member

	&end_decor if ($touch_specific_bro);
	print "</body></html>" if ($touch_specific_bro);
		
   } #if admin

} elsif($mode eq "update_challenge")  {

	$table = "challenges"; #don't remove

	my $partner = defined($query->param('partner')) ? $query->param('partner') : '';
	my $email_address;

	my $cond_of_match = decode_local($query->param('condition'));
	#$cond_of_match = decode('UTF-8', uri_decode($cond_of_match));
	
	$cond_of_match =~ s/\r//g;$cond_of_match =~ s/\n//g;

	my $owner = &nkname_lookup($query->param('owner'));

	$comm = "select date_and_time, partner, place, condition, status, sport, owner, price from challenges where ID = $oid";

	&getTable;
	my $time_of_match = ${${$listresult}[0]}[0];
	my $cands_string = ${${$listresult}[0]}[1];
	my $place_of_match = ${${$listresult}[0]}[2];
	
	my $co = ${${$listresult}[0]}[3];
	my $sta = ${${$listresult}[0]}[4];
	my $spo = ${${$listresult}[0]}[5];
	my $ow = ${${$listresult}[0]}[6];
	my $price = ${${$listresult}[0]}[7];
	
     	my @p_array = split(',',$cands_string);

	my @emails = ();
	my @losers = ();
	my $winner = '';
	
     	foreach my $pline (@p_array) {
		
		if ($pline eq $partner) { #mark the challenge with the date of buy
			$cmd = "insert into tags (tag,match_oid,category) values (current_date::text,$oid,1)";
			$result=$dbconn->prepare($cmd);$result->execute;
        		&dBaseError($dbconn, $cmd) if (!defined($result));
		}
		
     		$comm = "select g_email from members where proj_code = '$pline'";

		&getTable;
     		
		if ($ntuples) {
     			push @emails, ${${$listresult}[0]}[0] if ($pline ne $partner);
			push @losers, $pline if ($pline ne $partner);
			$email_address = ${${$listresult}[0]}[0] if ($pline eq $partner);
			$winner = $pline if ($pline eq $partner);
     		}
     	}	

	
	&tclub_doUpdateRecord ($query, $output);
	$query->delete_all;
	
	if (length($partner)) {
		#my $cmd = "update members set k_kredit=k_kredit-$price where proj_code='$partner'"; #stock
		my $cmd = "update members set k_kredit=k_kredit+$price where proj_code='$partner'"; #juma
	     
     		my $result=$dbconn->prepare($cmd);
     		$result->execute;
	}
    
    
     &_and_reload; #needed for touch

} elsif($mode eq "update_member") {
	
	$table = "members"; #don't remove
	
	&tclub_doUpdateRecord ($query, $output);
	$query->delete_all; 
  
	&_and_reload; #needed for touch
                
} elsif($mode eq "video_panel")  {

	&print_video_panel;

} elsif($mode eq "videos_page")  {

	&print_videos_page;

} elsif($mode eq "users_control")  {

	my %Coo = TClubMD5::GetCookies('CHAT');
	my $chat = defined($Coo{'CHAT'}) ? $Coo{'CHAT'} : 0;	

	if ($chat) {
		&print_users_mode;
	} else {
		&print_users_control;
	}

} elsif($mode eq "users_mode")  {

	&print_users_mode;

} elsif($mode eq "stats_mode")  {

	&print_stats_mode;
	
} elsif($mode eq "intre")  {

	&print_intre;
	
} elsif($mode eq "interprete")  {

	&print_interprete;

} elsif($mode eq "list_conferences")  {

	&print_conferences;

} elsif($mode eq "conf_edit")  {

	&conf_edit;
	
} elsif($mode eq "conf_list_create")  {

	&conf_list_create;
		
} elsif($mode eq "nw_panel")  {

	&print_nw_panel;

} elsif($mode eq "w_uc_panel_old")  {

	&print_w_uc_panel;

} elsif($mode eq "w_uc_panel")  {

	#&print_w_uc_panel;
	&print_users_panel;

} elsif($mode eq "w_uc_stats")  {

	&print_stats_panel;

} elsif($mode eq "polka_mode")  {

	&print_polka_mode;

} elsif($mode eq "w_uc_polka")  {

	&print_polka_panel;
		
} elsif($mode eq "uc_panel")  {

	my $part = defined($query->param('part')) ? $query->param('part') : 0; 
	
	$ENV{'GATEWAY_INTERFACE'}='CGI/1.1';
	$ENV{'REQUEST_METHOD'}='GET';
	
	my $f = "run";
	
	do ('/var/www/html/adm/'.$f.'.cgi');

} elsif($mode eq "uc_run_win")  {

	my $run = defined($query->param('run')) ? $query->param('run') : 0; 
	
	$ENV{'GATEWAY_INTERFACE'}='CGI/1.1';
	$ENV{'REQUEST_METHOD'}='GET';
	
	my $f = "run_win";
	
	do ('/var/www/html/adm/'.$f.'.cgi');


} elsif($mode eq "uc_smlight" || $mode eq "uc_mailq" 
|| $mode eq "uc_whitelist" || $mode eq "uc_spam" || $mode eq "uc_traff" || $mode eq "uc_traff_yota" 
|| $mode eq "uc_restart" || $mode eq "uc_ntpdate" 
|| $mode eq "uc_add_user" || $mode eq "uc_del_user" || $mode eq "uc_inst_win" || $mode eq "uc_files_win" || $mode eq "uc_stop_win"|| $mode eq "uc_deinst_win")  {

	my $addon = '';
	my $a = defined($query->param('admmode')) ? $query->param('admmode') : ''; my $aa = length($a) ? "admmode=$a" : '';	
	my $b = defined($query->param('period')) ? $query->param('period') : ''; my $bb = length($b) ? "&period=$b" : '';
	my $c = defined($query->param('sender')) ? $query->param('sender') : ''; my $cc = length($c) ? "&sender=$c" : '';
	my $d = defined($query->param('receiver')) ? $query->param('receiver') : ''; my $dd = length($d) ? "&receiver=$d" : '';
	$addon .= $aa.$bb.$cc.$dd;
	
	if ($mode eq "uc_mailq") {
		$addon = '';
		for ( my $i=1; $i<10; $i++) {
			my $a = defined($query->param('n'.$i)) ? $query->param('n'.$i) : ''; 
			my $aa = length($a) ? "n$i=$a" : '';
			my $b = defined($query->param('chb'.$i)) ? $query->param('chb'.$i) : '';
			my $bb = length($b) ? "chb$i=$b" : '';
			$addon .=$aa.'&'.$bb.'&' if ( length($aa) && length($bb) );
		}
		chop $addon;
	}
	
	$ENV{'GATEWAY_INTERFACE'}='CGI/1.1';
	$ENV{'REQUEST_METHOD'}='GET';
	$ENV{'QUERY_STRING'}=$addon;
	
	my $f = $mode eq "uc_deinst_win" ? "deinst_win" :
	$mode eq "uc_stop_win" ? "stop_win" :
	$mode eq "uc_files_win" ? "files_win" :
	$mode eq "uc_inst_win" ? "inst_win" :
	$mode eq "uc_del_user" ? "del_user" :
	$mode eq "uc_add_user" ? "add_user" :
	$mode eq "uc_traff" ? "traff" :
	$mode eq "uc_traff_yota" ? "traff_yota" :
	$mode eq "uc_restart" ? "restart_daemon" :
	$mode eq "uc_ntpdate" ? "ntpdate" :
	$mode eq "uc_spam" ? "spam" :
	$mode eq "uc_whitelist" ? "whitelist" :
	$mode eq "uc_smlight" ? "smlight" :
	$mode eq "uc_mailq" ? "mailq" : "run";
			
	do ('/var/www/html/adm/'.$f.'.cgi') unless ($demo_mode && ($mode eq "uc_add_user" || $mode eq "uc_del_user" || $mode eq "uc_restart"));
	do ('/var/www/html/adm/warn_demo.cgi') if ($demo_mode && ($mode eq "uc_add_user" || $mode eq "uc_del_user" || $mode eq "uc_restart"));

} elsif($mode eq "w_h_panel")  {

	&print_w_h_panel;


} elsif ($mode eq "h_panel" || $mode =~ /^h_([a-s]+)_user$/) {	
	
	my $addon = '';$addon="touch=1" if ($touch_specif_bro);
	
	$ENV{'GATEWAY_INTERFACE'}='CGI/1.1';
	$ENV{'REQUEST_METHOD'}='GET';
	$ENV{'QUERY_STRING'}=$addon;
	

	my $f = $mode =~ /^h_([a-s]+)_user$/ ? "help_$1_user" : "help";
	do ('/var/www/html/adm/'.$f.'.cgi');
		
} elsif($mode eq "w_ls_panel")  {

	&print_w_ls_panel;
	
} elsif($mode eq "ls_panel" || $mode eq "ls_month_detail" || $mode eq "ls_day_detail" || $mode eq "ls_user_detail" || $mode eq "ls_user_time" || $mode eq "ls_user_month" || $mode eq "ls_bigfiles")  {
	
	my $g = $mode eq "ls_panel" ? "index" : $mode eq "ls_month_detail" ? "month_detail" : $mode eq "ls_day_detail" ? "day_detail" : $mode eq "ls_user_detail" ? "user_detail" : 
	$mode eq "ls_bigfiles" ? "bigfiles" : $mode eq "ls_user_month" ? "user_month" : $mode eq "ls_user_time" ? "user_time" : '';
	
	my $addon = '';
	my $a = defined($query->param('year')) ? $query->param('year') : ''; my $aa = length($a) ? "year=$a" : '';
	my $b = defined($query->param('month')) ? $query->param('month') : ''; my $bb = length($b) ? "&month=$b" : '';
	my $c = defined($query->param('day')) ? $query->param('day') : ''; my $cc = length($c) ? "&day=$c" : '';
	my $d = defined($query->param('user')) ? $query->param('user') : ''; my $dd = length($d) ? "&user=$d" : '';
	my $e = defined($query->param('mmode')) ? $query->param('mmode') : ''; my $ee = length($e) ? "&mmode=$e" : '';
	
	$addon .= $aa.$bb.$cc.$dd.$ee;

	$ENV{'GATEWAY_INTERFACE'}='CGI/1.1';
	$ENV{'REQUEST_METHOD'}='GET';
	$ENV{'QUERY_STRING'}=$addon;
	
	do ('/var/www/html/lightsquid/'.$g.'.cgi');

} elsif($mode eq "ls_graph" || $mode eq "ls_topsites" || $mode eq "ls_whousesite" || $mode eq "ls_group_detail")  {
	
	my $g = $mode eq "ls_graph" ? "graph" : $mode eq "ls_topsites" ? "topsites" : $mode eq "ls_whousesite" ? "whousesite" : $mode eq "ls_group_detail" ? "group_detail" : '';
	
	my $addon = '';
	my $a = defined($query->param('year')) ? $query->param('year') : ''; my $aa = length($a) ? "year=$a" : '';
	my $b = defined($query->param('month')) ? $query->param('month') : ''; my $bb = length($b) ? "&month=$b" : '';
	my $c = defined($query->param('mmode')) ? $query->param('mmode') : ''; my $cc = length($c) ? "&mmode=$c" : '';
	my $d = defined($query->param('user')) ? $query->param('user') : ''; my $dd = length($d) ? "&user=$d" : '';
	my $e = defined($query->param('day')) ? $query->param('day') : ''; my $ee = length($e) ? "&day=$e" : '';
	my $f = defined($query->param('png')) ? $query->param('png') : ''; my $ff = length($f) ? "&png=$f" : '';
	
	$addon .= $aa.$bb.$cc.$dd.$ee.$ff;

	$ENV{'GATEWAY_INTERFACE'}='CGI/1.1';
	$ENV{'REQUEST_METHOD'}='GET';
	$ENV{'QUERY_STRING'}=$addon;
	
	do ('/var/www/html/lightsquid/'.$g.'.cgi');

} elsif($mode eq 'hahaha')  {

print STDERR "Hahaha!\n";

} elsif($mode eq 'myintro')  {

} else {
    print $output->start_html(-title=>"empty page", -BGCOLOR=>$bgcol);
    print "<H4><FONT COLOR=BLACK><P>$scriptname called with illegal arguments:</H4>\n\n<TABLE BORDER CELLSPACING=0 CELLPADDING=5>\n";
    my @names  = $query->param;
    foreach my $name (sort @names) {
        print "<TR><TD>$name<TD>" . $query->param($name) . "\n";
    }
    print "</TABLE>\n";
    print $output->end_html;
}


$dbconn->disconnect;

my $now_time  = time;
my $tt = $now_time - $script_start_time;

print STDERR "Debug: after disconnect, time is $tt\n" if ($debug);
exit;


sub dBaseError { #12

    my ($check, $message) = @_;

    my $str = $check->errstr;

    print qq{
    <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=KOI8-R" http-equiv="content-type">
  <title>Ooops</title>
</head>
<body style="padding: 5px; background: rgb(51, 102, 153) none repeat scroll 0%; font-family: Tahoma; font-size: 12px;">
<div style="border: 1px solid rgb(51, 102, 153); margin: 10px; padding: 30px; background: rgb(241, 248, 255) none repeat scroll 0% 50%;$blu_shado;">
    };
    print "Ooops! Some error occured, please be patient!<br>".$str;
    print qq{
<br><br><br>
<span style="font-weight: bold;">$xTER</span><br
 style="font-weight: bold;">
<span style="font-weight: bold;">(C) 2006-2019</span><br>
</div>
</body>
</html>    
    };
    
    die("Action failed on command:$message  Error_was:$DBI::errstr");
}

sub GetOrderBy { #13

    my $orderby=$_[0];
    if ($orderby) {

        $order = "ORDER BY $orderby";
    } else {
        $order='';
    }
    return $order;
}


sub getTable { #16

my $now_time  = time;
my $tt = $now_time - $script_start_time;

print STDERR "Debug: in get table - begin, dbase is $dbase; comm is $comm, time is $tt\n" if ($debug);

	$result=$dbconn->prepare($comm);

    	$result->execute;
	&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() ==
	-2);
	
	$listresult = $result->fetchall_arrayref;
	$ntuples = $result->rows();

my $now_time  = time;
my $tt = $now_time - $script_start_time;

print STDERR "Debug: in get table - end, time is $tt\n" if ($debug);

}
########################################## end parts of dbengine.cgi code

########################################## encoding and translit code

sub decode_local { #17

    my $var = shift;
return $var if ($develop == 12 || $develop >= 14);
    
    $var =~ s/\'/\"/g;
    $var =~ s/\n/ /g;

	if ($chars eq 'koi8-r' || $chars eq 'iso8859-1') {
	} elsif ($chars eq 'windows-1251') {
		$var = wintokoi($var);
	} elsif ($chars eq 'x-mac-cyrillic') {
		
		$var = mactokoi($var);
	} else {
		$var = k2($var);
	}

    return $var;
}

sub koitoutf8 { #26

my $pvdcoderwin=shift;

$pvdcoderwin=~ s/�/E/g;
$pvdcoderwin=~ s/�/e/g;
$pvdcoderwin=~ s/�/я/g;
$pvdcoderwin=~ s/�/п/g;

$pvdcoderwin=~ s/�/А/g;
$pvdcoderwin=~ s/�/Б/g;
$pvdcoderwin=~ s/�/В/g;
$pvdcoderwin=~ s/�/Г/g;
$pvdcoderwin=~ s/�/Д/g;
$pvdcoderwin=~ s/�/Е/g;
$pvdcoderwin=~ s/�/Ж/g;
$pvdcoderwin=~ s/�/З/g;
$pvdcoderwin=~ s/�/И/g;
$pvdcoderwin=~ s/�/Й/g;
$pvdcoderwin=~ s/�/К/g;
$pvdcoderwin=~ s/�/Л/g;
$pvdcoderwin=~ s/�/М/g;
$pvdcoderwin=~ s/�/Н/g;
$pvdcoderwin=~ s/�/О/g;
$pvdcoderwin=~ s/�/П/g;
$pvdcoderwin=~ s/�/Р/g;
$pvdcoderwin=~ s/�/С/g;
$pvdcoderwin=~ s/�/Т/g;
$pvdcoderwin=~ s/�/У/g;
$pvdcoderwin=~ s/�/Ф/g;
$pvdcoderwin=~ s/�/Х/g;
$pvdcoderwin=~ s/�/Ц/g;
$pvdcoderwin=~ s/�/Ч/g;
$pvdcoderwin=~ s/�/Ш/g;
$pvdcoderwin=~ s/�/Щ/g;
$pvdcoderwin=~ s/�/Ь/g;
$pvdcoderwin=~ s/�/Ы/g;
$pvdcoderwin=~ s/�/Ъ/g;
$pvdcoderwin=~ s/�/Э/g;
$pvdcoderwin=~ s/�/Ю/g;
$pvdcoderwin=~ s/�/Я/g;

$pvdcoderwin=~ s/�/а/g;
$pvdcoderwin=~ s/�/б/g;
$pvdcoderwin=~ s/�/в/g;
$pvdcoderwin=~ s/�/г/g;
$pvdcoderwin=~ s/�/д/g;
$pvdcoderwin=~ s/�/е/g;
$pvdcoderwin=~ s/�/ж/g;
$pvdcoderwin=~ s/�/з/g;
$pvdcoderwin=~ s/�/и/g;
$pvdcoderwin=~ s/�/й/g;
$pvdcoderwin=~ s/�/к/g;
$pvdcoderwin=~ s/�/л/g;
$pvdcoderwin=~ s/�/м/g;
$pvdcoderwin=~ s/�/н/g;
$pvdcoderwin=~ s/�/о/g;
$pvdcoderwin=~ s/�/р/g;
$pvdcoderwin=~ s/�/с/g;
$pvdcoderwin=~ s/�/т/g;
$pvdcoderwin=~ s/�/у/g;
$pvdcoderwin=~ s/�/ф/g;
$pvdcoderwin=~ s/�/х/g;
$pvdcoderwin=~ s/�/ц/g;
$pvdcoderwin=~ s/�/ч/g;
$pvdcoderwin=~ s/�/ш/g;
$pvdcoderwin=~ s/�/щ/g;
$pvdcoderwin=~ s/�/ь/g;
$pvdcoderwin=~ s/�/ы/g;
$pvdcoderwin=~ s/�/ъ/g;
$pvdcoderwin=~ s/�/э/g;
$pvdcoderwin=~ s/�/ю/g;

return $pvdcoderwin;
}

sub koitowin { #18

my $pvdcoderwin=shift;
$pvdcoderwin=~ tr/\xE1\xE2\xF7\xE7\xE4\xE5\xF6\xFA\xE9\xEA\xEB\xEC\xED\xEE\xEF\xF0\xF2\xF3\xF4\xF5\xE6\xE8\xE3\xFE\xFB\xFD\xFF\xF9\xF8\xFC\xE0\xF1\xC1\xC2\xD7\xC7\xC4\xC5\xD6\xDA\xC9\xCA\xCB\xCC\xCD\xCE\xCF\xD0\xD2\xD3\xD4\xD5\xC6\xC8\xC3\xDE\xDB\xDD\xDF\xD9\xD8\xDC\xC0\xD1/\xC0\xC1\xC2\xC3\xC4\xC5\xC6\xC7\xC8\xC9\xCA\xCB\xCC\xCD\xCE\xCF\xD0\xD1\xD2\xD3\xD4\xD5\xD6\xD7\xD8\xD9\xDA\xDB\xDC\xDD\xDE\xDF\xE0\xE1\xE2\xE3\xE4\xE5\xE6\xE7\xE8\xE9\xEA\xEB\xEC\xED\xEE\xEF\xF0\xF1\xF2\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFB\xFC\xFD\xFE\xFF/;
return $pvdcoderwin;
}

sub mactokoi { #19

my $pvdcoderwin=shift;
$pvdcoderwin =~ tr/\x80\x81\x82\x83\x84\x85\xDD\x86\x87\x88\x89\x8A\x8B\x8C\x8D\x8E\x8F\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9A\x9B\x9C\x9D\x9E\x9F\xE0\xE1\xE2\xE3\xE4\xE5\xDE\xE6\xE7\xE8\xE9\xEA\xEB\xEC\xED\xEE\xEF\xF0\xF1\xF2\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFB\xFC\xFD\xFE\xDF/\xE1\xE2\xF7\xE7\xE4\xE5\xB3\xF6\xFA\xE9\xEA\xEB\xEC\xED\xEE\xEF\xF0\xF2\xF3\xF4\xF5\xE6\xE8\xE3\xFE\xFB\xFD\xFF\xF9\xF8\xFC\xE0\xF1\xC1\xC2\xD7\xC7\xC4\xC5\xA3\xD6\xDA\xC9\xCA\xCB\xCC\xCD\xCE\xCF\xD0\xD2\xD3\xD4\xD5\xC6\xC8\xC3\xDE\xDB\xDD\xDF\xD9\xD8\xDC\xC0\xD1/; 

return $pvdcoderwin; 
}

sub wintokoi { #20

my $pvdcoderwin=shift; 
$pvdcoderwin =~ tr/\xC0\xC1\xC2\xC3\xC4\xC5\xA8\xC6\xC7\xC8\xC9\xCA\xCB\xCC\xCD\xCE\xCF\xD0\xD1\xD2\xD3\xD4\xD5\xD6\xD7\xD8\xD9\xDA\xDB\xDC\xDD\xDE\xDF\xE0\xE1\xE2\xE3\xE4\xE5\xB8\xE6\xE7\xE8\xE9\xEA\xEB\xEC\xED\xEE\xEF\xF0\xF1\xF2\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFB\xFC\xFD\xFE\xFF/\xE1\xE2\xF7\xE7\xE4\xE5\xB3\xF6\xFA\xE9\xEA\xEB\xEC\xED\xEE\xEF\xF0\xF2\xF3\xF4\xF5\xE6\xE8\xE3\xFE\xFB\xFD\xFF\xF9\xF8\xFC\xE0\xF1\xC1\xC2\xD7\xC7\xC4\xC5\xA3\xD6\xDA\xC9\xCA\xCB\xCC\xCD\xCE\xCF\xD0\xD2\xD3\xD4\xD5\xC6\xC8\xC3\xDE\xDB\xDD\xDF\xD9\xD8\xDC\xC0\xD1/; 
return $pvdcoderwin; 
}

sub utf2koi { #27

my $pvdcoderwin=shift;

$pvdcoderwin=~ s/А/�/g;
$pvdcoderwin=~ s/Б/�/g;
$pvdcoderwin=~ s/В/�/g;
$pvdcoderwin=~ s/Г/�/g;
$pvdcoderwin=~ s/Д/�/g;
$pvdcoderwin=~ s/Е/�/g;
$pvdcoderwin=~ s/Ж/�/g;
$pvdcoderwin=~ s/З/�/g;
$pvdcoderwin=~ s/И/�/g;
$pvdcoderwin=~ s/Й/�/g;
$pvdcoderwin=~ s/К/�/g;
$pvdcoderwin=~ s/Л/�/g;
$pvdcoderwin=~ s/М/�/g;
$pvdcoderwin=~ s/Н/�/g;
$pvdcoderwin=~ s/О/�/g;
$pvdcoderwin=~ s/П/�/g;
$pvdcoderwin=~ s/Р/�/g;
$pvdcoderwin=~ s/С/�/g;
$pvdcoderwin=~ s/Т/�/g;
$pvdcoderwin=~ s/У/�/g;
$pvdcoderwin=~ s/Ф/�/g;
$pvdcoderwin=~ s/Х/�/g;
$pvdcoderwin=~ s/Ц/�/g;
$pvdcoderwin=~ s/Ч/�/g;
$pvdcoderwin=~ s/Ш/�/g;
$pvdcoderwin=~ s/Щ/�/g;
$pvdcoderwin=~ s/Ь/�/g;
$pvdcoderwin=~ s/Ы/�/g;
$pvdcoderwin=~ s/Ъ/�/g;
$pvdcoderwin=~ s/Э/�/g;
$pvdcoderwin=~ s/Ю/�/g;
$pvdcoderwin=~ s/Я/�/g;

$pvdcoderwin=~ s/а/�/g;
$pvdcoderwin=~ s/б/�/g;
$pvdcoderwin=~ s/в/�/g;
$pvdcoderwin=~ s/г/�/g;
$pvdcoderwin=~ s/д/�/g;
$pvdcoderwin=~ s/е/�/g;
$pvdcoderwin=~ s/ж/�/g;
$pvdcoderwin=~ s/з/�/g;
$pvdcoderwin=~ s/и/�/g;
$pvdcoderwin=~ s/й/�/g;
$pvdcoderwin=~ s/к/�/g;
$pvdcoderwin=~ s/л/�/g;
$pvdcoderwin=~ s/м/�/g;
$pvdcoderwin=~ s/н/�/g;
$pvdcoderwin=~ s/о/�/g;
$pvdcoderwin=~ s/р/�/g;
$pvdcoderwin=~ s/с/�/g;
$pvdcoderwin=~ s/т/�/g;
$pvdcoderwin=~ s/у/�/g;
$pvdcoderwin=~ s/ф/�/g;
$pvdcoderwin=~ s/х/�/g;
$pvdcoderwin=~ s/ц/�/g;
$pvdcoderwin=~ s/ч/�/g;
$pvdcoderwin=~ s/ш/�/g;
$pvdcoderwin=~ s/щ/�/g;
$pvdcoderwin=~ s/ь/�/g;
$pvdcoderwin=~ s/ы/�/g;
$pvdcoderwin=~ s/ъ/�/g;
$pvdcoderwin=~ s/э/�/g;
$pvdcoderwin=~ s/ю/�/g;
$pvdcoderwin=~ s/ё/�/g;
$pvdcoderwin=~ s/Ё/�/g;

$pvdcoderwin=~ s/я/�/g;
$pvdcoderwin=~ s/п/�/g;

return $pvdcoderwin;
}

########################################## end encoding and translit code

sub export_images { #29

my $how_many = $_[0];

my $ord = "oid";
$ord = "vremya_z" if $table eq 'gallery';

my $mode = 0777;
mkdir $tmp_doc."/db_images" if ( ! -e "$tmp_doc/db_images");
chmod $mode, "$tmp_doc/db_images";

my $r = (0) ? "raster" : "raster_small";

my $search = "select ID, $r, uploaded_file  from $table order by $ord desc";
my $listResult=$dbconn->prepare($search);
    $listResult->execute; 
    my $listResult_data=$listResult->fetchall_arrayref;
my $ntuples=$listResult->rows;

$ntuples=$how_many if ($how_many && $ntuples > $how_many);

	for (my $i=0; $i < $ntuples; $i++) {
		my $oid= ${${$listResult_data}[$i]}[0];
		my $raster= ${${$listResult_data}[$i]}[1];
		my $filename= ${${$listResult_data}[$i]}[2];
		my $nff = $filename =~ /\.([a-zA-Z]+)\_([a-z]+)(\d*)$/ ? 1 : 0;
		
		my $chip;		

		unless ($nff) {	
			$chip = substr(TClubMD5::md5_hex($filename),0,4);
		} else {
			$chip = substr(TClubMD5::md5_hex($filename),0,8);
		};

		my $up_small = $chip."_small.jpg";
	  if( (! -f "$tmp_doc/db_images/$up_small") || (-s "$tmp_doc/db_images/$up_small") <= 0) {
		
		if($export_mode) {
			$search = "select lo_export($table.raster_small,'$tmp_doc/db_images/$up_small') 
			from $table where ID=$oid";
			$listResult=$dbconn->prepare($search);
    			$listResult->execute;

		} else {
			
		   my $s_call = "$prog_export '$server' '$port' '$user' '$passwd' '$dbase' '$raster' '$tmp_doc/db_images/$up_small'";

		   system($s_call) if ($raster);
		   		   
		   my $mode = 0644;
	   	   chmod $mode, "$tmp_doc/db_images/$up_small" if ($raster && $raster ne '');
		}
	  }

	}
}

sub export_big_image { #30

my $select_id = shift;
my $big_or_small = shift;

my $rast = 'raster';
$rast= 'raster_small' if ($big_or_small);

$rast= 'raster' if ($big_or_small && 0);

my $search  = "select $rast, uploaded_file  from $table where ID = $select_id";
my $listResult = $dbconn->prepare($search);
    $listResult->execute; 
    my $listResult_data=$listResult->fetchall_arrayref;

my $mode = 0777;
mkdir $tmp_doc."/db_images" if ( ! -e "$tmp_doc/db_images");
chmod $mode, "$tmp_doc/db_images";

	my $raster= ${${$listResult_data}[0]}[0];
	my $filename= ${${$listResult_data}[0]}[1];
	my $nff = $filename =~ /\.([a-zA-Z]+)\_([a-z]+)(\d*)$/ ? 1 : 0;
				
	my $chip;		
	unless ($nff) {	
		$chip = substr(TClubMD5::md5_hex($filename),0,4);
	} else {
		$chip = substr(TClubMD5::md5_hex($filename),0,8);
	};

	my $up_big = $chip."_large.jpg";
	$up_big = $chip."_small.jpg" if ($big_or_small);
	
   if ( (! -f "$tmp_doc/db_images/$up_big") || (-s "$tmp_doc/db_images/$up_big") <= 0) {
	
	if($export_mode) {
		
		$search = "select lo_export($table.raster,'$tmp_doc/db_images/$up_big') 
		from $table where ID=$select_id";
		$listResult=$dbconn->prepare($search);
    		$listResult->execute;
	} else {
		
	   #my $s_call = "$psql -c '\\lo_export $raster $tmp_doc/db_images/$up_big' $dbase  2>&1>/dev/null";
	   
	   my $addon = (0 && $big_or_small) ? ".tmp": '';
	   
	   my $s_call = "$prog_export '$server' '$port' '$user' '$passwd' '$dbase' '$raster' '$tmp_doc/db_images/$up_big$addon'";

	   system($s_call) if (length($raster));

	   my $mode = 0644;
	   chmod $mode, "$tmp_doc/db_images/$up_big" if ($raster && $raster ne '');
	}
   }
}

sub send_notification { #32

	my ($email,$mes,$subj,$html_par) = @_;
	
	my $mailprog = '/usr/sbin/sendmail';
	my %Config;
 
	$Config{'message'} =  $mes;
	
	$email = &check_email_address($email);
	
	$Config{'recipient'} = $email;

	$Config{'realname'} = "Control Panel";

	
	$Config{'my_email'} = "info";
	
	$Config{'recipient'} =~ s/\s//g;
	
 
 unless ( $Config{'recipient'} eq '0' || $Config{'recipient'} eq '' || $Config{'recipient'} =~ /thissite.com/)
 
 {
    my $chs = "charset=koi8-r";
    
    if ($utf && $language ne "russian") {
	$chs = "charset=UTF-8";
	my $c = MIME::Base64::encode_base64($subj); chop $c;
	$subj = "=?UTF-8?B?".$c."?=";
	
    } elsif ($utf && $language eq "russian") {
    	$mes = utf2koi($mes);
    	$subj = utf2koi($subj);
	my $c = MIME::Base64::encode_base64($subj); chop $c;
	$subj = "=?koi8-r?B?".$c."?=";
    }

#if (0) {    
   open(MAIL,"|$mailprog -t");
   #open(MAIL,">/tmp/let");

    print MAIL "To: $Config{'recipient'}\n";
    print MAIL "From: \"$Config{'realname'}\" <info>\n";

    print MAIL "MIME-Version: 1.0\n";
    
	unless ($html_par) {
    		print MAIL "Content-Type: text/plain; $chs\r\n";
	} else {
    		print MAIL "Content-Type: text/html; $chs\r\n";
	} 
    
    print MAIL "Content-Transfer-Encoding: 8bit\r\n";

    print MAIL "Subject: $subj\r\n";

    print MAIL $mes."\r\n";

    close (MAIL);
#}

 }

}

sub make_date { #33

my $addedtime = shift;
my $t; my $this_;
    ($thissec,$thismin,$thishour,$mday,$mon,$thisyear,$t,$t,$t) = gmtime(time+$addedtime);
    $mon++;
	my $month = $months[$mon];
	     $month = $$month if $$month;
    $thisyear += 1900;
    $current_date = "$mday $month $thisyear";
    $current_date = "$month $mday, $thisyear" if ($language eq "english");

    if ($mday >= 10 && $mon >= 10 ) { $this_ = "$mon/$mday";}
    elsif ($mon >= 10) { $this_ = "$mon/0$mday";}
    elsif ($mday >= 10) { $this_ = "0$mon/$mday";}
    else { $this_ = "0$mon/0$mday";}
    
    $thissec = '0'.$thissec if ($thissec < 10);

	$thisdate = "$thisyear/$this_";
    
    if ($thishour >= 10 && $thismin >= 10 ) { $thistime = "$thishour:$thismin";}
    elsif ($thishour >= 10) { $thistime = "$thishour:0$thismin";}
    elsif ($thismin >= 10) { $thistime = "0$thishour:$thismin";}
    else { $thistime = "0$thishour:0$thismin";}
}

sub print_reg_notice { #35

my ($rnum,$srnum,$gifnum) = &rnum_srnum_gifnum(4);

my $mode = 0644;
chmod $mode, "$htdocs/icon/reg/$gifnum.gif";

my $str1 = $language eq "russian" ? koitoutf8("��������� ���� �� ������"): "repeat the password";
my $str2 = $language eq "russian" ? koitoutf8("��� �����"): "new login";
my $str3 = $language eq "russian" ? koitoutf8("��� ������ �����<br>��������� ��������� �����!"): "small letters";
my $str4 = $language eq "russian" ? koitoutf8("������� ���� ���"): "small letters";
my $str5 = $language eq "russian" ? koitoutf8("��� ������ �� 8 ��������"): "password 8+";

print qq{
<html><head>
<meta name="viewport" content="width=device-width, initial-scale=$initial_scale">
};

     print qq{<noscript><meta http-equiv="refresh" content="2; URL=$scriptURL">Enable Javascript!</noscript>
<script language="JavaScript" type="text/javascript">};

     TClubMD5::print_javascript_md5();

print qq{alert('$result_message');} if ($result_message eq $__69 || $result_message eq $__70 || $result_message eq $__71 || $result_message eq $__72);

my $center = $firefox ? "center" : "bottom";
     
     print qq{
</script>
</head><body style="background:url(/img/gd2560d.png) $center left no-repeat #9cf;">
<div id=box_wrapper style="width:100%;text-align:center;padding-top:10px;">
};

print qq{
<div style="padding:10px;font-size:18px;width:180px;margin:10px auto;">$result_message</div>
<form method="post" action=$scriptURL onsubmit="email.value=chkemaillength(email.value); if (user.value) {user.value=chkbadsyms(user.value); user.value=user.value.toLowerCase();}; if (user.value && password1.value && password2.value) { password1.value=chkpasswd(password1.value); password1.value=calcMD5(password1.value+user.value); regcookie.value=password2.value; password2.value=calcMD5(password2.value+user.value);}; return true">
<span style="font-size:24px;text-decoration:underline;line-height:36px;">$str3</span><br><br>
<div id="box_container" style="font-size:24px;padding-bottom:20px;">
	<div id="box1">
	     <div>$str2</div>
     	     	<input style="margin-top:10px;width:240px;line-height:36px;font-size:24px;" type=text name=user value="$vars{user}">
		<input type=hidden name=email value="user_$vars{user}\@thissite.com">
       		<br>
		<span>$str4:</span>
       		<img src=$gifnum_prefix/icon/reg/$gifnum.gif width=90 height=45 style="margin-top:20px;margin-bottom:-15px;" border=0 alt=>
       		<br>
       		<input style="margin-top:10px;width:120px;line-height:36px;font-size:24px;" type=text name=scode value="">
       		<input type=hidden name=srnum value="$srnum"><br>
       		<br>
	</div>
	<div id="box2" style="text-align:center;">
		<div>$str5</div>
		<input type=password name=password1 style="margin-top:10px;width:240px;line-height:36px;font-size:24px;">
		<input type=hidden name=regcookie value="">
		<br><span>$str1</span><br>
		<input type=password name=password2 style="margin-top:10px;width:240px;line-height:36px;font-size:24px;">
		<br><br>
		<span>READY?</span><br><br>
		<p style="background:#9cf;padding:5px;margin:0 auto;width:240px;">
		<input type=submit name=Submit style="margin-top:10px;width:240px;line-height:36px;font-size:24px;" value="GO!">
		</p>
		
	</div>
	<div style="clear:both;"></div>
</div> <!-- box_container -->
</form>
</div> <!-- box_wrapper -->
</body>
</html>
};

}

sub rnum_srnum_gifnum { #38

my $par = shift;

my $rnum = substr(TClubMD5::md5_hex(time()),0,$par);
my $srnum=TClubMD5::md5_hex($rnum);
my $gifnum = substr($srnum,0,$par);


$s_call = 
"/bin/echo $rnum | $pnmdir/pbmtext | $pnmdir/pnmscale 7  | $pnmdir/ppmshift 2 | \
$pnmdir/ppmspread 10 | $pnmdir/pnmscale -ysize 100 -xsize 200| $pnmdir/ppmtogif >$htdocs/icon/reg/$gifnum.gif";
system($s_call);

my $mode = 0644;
chmod $mode, "$htdocs/icon/reg/$gifnum.gif";

return ($rnum,$srnum,$gifnum);

}


sub psupload { #45
	
my ($query, $path, $maxsize, $newname) = @_;
my $k;
my $_chunk = "upload";$_chunk = "pnmprocess" if (!$export_mode);
	

if ($path) {
    	    
if ($query->param('uploaded_file')) {
	my $file = $query->param('uploaded_file');

	my $filename = $file; 
	$filename =~ s/^.*(\\|\/)//;
	$filename =~ s/ +/\_/g;
	$filename = decode_local($filename);

	$filename = $newname if $newname;
	my $badname = $filename;
		
	binmode OUTFILE;
	binmode $file;

	if ($filename =~ /(.*).(jpg)$/i || $filename =~ /(.*).(jpeg)$/i || $filename =~ /(.*).(tif)$/i || $filename =~ /(.*).(gif)$/i 
	|| $filename =~ /(.*).(bmp)$/i || $filename =~ /(.*).(png)$/i){
		$k = "good";
		$filename = ".".$2;
	} else {
		$filename = ".jpg";
	}

if (open(OUTFILE, ">$path/$filename")) {
		
	if($maxsize > 0) {
		if( (-s "$path/$filename") > ($maxsize * 1024)) {
			unlink("$path/$filename");
			return("The uploaded file was too big and has been removed.");
		}
	}

	if ($k eq "good") {
		while (my $bytesread = read($file, my $buffer, 1024)) { 
			print OUTFILE $buffer;
		} 
	} else {
		print OUTFILE "bad image format: $badname";
	}
	close (OUTFILE);
	
	my $mode = 0644;
	chmod $mode, "$path/$filename";

if ($with_trigger) {
	$s_call = "/home2/clients/w_motiva/bin/bol trigger_$_chunk $filename";
	system($s_call);
} else {

	my $anytopnm;

	if ($filename =~ /(.*).jpg$/ || $filename =~ /(.*).JPG$/ || $filename =~ /(.*).jpeg$/ || $filename =~ /(.*).JPEG$/){
		$anytopnm = "jpegtopnm";
	} elsif ($filename =~ /(.*).tif$/ || $filename =~ /(.*).TIF$/){
		$anytopnm = "tifftopnm";
	} elsif ($filename =~ /(.*).gif$/ || $filename =~ /(.*).GIF$/){
		$anytopnm = "giftopnm";
	} elsif ($filename =~ /(.*).bmp$/ || $filename =~ /(.*).BMP$/){
		$anytopnm = "bmptoppm";
	}elsif ($filename =~ /(.*).png$/ || $filename =~ /(.*).PNG$/){
		$anytopnm = "pngtopnm";
	}

	my $newfilename_small = $1."_small.jpg";
	my $newfilename = $1."_large.jpg";

	my $cut_param;

	my $chunk = `$pnmdir/$anytopnm $upload_dir/$filename | $pnmdir/pnmfile`;
	$chunk =~ /(.*)\s(\d*)\sby\s(\d*)\s(.*)/;

	my $xsize = int($2);
	my $ysize = int($3);
	
	my $wdth = 96;

	if ($xsize > 1.3 * $ysize) {
		$cut_param = "$pnmdir/pnmcut -width $wdth -pad |";
	} else {
		$cut_param = '';
	}

	
	$s_call = 
"$pnmdir/$anytopnm $upload_dir/$filename | $pnmdir/pnmscale -xsize $wdth |".$cut_param."$pnmdir/pnmtojpeg >$upload_dir/$newfilename_small";

	system($s_call);

	$ysize=768 if ($ysize > 768);

	$s_call = 
"$pnmdir/$anytopnm $upload_dir/$filename | $pnmdir/pnmscale -ysize $ysize | $pnmdir/pnmtojpeg >$upload_dir/$newfilename";

	$s_call = "$pnmdir/$anytopnm $upload_dir/$filename | $pnmdir/pnmtojpeg >$upload_dir/$newfilename" 
	if ($develop == 12 || $develop >= 14); #no scaling for _large.jpg
	
	system($s_call);

} #no trigger


} else { return("The subroutine could not open the output file: $path/$filename");} #no open

} else {return("The upload form was submitted without a file being uploaded.");} #no uploaded_file

} else {return("The subroutine was not told the absolute path to the directory where the uploaded file should be stored.");} #no path


}

sub start_page { #46

my %Cookies = TClubMD5::GetCookies('MOBILE');

my $pda = $Cookies{'MOBILE'};

if ($check_response_delta) {
my $cmd = "insert into deltas (proj_code, addr, mark, program, eventtype, p_vremya_z, delta) values ('$r_user','$addr','$mark','---',0,current_timestamp,0)";

my $result=$dbconn->prepare($cmd);
$result->execute;
&dBaseError($dbconn, $cmd) if (!defined($result));
}

print STDERR "Here in start_page: user is $r_user, ip is $addr ,cool is $cool_auth_cookies, nologin is $nologin!\n" if ($debug);

if ($debug) {
	print STDERR "wt is $Coo{'wtUser'}, cd is $Coo{'cdAuth'}, Us is $Coo{'User'}, V is $Coo{'v'}!\n";
	print STDERR "pda is $pda, g_e is $gold_eligible, status is $current_status, develop is $develop\n";
}

#print STDERR "Here in start_page - is_admin is $is_admin!\n";

if ($develop == 12 || ($develop == 15 || $develop == 16)) { #hack ash
if ($is_admin || $mycabo_master) {
   unless ($scriptURL =~ /cube\./) {
	if ($softpac eq '5' || $softpac eq '2') {
		
		if ($develop == 12) {
			if ($free_media) {
				&print_system_panel;
			} else {
				&print_video_panel;
			}
		}
		&print_conferences if ($develop == 15);
		&print_system_panel if ($develop == 16);
	} elsif ($softpac eq '3') {
		&print_system_panel_miner;
	} else {
		&print_system_panel if ($develop == 12);
		&print_conferences if ($develop == 15);
		#&print_system_panel if ($develop == 16 && !$multicabo);
		#&print_users_panel if ($develop == 16 && $multicabo);
		&print_users_panel if ($develop == 16);
	}
   } else {

	&print_users_panel;
   }
} else {
	&print_users_panel;
}
  
} elsif ($develop == 14) {
	&print_stockboard_panel(0);
}

} 

sub register_activity {
	my $cmd = "update members set p_vremya_z = current_timestamp, q_last_ip = '$addr', r_last_browser = '$user_agent' where proj_code='$r_user'";

	my $result=$dbconn->prepare($cmd);
	$result->execute;
	&dBaseError($dbconn, $cmd) if (!defined($result));
}

sub print_stockboard_panel {

my $par = shift;
my $add_button_mode = $par == 0 ? "add_ad" : $par == 1 ? "add_member" : "hahaha";
$curr_num_challenges = $curr_num_buyers if ($par == 1);
$curr_num_challenges = $curr_num_sells if ($par == 3);
$curr_num_challenges = $curr_num_mybuys if ($par == 5);

my $filter = defined($query->param('tag')) && ($par eq '5' || $par eq '3') ? $query->param('tag') : '';

#print STDERR "Here tagtable is $tagtable, filter is $filter!\n";

&register_activity unless ($nologin);

print qq{
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
    <link rel="stylesheet" href="/css_cp/fontopensans.css">
    $bubbles_css
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<style>

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}
.mob_nav {color:#222;width:11%;padding:5px 2px;font-size:0.84rem;font-weight:bold;}

.box{
    padding: 15px;
    background: -moz-linear-gradient(top,  rgba(137,255,241,0) 0%, rgba(0,0,0,1) 100%);
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(137,255,241,0)), color-stop(100%,rgba(0,0,0,1)));
    background: -webkit-linear-gradient(top,  rgba(137,255,241,0) 0%,rgba(0,0,0,1) 100%);
    background: -o-linear-gradient(top,  rgba(137,255,241,0) 0%,rgba(0,0,0,1) 100%);
    background: -ms-linear-gradient(top,  rgba(137,255,241,0) 0%,rgba(0,0,0,1) 100%);
    background: linear-gradient(to bottom,  rgba(137,255,241,0) 0%,rgba(0,0,0,1) 100%);
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#0089fff1', endColorstr='#000000',GradientType=0 );
}
.arrs{
display:none;float:left;font-size:24px;font-weight:bold;margin-top:-10px;
}
</style>
};

my $outw_wd = "91%";
my $inw_wd = "96%";

my $upmg = "30px";
my $btmg = "0px";

my $brd = ($squares) ? "0px" : "20px";

#zooming start_page_love
my $html_z = "1.3";
#my $html_zoom = "html {text-align:center;zoom: $html_z;-moz-transform: scale($html_z);-webkit-transform: scale($html_z);transform: scale($html_z);}";
$html_zoom = '';

my $bg = &rad_grad('#c6e2ff','#def',50);
print qq{
<style>
$html_zoom
body {padding: 0; margin: 0; text-align: center; background: $wrapper_colors[0];} 
div#wrapper {width: $outw_wd;margin:0 auto;text-align:center;padding:1px;border:0px solid #222;}
div#inwrapper {width:$inw_wd; margin:10px;padding:5px;border-color:#828282;border-width:0px;border-style:dotted;}
</style>
} if ($touch_specific_bro);

my $vali = ($par == 4 || $par == 6) ? "middle" : "top";

print qq{
<style>
body {padding: 0; margin: 0; text-align: center; background: #fff;} 
div#wrapper {position:absolute;display:table;width: 100%;height:70%;background: #fff}
div#inwrapper {width:$inw_wd; margin:0 auto;padding:0px;display:table-cell;vertical-align:$vali; background: #fff}
</style>
} unless ($touch_specific_bro);

print qq{
<link rel="stylesheet" href="/css_cp/generic.css" type="text/css" media="screen" />
<style>
	.postControlsBottom .bottomDiv {
		width:100%;
	}
	.tags {
		!width:350px;
		font-size:11px;
		color:#555;
		float:right;
		text-align:right;
		background-color:transparent;
		margin-bottom:5px;
		white-space:nowrap;
	}
	.tags .tag {
		padding: 3px;
		background-color:#ffff77;
		border-radius:5px;
		margin: 2px;
		font-size:12px;
		z-index: 1;
	}
	.tags .tag, a:link {
		color: #555;
	}
	.tags {
		width:100%;
		font-size:16px;
		color:#555;
	}
	.tagged {
		color: #222;
		font-size:12px;
		margin-top:-5px;
	}
	.postControlsBottom {
		margin:5px 0 -5px 0;
		padding:10px 10px 3px 10px;
		overflow:auto;
		background-color:transparent;
		/* for IE */
		filter:alpha(opacity=80);
		/* CSS3 standard */
		opacity:0.8;
}
	.postControlsBottom .bottomDiv {
		float:left;
		!width:385px;
	}
</style>
	    <script language="JavaScript" type="text/javascript" src="/js_cp/generic.js"></script>			
};

&print_current_moo(1);

unless ($par eq '2' || $par eq '4') { # rich JS needed 

#&print_brainjar_js;
	print q{<script language="JavaScript" type="text/javascript" src="/js_cp/bj.js"></script>
};

#ajax loading additional rows from DB as https://davidwalsh.name/mootools-scrollspy-load and luzeroff.ru

print qq{	    <script type="text/javascript" src="/js_cp/ScrollSpy.js"></script>
};

print q{	    <script language="JavaScript" type="text/javascript" src="/js_cp/moo_no_lightbox.js"></script>
};

print q{	    <script language="JavaScript" type="text/javascript" src="/js_cp/resplendid.js"></script>
};

&print_mbox if ($mBox);

print qq{

<script>

function testScroll(ev){
    if(window.pageYOffset >= 800 && \$('scroll_y_handle') && \$('scroll_y_handle').style.display == 'none') \$('scroll_y_handle').style.display = 'block';
    if(window.pageYOffset < 800 && \$('scroll_y_handle') && \$('scroll_y_handle').style.display == 'block') \$('scroll_y_handle').style.display = 'none';
    
    if(window.pageYOffset >= 800 && \$('scroll_r_handle') && \$('scroll_r_handle').style.display == 'none') \$('scroll_r_handle').style.display = 'block';
    if(window.pageYOffset < 800 && \$('scroll_r_handle') && \$('scroll_r_handle').style.display == 'block') \$('scroll_r_handle').style.display = 'none';
	if (\$('log_spinning') && \$('log_spinning').style.display == 'block') {var counterRect = \$('ncha_div').getBoundingClientRect();var lst = counterRect.top-$crt; 
	\$('log_spinning').setStyles({'top' :  lst});}
}
window.onscroll=testScroll;
</script>
};

my $ac1 = $chk[2]."?who=".$r_user."&token=".$token;
my $touch_specific_bro = 0; #hack ash

print qq{
<script>

var counter=0;
var action1='$ac1';

var idle=1;
var n_cur_cha = '$curr_num_challenges';
var n_cur_hsum = '$curr_hashsum';

var scr = '/';
var touch = $touch_specific_bro;
var num_cur_challenges=$curr_num_challenges;
var num_open_cha = $ncha_limit;
var num_order = $num_order;

var num_offers = [
};

for (my $i=0;$i<$num_sports;$i++) {

	if ($par eq '0') { #stock
		print $num_offers[$i];
	} elsif ($par eq '1') { #buyers
		print $num_buyers[$i];
	} elsif ($par eq '3') { #sells
		print $num_sells[$i];
	} elsif ($par eq '5') { #mybuys
		print $num_mybuys[$i];
	}
	print ',' unless ($i == $num_sports-1);
} #end for

print qq{ ];
var current_sport = $curr_sport;
var curr_sport_label = '$sport_labels{$curr_sport}';

var type = $par; //type == 0 challenges; type = 1 members; type = 3 sells;
var to_sort;
var from_interact = 0;//setting it to 1 onclick submit from ajax boxes
var zeros = 1;// zeros are one when arros down in sort -- hack ash

var selrow = 0;
var desiredPosts = 2;

var start = $ncha_limit;
var limit = $ncha_limit;
};

if (length($tag)) {
print qq {var tag = '$tag';};
} else {
print qq {var tag = "";};
}

print qq {

var tagtable = $tagtable;
var come_here;

var beginning = 1;

var who = '$r_user';
var tok = '$token';

</script>
};

print qq{
<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(55188343, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>

<noscript><div><img src="https://mc.yandex.ru/watch/55188343" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<script>
Locale.use('ru-RU');

</script>
};

print qq{
<script>
var action_a = "$scriptname?mode=hide_record&coid=";
var action_c = "$scriptname?mode=color_chal&coid=";

function hide_record (oid) {

		var form_a = document.createElement("form");
		form_a.setAttribute("method", "get");
		form_a.setAttribute("id", "myForm_hide_challenge");
		document.body.appendChild(form_a);
		
		var log = \$('marker_'+oid).empty();
					
		\$('myForm_hide_challenge').action = action_a + oid;
		\$('myForm_hide_challenge').set('send', {onComplete: function(response) {
			
			check_response(response);
			log.set('html', response);
			
		var counterRect = \$('ncha_div').getBoundingClientRect();
		
		var a = counterRect.left-71;var b = counterRect.top-15;
		
			var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
			\$('log_spinning').setStyles({'position': pos });
			\$('log_spinning').setStyles({'left': a });	
			\$('log_spinning').setStyles({'top': b });
			\$('log_spinning').setStyles({'display': 'block' });
			\$('log_spinning').fade(1);
			r(current_sport,num_open_cha,num_order,type,tag,tagtable);
			\$('myForm_list_challenges').send();
		}});
		\$('myForm_hide_challenge').send();
		\$('myForm_hide_challenge').dispose();

}


function color_record (oid) {
		var form_c = document.createElement("form");
		form_c.setAttribute("method", "get");
		form_c.setAttribute("id", "myForm_color_challenge");
		document.body.appendChild(form_c);
		
		var log = \$('color_'+oid).empty();
					
		\$('myForm_color_challenge').action = action_c + oid;
		\$('myForm_color_challenge').set('send', {onComplete: function(response) {			
			check_response(response);
			log.set('html', response);
		
			var counterRect = \$('ncha_div').getBoundingClientRect();
			
			var a = counterRect.left-71;var b = counterRect.top-15;
			
			var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
			\$('log_spinning').setStyles({'position': pos });
			\$('log_spinning').setStyles({'left': a });	
			\$('log_spinning').setStyles({'top': b });
			\$('log_spinning').setStyles({'display': 'block' });
			\$('log_spinning').fade(1);
			r(current_sport,num_open_cha,num_order,type,tag,tagtable);
			\$('myForm_list_challenges').send();
		}});
		\$('myForm_color_challenge').send();
		\$('myForm_color_challenge').dispose();

}
</script>
} if ($is_admin);


my $z = koitoutf8("��������..");
my $lh = "var counterRect = \$('ncha_div').getBoundingClientRect();var a = counterRect.left-210;var b = counterRect.top+60;";

print qq{	
<script>

var a = (screen.width/2)-$x_screen_offset;
var b = (screen.height/2)-$y_screen_offset;
var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';

var counter=0;
var action1='$ac1&cat=$curr_sport';
var idle = 1;
		
Native.implement([Element, Window, Document, Events], {
	oneEvent: function(type, fn) {
		return this.addEvent(type, function() {
			this.removeEvent(type, arguments.callee);
			return fn.apply(this, arguments);
		});
	}
});


(function(\$) {

	window.addEvent('domready', function() {

		var zebraTables = new ZebraTable();
		c(current_sport, desiredPosts, touch, num_order, tag, tagtable);
		
			
			new mBox.Tooltip({
    				setContent: 'data-mBox-tooltip',

				attach: 'pokazat',
				pointer: 'center',
				offset: {y: 3},
				fixed: true,
				fade: {
					open: false,
					close: true
				},
				fadeDuration: 200
			});

	});//domready
})(document.id);

	
window.addEvent('domready', function() {
			
			makeAllSortable();			
			\$\$('.tipz').each(function(element,index) {
				if (element.get('title')) {
					var content = element.get('title').split('::');
					element.store('tip:title', content[0]);
					element.store('tip:text', content[1]);
				}
			});	
			var tipz = new Tips('.tipz',{
				className: 'tipz',
				fixed: true,
				hideDelay: 50,
				showDelay: 50
			});
			
			if (\$('ask_add_ad') && (touch)) {
				\$('ask_add_ad').addEvent('click', function(e) {

					e.stop();
					theString=scr+'?mode=$add_button_mode';
					location.href=theString;

				});			
			}
			$lh
		   	if (\$('ask_add_ad') && !touch) {
				\$('ask_add_ad').addEvent('click', function(e) {

					e.stop();check_my_auth();
					\$('ajax_0').setStyles({'position': pos });
					\$('ajax_0').setStyles({'left': a });
					\$('ajax_0').setStyles({'top': b });
					\$('ajax_0').setStyles({'display': 'block' });
					\$('ajax_0').fade(1);
					\$('container_log_ajax_0').setStyles({'display': 'block' });
					var log_add_ad = \$('_ajax_0').empty().addClass('ajax-loading');
		
					\$('myForm_add_ad').set('send', {onComplete: function(response) { 
					
						check_response(response);			

						log_add_ad.removeClass('ajax-loading');
						log_add_ad.set('html', response);
				}});
				\$('myForm_add_ad').send();
			});
		   	}
			//inside domready
			r(current_sport,num_open_cha,num_order,type,tag,tagtable);
		
		if (\$('myForm2')) \$('myForm2').dispose();
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm2");
		document.body.appendChild(form);	
		\$('myForm2').action = action1;	
		
		\$('myForm2').set('send', {onComplete: function(response) {

		  if (response) {

			var r = response.split('&');
			if (document.getElementById('ncha_div')) n_cur_cha = document.getElementById('ncha_div').innerHTML.toInt();
			if (\$('hashsum')) n_cur_hsum = \$('hashsum').innerHTML.toInt();

			if( typeof r[2] !== 'undefined' && r[2] > 0) {
				if (\$('forum_counter')) {\$('forum_counter').setStyles({'display':'block'});
				\$('forum_counter').innerHTML = '<span style="color:#711">'+r[2]+'\</span>';}
				
			}  else {
				\$('forum_counter').setStyles({'display':'none'});
			}
										
			   if (r[1] != n_cur_hsum) {

				n_cur_cha = r[0];
				n_cur_hsum = r[1];
				
				var counterRect = \$('ncha_div').getBoundingClientRect();

				var a = counterRect.left-71;var b = counterRect.top-15;
			
				var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
				\$('log_spinning').setStyles({'position': pos });
				\$('log_spinning').setStyles({'left': a });	
				\$('log_spinning').setStyles({'top': b });
				\$('log_spinning').setStyles({'display': 'block' });
				\$('log_spinning').fade(1);
				
				//if (typeof zebraTables !== 'undefined') { zebraTables.destruct();}
				\$('myForm_list_challenges').send();

			   }						
		  }
			
		  if (counter < 10000 && idle)  come_here = setTimeout("\$('myForm2').send()",3600);
		  else if ( counter < 100 && !idle)  come_here = setTimeout("\$('myForm2').send()",30000);
		  else {
		  }		

		  counter++;
		  //if (counter > 3) come_here = 1;
			
		}});

		\$('myForm2').send();	
if (\$('sel_bli')) {
	\$('sel_bli').options[\$('sel_bli').selectedIndex].text = curr_sport_label;
	\$('sel_bli').value = $curr_sport;
}

});

</script>
};

} #unless rich JS needed

print qq{
<style>
.mydiv {
  display: inline-block;
  max-height: 720px;
  overflow: auto;
  width:100%;
}

.mytable th {
  position: -webkit-sticky;
  position: sticky;
  top: -1px;
}

.mytable {
  border-collapse: collapse;
  width:100%;
}

.mytable th {
  background-color: #567086;
  !background-color: #1976D2; 
  color: #fff;
  opacity:1;
  height:30px;
  z-index:2;
}

.mytable th,
td {
  padding: 1em .5em;
}

.mytable tr {
  color: #212121;
}

!.mytable tr:nth-child(odd) {
!  background-color: #BBDEFB;
!}
.mytable th:nth-child(1), td:nth-child(1) {width: 20%}
.mytable th:nth-child(2), td:nth-child(2) {width: 25%}
.mytable th:nth-child(3), td:nth-child(3) {width: 20%}
.mytable th:nth-child(4), td:nth-child(4) {width: 20%}
.mytable th:nth-child(5), td:nth-child(5) {width: 15%}
</style>
</head>

<body id="stockboardPage" style="background:transparent;">
};

print qq{
<!--Copyright to Shen Huang, you can reach me out at shenhuang@live.ca-->
<div id = "board"></div>
		<sand></sand>
		<water></water>
		<skymask></skymask>
		<boat>
			<mast></mast>
			<sail></sail>
		</boat>
		<tree>
			<branch></branch>
			<leaf1></leaf1>
			<leaf2></leaf2>
			<leaf3></leaf3>
			<leaf4></leaf4>
			<leaf5></leaf5>
			<leaf6></leaf6>
			<coconut1></coconut1>
			<coconut2></coconut2>
			<coconut3></coconut3>
		</tree>
} if (!$touch_specific_bro && $par eq '4');

print "<div id=\"home\" style=\"background:transparent;\">";
&print_upper_menu($par);

print "<div id=\"wrapper\" style=\"background:transparent;\">";
print "<div id=\"inwrapper\" style=\"background:transparent;\">";

print qq{
<form id="myForm_list_challenges" action="$scriptname?mode=list_challenges" method="get">
</form>	
};

print qq{<div id=log_spinning style="display:none;background:url(/icon/spinning-wheel3.gif) no-repeat center;
position:fixed;top:300px;left:300px;width:200px;height:90px;z-index:2000;"></div>};


unless ($par eq '6' || $par eq '4') {
	unless ($par eq '5' || $par eq '3') {
		print qq{<div id=log_list_controls_container>};
		
		&list_controls($curr_sport,$par,0);
		
		print "</div>";
		
		print qq{<div id=log_list_challenges_container class="mydiv">};

		&list_challenges($curr_sport,$ncha_limit,$par,0);
	
	} else {
		print qq{<div id=log_list_controls_container>};

		&list_controls($curr_sport,$par,0,$filter,$tagtable);
		
		print "</div>";
				
		print qq{<div id=log_list_challenges_container class="mydiv">};

		&list_challenges($curr_sport,$ncha_limit,$par,0,$filter,$tagtable);}
} elsif ($par eq '6') {
	print qq{<div id=log_list_challenges_container class="mydiv">};
	&print_edit_profile;
} else {
#help_panel
	&print_help_forum;
}

print "</div><!-- log_list_challenges_container -->";

print "</div><!-- inwrapper -->";
print "</div><!-- wrapper -->";

&print_styled_ajax_box(0);

print qq{<script src="/js_cp/calendar.js"></script>};

my $curr_sport_local = defined($query->param('cat')) && $is_admin ? $query->param('cat') : -1;
my $not_main = $curr_sport_local >= 0 ? 1 : 0;

print qq {<script>
writeCookie('SPORT',$curr_sport_local);
</script>
} if (isint($curr_sport_local) && $not_main);

my $sportand = (isint($curr_sport_local) && $not_main) ? "&cat=$curr_sport_local" : '';

my $mo = $par == 0 ? "add_ad" : $par == 1 ? "add_member" : "hahaha";
print qq{
	<form id="myForm_add_ad" action="$scriptname?mode=$mo$sportand" method="get">
	</form>
};


print q{
<script>

function getElementsByCondition(condition,container)
{
container = container||document
var all = container.all||container.getElementsByTagName('*')
var arr = []
for(var k=0;k<all.length;k++)
{
var elm = all[k]
if(condition(elm,k))
arr[arr.length] = elm
}
return arr
}
var hidden = getElementsByCondition(
function(el){if(el.className=='zoomgif'){el.style.display='none';return el}}
)

</script>
} unless (($opera && $downgraded ) || $ie);

print qq{
 	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small box"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>
    </div><!-- home -->
    
</body>
</html>
};

}

sub print_upper_menu ($par) {

my $par = shift;

my @href;my @active; my @sronly;

if ($par == 0) {
	@href=("javascript:void();","$scriptname?mode=stockusers_panel","$scriptname?mode=stockpartners_panel","$scriptname?mode=stocksells_panel","$scriptname?mode=stockhelp_panel");
	#@href=("javascript:void();","javascript: function link_users() {type=1; r(current_sport,num_open_cha,num_order,type,tag,0);\$('myForm_list_challenges').send();} link_users();","$scriptname?mode=stockpartners_panel","$scriptname?mode=stocksells_panel","$scriptname?mode=stockhelp_panel");
	@active=(" active", '', '', '', '');
	@sronly=("<span class='sr-only'>(current)</span>",'','','','');

} elsif ($par == 1) {

	@href=("$scriptname?mode=stockboard_panel","javascript:void();","$scriptname?mode=stockpartners_panel","$scriptname?mode=stocksells_panel","$scriptname?mode=stockhelp_panel");
	@active=(''," active",'','','');
	@sronly=('',"<span class='sr-only'>(current)</span>",'','','');

} elsif ($par == 2) {

	@href=("$scriptname?mode=stockboard_panel","$scriptname?mode=stockusers_panel","javascript:void();","$scriptname?mode=stocksells_panel","$scriptname?mode=stockhelp_panel");
	@active=('',''," active",'','');
	@sronly=('','',"<span class='sr-only'>(current)</span>",'','');

} elsif ($par == 3) {

	@href=("$scriptname?mode=stockboard_panel","$scriptname?mode=stockusers_panel","$scriptname?mode=stockpartners_panel","javascript:void();","$scriptname?mode=stockhelp_panel");
	@active=('','',''," active",'');
	@sronly=('','','',"<span class='sr-only'>(current)</span>",'');


} elsif ($par == 4) {

	@href=("$scriptname?mode=stockboard_panel","$scriptname?mode=stockusers_panel","$scriptname?mode=stockpartners_panel","$scriptname?mode=stocksells_panel","javascript:void();");
	@active=('','','',''," active");
	@sronly=('','','','',"<span class='sr-only'>(current)</span>");

} elsif ($par == 5) {

	@href=("$scriptname?mode=stockboard_panel","javascript:void();","$scriptname?mode=stockmyprofile_panel","$scriptname?mode=stockhelp_panel");
	@active=(''," active",'','');
	@sronly=('',"<span class='sr-only'>(current)</span>",'','');

} elsif ($par == 6) {

	@href=("$scriptname?mode=stockboard_panel","$scriptname?mode=stockmybuys_panel","javascript:void();","$scriptname?mode=stockhelp_panel");
	@active=('',''," active",'');
	@sronly=('','',"<span class='sr-only'>(current)</span>",'');

}

my $mob_forum_c = "<div id=forum_counter style=\"padding-bottom:5px;font-size:24px;font-weight:bold;font-style:normal;width:24px;height:24px;border-radius:12px;background:#ff7;float:right;display:none;\"></div>";

my $touch_nav_bar = $touch_specific_bro ? $is_admin ? "<div style=\"padding:3px;width:98%;border:2px #fff solid;text-align:center;margin:20px auto 0px auto;background:#def;\">
<div class=mob_nav style=\"float:left;width:10%;\" onclick=\"location.href='?mode=stockboard_panel';\">$stockboard_menu_str</div>
<div class=mob_nav style=\"float:left;width:12%;\" onclick=\"location.href='?mode=stockusers_panel';\">$u_buyers_menu_str</div>
<div class=mob_nav style=\"float:left;width:8%;\" onclick=\"location.href='?mode=stockpartners_panel';\">$u_patners_menu_str</div>
<div class=mob_nav style=\"float:right;width:14%;\" onclick=\"location.href='?mode=stockhelp_panel';\">$help_menu_str$mob_forum_c</div>
<div class=mob_nav  style=\"float:right;width:14%;\" onclick=\"location.href='?mode=stocksells_panel';\">$u_sells_menu_str</div>
<div style=\"clear:both;\"></div>
</div>" : 
"<div style=\"padding:3px;width:98%;border:2px #fff solid;text-align:center;margin:20px auto 0px auto;background:#def;\">
<div class=mob_nav style=\"float:left;width:10%;\" onclick=\"location.href='?mode=stockboard_panel';\">$stockboard_menu_str</div>
<div class=mob_nav style=\"float:left;width:12%;\" onclick=\"location.href='?mode=stockmybuys_panel';\">$u_buys_menu_str</div>
<div class=mob_nav style=\"float:left;width:10%;\" onclick=\"location.href='?mode=stockmyprofile_panel';\">$u_profile_menu_str</div>
<div class=mob_nav style=\"float:right;width:12%;\" onclick=\"location.href='?Submit=Logout';\">$logout</div>
<div class=mob_nav style=\"float:right;width:12%;\" onclick=\"location.href='?mode=stockhelp_panel';\">$help_menu_str$mob_forum_c</div>
<div style=\"clear:both;\"></div>
</div>" : '';

print qq{
        <nav class="navbar navbar-expand-xl">
	<div class="container h-100">
		<div id="box_a">
};
if ($is_admin) { 	print qq{
					<div><h1 class="tm-site-title mb-0">$xTER</h1>
						<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a>
					</div>
					<div style="font-size:14px;color:#fed;float:top;">$edition</div>
					<div style="clear:all;"></div>
};
} else {
			 print qq{
					<div><h1 class="tm-site-title mb-0">Balance:</h1>
						&nbsp;<span style="color:#fff;">$denga</span><a id="curr_balance_id" style="color:#9cf;margin-top:4px;margin-left:5px;font-weight:bold;font-size:20px;">$curr_balance</a>
					</div>
					<div style="clear:all;"></div>
};
}
print qq{		</div><!-- box_a -->
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link$active[0]" href="$href[0]">
                                <i class="fas fa-tachometer-alt"></i>
                                $stockboard_menu_str
				$sronly[0]
                            </a>
                        </li>
};

my $forum_c = $touch_specific_bro ? '' : "<div id=forum_counter style=\"padding-bottom:5px;font-size:24px;font-weight:bold;font-style:normal;width:24px;height:24px;border-radius:12px;background:#ffff77;float:right;display:none;\"></div>";

print qq {		
			<li class="nav-item">
                            <a class="nav-link$active[1]" href="$scriptname?mode=stockmybuys_panel">
                                <i class="fas fa-shopping-bag"></i>
                                $u_buys_menu_str
				$sronly[1]
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link$active[2]" href="$scriptname?mode=stockmyprofile_panel">
                                <i class="fas fa-file-alt"></i>
                                $u_profile_menu_str
				$sronly[2]
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link$active[3]" href="$scriptname?mode=stockhelp_panel">
                                <i class="fas fa-question-circle">
				$forum_c</i>
                                $help_menu_str
				$sronly[3]
				</a>
                        </li>
} unless ($is_admin);
print qq{
                        <li class="nav-item">
                            <a class="nav-link$active[1]" href="$href[1]">
                                <i class="fas fa-users"></i>
                                $u_buyers_menu_str
				$sronly[1]
                            </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link$active[2]" href="$href[2]">
                                <i class="fas fa-handshake"></i>
                                $u_partners_menu_str
				$sronly[2]
                            </a>
                        </li -->
                        <li class="nav-item">
                            <a class="nav-link$active[3]" href="$href[3]">
                                <i class="fas fa-shopping-bag"></i>
                                $u_sells_menu_str
				$sronly[3]
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link$active[4]" href="$href[4]">
                                <i class="fas fa-question-circle">
				$forum_c</i>
                                $help_menu_str
				$sronly[4]
                            </a>
                        </li>
} if ($is_admin);

my $Juser = nkname_lookup($r_user);

#print STDERR " Here juser is $Juser!\n";

print qq{
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                              $Juser,  <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div><!-- navbarSupportedContent -->
            </div><!-- container h-100 -->

        </nav>$touch_nav_bar
};

}

sub print_video_panel { #0391

if (($softpac ne '5' && $softpac ne '2') || ($free_media && $develop != 16) ){
print qq{
<!DOCTYPE html>
<html lang="en">

<head>
</head>
<body>
<script>
var yon = window.confirm('This is FREE EDITION! Please UPGRADE to HOME EDITION');if (yon) {window.location.href='/cgi/genc/cp?mode=nw_panel';};
</script>
</body>
};
exit;
}

my $ret = `sudo /usr/local/bin/cp_new.sh`;

my $EM_STR = `cat /etc/sysconfig/interfaces.new | grep MAIL | awk -F '=' '{print \$2}'`; $EM_STR =~ s/(\r|\n)//g; $EM_STR = "a\@b.com" unless (length($EM_STR));
my $SMS_STR = `cat /etc/sysconfig/interfaces.new | grep SMS | awk -F '=' '{print \$2}'`; $SMS_STR =~ s/(\r|\n)//g; $SMS_STR="7(999)9999999" unless (length($SMS_STR));

my $notify_me_at = $language eq "russian" ? koitoutf8("���������� � ��������") : "Notify me at";$notify_me_at = "email";
my $notification = $language eq "russian" ? koitoutf8("<= �������� � �������� =>") : ": <= email <= Notify => sms => :"; $notification = "&nbsp;<br>" if ($touch_specific_bro);
my $pushbutton = $language eq "russian" ? koitoutf8("������� ������") : "PUSH button TO BEGIN";
my $spisok = $language eq "russian" ? koitoutf8("�������� �������") : "watch recorded videos";
my $zapis = $language eq "russian" ? koitoutf8("������ ������ �����") : "record new video";
my $od = $language eq "russian" ? koitoutf8("�������� ��������") : "object detection";
my $hd720 = $language eq "russian" ? koitoutf8("��������� ����� � ����") : "save stream to file";
my $strim = $language eq "russian" ? koitoutf8("����-�����") : "live stream";

my $default_object = "person";

my @str = split('\n', `v4l2-ctl --list-devices | grep USB`);
my $USB_STR1 = length($str[0]) ? $str[0] : "CAMERA1 IS NOT PLUGGED";
my $USB_STR2 = length($str[1]) ? $str[1] : "CAMERA2 IS NOT PLUGGED";

my $usb_bgr1 = length($str[0]) ? '' : "background:url(/img/usb.png) center center no-repeat #435c70;";
my $usb_bgr2 = length($str[1]) ? '' : "background:url(/img/usb.png) center center no-repeat #435c70;";


my $cam1_started_type = 0;
my $cam2_started_type = 0;

my $cam1_started_indicator = int(`/usr/local/bin/check_od.sh 1`);
my $cam1_started = $cam1_started_indicator > 0 ? 1 : 0;

unless ($cam1_started) {
	$cam1_started = int(`sudo /usr/local/bin/check_stream.sh 1 1`);
	$cam1_started_type = 1 if ($cam1_started);
}

unless ($cam1_started) {
	$cam1_started = int(`sudo /usr/local/bin/check_stream.sh 1 2`);
	$cam1_started_type = 2 if ($cam1_started);
}

unless ($cam1_started) {
	$cam1_started = int(`sudo /usr/local/bin/check_stream.sh 1 3`);
	$cam1_started_type = 3 if ($cam1_started);
}

my $cam2_started_indicator = int(`/usr/local/bin/check_od.sh 2`);
my $cam2_started = $cam2_started_indicator > 0 ? 1 : 0;

unless ($cam2_started) {
	$cam2_started = int(`sudo /usr/local/bin/check_stream.sh 2 1`);
	$cam2_started_type = 1 if ($cam2_started);
}

unless ($cam2_started) {
	$cam2_started = int(`sudo /usr/local/bin/check_stream.sh 2 2`);
	$cam2_started_type = 2 if ($cam2_started);
}

unless ($cam2_started) {
	$cam2_started = int(`sudo /usr/local/bin/check_stream.sh 2 3`);
	$cam2_started_type = 3 if ($cam2_started);
}

my $left_start1 = $cam1_started ? "class=\"left_start_dimmed round_button\"": length($str[0]) ? "class=\"left_start round_button\" onclick=\"if (not_started1) {\$('embedded_video1').setStyles({'visibility':'hidden'});\$('f1').setStyles({'visibility':'visible'});start_od(1,0);}\"" : "class=\"left_start_dimmed round_button\"";
my $left_start_rec1 = $cam1_started ? "class=\"left_start_dimmed round_button\"": length($str[0]) ? "class=\"left_start round_button\" onclick=\"if (not_started1) {\$('embedded_video1').setStyles({'visibility':'hidden'});\$('f1').setStyles({'visibility':'visible'});start_od(1,1);}\"" : "class=\"left_start_dimmed round_button\"";
my $left_start_stream1 = $cam1_started ? "class=\"left_start_dimmed round_button\"": length($str[0]) ? "class=\"left_start round_button\" onclick=\"if (not_started1) {\$('embedded_video1').setStyles({'visibility':'hidden'});\$('f1').setStyles({'visibility':'visible'});start_od(1,2);}\"" : "class=\"left_start_dimmed round_button\"";
my $left_start_hd1 = $cam1_started ? "class=\"left_start_dimmed round_button\"": length($str[0]) ? "class=\"left_start round_button\" onclick=\"if (not_started1) {\$('embedded_video1').setStyles({'visibility':'hidden'});\$('f1').setStyles({'visibility':'visible'});start_od(1,3);}\"" : "class=\"left_start_dimmed round_button\"";
my $left_start_view1 = $cam1_started ? "class=\"left_start_dimmed round_button\"": "class=\"left_start round_button\"";

my $left_start2 = $cam2_started ? "class=\"left_start_dimmed round_button\"": length($str[1]) ? "class=\"left_start round_button\" onclick=\"if (not_started2) {\$('embedded_video2').setStyles({'visibility':'hidden'});\$('f2').setStyles({'visibility':'visible'});start_od(2,0);}\"" : "class=\"left_start_dimmed round_button\"";
my $left_start_rec2 = $cam2_started ? "class=\"left_start_dimmed round_button\"": length($str[1]) ? "class=\"left_start round_button\" onclick=\"if (not_started2) {\$('embedded_video2').setStyles({'visibility':'hidden'});\$('f2').setStyles({'visibility':'visible'});start_od(2,1);}\"" : "class=\"left_start_dimmed round_button\"";
my $left_start_stream2 = $cam2_started ? "class=\"left_start_dimmed round_button\"": length($str[1]) ? "class=\"left_start round_button\" onclick=\"if (not_started2) {\$('embedded_video2').setStyles({'visibility':'hidden'});\$('f2').setStyles({'visibility':'visible'});start_od(2,2);}\"" : "class=\"left_start_dimmed round_button\"";
my $left_start_hd2 = $cam2_started ? "class=\"left_start_dimmed round_button\"": length($str[1]) ? "class=\"left_start round_button\" onclick=\"if (not_started2) {\$('embedded_video2').setStyles({'visibility':'hidden'});\$('f2').setStyles({'visibility':'visible'});start_od(2,3);}\"" : "class=\"left_start_dimmed round_button\"";
my $left_start_view2 = $cam2_started ? "class=\"left_start_dimmed round_button\"": "class=\"left_start round_button\"";

my $right_stop1 = $cam1_started ? "class=\"right_stop round_button\" onclick='stop_od(1,$cam1_started_type);'" : "class=\"right_stop_dimmed round_button\"";
my $right_stop2 = $cam2_started ? "class=\"right_stop round_button\" onclick='stop_od(2,$cam2_started_type);'" : "class=\"right_stop_dimmed round_button\"";

my $right_stop1a = $cam1_started ? "class=\"right_stop\"" : "class=\"right_stop_dimmed\"";
my $right_stop2a = $cam2_started ? "class=\"right_stop\"" : "class=\"right_stop_dimmed\"";

my $frame1_dimmed_style = $cam1_started ? "background: url(/icon/spinning-wheel3.gif) center center no-repeat;" : "visibility:hidden;";
my $frame2_dimmed_style = $cam2_started ? "background: url(/icon/spinning-wheel3.gif) center center no-repeat;" : "visibility:hidden;";

my $disp1 = $cam1_started ? "display:none;" : length($str[0]) ? "position:absolute;" : "display:none;";
my $disp2 = $cam2_started ? "display:none;" : length($str[1]) ? "position:absolute;" : "display:none;";

my $header_str = $video_menu_str;

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<a class=mob_nav href='/cgi/genc/cp?mode=system_panel'>$info_menu_str</a>
<span class=mob_nav_active>$video_menu_str</span>
$logs_menu_mob
$users_menu_mob
<a class=mob_nav href='/cgi/genc/cp?mode=nw_panel'>$settings_menu_str_short</a>
<!-- a class=mob_nav href='/cgi/genc/cp?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='/?Submit=Logout'>$logout</a>
</div>" : '';

my $hashcam1 = `ps aux | grep mjpeg_serve3.py |  grep -v grep | awk '{print \$14}'`;$hashcam1 =~ s/\n//g;$hashcam1 =~ s/\r//g;
$hashcam1 = length($hashcam1) ? $hashcam1 : "cam";

#another try
if ($hashcam1 eq "cam") {
$hashcam1 = `sleep 1 && ps aux | grep mjpeg_serve3.py |  grep -v grep | awk '{print \$14}'`;$hashcam1 =~ s/\n//g;$hashcam1 =~ s/\r//g;
$hashcam1 = length($hashcam1) ? $hashcam1 : "cam";
}

my $hashcam2 = `ps aux | grep mjpeg_serve4.py |  grep -v grep | awk '{print \$14}'`;$hashcam2 =~ s/\n//g;$hashcam2 =~ s/\r//g;
$hashcam2 = length($hashcam2) ? $hashcam2 : "cam";

#another try
if ($hashcam2 eq "cam") {
$hashcam2 = `sleep 1 && ps aux | grep mjpeg_serve4.py |  grep -v grep | awk '{print \$14}'`;$hashcam2 =~ s/\n//g;$hashcam2 =~ s/\r//g;
$hashcam2 = length($hashcam2) ? $hashcam2 : "cam";
}


$my_ip .= $suffix 
#if ($http_prefix eq "http")
;#hack ash

my $video1_str = "$http_prefix://$my_ip/od1/$hashcam1.mjpg";
my $video2_str = "$http_prefix://$my_ip/od2/$hashcam2.mjpg";

#===
if ($hashcam1 eq "cam") {
	$hashcam1 = `ps aux | grep ffmpeg_old1 |  grep -v grep |  grep -v cpulimit | awk '{print \$24}'`;
	$hashcam1 =~ s/(\r|\n)//g;$hashcam1 =~ s/\.ffm/\.webm/g;
	
	$hashcam1 =~ s/http/https/g if ($http_prefix eq "https");
	
	#unless ($http_prefix eq "http") { #hack ash
		$hashcam1 =~ s/:8086/\/stream1/g;
	#} else {
	#	$hashcam1 =~ s/:8086/$suffix\/stream1/g;	
	#}
	
	$hashcam1 =~ s/$int_ip/$my_ip/g;
	$hashcam1 = length($hashcam1) ? $hashcam1 : "cam";
	$video1_str = "$hashcam1";
}

if ($hashcam1 eq "cam") {
	$hashcam1 = `ps aux | grep ffmpeg_veryold1 |  grep -v grep |  grep -v cpulimit | awk '{print \$36}'`;
	$hashcam1 =~ s/(\r|\n)//g;$hashcam1 =~ s/\.ffm/\.mpeg/g;
	
	$hashcam1 =~ s/http/https/g if ($http_prefix eq "https");
	
	#unless ($http_prefix eq "http") { #hack ash
		$hashcam1 =~ s/:8086/\/stream1/g;
	#} else {
	#	$hashcam1 =~ s/:8086/$suffix\/stream1/g;	
	#}
	
	$hashcam1 =~ s/$int_ip/$my_ip/g;
	$hashcam1 = length($hashcam1) ? $hashcam1 : "cam";
	$video1_str = "$hashcam1";
}

if ($hashcam1 eq "cam") {
	$hashcam1 = `ps aux | grep ffmpeg1 |  grep -v grep | grep -v cpulimit | awk '{print \$26}'`;$hashcam1 =~ s/(\r|\n)//g;$hashcam1 =~ s/\/opt\/nvme\/videos\///g;
	$hashcam1 = length($hashcam1) ? $hashcam1 : "cam";
	$video1_str = $cam1_started && $cam1_started_type != 1  ? '' : "/cgi/genc/cp?mode=list_rec_files&cam=1&file=$hashcam1";
}
#===
	my $vdisp1 = $cam1_started && $cam1_started_type != 1 ? '' : "display:none;";

#===
if ($hashcam2 eq "cam") {
	$hashcam2 = `ps aux | grep ffmpeg_old2 | grep -v grep |  grep -v cpulimit | awk '{print \$24}'`;
	$hashcam2 =~ s/(\r|\n)//g;$hashcam2 =~ s/\.ffm/\.webm/g;

	$hashcam2 =~ s/http/https/g if ($http_prefix eq "https");
	
	#unless ($http_prefix eq "http") { #hack ash
		$hashcam2 =~ s/:8087/\/stream2/g;
	#} else {
	#	$hashcam2 =~ s/:8087/$suffix\/stream2/g;	
	#}
	
	$hashcam2 =~ s/$int_ip/$my_ip/g;
	$hashcam2 = length($hashcam2) ? $hashcam2 : "cam";
	$video2_str = "$hashcam2";
}

if ($hashcam2 eq "cam") {
	$hashcam2 = `ps aux | grep ffmpeg_veryold2 | grep -v cpulimit | grep -v grep | awk '{print \$36}'`;
	$hashcam2 =~ s/(\r|\n)//g;$hashcam2 =~ s/\.ffm/\.mpeg/g;
	
	$hashcam2 =~ s/http/https/g if ($http_prefix eq "https");
	
	#unless ($http_prefix eq "http") { #hack ash
		$hashcam2 =~ s/:8087/\/stream2/g;
	#} else {
	#	$hashcam2 =~ s/:8087/$suffix\/stream2/g;	
	#}
	
	$hashcam2 =~ s/$int_ip/$my_ip/g;
	$hashcam2 = length($hashcam2) ? $hashcam2 : "cam";
	$video2_str = "$hashcam2";
}

if ($hashcam2 eq "cam") {
	$hashcam2 = `ps aux | grep ffmpeg2 |  grep -v grep |  grep -v cpulimit | awk '{print \$26}'`;$hashcam2 =~ s/(\r|\n)//g;$hashcam2 =~ s/\/opt\/nvme\/videos\///g;
	$hashcam2 = length($hashcam2) ? $hashcam2 : "cam";
	$video2_str = $cam2_started && $cam2_started_type != 1 ? '' : "/cgi/genc/cp?mode=list_rec_files&cam=2&file=$hashcam2";	
}
#===
my $video2_str_i = $cam2_started && $cam2_started_type != 1 ? '' : "/videos/1_20190527_18:09_46.webm";

my $vdisp2 = $cam2_started && $cam2_started_type != 1 ? '' : "display:none;";
		
my $mt = $touch_specific_bro ? "0px" : "0px";

my $wi = $touch_specific_bro ? "100%" : "100%";
my $wi1 = $touch_specific_bro ? "100%" : "100%";
my $wi2 = $touch_specific_bro ? "99%" : "99%";
my $wi3 = $touch_specific_bro ? "98%" : "98%";
my $wi4 = $touch_specific_bro ? "99%" : "99%";

my $mr = $touch_specific_bro ? "margin-right:-20px;" : '';
my $fl = $touch_specific_bro ? "float:left;" : '';
my $mmt = $touch_specific_bro ? "-10px" : "10px";
my $mywi = $touch_specific_bro ? "80vw" : "512px";

my $last_photo = `ls -Art /var/www/html/cp/pu*/tmp/db_images/ | tail -n 1`;
$last_photo =~ s/(\r|\n)//g;
#print STDERR "Here last_photo is $last_photo!\n";
print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
    <link rel="stylesheet" href="/css_cp/fontopensans.css">
<style>
#working {
text-align:center;
margin:60px auto 10px auto;
width:510px;
font-size:18px;
}
#delay_counter1, #delay_counter2 {
width:510px;
color:#fee;
font-size:44px;
font-weight:bold;
text-align:center;
margin:5px auto;
border:0px solid #fff;
}
.left_start {
float:left;margin-left:30px;color:#fee;cursor:pointer;text-decoration:underline;
}
.right_stop {
float:right;margin-right:30px;color:#fee;cursor:pointer;text-decoration:underline;
}
.left_start_dimmed {
float:left;margin-left:30px;color:#fee;opacity:0.5;display:none;
}
.right_stop_dimmed {
float:right;margin-right:30px;color:#fee;opacity:0.5;display:none;
}
.usb_info {
color:#369;font-size:14px;font-family:Courier;margin-bottom:5px;
}
.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}
.mob_nav {color:#ccc;width:15%;padding:5px 2px;}

.round_button {
background:#fee;
opacity:0.5;
color:#369;
border-radius:7px;
cursor:pointer;
margin:5px;
padding:7px;
}
.link1 {
color:#9cf;
text-edcoration:underline;
cursor:pointer;
float:right;
}

.ic {
margin-left:0px;
width:96px;
}

.bubble {
	z-index : 999;
	position : absolute;
	border-radius : 50%;
	font-family:Open Sans;
	font-size:18px;
	color:#000;
	padding-top:36px;
}
#showtime {
	z-index : 999;
	position : absolute;
	border-radius : 50%;

	text-align:center;
	font-family:Open Sans;
	font-size:24px;
	color:#222;
	opacity:0.8;
	
	visibility:hidden;
	display: table;
}

#sht_mid {
  display: table-cell;
  vertical-align: middle;
}

#sht_div {

	width:140px;
	margin:0 auto;
	color:#fff;
}

</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(55188343, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/55188343" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
	
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>
<script>

var ajaxed = $ajaxed;
var not_started1 = 1;
var not_started2 = 1;

var default_object = '$default_object';
var default_action = 1;
var default_photo = '<img src=db_images/$last_photo style="width:$wi4;">';
var current_object = default_object;
var current_action = default_action;
var current_photo = '';

var delay_counters = [0,0,0];

function check_response(response) {

	var r = new RegExp('DOCTYPE HTML PUBLIC','ig');
	if (typeof(response) != 'undefined' && response != null && response.match(r)) {
		document.body.style.opacity='0.05';
		alert('Authorization Required');
		(function(){location.href='/cgi/genc/cp?mode=login';}).delay(1000);
		return;
	}
}

function start_od(n,type) {

		\$('f'+n).innerHTML='<div style="width:$mywi;"><div style="width:100%;margin:20px auto;" id=working>$working</div><div style="width:100%;margin:0 auto;" id=delay_counter'+n+'></div></div>';
		
		\$('od_left_start_'+n).setStyles({'display': 'none' });
		\$('od_left_start_rec'+n).setStyles({'display': 'none' });
		\$('od_left_start_stream'+n).setStyles({'display': 'none' });
		\$('od_left_start_hd'+n).setStyles({'display': 'none' });
		\$('od_left_view'+n).setStyles({'display': 'none' });
		
		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_start_od');
		document.body.appendChild(form);	
		document.getElementById('myForm_start_od').action = '/cgi/genc/cp?mode=start_od&n='+n+'&type='+type;		
		document.getElementById('myForm_start_od').set('send', {onComplete: function(response) { 
			check_response(response);
			if (n == 1) {not_started1 = 0;delay_counters[1] = 0;}
			if (n == 2) {not_started2 = 0;delay_counters[2] = 0;}			
		}});	
		document.getElementById('myForm_start_od').send();
		document.getElementById('myForm_start_od').dispose();
		
		sendForm2(n,type);
}

function stop_od(n,type) {
		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_stop_od');
		document.body.appendChild(form);	
		document.getElementById('myForm_stop_od').action = '/cgi/genc/cp?mode=stop_od&n='+n+'&type='+type;		
		document.getElementById('myForm_stop_od').set('send', {onComplete: function(response) { 
			check_response(response);
			if (n == 1) {not_started1 = 1;delay_counters[1] = 0;}
			if (n == 2) {not_started2 = 1;delay_counters[2] = 0;}			
			
			location.reload();
		}});	
		document.getElementById('myForm_stop_od').send();
		document.getElementById('myForm_stop_od').dispose();
		return false;
}

function sendForm1() {
				
		if (\$('myForm1')) \$('myForm1').dispose();
		var form1 = document.createElement("form");
		form1.setAttribute("method", "get");
		form1.setAttribute("id", "myForm1");
		document.body.appendChild(form1);
		\$('myForm1').action = '$scriptURL/cgi/genc/cp?mode=print_events&obj='+current_object;
		\$('myForm1').set('send', {
			$ie_no_cache onComplete: function(response) {

				check_response(response);

				if (response) {	

					var log2 = \$('log_events_container').empty();
					log2.set('html', response);
					
					var upphoto  = response.split('--');
					var new_photo = '<'+upphoto[1]+'>';
					if (new_photo !== current_photo) {
						\$('f3').set('html',new_photo);
						current_photo = new_photo;
					}
					
				}

				to_set = setTimeout(sendForm1,$ajval);
			}
		});

	\$('myForm1').send();
}

function sendForm2(par,type) {
				
		if (\$('myForm2')) \$('myForm2').dispose();
		var form2 = document.createElement("form");
		form2.setAttribute("method", "get");
		form2.setAttribute("id", "myForm2");
		document.body.appendChild(form2);
		\$('myForm2').action = '/cgi/genc/cp?mode=check_streaming&cam='+par+'&type='+type;
		\$('myForm2').set('send', {
			$ie_no_cache onComplete: function(response) {

				check_response(response);
				
				var dly = type == 0 ? 2000 : 500;

				if (response > 0) {		
					\$('delay_counter'+par).innerHTML='..OK..';
					(function() {location.href='/cgi/genc/cp?mode=video_panel';}).delay(dly);

				} else {
					\$('delay_counter'+par).innerHTML='..'+delay_counters[par]+'..';
					delay_counters[par] += 1;
					(function() {to_set = setTimeout(sendForm2(par,type),$ajval);}).delay(2000);
					
				}

				
			}
		});

	\$('myForm2').send();
}

function js_change_value(f) {
		
		
		var i = 'input_' + f;		
		var s = 'show_' + f;
		
		var v = document.getElementById(i).value;
		if (f != 7 && f != 8) document.getElementById(s).innerHTML = v;

		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_au");

		document.body.appendChild(form); 
		\$('myForm_au').action = '/cgi/genc/cp?mode=js_change_value&par='+f+'&val='+v;
		\$('myForm_au').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				data_needs_saving = 1;			
		}});
		\$('myForm_au').send();
		\$('myForm_au').dispose();
}

function ValidateSMSNumber(str) {

str = str.replace(/[+]/g, '');
  if (/^[(]{0,1}[0-9]{1,3}[)]{0,1}[-\s\./0-9]*\$/.test(str)) {  
    return (true)  
  }  
  alert("invalid value of phone number!")  
  return (false)
}

function ValidateEmail(email) {
    if (/^[^\s\@]+\@[^\s\@]+\.[^\s\@]+\$/.test(String(email).toLowerCase())) {
    return (true)  
  }  
  alert("invalid value of email!")  
  return (false)
}
				
Locale.use('ru-RU');
	
window.addEvent('domready', function(){
	if (ajaxed) to_set = setTimeout(sendForm1,$ajval);
	\$('f3').set('html',default_photo);
	\$('embedded_video2').setStyles({'visibility':'visible'});
	\$('f2').setStyles({'visibility':'hidden'});
	//\$('vifr2').contentWindow.location.href='$video2_str_i';	
});

</script>
</head>

<body id="videoPage" style="background:url(/img/bluesky.jpg) center center repeat-y #eee;"$onlo>
    <div id="home">
        <nav class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                    <div><div><h1 class="tm-site-title mb-0">$xTER</h1>
			<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a></div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div><div style="clear:all;"></div></div>
			
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link" href="/cgi/genc/cp?mode=system_panel">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="javascript:void(0);">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                                <span class="sr-only">(current)</span>
                            </a>
                        </li>
                        $logs_menu
			$users_menu
                        <li class="nav-item">
                            <a class="nav-link" href="/cgi/genc/cp?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                            </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="/cgi/genc/cp?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                Admin, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div class="container" style="margin-top:$mmt;">
            <div class="row">
                <div class="col">
                    <!-- p class="text-white mt-5 mb-5"><b>$header_str</b></p --><br>
                </div>
            </div>
            <div class="row tm-content-row">
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col"><span class=usb_info>$USB_STR1</span>
                    <div class="tm-bg-primary-dark tm-block" style="padding-left:15px;padding-top:15px;$usb_bgr1">
		      <div style="margin-top:0px;">
			<span id=od_left_start_stream1 $left_start_stream1 style="float:right;">LIVE</span>
			<span id=od_left_start_hd1 $left_start_hd1 style="float:right;">HD720</span>
			<span id=od_left_start_1 $left_start1 style="float:right;">OD</span>
			<span id=od_left_start_rec1 $left_start_rec1 style="float:right;">REC</span>
			<span id=od_left_view1 onclick="\$('embedded_video1').setStyles({'visibility':'visible'});\$('f1').setStyles({'visibility':'hidden'});\$('vifr1').contentWindow.location.href='$video1_str';" $left_start_view1 style="float:right;">VIEW</span>
			<div $right_stop1a style="margin-top:$mt;"><a href='$video1_str' target=new class=link1 style="font-size:12px;margin-left:5px;$vdisp1">$video1_str</a><span $right_stop1>STOP</span></div>
		      </div>
		      <div id=f1 style="text-align:center;width:60%;white-space:nowrap;font-size:18px;margin:120px auto;color:#eee;$disp1">$pushbutton:
		      	<ul style="font-size:16px;float:right;margin-top:10px;text-align:left;padding-top:20px;$mr"><li>VIEW: $spisok</li><li>REC: $zapis</li><li>OD: $od</li><li>HD720: $hd720</li><li>LIVE: $strim</li></ul>
		      </div>
		      <p style="width:$wi;height:360px;overflow:hidden;text-align:center;margin:0px auto;padding-left:16px;padding-top:12px;float:bottom;$frame1_dimmed_style" id=embedded_video1>
			<iframe id=vifr1 src="$video1_str" height="360" style="border-width:0px;color:transparent;text-align:center;margin:0px auto;width:$wi;"></iframe>
		      </p>		
                    </div>
		    <div style="text-align:left;margin-top:6px;">
			<span style="margin:0px auto 0px auto;color:#369;">CAMERA 1</span>
		    </div>	
                </div>
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col"><span class=usb_info>$USB_STR2</span>
                    <div class="tm-bg-primary-dark tm-block" style="padding-left:15px;padding-top:15px;$usb_bgr2">
		      <div style="margin-top:0px;">
			<span id=od_left_start_stream2 $left_start_stream2 style="float:right;">LIVE</span>
			<span id=od_left_start_hd2 $left_start_hd2 style="float:right;">HD720</span>
			<span id=od_left_start_2 $left_start2 style="float:right;">OD</span>
			<span id=od_left_start_rec2 $left_start_rec2 style="float:right;">REC</span>
			<span id=od_left_view2 onclick="\$('embedded_video2').setStyles({'visibility':'visible'});\$('f2').setStyles({'visibility':'hidden'});\$('vifr2').contentWindow.location.href='$video2_str';" $left_start_view2 style="float:right;">VIEW</span>
		        <div $right_stop2a style="margin-top:$mt;"><a href='$video2_str' target=new class=link1 style="font-size:12px;margin-left:5px;$vdisp2">$video2_str</a><span $right_stop2>STOP</span></div>
		      </div>
		      <div id=f2 style="text-align:center;width:60%;white-space:nowrap;font-size:18px;margin:72px auto;color:#eee;$disp2">$pushbutton:
		      	<ul style="font-size:16px;float:right;margin-top:10px;text-align:left;padding-top:20px;$mr"><li>VIEW: $spisok</li><li>REC: $zapis</li><li>OD: $od</li><li>HD720: $hd720</li><li>LIVE: $strim</li></ul>
		      </div>
		      <p style="width:$wi;height:360px;overflow:hidden;text-align:center;margin:0px auto;padding-left:16px;padding-top:12px;float:bottom;$frame2_dimmed_style" id=embedded_video2>
			<iframe id=vifr2 src="$video2_str" height="360" style="border-width:0px;color:transparent;text-align:center;margin:0px auto;width:$wi1;"></iframe>
		      </p>
                    </div>
		    <div style="text-align:right;margin-top:6px;">
			<span style="margin:0px auto 0px auto;color:#369;">CAMERA 2</span>
		    </div>
                </div>
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col">
                    <div id=f3 class="tm-bg-primary-dark tm-block tm-block-taller" style="padding-top:54px;">
		    	<div style="background:transparent;width:240px;margin:90px auto;height:90px;color:#9cf;text-align:center;padding-top:20px;">$hover_mouse</div>                       
                    	</div>
                </div>
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col">
                    <div class="tm-bg-primary-dark tm-block tm-block-taller tm-block-overflow" style="padding-top:30px;">
                        <div style="width:$wi2;margin-bottom:5px;">
				<h2 class="tm-block-title" style="float:left;">$journal_events OD</h2>
				<div id=f4>
};

&print_od_header($default_object);

print qq{</div><!-- f4 -->
				<div style="width:$wi3;margin-left:0px;margin-top:-15px;margin-bottom:5px;font-size:14px;float:right;text-align:center;">
					<span style="float:none;text-align:center;margin:-5px auto 0px auto;font-size:14px;color:#fff;">$notification</span>
					<span id=show_11 style="width:120px;font-weight:normal;color:#222;float:left;cursor:pointer;background:#fed;padding:0px 2px;" onclick="\$('show_11').setStyles({'display':'none'});\$('input_11').setStyles({'display':'block'});\$('input_11').focus();">$EM_STR</span>
					<input id=input_11 class=ic style="display:none;float:left;margin-top:-5px;padding:0px 2px;text-align:right;" type=text value='$EM_STR' onblur="\$('input_11').setStyles({'display':'none'});\$('show_11').setStyles({'display':'block'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateEmail(this.value)) {var yon = window.confirm('Change email?!');if (yon) {js_change_value(11);\$('input_11').setStyles({'display':'none'});\$('show_11').setStyles({'display':'block'});}}}">
					<span id=show_12 style="font-weight:normal;color:#222;float:right;cursor:pointer;background:#fed;padding:0px 2px;margin-right:10px;" onclick="\$('show_12').setStyles({'display':'none'});\$('input_12').setStyles({'display':'block'});\$('input_12').focus();">+$SMS_STR</span>
					<input id=input_12 class=ic style="display:none;float:right;margin-top:-5px;padding:0px 2px;text-align:right;margin-right:20px;" type=text value='$SMS_STR' onblur="\$('input_12').setStyles({'display':'none'});\$('show_12').setStyles({'display':'block'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSMSNumber(this.value)) {var yon = window.confirm('Change sms number?!');if (yon) {js_change_value(12);\$('input_12').setStyles({'display':'none'});\$('show_12').setStyles({'display':'block'});}}}">
		    			<!-- span style="float:right;color:#fff;">sms:&nbsp;</span --><div style="clear:both;"></div>
				</div>
				<div style="clear:both;"></div>
			</div>
                        <div class="tm-notification-items" style="height:300px;overflow:auto;" id=log_events_container>
};

&print_events($default_object);

print qq{
                        </div>
                    </div>
                </div>
            </div>
        </div>
	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>
    </div>
};

if ($demo_mode && !$touch_specific_bro) {
#if ($demo_mode) {
print qq{
	<div id = "board"></div>
	<div id="showtime" onclick="if (gbi) gbi = setInterval(generateBubbles, 7000);this.style.visibility='hidden';"><div id=sht_mid><div id=sht_div></div></div></div>
</body>
<script language="JavaScript" type="text/javascript" src="/js_cp/mybubbles.js"></script>
</html>
};
} else {
print qq{
</body>
</html>
};
}

}

sub print_od_header {

var $obj = shift;

$comm = "select monitor_type from objects where object = '$obj'";
&getTable;

my $selobj = $obj;
my $selobj_mon_t = ${${$listresult}[0]}[0];

my @mon_t = (1,2,3); @mon_t = &xDel($selobj_mon_t,@mon_t);

my $log = $language eq "russian" ? koitoutf8("���") : "log";
my $target_object = $language eq "russian" ? koitoutf8("���") : "object";
my $target_action = $language eq "russian" ? koitoutf8("���") : "action";

my %_labels = ('1'=>$log,'2'=>"email",'3'=>"sms");


$comm = "select object, monitor_type from objects where monitored = 't' and object != '$obj' order by confidence desc";
getTable;

my @unselobjs = ();my @unselobjs_mon_t = ();

for (my $i=0;$i < $ntuples; $i++) {
	push @unselobjs, ${${$listresult}[$i]}[0];
	push @unselobjs_mon_t, ${${$listresult}[$i]}[1];
}

print qq{			
				<div style="float:right;margin-right:5px;color:#9cf;font-weight:bold;margin-top:-5px;">
					<select name=selaction onChange="var old_action=current_action;current_action=this.value;var yon = window.confirm('Change action for object '+current_object+'?!');if (yon) {var form = document.createElement(\'form\');form.setAttribute(\'method\', \'get\');form.setAttribute(\'id\', \'myForm_change_action\');document.body.appendChild(form);\$(\'myForm_change_action\').action = \'$scriptname?mode=change_action&obj='+current_object+'&act=\'+this.value;\$(\'myForm_change_action\').set(\'send\', {onComplete: function(response) {check_response(response);}});\$(\'myForm_change_action\').send();\$(\'myForm_change_action\').dispose();} else {this.value=old_action;}"><option value=$selobj_mon_t>$_labels{$selobj_mon_t}
};
			foreach my $cline (@mon_t) {

				print "<OPTION VALUE=\"$cline\">$_labels{$cline}";
			}

print qq{					
					</select>
				</div>
				<div style="float:right;margin-right:10px;color:#fed;font-size:12px;margin-top:-5px;">$target_action:</div>
			
				<div style="float:right;margin-right:5px;color:#9cf;font-weight:bold;margin-top:-5px;">
					<select name=selobj onChange="current_object=this.value;var form = document.createElement(\'form\');form.setAttribute(\'method\', \'get\');form.setAttribute(\'id\', \'myForm_change_object\');document.body.appendChild(form);\$(\'myForm_change_object\').action = \'$scriptname?mode=change_object&obj=\'+this.value;\$(\'myForm_change_object\').set(\'send\', {onComplete: function(response) {check_response(response); \$('f4').set('html',response);}});\$(\'myForm_change_object\').send();\$(\'myForm_change_object\').dispose();">
					<option value=$selobj>$selobj
};
			foreach my $cline (@unselobjs) {

				print "<OPTION VALUE=\"$cline\">$cline";
			}
print qq{
					</select>
				</div>
				<div style="float:right;margin-right:10px;color:#fed;font-size:12px;margin-top:-5px;">$target_object:</div>
};

}

sub print_ur {

my $dev = (-b "/dev/nvme0n1p1") ? " /dev/nvme0n1p1" : (-b "/dev/sda1") ? " /dev/sda1" : '';

	my $str = `/bin/uptime`;
	$str =~ s/\,/<br>/g;
	my $str1 = $with_sensors ? `/bin/sensors | grep Core | awk '{print \$1 \$2 \$3}'` : '';
	$str1 = "No sensors" unless length($str1);
	$str1 =~ s/\n/<br>/g;
	my $str2 = `df /$dev`;
	$str2 =~ s/\n/<br>/g;
	my $str3 = `free`;
	$str3 =~ s/\n/<br>/g;
	my $str4 = `sudo /usr/local/bin/ps.sh | grep nobody | grep -v grep`;
	$str4 =~ s/\n/<br>/g;
#hack --ash
$str4 =~ s/tutorial/prod/g;
$str4 =~ s/GroupCall/Chat/g;
$str4 =~ s/groupcall/chat/g;	
	print $str."MSK".$str1."MSK".$str2."MSK".$str3."MSK".$str4;
}

sub print_ur_miner {

my $dev = (-b "/dev/nvme0n1p1") ? " /dev/nvme0n1p1" : (-b "/dev/sda1") ? " /dev/sda1" : '';

	my $ethmi_grep_str = `sudo /usr/local/bin/ps.sh | grep ethminer | grep -v grep | awk '{print \$17}' | grep -v sed`;
	my $str = length($ethmi_grep_str) ? "MINING TO: ".$ethmi_grep_str : "NO MINING";
	
	$str =~ s/\,/<br>/g;
	my $str1 = $with_sensors ? `/bin/sensors | grep Core` : '';
	$str1 =~ s/\n/<br>/g;
my $FANS_STR = $with_sensors ? `/bin/sensors | grep fan | grep -v cpu` : '';
$FANS_STR =~ s/\n/<br>/g;
my $TEMP_STR = $with_sensors ? `/bin/sensors | grep temp | grep -v core` :'';
$TEMP_STR =~ s/\n/<br>/g;
	$str1 = "Temp: ".$TEMP_STR
	#."<br>Fans: ".$FANS_STR
	;
	my $str2 = `df /$dev`;
	$str2 =~ s/\n/<br>/g;
	my $str3 = `free`;
	$str3 =~ s/\n/<br>/g;
	#my $str4 = `ps aux`;
	my $str4 = `sudo /usr/local/bin/tail_ethminer_log.sh  | sed /^stack/d | sed /acktrace/d | sed /^SIG/d | sed /lib64/d | sed /local/d | sed /available/d | sed /sufficient/d`;
	$str4 =~ s/\n/<br>/g;
	$str4 = "LOG IS EMPTY" unless length($str4);

	my $str5 = `sudo /usr/local/bin/ps.sh | grep bin/gexp | grep -v val | grep -v grep | awk  '{print \$19}'`;
	$str5 =~ s/\n/<br>/g;
	$str5 =  length($str5) ? "gexp on port $str5" : "gexp NOT RUNNING";

	my $str6 = `sudo /usr/local/bin/ps.sh | grep bin/pirl | grep -v val | grep -v grep | awk  '{print \$19}'`;
	$str6 =~ s/\n/<br>/g;
	$str6 =  length($str6) ? "pirl on port $str6" : "pirl NOT RUNNING";

	my $str7 = `sudo /usr/local/bin/ps.sh | grep bin/geth | grep -v val | grep -v grep | awk  '{print \$16}'`;
	$str7 =~ s/\n/<br>/g;
	$str7 =  length($str7) ? "geth on port $str7" : "geth NOT RUNNING";
			
	print $str."MSK".$str1."MSK".$str2."MSK".$str3."MSK".$str4."MSK".$str5."MSK".$str6."MSK".$str7;
}

sub print_events {

my $obj = shift;

my $localtime = $language eq "russian" ? koitoutf8("������� �����") : "Local Time";
my $appeared_in = $language eq "russian" ? koitoutf8("�������� � ����") : "appeared in";
my $disappeared_from = $language eq "russian" ? koitoutf8("������ �� ����") : "disappeared from";
my $registered_in = $language eq "russian" ? koitoutf8("��� �������") : "registered in";

&make_date($gmtimeshift);

my $onclick = $touch_specific_bro ? "onclick" : "onmouseover";
	
	$comm = "select t, events.object, snapshot, camera, event_type from events,objects where events.object = '$obj' and events.object = objects.object and objects.monitored = 't' order by t desc limit 10";
	&getTable;

my $wi4 = $touch_specific_bro ? "99%" : "99%";

if ($ntuples) {
	print qq {<!--img src=db_images/${${$listresult}[0]}[2] style="width:$wi4"-->};
	for (my $i=0;$i < $ntuples; $i++) {

		my $t = ${${$listresult}[$i]}[0];
		my $ob = ${${$listresult}[$i]}[1];
		my $pho = ${${$listresult}[$i]}[2];
		my $ca = ${${$listresult}[$i]}[3];
		my $et = ${${$listresult}[$i]}[4];
		
		my $app = $et == 1 ? $appeared_in : $et == 2 ? $disappeared_from : $registered_in;

		print qq {
                            <div class="media tm-notification-item" $onclick="\$('f3').set('html','<img src=db_images/$pho style=width:$wi4;>');">
                                <div class="tm-gray-circle"><img src="/img/tb.jpg" class="rounded-circle"></div>
                                <div class="media-body">
                                    <p class="mb-2"><b>$ob</b> $app <a href="javascript:void(0);" class="tm-notification-link">camera $ca</a>.</p>
                                    <span class="tm-small tm-text-color-secondary">\@$t</span>
                                </div>
                            </div>
		};
	} #end for
} else {
		my $ca = "ANY";
		print qq {
                            <div class="media tm-notification-item" $onclick="\$('f3').set('html','');">
                                <div class="tm-gray-circle"><img src="/img/tb.jpg" class="rounded-circle"></div>
                                <div class="media-body">
                                    <p class="mb-2"><b>$ob</b> $app <a href="javascript:void(0);" class="tm-notification-link">camera $ca</a></p>
                                    <span class="tm-small tm-text-color-secondary">NEVER DETECTED</span>
                                </div>
                            </div>
		};
}
}

sub print_system_panel {

my $dev = (-b "/dev/nvme0n1p1") ? " /dev/nvme0n1p1" : (-b "/dev/sda1") ? " /dev/sda1" : '';

my $UR_STR = `/bin/uptime`;
$UR_STR =~ s/\,/<br>/g;

my $TEMP_STR = $with_sensors ? `/bin/sensors | grep Core | awk '{print \$1 \$2 \$3}'` : '';
$TEMP_STR =~ s/\n/<br>/g;
$TEMP_STR = "&nbsp;<br>&nbsp;" unless length($TEMP_STR);

#my $PS_STR = `sudo /usr/local/bin/ps.sh`;
my $PS_STR = `ps aux | grep nobody`;
$PS_STR =~ s/\n/<br>/g;

#hack --ash
$PS_STR =~ s/tutorial/prod/g;
$PS_STR =~ s/GroupCall/Chat/g;
$PS_STR =~ s/groupcall/chat/g;

my $DU_STR = `df /$dev`;
$DU_STR =~ s/\n/<br>/g;

my $FREE_STR = `free`;
$FREE_STR =~ s/\n/<br>/g;

my $header_str = $language eq "russian" ? koitoutf8("���������� � �������") : "System Information";

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<span class=mob_nav_active>$info_menu_str</span>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob
$users_menu_mob
<a class=mob_nav href='$scriptname?mode=nw_panel'>$settings_menu_str_short</a>
<!-- a class=mob_nav href='$scriptname?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : '';

my $scrw =  defined($Cookies{'ScreenResW'}) && length($Cookies{'ScreenResW'}) ? $Cookies{'ScreenResW'} : 0;
my $scrwstr = "if (screen.width != $scrw) writeCookie('ScreenResW', screen.width);";

my $a1 = $touch_specific_bro || 1 ? "width:100%" : "min-width:1120px";
my $a2 = $touch_specific_bro || 1? "width:100%" : "width:1120px";
#my $a3 = $touch_specific_bro ? "width:100%" : "width:960px";
my $a3 = "width:100%";

my $ml3 = $touch_specific_bro ? "195px" : "174px";

my $fl = $touch_specific_bro ? '' : "float:left;";
my $fr = $touch_specific_bro ? '' : "float:right;";

my $bpos = $touch_specific_bro ? "relative" : "absolute";
my $bbot = $touch_specific_bro ? "-20px" : "16px";
my $bbotf = $touch_specific_bro ? "-20px" : "8px";

my $bwi = $touch_specific_bro ? "100%" : "48%";
my $maxhi = $touch_specific_bro ? "min-height:70%;height:70%;" : '';
my $mabo = $touch_specific_bro ? "0px" : "0px";
my $mato = $touch_specific_bro ? "-54px" : "0px";
my $matoriha = $touch_specific_bro ? "10px" : "10px";
my $matomilo = $touch_specific_bro ? "60px" : "10px";
my $fanmato = $touch_specific_bro ? "-5px" : "5px";
my $fanmabo = $touch_specific_bro ? "5px" : "5px";
my $ogr = $touch_specific_bro ? "max-height:36px;overflow:auto;" : '';
my $pabo = $touch_specific_bro ? "5%" : "0px";
my $minhi = $touch_specific_bro ? "360px" : "240px";
my $spa = $touch_specific_bro ? '' : "<div class='row'><div class='col'><br><br></div></div>";
my $repi = $touch_specific_bro ? "top center repeat-y" : "center center no-repeat";
my $sti = $touch_specific_bro ? " style='margin-top:10px;'" : '';
my $reboo = $free_media || $not_so_free_media ? "Restart KMS" : "Reboot";
my $shutdo = $free_media || $not_so_free_media ? "Stop KMS" : "Shutdown";
my $do_shutdo = $free_media || $not_so_free_media? " stop KMS" : " shutdown";

my $sty_lim120 = $free_media ? " style=\"max-height:120px;overflow:auto;\"" : '';
my $sty_lim90 = $free_media ? " style=\"max-height:90px;overflow:auto;\"" : '';
my $sty_lim60 = $free_media ? " style=\"max-height:60px;overflow:auto;\"" : '';

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
<style>
.ctrl_btn {
width:$ml3;
height:30px;
line-height:20px;
font-size:16px;
color:#9cf;
font-weight:bold;
padding:3px;
border:1px solid #fee;
margin:5px auto;
text-align:center;
position:$bpos;
bottom:$bbot;
cursor:pointer;
}

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}
.mob_nav {color:#ccc;width:15%;padding:5px 2px;}


#log_ur_container, #log_du_container, #log_temp_container, #log_free_container, #log_ps_container {
font-size:12px;
font-family:Courier;
color:#fffeee;
}
</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<link rel="stylesheet" href="/css_cp/generic.css">
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/generic.js"></script>
};

&print_mbox if ($mBox);

&print_centered_ajax_box("hi_res");
&print_drago;

print qq{
<script>

var ajaxed = $ajaxed;

function toggleZoomScreen() {
        document.body.style.zoom = "90%";
        console.log('100%');
        alert('Please Zoom Out the Page with Ctrl-');
}

function check_response(response) {

	var r = new RegExp('DOCTYPE HTML PUBLIC','ig');
	if (typeof(response) != 'undefined' && response != null && response.match(r)) {
		document.body.style.opacity='0.05';
		alert('Authorization Required');
		(function(){location.href='$scriptname?mode=login';}).delay(1000);
		return;
	}
}

function js_ctrl(par) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_ctrl');
		document.body.appendChild(form);	
		document.getElementById('myForm_js_ctrl').action = '$scriptname?mode=js_ctrl&par='+par;		
		document.getElementById('myForm_js_ctrl').set('send', {onComplete: function(response) { 
			check_response(response);
		}});	
		document.getElementById('myForm_js_ctrl').send();
		document.getElementById('myForm_js_ctrl').dispose();
		
		if (par != 0 && par != 6) (function() {location.reload();}).delay(1000);
}

function sendForm() {
	\$('myForm1').send();
}

function sendForm1() {
				
		if (\$('myForm1')) \$('myForm1').dispose();
		var form1 = document.createElement("form");
		form1.setAttribute("method", "get");
		form1.setAttribute("id", "myForm1");
		document.body.appendChild(form1);
		\$('myForm1').action = '$scriptURL?mode=print_ur';
		\$('myForm1').set('send', {
			$ie_no_cache onComplete: function(response) {

				check_response(response);

				if (response) {
					
					var log1 = \$('log_ur_container').empty();
					var log2 = \$('log_temp_container').empty();
					var log3 = \$('log_du_container').empty();
					var log4 = \$('log_free_container').empty();
					var log5 = \$('log_ps_container').empty();
					var r = response.split('MSK');
					log1.set('html', r[0]);
					log2.set('html', r[1]);
					log3.set('html', r[2]);
					log4.set('html', r[3]);
					log5.set('html', r[4]);
				}

				to_set = setTimeout(sendForm1,5000);
			}
		});

	sendForm();
}

function writeCookie(cname,value) {
	var curCookie = escape(cname) + "=" + escape(value) +"; expires=Sat, 01-Jan-2033 00:00:01 GMT;SameSite=None;Secure;"
	document.cookie = curCookie
}

$scrwstr
				
Locale.use('ru-RU');
	
window.addEvent('domready', function(){
	if (ajaxed) to_set = setTimeout(sendForm1,$ajval);	
});
</script>
</head>

<body id="systemPage"  style="#eee;"$onlo>
    <div id="home">
        <nav class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                <div>
			<div><h1 class="tm-site-title mb-0">$xTER</h1>
				<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a>
			</div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div>
			<div style="clear:all;"></div>
		</div>
		<button class="navbar-toggler ml-auto mr-0" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" 
			onclick="toggleZoomScreen()" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars tm-nav-icon"></i>
                </button>
			
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link active" href="javascript:void(0);">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
				
                                <span class="sr-only">(current)</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
			$logs_menu
			$users_menu
                        <li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                            </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                Admin, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div class="container">
		$spa
            <!-- row -->
            <div class="row tm-content-row"$sti>
                <div id=left_half class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="min-width:$miwi;margin:10px auto 20px auto;padding-bottom:$pabo;">
                    <div class="tm-bg-primary-dark tm-block" style="$fl;width:$bwi;$maxhi">
                        <h2 class="tm-block-title">Status</h2>
                        <div id="log_ur_container"$sty_lim90>$UR_STR</div>
};
print qq{
			<div class=ctrl_btn id="reboot_button" onclick="var yon = window.confirm('Really?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });js_ctrl(6);(function() {location.href='$scriptname?mode=system_panel';}).delay(14400);}">$reboo</div>
                    </div>
} if (0);

#ajax form
&print_styled_ajax_box(0);
print qq{
	<form id="myForm_hi_res" action="/cgi/genc/cp?mode=hi_res" method="get"></form>
};

print qq{
			<div class=ctrl_btn id="ask_hi_res">$reboo</div>
                    </div>
};
print qq{
                     <div class="tm-bg-primary-dark tm-block" style="$fr;width:$bwi;margin-bottom:$mabo;margin-top:$mato;$maxhi">
                        <h2 class="tm-block-title"$sti>CPU Temp</h2>
                        <div id="log_temp_container"$sty_lim90>$TEMP_STR</div>

			<div class=ctrl_btn id="shutdown_button" onclick="var yon = window.confirm('Really$do_shutdo?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });js_ctrl(0);(function() {location.href='$scriptname?mode=system_panel';}).delay(3600);}">$shutdo</div>
                    </div>
                </div>
                 <div id=right_half class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="min-width:$miwi;margin: $matoriha auto 20px auto;padding-bottom:$pabo;">
                    
		    <div class="tm-bg-primary-dark tm-block" style="$fl;width:$bwi;$maxhi">
                        <h2 class="tm-block-title">Disk Use</h2>
                        <div id="log_du_container"$sty_lim120>$DU_STR</div>
			
			<div class=ctrl_btn id="cleardisk_button" onclick="var yon = window.confirm('Really delete VIDEOS?!');if (yon) {js_ctrl(1);}">Free Space</div>
                    </div>
                    <div class="tm-bg-primary-dark tm-block" style="$fr;width:$bwi;margin-bottom:$mabo;margin-top:$mato;$maxhi">
                        <h2 class="tm-block-title">Memory Use</h2>
                        <div id="log_free_container">$FREE_STR</div>
			
			<div class=ctrl_btn id="clearmem_button" onclick="var yon = window.confirm('Really clear memory?!');if (yon) {js_ctrl(2);}">Free Mem</div>
                    </div>
                </div>
                <div class="col-12 tm-block-col" style="$a1;min-height:$minhi;">
                    <div class="tm-bg-primary-dark" style="$a2;margin:$matomilo auto;padding:30px 20px 0 20px;min-height:$minhi;" >
                        <!-- h2 class="tm-block-title">Process List</h2 -->
			<div style="$a3;max-height:220px;overflow:auto;text-align:left;padding:0px 0px 30px 20px;" id="log_ps_container">
				$PS_STR
			</div>
                    </div>
                </div>
            </div>
        </div>
	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>
    </div>
</body>
</html>
};

$RET = `killall cp`;
}

sub print_system_panel_miner {

my $dev = (-b "/dev/nvme0n1p1") ? " /dev/nvme0n1p1" : (-b "/dev/sda1") ? " /dev/sda1" : '';

my $ethmi_grep_str = `sudo /usr/local/bin/ps.sh | grep ethminer | grep -v grep | awk '{print \$17}' | grep -v sed`;
my $UR_STR = length($ethmi_grep_str) ? "MINING TO: ".$ethmi_grep_str : "NO MINING";
$UR_STR =~ s/\,/<br>/g;

my $wat2do = length($ethmi_grep_str) ? "STOP" : "START";
my $wat2do_param = length($ethmi_grep_str) ? 14 : 13;

my $FANS_STR = $with_sensors ? `/bin/sensors | grep fan | grep -v cpu` : '';
$FANS_STR =~ s/\n/<br>/g;
my $TEMP_STR = $with_sensors ? `/bin/sensors | grep temp | grep -v core` :'';
$TEMP_STR =~ s/\n/<br>/g;

#my $PS_STR = `sudo /usr/local/bin/ps.sh`;
#my $PS_STR = `ps aux`;
my $PS_STR = `sudo /usr/local/bin/tail_ethminer_log.sh | sed /^stack/d | sed /acktrace/d | sed /^SIG/d | sed /lib64/d | sed /local/d | sed /available/d | sed /sufficient/d`;
$PS_STR =~ s/\n/<br>/g;
$PS_STR = "LOG IS EMPTY" unless length($PS_STR);

#my $DU_STR = `sudo /usr/local/bin/du.sh /opt/nvme/var`;
my $DU_STR = `df /$dev`;
$DU_STR =~ s/\n/<br>/g;

my $BC_STR1 = `sudo /usr/local/bin/ps.sh | grep bin/gexp | grep -v val | grep -v grep | awk  '{print \$19}'`;
$BC_STR1 =~ s/\n/<br>/g;
$BC_STR1 = length($BC_STR1) ? "gexp on port $BC_STR1" : "gexp NOT RUNNING";

my $BC_STR2 = `sudo /usr/local/bin/ps.sh | grep bin/pirl | grep -v val | grep -v grep | awk  '{print \$19}'`;
$BC_STR2 =~ s/\n/<br>/g;
$BC_STR2 = length($BC_STR2) ? "pirl on port $BC_STR2" : "pirl NOT RUNNING";

my $BC_STR3 = `sudo /usr/local/bin/ps.sh | grep bin/geth | grep -v val | grep -v grep | awk  '{print \$16}'`;
$BC_STR3 =~ s/\n/<br>/g;
$BC_STR3 = length($BC_STR3) ? "geth on port $BC_STR3" : "geth NOT RUNNING";

my $FREE_STR = `free`;
$FREE_STR =~ s/\n/<br>/g;

my $coinbase = substr(`sudo /usr/local/bin/read_coinbase.sh`,0, 16)."(...)";

my $pirl_checked = (-f "/tmp/pirl_flag") ?  " checked=checked"  : '';
my $gexp_checked = (-f "/tmp/gexp_flag") ?  " checked=checked"  : '';
my $geth_checked = (-f "/tmp/geth_flag") ?  " checked=checked"  : '';

#$gexp_checked = " checked=checked";

my $header_str = $language eq "russian" ? koitoutf8("���������� � �������") : "System Information";

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<span class=mob_nav_active>$info_menu_str</span>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob
$users_menu_mob
<a class=mob_nav href='$scriptname?mode=nw_panel'>$settings_menu_str_short</a>
<!-- a class=mob_nav href='$scriptname?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : '';

my $scrw =  defined($Cookies{'ScreenResW'}) && length($Cookies{'ScreenResW'}) ? $Cookies{'ScreenResW'} : 0;
my $scrwstr = "if (screen.width != $scrw) writeCookie('ScreenResW', screen.width);";

my $a1 = $touch_specific_bro || 1? "width:100%" : "min-width:1120px";
my $a2 = $touch_specific_bro || 1? "width:100%" : "width:1120px";
#my $a3 = $touch_specific_bro ? "width:100%" : "width:960px";
my $a3 = "width:100%";

my $ml3 = $touch_specific_bro ? "195px" : "174px";

my $fl = $touch_specific_bro ? '' : "float:left;";
my $fr = $touch_specific_bro ? '' : "float:right;";

my $bpos = $touch_specific_bro ? "relative" : "absolute";
my $bbot = $touch_specific_bro ? "-20px" : "16px";
my $bbotf = $touch_specific_bro ? "-10px" : "18px";

my $bwi = $touch_specific_bro ? "100%" : "255px";
my $maxhi = $touch_specific_bro ? "min-height:70%;height:70%;" : '';
my $mabo = $touch_specific_bro ? "0px" : "0px";
my $mato = $touch_specific_bro ? "-45px" : "0px";
my $matol = $touch_specific_bro ? "-102px" : "0px";
my $matoriha = $touch_specific_bro ? "15px" : "10px";
my $matomilo = $touch_specific_bro ? "60px" : "10px";
my $pabo = $touch_specific_bro ? "5%" : "0px";
my $minhi = $touch_specific_bro ? "360px" : "240px";
my $minhei = $touch_specific_bro ? "min-height:360px" : '';
my $spa = $touch_specific_bro ? '' : "<div class='row'><div class='col'><br><br></div></div>";
my $repi = $touch_specific_bro ? "top center repeat-y" : "center center no-repeat";
my $sti = $touch_specific_bro ? " style='margin-top:10px;'" : '';

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
<style>
.ctrl_btn {
width:$ml3;
height:30px;
line-height:20px;
font-size:16px;
color:#9cf;
font-weight:bold;
padding:3px;
border:1px solid #fee;
margin:5px auto;
text-align:center;
position:$bpos;
bottom:$bbot;
cursor:pointer;
}
.ctrl_fan {
width:15%;
text-align:center;
float:left;
cursor:pointer;
padding:5px 0px;
margin: 2px;
color:#9cf;
border: 1px #fff solid;
font-size:14px;
font-weight:bold;
}
.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}
.mob_nav {color:#ccc;width:15%;padding:5px 2px;}


#log_ur_container, #log_du_container, #log_temp_container, #log_free_container, #log_ps_container, #log_bc1_container, #log_bc2_container, #log_bc3_container, #log_cb_container {
font-size:12px;
font-family:Courier;
color:#fffeee;
padding-top:3px;
}
</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>

<script>

var ajaxed = $ajaxed;

var to_set;

function toggleZoomScreen() {
        document.body.style.zoom = "90%";
        console.log('100%');
        alert('Please Zoom Out the Page with Ctrl-');
}

function check_response(response) {

	var r = new RegExp('DOCTYPE HTML PUBLIC','ig');
	if (typeof(response) != 'undefined' && response != null && response.match(r)) {
		document.body.style.opacity='0.05';
		alert('Authorization Required');
		(function(){location.href='$scriptname?mode=login';}).delay(1000);
		return;
	}
}

function js_ctrl(par) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_ctrl');
		document.body.appendChild(form);	
		document.getElementById('myForm_js_ctrl').action = '$scriptname?mode=js_ctrl&par='+par;		
		document.getElementById('myForm_js_ctrl').set('send', {onComplete: function(response) { 
			check_response(response);
		}});	
		document.getElementById('myForm_js_ctrl').send();
		document.getElementById('myForm_js_ctrl').dispose();
		
		if (par != 0 && par != 6 && par != 13 && par != 14 && par != 22 && par != 23 && par != 24 && par != 25 && par != 26 && par != 27) (function() {location.reload();}).delay(1000);
		if (par === 0) (function() {location.reload();}).delay(2400);
}

function toggle_gexp(par) {
	var val = par ? 24 : 25; 
	js_ctrl(val);
	console.log('gexp toggled!');
}

function toggle_pirl(par) {
	var val = par ? 22 : 23; 
	js_ctrl(val);
	console.log('pirl toggled!');
}

function toggle_geth(par) {
	var val = par ? 26 : 27; 
	js_ctrl(val);
	console.log('geth toggled!');
}

function sendForm() {
	\$('myForm1').send();
}

function sendForm1() {
				
		if (\$('myForm1')) \$('myForm1').dispose();
		var form1 = document.createElement("form");
		form1.setAttribute("method", "get");
		form1.setAttribute("id", "myForm1");
		document.body.appendChild(form1);
		\$('myForm1').action = '$scriptURL?mode=print_ur';
		\$('myForm1').set('send', {
			$ie_no_cache onComplete: function(response) {

				check_response(response);

				if (response) {
					
					var log1 = \$('log_ur_container').empty();
					var log2 = \$('log_temp_container').empty();
					var log3 = \$('log_du_container').empty();
					//var log4 = \$('log_free_container').empty();
					var log5 = \$('log_ps_container').empty();
					var log6 = \$('log_bc1_container').empty();
					var log7 = \$('log_bc2_container').empty();
					var log8 = \$('log_bc3_container').empty();
					var r = response.split('MSK');
					log1.set('html', r[0]);
					log2.set('html', r[1]);
					log3.set('html', r[2]);
					//log4.set('html', r[3]);
					log5.set('html', r[4]);
					log6.set('html', r[5]);
					log7.set('html', r[6]);
					log8.set('html', r[7]);
				}

				to_set = setTimeout(sendForm1,5000);
			}
		});

	sendForm();
}

function writeCookie(cname,value) {
	var curCookie = escape(cname) + "=" + escape(value) +"; expires=Sat, 01-Jan-2033 00:00:01 GMT;SameSite=None;Secure;"
	document.cookie = curCookie
}

$scrwstr
				
Locale.use('ru-RU');
	
window.addEvent('domready', function(){
	if (ajaxed) to_set = setTimeout(sendForm1,$ajval);	
});
</script>
</head>

<body id="systemPage"  style="background:url(/img/bluesky.jpg) $repi #eee;"$onlo>
    <div id="home">
        <nav class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                <div>
			<div><h1 class="tm-site-title mb-0">$xTER</h1>
				<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a>
			</div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div>
			<div style="clear:all;"></div>
		</div>
		<button class="navbar-toggler ml-auto mr-0" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" 
			onclick="toggleZoomScreen()" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars tm-nav-icon"></i>
                </button>
					
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link active" href="javascript:void(0);">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                                <span class="sr-only">(current)</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
                        $logs_menu
			$users_menu
                        <li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                            </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                Admin, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div class="container">
		$spa
            <!-- row -->
            <div class="row tm-content-row"$sti>
                <div id=left_half class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="min-width:$miwi;margin:10px auto 20px auto;padding-bottom:$pabo;">
                    <div class="tm-bg-primary-dark tm-block" style="$fl;width:$bwi;$maxhi">
                        <h2 class="tm-block-title">Mining</h2>
                        <div id="log_ur_container">$UR_STR</div>
			<div class=ctrl_btn id="wat2do_button" onclick="var yon = window.confirm('Really $wat2do?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });js_ctrl($wat2do_param);(function() {location.href='$scriptname?mode=system_panel';}).delay(2400);}">$wat2do</div>
                    </div>
                    <div class="tm-bg-primary-dark tm-block" style="$fr;width:$bwi;margin-bottom:$mabo;margin-top:$matol;$maxhi;$minhei">
                        <h2 class="tm-block-title">Temperature</h2>
                        <div style="margin-top:-20px;" id="log_temp_container"><div>Temp: $TEMP_STR</div>
			<!-- div><br>Fans: $FANS_STR</div -->
			</div>
			<div style="position:$bpos;bottom:$bbotf;width:220px;margin-left:0px;">
			<div style="color:#fff;font-size:12px;margin-bottom:5px;">Fan power %:</div>
			<!-- div class=ctrl_fan id="fan_button0" onclick="var yon = window.confirm('Really FAN 5%?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' }); js_ctrl(15);}">5</div -->
			<div class=ctrl_fan id="fan_button1" onclick="var yon = window.confirm('Really FAN 20%?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' }); js_ctrl(16);}">20</div>
			<div class=ctrl_fan id="fan_button2" onclick="var yon = window.confirm('Really FAN 40%?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' }); js_ctrl(17);}">40</div>
			<div class=ctrl_fan id="fan_button3" onclick="var yon = window.confirm('Really FAN 60%?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' }); js_ctrl(18);}">60</div>
			<div class=ctrl_fan id="fan_button4" onclick="var yon = window.confirm('Really FAN 80%?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' }); js_ctrl(19);}">80</div>						
			<div class=ctrl_fan id="fan_button5" onclick="var yon = window.confirm('Really FAN 95%?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' }); js_ctrl(20);}">95</div>						 
			<div class=ctrl_btn style="clear:left;display:none;"></div>
			</div>               
		    </div>
                </div>
                <div id=right_half class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="min-width:$miwi;margin: $matoriha auto 20px auto;padding-bottom:$pabo;">
                    
		    <div class="tm-bg-primary-dark tm-block" style="$fl;width:$bwi;$maxhi">

                        <h2 class="tm-block-title">Blockchain</h2>
			<p id="log_cb_container">current coinbase: $coinbase</p>
			<div>
			<input style="float:left;margin-right:5px;margin-bottom:3px;" type=checkbox$pirl_checked name=pirl_checker onclick="var now = this.checked == 1 ? false : true; var enable = this.checked == 1 ? 'enable' : 'disable'; var yon = window.confirm(enable + ' pirl? hit RENEW to effect');if (yon) {toggle_pirl(this.checked);} else {this.checked=now;}">
                        <div style="float:left;" id="log_bc2_container">
				$BC_STR2			
			</div>
			<div style="clear:left;"></div>
			</div>
			<div>
			<input style="float:left;margin-right:5px;margin-bottom:3px;" type=checkbox$gexp_checked name=gexp_checker onclick="var now = this.checked == 1 ? false : true;var enable = this.checked == 1 ? 'enable' : 'disable'; var yon = window.confirm(enable + ' gexp? hit RENEW to effect');if (yon) {toggle_gexp(this.checked);} else {this.checked=now;}">
                        <div style="float:left;" id="log_bc1_container">
				$BC_STR1			
			</div>
			<div style="clear:left;"></div>
			</div>
			<div>
			<input style="float:left;margin-right:5px;margin-bottom:3px;" type=checkbox$geth_checked name=geth_checker onclick="var now = this.checked == 1 ? false : true;var enable = this.checked == 1 ? 'enable' : 'disable'; var yon = window.confirm(enable + ' geth? hit RENEW to effect');if (yon) {toggle_geth(this.checked);} else {this.checked=now;}">
                        <div style="float:left;" id="log_bc3_container">
				$BC_STR3			
			</div>
			<div style="clear:left;"></div>
			</div>
			<div class=ctrl_btn id="bc_button" onclick="var yon = window.confirm('Really restart daemons?!');if (yon) {js_ctrl(21);}">RENEW</div>
                    </div>
		    
                    <div class="tm-bg-primary-dark tm-block" style="$fr;width:$bwi;margin-bottom:$mabo;margin-top:$mato;$maxhi">
                        <h2 class="tm-block-title">Disk Use</h2>
                        <div id="log_du_container">
				$DU_STR			
			</div>
			<div class=ctrl_btn id="shutdown_button" onclick="var yon = window.confirm('Really shutdown the system?!');if (yon) {\$('systemPage').setStyles({'opacity': 0.5 });\$('systemPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });js_ctrl(0);}">SHUTDOWN</div>
                    </div>
                    <!-- div class="tm-bg-primary-dark tm-block" style="float:right;width:255px;">
                        <h2 class="tm-block-title">Memory Use</h2>
                        <div id="log_free_container">
				$FREE_STR			
			</div>
			<div class=ctrl_btn id="clearmem_button" onclick="var yon = window.confirm('Really clear memory?!');if (yon) {js_ctrl(2);}">Free Mem</div>
                    </div -->
                </div>
                <div class="col-12 tm-block-col" style="$a1;min-height:$minhi;">
                    <div class="tm-bg-primary-dark" style="$a2;margin:$matomilo auto;padding:30px 20px 0 20px;min-height:$minhi;" >
                        <h2 class="tm-block-title">Mining Log</h2>
			<div style="$a3;max-height:220px;overflow:auto;text-align:left;padding:0px 0px 30px 20px;" id="log_ps_container">
				$PS_STR
			</div>
                    </div>
                </div>
            </div>
        </div>
	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>
    </div>
</body>
</html>
};
}

sub print_nw_panel {

#copying settings to tmp_files
my $ret = `sudo /usr/local/bin/cp_new.sh`;

my $ETH0_STR = `cat /etc/sysconfig/interfaces.new | grep \"PRI=\" | awk -F '=' '{print \$2}'`;
my $IF_STR = `cat /etc/sysconfig/interfaces.new | grep \"PRI_IF=\" | awk -F '=' '{print \$2}'`;$IF_STR =~ s/(\r|\n)//g;
my $GW_STR = `cat /etc/sysconfig/interfaces.new | grep \"PRI_GW=\" | awk -F '=' '{print \$2}'`;

#29.05.20 more correct way for complex nets

my $NET_STR = `cat /etc/sysconfig/interfaces.new | grep \"PRI_NET=\" | awk -F '=' '{print \$2}'`;
my $NET1_STR = `cat /etc/sysconfig/interfaces.new | grep \"SEC_NET=\" | awk -F '=' '{print \$2}'`;

my $TURN_STR = `cat /etc/sysconfig/interfaces.new | grep \"TURNSERVER=\" | awk -F '=' '{print \$2}'`;

my $ETH1_STR = `cat /etc/sysconfig/interfaces.new | grep \"SEC=\" | awk -F '=' '{print \$2}'`;
my $GW1_STR = `cat /etc/sysconfig/interfaces.new | grep \"SEC_GW=\" | awk -F '=' '{print \$2}'`;
my $EXT_STR = `cat /etc/sysconfig/interfaces.new | grep EXT | awk -F '=' '{print \$2}'`;
my $WLAN_STR = `cat /etc/sysconfig/interfaces.new | grep WLAN_IP | awk -F '=' '{print \$2}'`;
my $MACADDR_STR = `/sbin/ifconfig $IF_STR | grep "ether " | awk '{print \$2}'`;
my $SSID_STR = `cat /etc/sysconfig/interfaces.new | grep SSID | awk -F '=' '{print \$2}'`;
my $WP_STR = `cat /etc/sysconfig/interfaces.new | grep KEY1 | awk -F '=' '{print \$2}'`;
$WP_STR =~ s/(\r|\n)//g;
my $XP_STR = `cat /etc/sysconfig/interfaces.new | grep KEY2 | awk -F '=' '{print \$2}'`;
$XP_STR =~ s/(\r|\n)//g;
my $KEY6_STR = `cat /etc/sysconfig/interfaces.new | grep KEY6 | awk -F '=' '{print \$2}'`;
$KEY6_STR =~ s/(\r|\n)//g;

my $alx= `cat /etc/kurento/modules/kurento/WebRtcEndpoint.conf.ini | grep alex | awk -F '\@' '{print \$1}'`;
my $with_coturn = length($alx) ? " style='color:#6f6;font-weight:bold;'" : '';
my $with_ext = length($alx) ? '' : " style='color:#6f6;font-weight:bold;'";

my $current_policy = `cat /etc/sysconfig/interfaces.new | grep KEY3 | awk -F '=' '{print \$2}'`;
$current_policy =~ s/\n//g;$current_policy =~ s/\r//g;
my $current_list = $current_policy eq '1' ? "whitelist" : "blacklist";

my $current_http_service = `cat /etc/sysconfig/interfaces.new | grep KEY4 | awk -F '=' '{print \$2}'`;
$current_http_service =~ s/\n//g;$current_http_service =~ s/\r//g;
$current_http_service = $current_http_service eq '1' ? "HTTPS" : "HTTP";

my $cdimmer = $current_http_service eq "HTTP" ? "opacity:0.5;cursor:pointer;color:#def;text-decoration:underline;" : '';
my $ccdimmer = $current_http_service eq "HTTP" ? '' :"opacity:0.5;cursor:pointer;color:#def;text-decoration:underline;";

my $cwarn = $demo_mode ? "DEMO mode: cannot change SERVER_TYPE" : "Changing SERVER_TYPE to HTTPS?";
my $ccwarn = $demo_mode ? "DEMO mode: cannot change SERVER_TYPE" : "Changing SERVER_TYPE to HTTP? Warning: you may find it hard to switch back!";

my $concl = $current_http_service eq "HTTP" ? " onclick=\"var yon = window.confirm('$cwarn');if (yon) {js_ctrl(11);}\"" : '';
my $cconcl = $current_http_service eq "HTTP" ? '' :" onclick=\"var yon = window.confirm('$ccwarn');if (yon) {js_ctrl(12);}\"";
$cconcl = $current_http_service eq "HTTP" ? '' :" onclick=\"alert('Option disabled in this Edition!');\"" if ($free_media || $not_so_free_media || $polka);

my $curr_http_s = $language eq "russian" ? koitoutf8("������") : "Server";

my $curr_hname = $language eq "russian" ? koitoutf8("����") : "Host";
my $curr_cbase = "Coinbase";
my $curr_op_pwd = "Op'Password";
my $curr_mtarget = "Target";

my $DOMAIN_STR = `cat /etc/sysconfig/interfaces.new | grep XTERTECH | awk -F '=' '{print \$2}'`;
$DOMAIN_STR =~ s/\n//g; $DOMAIN_STR =~ s/\r//g;

my $HNAME_STR = `cat /etc/sysconfig/interfaces.new | grep HOSTNAME | awk -F '=' '{print \$2}'`;
$HNAME_STR =~ s/\n//g; $HNAME_STR =~ s/\r//g;

my $CBASE_STR = $softpac eq '3' ? `sudo /usr/local/bin/read_coinbase.sh` : '';
$CBASE_STR =~ s/\n//g; $CBASE_STR =~ s/\r//g;
$CBASE_STR = "your coinbase" unless length($CBASE_STR);

my $MTARGET_STR = $softpac eq '3' ? `sudo /usr/local/bin/read_miner_target.sh` : '';
$MTARGET_STR =~ s/\n//g; $MTARGET_STR =~ s/\r//g;
$MTARGET_STR = "http://127:0.0.1:9656" unless length($MTARGET_STR);

my $bdimmer = $current_policy eq '1' ? "opacity:0.5;cursor:pointer;color:#def;text-decoration:underline;" : '';
my $wdimmer = $current_policy eq '1' ? '' :"opacity:0.5;cursor:pointer;color:#def;text-decoration:underline;";

my $bwarn = $demo_mode ? "DEMO mode: cannot change POLICY" : "Changing POLICY to BLACKLIST?";
my $wwarn = $demo_mode ? "DEMO mode: cannot change POLICY" : "Changing POLICY to WHITELIST?";

my $boncl = $current_policy eq '1' ? " onclick=\"var yon = window.confirm('$bwarn');if (yon) {js_ctrl(8);}\"" : '';
my $woncl = $current_policy eq '1' ? '' :" onclick=\"var yon = window.confirm('$wwarn');if (yon) {js_ctrl(9);}\"";

my $header_str = $settings_menu_str;

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<a class=mob_nav href='$scriptname?mode=system_panel';\">$info_menu_str</a>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob
$users_menu_mob
<span class=mob_nav_active>$settings_menu_str_short</span>
<!-- a class=mob_nav href='$scriptname?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : '';

my $ml1 = $touch_specific_bro ? "20px" : "0px";
my $ml2 = $touch_specific_bro ? "0px" : "-240px";
$ml2 = $touch_specific_bro ? "0px" : "-180px" if ($softpac eq '3');
my $ml3 = $touch_specific_bro ? "195px" : "170px";

my $ml4 = $touch_specific_bro ? "0px" : "-240px";
my $ml5 = $touch_specific_bro ? "0px" : "-300px";

my $default_route = `/usr/sbin/ip route show | grep "default via" | awk '{print \$5}'`; $default_route =~ s/(\r|\n)//g; 
my $mt = $touch_specific_bro ? "0px" : "0px";
my $checked = ''; $checked = " checked=checked" if ($KEY6_STR eq "true");
my $checked_eth1 = ''; $checked_eth1 = " checked=checked" if ($default_route eq "eth1");

my $wifi_check = `/sbin/ifconfig | grep wlan | awk '{print \$2}'`; my $wifi_enabled = $wifi_check =~ /UP/ ?  "enabled" : "disabled";
my $checked_wf = ''; $checked_wf = " checked=checked" if ($wifi_enabled eq "enabled");

#print STDERR "Here default route is $default_route !\n";

my $bg = $touch_specific_bro ? "background:url(/img/bluesky.jpg) center center repeat-y " : '';

my $softpac_display = "block";;
my $hyper = `dmesg | grep Hyper | awk '{print \$3}'`;
$hyper =~ s/(\r|\n)//g;
my $virtual = $hyper eq "Hypervisor" ? 1 : 0;
my $disp = $hyper eq "Hypervisor" ? " style=\"display:none;\"" : '';
$bubbles_css=''; #hack ash

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
    <link rel="stylesheet" href="/css_cp/generic.css">
    $bubbles_css
<style>

.ctrl_btn {
width:$ml3;
height:30px;
line-height:20px;
font-size:16px;
color:#9cf;
font-weight:bold;
padding:3px;
border:1px solid #fee;
margin:15px 0px;
text-align:center;
cursor:pointer;
}

.nw_title, .nw_value, .nw_change {
font-size:12px;
font-family:Courier;
font-weight:bold;
color:#fffeee;
}

.nw_title_mob, .nw_value_mob, .nw_change_mob {
font-size:16px;
font-family:Courier;
font-weight:bold;
color:#fffeee;
}

.nw_value, .nw_change {
font-weight:normal;
}

.nw_change {
margin-left:5px;
font-style:italic;
color:#fffeee;
text-decoration:underline;
cursor:pointer;
}

.show_input_container {
height:24px;
margin-bottom:15px;
}

.show_div {
display:block;
white-space:nowrap;
}

.input_div {
display:none;
white-space:nowrap;
}

.ic {
margin-left:0px;
width:128px;
}

.sc2 {
display:inline;
background:transparent;
font-weight:bold;
color:#9cf;
line-height:32px;
}

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}

.mob_nav {color:#ccc;width:15%;padding:5px 2px;}


.exclam {
color:#f00;
font-weight:bold;
margin:0px 5px 0px 5px;
border-radius:10px;
cursor:pointer;
}

.blips {
font-weight:bold;
color:#9cf;
line-height:32px;
text-align:left;
}

</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
};

print qq{
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/$genericjs"></script>	
};

&print_mbox if ($mBox);

&print_centered_ajax_box("add_certs");
&print_centered_ajax_box("add_png");
&print_centered_ajax_box("add_mp3");
&print_drago;

print qq{
<script>

var ajaxed = $ajaxed;
var data_needs_saving = 0;
var virtual = $virtual;

function toggleZoomScreen() {
        document.body.style.zoom = "90%";
        console.log('100%');
        alert('Please Zoom Out the Page with Ctrl-');
}

function check_response(response) {

	var r = new RegExp('DOCTYPE HTML PUBLIC','ig');
	if (typeof(response) != 'undefined' && response != null && response.match(r)) {
		document.body.style.opacity='0.05';
		alert('Authorization Required');
		(function(){location.href='$scriptname?mode=login';}).delay(1000);
		return;
	}
}

function js_ctrl(par) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_ctrl');
		document.body.appendChild(form);	
		\$('myForm_js_ctrl').action = '$scriptname?mode=js_ctrl&par='+par;		
		\$('myForm_js_ctrl').set('send', {onComplete: function(response) { 
			check_response(response);
		}});	
		\$('myForm_js_ctrl').send();
		\$('myForm_js_ctrl').dispose();
		
		if (par != 0 && par != 4 && par != 6 && par != 21) (function() {location.reload();}).delay(1000);
}

function js_chip(par,ty) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_chip');
		document.body.appendChild(form);
		var str = par == 1 ? btoa(\$('input_7').value) : par == 2 ? btoa(\$('input_8').value) : '';
		
		\$('myForm_js_chip').action = '$scriptname?mode=js_chip&par='+str;		
		\$('myForm_js_chip').set('send', {onComplete: function(response) { 
			check_response(response);
			var nu = typeof(ty) === 'undefined' ? '' : ' - NEW';
			var cli = typeof(ty) === 'undefined' ? '' : ' - then click SAVE';
			var wa = par == 1 ? ' WIFI PASSWORD, WRITE IT DOWN!!' :  par == 2 ? ' ADMIN PASSWORD, WRITE IT DOWN!!!' : '';
			var info = atob(response) + nu + wa + cli;
			if (typeof(ty) === 'undefined') {
				new mBox.Notice({type: 'info',position: {
				x: 'center',
				y: 'center'
				},
				move: false,delayClose: 7000,width: 420, content: info});
			} else {
				new mBox.Modal({
				content: '<div class=centered>'+info+'</div>',
				setStyles: {content: {padding: '25px', lineHeight: 24, margin: '0 auto', fontSize: 20}},
				width:360,
				title: 'Warning',
				attach: 'anchor'
				});
				\$('anchor').fireEvent('click');
			}
			//alert(info);
			
			
		}});	
		\$('myForm_js_chip').send();
		\$('myForm_js_chip').dispose();

}

function toggle_add_edit_box (num,mode) {
			//if ((num == 1 || num == 2 || num == 4) && virtual) return;
			if ((num == 1 || num == 2) && virtual) return;
			
		   \$('show_div_'+num).style.display = mode == 1 ? 'none' : 'block';
		   \$('input_div_'+num).style.display = mode == 1 ? 'block' : 'none';
		   \$('changer_'+num).innerHTML = mode == 1 ? 'Enter' : 'change';
		   
		   if ((num == 3 || num == 4) && mode != 1)  {
		   	new mBox.Notice({type: 'ok', position: {
				x: 'center',
				y: 'center'
			},
			move: false, delayClose: 4000,width: 420, content: "OK please stand by while reloading Kurento"});
			let to = num == 3 ? 7000 : 2000;
			setTimeout(function () {location.reload()}, to)
		   }; // to make colors change
}

function toggle_dh (val) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_dh");

		document.body.appendChild(form); 
		\$('myForm_dh').action = '$scriptname?mode=js_change_value&par=10&val='+val;
		\$('myForm_dh').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				data_needs_saving = 1;			
		}});
		\$('myForm_dh').send();
		\$('myForm_dh').dispose();
}

function toggle_dr (val) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_dr");

		document.body.appendChild(form); 
		\$('myForm_dr').action = '$scriptname?mode=js_change_value&par=16&val='+val;
		\$('myForm_dr').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);		
		}});
		\$('myForm_dr').send();
		\$('myForm_dr').dispose();
}

function toggle_wf (val) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_wf");
console.log('here val is',val)
		document.body.appendChild(form); 
		\$('myForm_wf').action = '$scriptname?mode=js_change_value&par=17&val='+val;
		\$('myForm_wf').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				window.location.reload();		
		}});
		\$('myForm_wf').send();
		\$('myForm_wf').dispose();
		
}

function blinker(par) {
\$('input_'+par).fade(0); (function(){\$('input_'+par).fade(1); toggle_add_edit_box(par,0);}.delay(750));
}

function js_change_value(f) {
		
		var i = 'input_' + f;		
		var s = 'show_' + f;
		
		var v = document.getElementById(i).value;
		if (f != 7 && f != 8) document.getElementById(s).innerHTML = v;

		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_au");

		document.body.appendChild(form); 
		\$('myForm_au').action = '$scriptname?mode=js_change_value&par='+f+'&val='+v;
		\$('myForm_au').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				if (f !== 18) data_needs_saving = 0;			
		}});
		\$('myForm_au').send();
		\$('myForm_au').dispose();
}

function js_edit_bl(type,val) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_edit_bl');
		document.body.appendChild(form);
		
		var str = btoa(val);
		
		\$('myForm_js_edit_bl').action = '$scriptname?mode=js_edit_bl&pol=$current_policy&type='+type+'&str='+str;		
		\$('myForm_js_edit_bl').set('send', {onComplete: function(response) { 
			check_response(response);
			//alert(response);
			
		}});	
		\$('myForm_js_edit_bl').send();
		\$('myForm_js_edit_bl').dispose();
		
}


function ValidateIPaddress(ipaddr,par) {
 if (par > 0) {
  if (/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\$/.test(ipaddr)) {  
    return (true)  
  }  
  alert("invalid IP address!")  
  return (false)
 } else {
 if ( /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\$/.test(ipaddr) || 
 /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\$/.test(ipaddr) ||
 /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\$/.test(ipaddr) ||
 /^([a-zA-Z0-9_][-_a-zA-Z0-9]{0,62}\.)+([a-zA-Z0-9]{1,10})\$/.test(ipaddr) ) {  
    return (true)  
  }  
  alert("invalid IP or domain!")  
  return (false)
 } 
}  

function ValidateSSIDaddress(ssid) {
  if (/^([a-zA-Z0-9_.]+)\$/.test(ssid)) {  
    return (true)  
  }  
  alert("invalid value - only letters/numbers plz!")  
  return (false)  
}

function ValidateURL(url) {
  if (/^([a-zA-Z0-9_\\-.:\/]+)\$/.test(url)) {  
    return (true)  
  }  
  alert("invalid value - only URL symbols!")  
  return (false)  
}

function ValidateDomainName(url) {
  if (/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+\$/.test(url)) {  
    return (true)  
  }  
  alert("invalid value for domain name!")  
  return (false)  
}
				
Locale.use('ru-RU');
	
window.addEvent('domready', function(){
	//if (ajaxed) to_set = setTimeout(sendForm1,$ajval);	
});

window.onbeforeunload = function() {
   if (data_needs_saving == 1) {
       return "Leave the page with unsaved data?";
   } else {
      return;
   }
};

</script>
};

if ($free_media || $not_so_free_media) {
print qq{
<script>
function js_change_logo() {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_change_logo");

		document.body.appendChild(form); 
		\$('myForm_change_logo').action = '/cgi/genc/cp?mode=js_change_logo';
		var new_logo = \$('dbao') ? \$('dbao').value : '';
		if (new_logo.length > 0) \$('myForm_change_logo').action = \$('myForm_change_logo').action + '&dbao='+new_logo;

		\$('myForm_change_logo').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				console.log('Changed logo:', response);			
		}});
		\$('myForm_change_logo').send();
		\$('myForm_change_logo').dispose();
}

function js_radio_oc(a) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_radio_oc");

		document.body.appendChild(form); 
		\$('myForm_radio_oc').action = '/cgi/genc/cp?mode=js_radio_oc&type='+a;

		\$('myForm_radio_oc').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				console.log('Type_oc:', response);			
		}});
		\$('myForm_radio_oc').send();
		\$('myForm_radio_oc').dispose();
}

function js_guru_controls(p,s) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_ctrl");

		document.body.appendChild(form); 
		\$('myForm_ctrl').action = '?mode=js_guru_ctrl&par='+p;
		if (/^([a-zA-Z0-9]+)\$/.test(s)) \$('myForm_ctrl').action = '?mode=js_guru_ctrl&par='+p+'&name='+s;

		\$('myForm_ctrl').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);			
		}});
		\$('myForm_ctrl').send();
		\$('myForm_ctrl').dispose();
}

function js_radio_av(a) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_radio_av");

		document.body.appendChild(form); 
		\$('myForm_radio_av').action = '/cgi/genc/cp?mode=js_radio_av&type='+a;

		\$('myForm_radio_av').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				console.log('Type_av:', response);			
		}});
		\$('myForm_radio_av').send();
		\$('myForm_radio_av').dispose();
}

function js_block() {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_add_block");

		document.body.appendChild(form); 
		\$('myForm_add_block').action = '/cgi/genc/cp?mode=js_add_block';
		
		var perv = \$('perv_name') ? \$('perv_name').value : '';

		if (perv.length > 0) \$('myForm_add_block').action = \$('myForm_add_block').action + '&perv='+perv;
		\$('myForm_add_block').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				console.log('Blocker:', response);
				\$('perv_name').value='';			
		}});
		\$('myForm_add_block').send();
		\$('myForm_add_block').dispose();
}

function js_unblock() {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_remove_block");

		document.body.appendChild(form); 
		\$('myForm_remove_block').action = '/cgi/genc/cp?mode=js_remove_block';
		
		var perv = \$('perv_name') ? \$('perv_name').value : '';

		if (perv.length > 0) \$('myForm_remove_block').action = \$('myForm_remove_block').action + '&perv='+perv;
		\$('myForm_remove_block').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				console.log('Unblocker:', response);
				\$('perv_name').value='';			
		}});
		\$('myForm_remove_block').send();
		\$('myForm_remove_block').dispose();
}
</script>
};
} #free_media

print qq{
</head>

<body id="settingsPage" style="$bg#eee;"$onlo>
};
print qq{
<!--Copyright to Shen Huang, you can reach me out at shenhuang@live.ca-->
<div id = "board"></div>
		<sand></sand>
		<water></water>
		<skymask></skymask>
		<boat>
			<mast></mast>
			<sail></sail>
		</boat>
		<tree>
			<branch></branch>
			<leaf1></leaf1>
			<leaf2></leaf2>
			<leaf3></leaf3>
			<leaf4></leaf4>
			<leaf5></leaf5>
			<leaf6></leaf6>
			<coconut1></coconut1>
			<coconut2></coconut2>
			<coconut3></coconut3>
		</tree>
} 
unless ($touch_specific_bro)
;

my $colr = $touch_specific_bro ? "color:#222;" : '';
#my $dispc = !$png_change_permitted ? "display:none" : '';
my $fl = $touch_specific_bro ? "float:left;" : "float:left;";
my $fr = $touch_specific_bro ? "float:right;" : "float:right;";
my $wi = $touch_specific_bro ? "100%" : "255px";
my $miwi = $touch_specific_bro ? "100%" : "560px";
my $mt = $touch_specific_bro ? "30px" : "10px";

my $di1 = "block";
my $di2 = "none";
my $di3 = "none";
my $di4 = "none";
my $di5 = "none";

my $next_eth = "ETH1";
$next_eth = "KMS" if ($free_media || $not_so_free_media);
my $next_eth0 = "ETH0";
my $next_eth1 = "ETH1";
$next_eth1 = "KMS" if ($free_media || $not_so_free_media);

my $next_wlan = "LOG";
my $next_wlan0 = "WLAN0";
my $next_wlan1 = "LOG";

my $next_wifi = "WLAN";
my $next_antit = "<s>TOR</s>";
my $next_save = "Save";

print qq{
    <div id="home">
        <nav class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                <div>
			<div><h1 class="tm-site-title mb-0">$xTER</h1>
				<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a>
			</div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div>
			<div style="clear:all;"></div>
		</div>
		<button class="navbar-toggler ml-auto mr-0" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" 
			onclick="toggleZoomScreen()" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars tm-nav-icon"></i>
                </button>
		
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=system_panel">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
                        $logs_menu
			$users_menu
                        <li class="nav-item">
                            <a class="nav-link active" href="javascript:void(0);">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
				<span class="sr-only">(current)</span>
                            </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                Admin, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
};

#ajax form
&print_styled_ajax_box(0);
print qq{
	<form id="myForm_add_certs" action="/cgi/genc/cp?mode=add_certs" method="get">
	</form>
	<form id="myForm_add_png" action="/cgi/genc/cp?mode=add_png" method="get">
	</form>
	<form id="myForm_add_mp3" action="/cgi/genc/cp?mode=add_mp3" method="get">
	</form>	
	<span id=anchor></span>
};

my $res = `grep curip /home/nobody/vchat/lastlog | grep joinRoom | awk '{print \$14}' | jq -r '.name' | awk -vOFS='\t' '{print \$1 ".."}'` if ($free_media || $not_so_free_media);

my $al = "alert('Option disabled in this edition!');";

my $av0 = $develop != 16 ? "console.log('audio');js_radio_av(0);" : $al;
my $av1 = $develop != 16 ? "console.log('video');js_radio_av(1);" : $al;

my $oc0 = $cli eq "rhplus" || $not_so_free_media ? "console.log('opened gate');js_radio_oc(0);" : $al;
my $oc1 = $cli eq "rhplus" || $not_so_free_media ? "console.log('closed gate');js_radio_oc(1);" : $al;

$oc0 = $develop == 16 && !$multicabo && $is_admin ? "console.log('opened cabo');js_guru_controls(3,'');" : $oc0;
$oc1 = $develop == 16 && !$multicabo && $is_admin ? "console.log('closed cabo');js_guru_controls(2,'');" : $oc1;

my $dbao = $cli eq "rhplus" || ($develop == 16 && !$multicabo) ? "console.log('dazibao:' + document.getElementById('dbao').value);js_change_logo();" : $al;
my $jb = $cli eq "rhplus" || ($develop == 16 && !$multicabo) ? "console.log('js_block');js_block();" : $al;
my $ujb = $cli eq "rhplus" || ($develop == 16 && !$multicabo) ? "console.log('js_unblock');js_unblock();" : $al;

unless ($touch_specific_bro) {

my $certs_align = $softpac eq '3' ? "center" : "left";

print qq{
        <div class="container">
            <div class="row" style="margin-top:$mt;width:100%;min-width:480px;padding:2px;">
                <div class="col" style="min-width:20%;text-align:right;">
                    <p class="text-white" style="margin-top:48px;">
		    	<span style="margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_hname:</span>
			<span id=show_9 style="font-weight:bold;color:#9cf;cursor:pointer;background:#455c71;padding:0px 2px;display:inline;" onclick="\$('show_9').setStyles({'display':'none'});\$('input_9').setStyles({'display':'inline'});\$('input_9').focus();">$HNAME_STR</span>
			<input id=input_9 class=ic style="display:none;margin-top:-5px;padding:0px 2px;" type=text value='$HNAME_STR' onblur="\$('input_9').setStyles({'display':'none'});\$('show_9').setStyles({'display':'inline'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {var yon = window.confirm('Change HOST name?!');if (yon) {js_change_value(9);\$('input_9').setStyles({'display':'none'});\$('show_9').setStyles({'display':'inline'});}}}">
		    </p>

};
if ($certs_change_permitted) {
 print qq{
		    <!-- div style="margin-top:-16px;">
				<span style="margin:0px 5px;font-weight:bold;color:#fff;">New room:</span><input id="nnode_adder" class=ic type=text value=""><input type=button value="Add" onclick="js_guru_controls(6, \$('nnode_adder').value);">
                   </div -->
                </div>
                <div id="domain_container" style="min-width:20%;text-align:center;padding:2px;">
			<p class="text-white" style="margin-top:48px;">
				<span style="margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">Domain:</span>
				<span class=nw_change id=changer_27 onclick="toggle_add_edit_box(27,1);\$('input_27').focus();">change</span>
			</p>
			<div class=show_input_container id=sic_27 style="margin-top:-16px;">
				<div class=show_div id="show_div_27"><span id="show_27" class=sc2>$DOMAIN_STR</span></div>
				<div class=input_div id="input_div_27">
					<input id="input_27" class=ic style="width:180px;" type=text value="$DOMAIN_STR" onblur="toggle_add_edit_box(27,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateDomainName(this.value)) {blinker(27); js_change_value(27);}}">
				</div>
                	</div>
		</div>
 };
} else {
 print qq{
                </div>
                <div class="col" style="min-width:20%;text-align:center;padding:2px;">
                    <p class="text-white" style="margin-top:48px;">
		    	<span style="margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_http_s:</span>
		    	<span style="display:inline;font-weight:bold;background:#455c71;padding:3px 2px 2px 2px;color:#9cf;$ccdimmer"$cconcl>HTTP</span>&nbsp;<span style="display:inline;font-weight:bold;background:#455c71;padding:3px 2px 2px 2px;color:#9cf;$cdimmer"$concl>HTTPS</span>
		   </p>
                </div>
 };
}

print qq{
                <div class="col" style="min-width:20%;text-align:$certs_align;padding:2px;">
                    <p class="text-white" style="margin-top:48px;">
		    	<span style="margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">Cert:</span>
		    	<span id=ask_add_certs style="color:#009;text-decoration:underline;cursor:pointer;">upload</span><br>
			<span style="margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr$dispc">PNG:</span>
		    	<span id=ask_add_png style="color:#009;text-decoration:underline;cursor:pointer;$dispc">upload</span><br>
			<span style="margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr$dispc">MP3:</span>
		    	<span id=ask_add_mp3 style="color:#009;text-decoration:underline;cursor:pointer;$dispc">upload</span><br>
		   </p>
                </div>
};
print qq{		
                <div class="col" style="min-width:20%;text-align:right;padding:2px;">
                    <p class="text-white" style="margin-top:48px;">
		    	<span style="float:left;margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_op_pwd:</span>
			<span id=show_19 style="font-weight:bold;color:#9cf;float:left;cursor:pointer;background:#455c71;padding:1px 2px;margin:" onclick="\$('show_19').setStyles({'display':'none'});\$('input_19').setStyles({'display':'inline'});\$('input_19').focus();">********</span>
			<input id=input_19 class=ic style="display:none;float:left;padding:0px 2px;width:90px;" type=text value='********' onblur="\$('input_19').setStyles({'display':'none'});\$('show_19').setStyles({'display':'inline'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {var yon = window.confirm('Change password for op?!');if (yon) {js_change_value(19);\$('input_19').setStyles({'display':'none'});\$('show_19').setStyles({'display':'inline'});}}}">
		    </p>
                </div>
                <div class="col" style="min-width:20%;text-align:left;padding:2px;">
                    <p class="text-white" style="margin-top:5px;">
		    	<span style="float:left;margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_mtarget:</span>
			<span id=show_20 style="font-weight:bold;color:#9cf;float:left;cursor:pointer;background:#455c71;padding:2px 2px;width:180px;" onclick="\$('show_20').setStyles({'display':'none'});\$('input_20').setStyles({'display':'inline'});\$('input_20').focus();">$MTARGET_STR</span>
			<input id=input_20 class=ic style="display:none;float:left;padding:0px 2px;width:180px;" type=text value='$MTARGET_STR' onblur="\$('input_20').setStyles({'display':'none'});\$('show_20').setStyles({'display':'inline'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateURL(this.value)) {var yon = window.confirm('Change MINING TARGET?!');if (yon) {js_change_value(20);\$('input_20').setStyles({'display':'none'});\$('show_20').setStyles({'display':'inline'});}}}">
		    </p>
                    <p class="text-white" style="margin-top:24px;">
		    	<span style="float:left;margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_cbase:</span>
			<span id=show_18 style="font-weight:bold;color:#9cf;float:left;cursor:pointer;background:#455c71;padding:2px 2px;width:180px;" onclick="\$('show_18').setStyles({'display':'none'});\$('input_18').setStyles({'display':'inline'});\$('input_18').focus();">$CBASE_STR</span>
			<input id=input_18 class=ic style="display:none;float:left;padding:0px 2px;width:180px;" type=text value='$CBASE_STR' onblur="\$('input_18').setStyles({'display':'none'});\$('show_18').setStyles({'display':'inline'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {var yon = window.confirm('Change COINBASE?!');if (yon) {js_change_value(18);\$('input_18').setStyles({'display':'none'});\$('show_18').setStyles({'display':'inline'});}}}">
		    </p>

                </div>
} if ($softpac eq '3');#miner

print qq{
            </div>
            <!-- row -->
            <div class="row tm-content-row" style="margin-top:-$mt;">
                <div id=left_half class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="min-width:$miwi;margin: $mt auto 20px auto;">
		    
		    <span id=next_eth style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" onclick="document.getElementById('quarter_a').style.display=document.getElementById('quarter_a').style.display == 'block' ? 'none' : 'block';
		    document.getElementById('quarter_aa').style.display=document.getElementById('quarter_aa').style.display == 'block' ? 'none' : 'block';
		    document.getElementById('next_eth').innerHTML = document.getElementById('quarter_aa').style.display == 'block' ? '$next_eth0' : '$next_eth1';">$next_eth</span>
};
print qq{		    
		    <span id=next_wlan style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" onclick="document.getElementById('quarter_b').style.display=document.getElementById('quarter_b').style.display == 'block' ? 'none' : 'block';
		    document.getElementById('quarter_bb').style.display=document.getElementById('quarter_bb').style.display == 'block' ? 'none' : 'block';
		    document.getElementById('next_wlan').innerHTML = document.getElementById('quarter_bb').style.display == 'block' ? '$next_wlan0' : '$next_wlan1';">$next_wlan</span>
} if ($free_media || $not_so_free_media);

print qq{<br>		    
                    <div id=quarter_a class="tm-bg-primary-dark tm-block" style="min-height:27%;display:$di1;width:$wi;$fl">
                        <div>
				<div style="float:left;">
					<h2 class="tm-block-title">Ethernet eth0</h2>
				</div>
				<div style="float:left;margin-left:15px;">
};
print qq{					<input type=checkbox$checked name=dhtoggler onclick="var now = this.checked == 1 ? false : true;var yesno = this.checked == 1 ? 'yes' : 'no';var yon = window.confirm('WARNING: <<dhclient>, '+yesno+'?');if (yon) {toggle_dh(this.checked);} else {this.checked=now;}">
} if ($ETH0_STR eq $EXT_STR);
print qq{				</div>
				<div style="clear:left;"></div>
			</div>
                        <div id="IP_container"><span class=nw_title>Internal_IP:</span><span id=changer_1 class=nw_change$disp onclick="toggle_add_edit_box(1,1);\$('input_1').focus();">change</span></div>
			<div class=show_input_container id=sic_1>
				<div class=show_div id="show_div_1"><span id="show_1" class=sc2>$ETH0_STR</span></div>
				<div class=input_div id="input_div_1">
					<input id="input_1" class=ic type=text value="$ETH0_STR" onblur="toggle_add_edit_box(1,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(1);js_change_value(1);}}">
				</div>
			</div>
                        <div id="GW_container"><span class=nw_title>Gateway_IP:</span><span id=changer_2 class=nw_change$disp onclick="toggle_add_edit_box(2,1);\$('input_2').focus();">change</span></div>
			<div class=show_input_container id=sic_2>
				<div class=show_div id="show_div_2"><span id="show_2" class=sc2>$GW_STR</span></div>
				<div class=input_div id="input_div_2">
					<input id="input_2" class=ic type=text value="$GW_STR" onblur="toggle_add_edit_box(2,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(2);js_change_value(2);}}">
				</div>
			</div>
                        <div id="EXT_container"><span class=nw_title$with_ext>External_IP:</span><span class=nw_change id=changer_3 onclick="toggle_add_edit_box(3,1);\$('input_3').focus();">change</span></div>
			<div class=show_input_container id=sic_3>
				<div class=show_div id="show_div_3"><span id="show_3" class=sc2>$EXT_STR</span></div>
				<div class=input_div id="input_div_3">
					<input id="input_3" class=ic type=text value="$EXT_STR" onblur="toggle_add_edit_box(3,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(3);js_change_value(3);}}">
				</div>
			</div>
                        <div id="TURN_container"><span class=nw_title$with_coturn>TURN:</span><span id=changer_4 class=nw_change onclick="toggle_add_edit_box(4,1);\$('input_4').focus();">change</span></div>
			<div class=show_input_container id=sic_4>
				<div class=show_div id="show_div_4"><span id="show_4" class=sc2>$TURN_STR</span></div>
				<div class=input_div id="input_div_4">
					<input id="input_4" class=ic type=text value="$TURN_STR" onblur="toggle_add_edit_box(4,0);" onkeydown='var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (true) {blinker(4);js_change_value(4);}}'>
				</div>
			</div>
                        <!-- div id="MACADDR_container"><span class=nw_title>MAC_Address:</span>
				<div class=show_input_container id=sic_4>
					<div class=show_div id="show_div_4"><span id="show_4" class=sc2>$MACADDR_STR</span></div>
				</div>
			</div -->
                   </div><!-- quarter_a -->
};
print qq{
                   <div id=quarter_aa class="tm-bg-primary-dark tm-block" style="min-height:27%;display:$di2;width:$wi;$fl">
                        <div>
				<div style="float:left;">
					<h2 class="tm-block-title">Ethernet eth1</h2>
				</div>
				<div style="float:left;margin-left:15px;display:$softpac_display;">
					<input type=checkbox$checked_eth1 name=drtoggler onclick="var now = this.checked == 1 ? false : true; var yesno = this.checked == 1 ? 'yes' : 'no';var yon = window.confirm('WARNING: setting default route to ETH1, '+yesno+'?');if (yon) {toggle_dr(this.checked);} else {this.checked=now;}">
				</div>
				<div style="clear:left;"></div>
			</div>
                        <div id="IP_container2"><span class=nw_title>IP:</span><span id=changer_13 class=nw_change onclick="toggle_add_edit_box(13,1);\$('input_13').focus();">change</span></div>
			<div class=show_input_container id=sic_13>
				<div class=show_div id="show_div_13"><span id="show_13" class=sc2>$ETH1_STR</span></div>
				<div class=input_div id="input_div_13">
					<input id="input_13" class=ic type=text value="$ETH1_STR" onblur="toggle_add_edit_box(13,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(13);js_change_value(13);}}">
				</div>
			</div>
                        <div id="NETMASK_container2"><span class=nw_title>Net:</span><span id=changer_14 class=nw_change onclick="toggle_add_edit_box(14,1);\$('input_14').focus();">change</span></div>
			<div class=show_input_container id=sic_14>
				<div class=show_div id="show_div_14"><span id="show_14" class=sc2>$NET1_STR</span></div>
				<div class=input_div id="input_div_14">
					<input id="input_14" class=ic type=text value="$NET1_STR" onblur="toggle_add_edit_box(14,0);" onkeydown='var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (true) {blinker(14);js_change_value(14);}}'>
				</div>
			</div>
                        <div id="GW_container2"><span class=nw_title>Gateway_IP:</span><span id=changer_15 class=nw_change onclick="toggle_add_edit_box(15,1);\$('input_15').focus();">change</span></div>
			<div class=show_input_container id=sic_15>
				<div class=show_div id="show_div_15"><span id="show_15" class=sc2>$GW1_STR</span></div>
				<div class=input_div id="input_div_15">
					<input id="input_15" class=ic type=text value="$GW1_STR" onblur="toggle_add_edit_box(15,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(15);js_change_value(15);}}">
				</div>
			</div>
                   </div><!-- quarter_aa -->
} unless ($free_media || $not_so_free_media);



print qq{
                   <div id=quarter_aa class="tm-bg-primary-dark tm-block" style="min-height:27%;display:$di2;width:$wi;$fl">

                        <div>
				<div style="float:left;">
					<h2 class="tm-block-title">KMS Keeper</h2>
				</div>
				<div style="clear:left;"></div>
			</div>
} if ($free_media || $not_so_free_media);

print qq{			
			<div style="position:absolute;top:110px;"><span class=nw_title>Video On/Off:</span>
				<form action="#">
					<INPUT style="margin:5px 3px;" TYPE=radio name=av VALUE=0 onclick="$av0" /><span style="color:#fff;">AUDIO</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name=av VALUE=1 onclick="$av1" /><span style="color:#fff;">VIDEO</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name=av CHECKED VALUE=? onclick="console.log('?');" /><span style="color:#fff;">?</span>
				</form>
			</div>
} if ($super_free_media && 0);


print qq{			
			<!-- div style="position:absolute;top:110px;"><span class=nw_title>Gate Open/Closed:</span>
				<form action="#">
					<INPUT style="margin:5px 3px;" TYPE=radio name=oc VALUE=0 onclick="$oc0" /><span style="color:#fff;">OPEN</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name=oc VALUE=1 onclick="$oc1" /><span style="color:#fff;">CLOSE</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name=oc CHECKED VALUE=? onclick="console.log('?');" /><span style="color:#fff;">?</span>
				</form>
			</div -->

			<div style="position:absolute;top:110px;"><span class=nw_title>Public Message:</span>
				<form action="#">
					<input id=dbao type=text style="width:120px;margin-left:0px;" onclick="this.value='';" placeholder="Message">
					<input type=button style="width:60px;" onclick="$dbao" value="Do" />
				</form>
			</div>

			<div style="position:absolute;top:170px;"><span class=nw_title>Block Dude:</span>
				<form action="#"><input id=perv_name type=text style="width:120px;margin-left:0px;" onclick="this.value='';" placeholder="Loco" required>
					<input type=button onclick="$jb" value="x->" style="width:60px;">
				</form>
			</div>

			<div style="position:absolute;top:230px;"><span class=nw_title>Un-block Dude:</span>
				<form action="#"><input id=perv_name type=text style="width:120px;margin-left:0px;" onclick="this.value='';" placeholder="Dude" required>
					<input type=button onclick="$ujb" value="u->" style="width:60px;">
				</form>
			</div>
			
			<div style="position:absolute;top:290px;"><span class=nw_title>Reset Room:</span>
				<form action="#">
					<input type=button onclick="var yon = window.confirm('Really?!');if (yon) {\$('settingsPage').setStyles({'opacity': 0.5 });\$('settingsPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });js_ctrl(21);(function() {location.href='$scriptname?mode=nw_panel';}).delay(2400);}" value="Reset Room" style="width:160px;">
				</form>
			</div>
			
                   </div><!-- quarter_aa -->
} if ($free_media || $not_so_free_media);

print qq{
		    <div id=quarter_b class="tm-bg-primary-dark tm-block" style="min-height:27%;display:$di1;width:$wi;$fr">
                        <!-- h2 class="tm-block-title">WiFi wlan0</h2 -->
			<div>
				<div style="float:left;">
					<h2 class="tm-block-title">WiFi $wifi_enabled!</h2>
				</div>
				<div style="float:left;margin-left:15px;">
					<input type=checkbox$checked_wf name=wftoggler onclick="var now = this.checked == 1 ? false : true; var yesno = this.checked == 1 ? 'yes' : 'no';var yon = window.confirm('WARNING: enable WiFi, '+yesno+'?');if (yon) {toggle_wf(this.checked);} else {this.checked=now;}">
				</div>
				<div style="clear:left;"></div>
			</div>
                        <div id="WLAN0_container"><span class=nw_title>Router_IP:</span><span class=nw_change id=changer_5 onclick="toggle_add_edit_box(5,1);\$('input_5').focus();">change</span></div>
			<div class=show_input_container id=sic_5>
				<div class=show_div id="show_div_5"><span id="show_5" class=sc2>$WLAN_STR</span></div>
				<div class=input_div id="input_div_5">
					<input id="input_5" class=ic type=text value="$WLAN_STR" onblur="toggle_add_edit_box(5,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(5);js_change_value(5);}}">
				</div>
			</div>
                        <div id="SSID_container"><span class=nw_title>SSID:</span><span class=nw_change id=changer_6 onclick="toggle_add_edit_box(6,1);\$('input_6').focus();">change</span></div>
			<div class=show_input_container id=sic_6>
				<div class=show_div id="show_div_6"><span id="show_6" class=sc2>$SSID_STR</span></div>
				<div class=input_div id="input_div_6">
					<input id="input_6" class=ic type=text value="$SSID_STR" onblur="toggle_add_edit_box(6,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {blinker(6);js_change_value(6);}}">
				</div>
			</div>
                        <div id="WP_container"><span class=nw_title>WiFi key<span class=exclam title="click to see password" onmouseover="this.style.background='#fee';" onmouseout="this.style.background='transparent';" onclick="js_chip(1);//(function() {location.reload();}).delay(1000);">[!]</span>:</span><span class=nw_change id=changer_7 onclick="toggle_add_edit_box(7,1);\$('input_7').focus();">change</span></div>
			<div class=show_input_container id=sic_7>
				<div class=show_div id="show_div_7"><span id="show_7" class=sc2>********</span></div>
				<div class=input_div id="input_div_7">
					<input id="input_7" class=ic type=text value="$WP_STR" onblur="toggle_add_edit_box(7,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {blinker(7);js_change_value(7);js_chip(1,1);}}">
				</div>
			</div>
                        <div id="XP_container"><span class=nw_title>Admin key<span class=exclam title="click to see password" onmouseover="this.style.background='#fee';" onmouseout="this.style.background='transparent';" onclick="js_chip(2);//(function() {location.reload();}).delay(1000);">[!]</span>:</span><span class=nw_change id=changer_8 onclick="toggle_add_edit_box(8,1);\$('input_8').focus();">change</span></div>
			<div class=show_input_container id=sic_8>
				<div class=show_div id="show_div_8"><span id="show_8" class=sc2>********</span></div>
				<div class=input_div id="input_div_8">
					<input id="input_8" class=ic type=text value="$XP_STR" onblur="toggle_add_edit_box(8,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {blinker(8);js_change_value(8);js_chip(2,1);}}">
				</div>
			</div>
                   </div><!-- quarter_b -->
};
print qq{		   
		    <div id=quarter_bb class="tm-bg-primary-dark tm-block" style="min-height:27%;display:$di2;width:$wi;$fr">

			<div>
				<div style="float:left;">
					<h2 class="tm-block-title">Vchat Logs</h2>
				</div>
				<div style="clear:left;"></div>
			</div>
                        <div id="Vlog_container"><span class=nw_title>User Logins:</span></div>
			<div style="color:#9cf;margin-top:5px;min-height:230px;max-height:60%;max-width:240px;overflow:auto;font-family:Courier;font-size:14px;">
				$res
			</div>
                   </div><!-- quarter_bb -->
} if ($free_media || $not_so_free_media);
print qq{		   
                </div><!-- left_half -->
                <div id=right_half class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="min-width:$miwi;margin:$mt auto 20px auto;">
		<span style="padding:5px;background:transparent;opacity:0.5;">&nbsp;</span><br>
		    
                    <div id=quarter_c class="tm-bg-primary-dark tm-block" style="width:$wi;overflow:auto;min-height:27%;$fl">
                        <h2 class="tm-block-title" style="float:left;margin-left:5px;$bdimmer"$boncl>Blacklist</h2>
			<h2 class="tm-block-title" style="float:right;margin-right:10px;$wdimmer"$woncl>$antitor_menu_str</h2><span style="clear:all;"></span>
			<div class=nw_change onclick="\$('add_new_blip').setStyles({'display':'block'});\$('add_new_blip').value='';\$('add_new_blip').focus();" style="float:right;margin-right:0px;width:160px;text-align:right;margin-top:-10px;">new</div>
			<input id=add_new_blip type=text value="" style="display:none;width:120px;" onblur="\$('add_new_blip').setStyles({'display':'none'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,0)) {js_edit_bl(1,this.value); (function() {location.reload();}).delay(1000);}}">
			<div style="clear:all;"><br></div>
};

my $file = "/etc/sysconfig/$current_list";
my @bips = ();

if (open my $info, $file) {

while( my $line = <$info>)  {
	$line =~ s/(\r|\n)//g;  
	push @bips,$line;    
}

close $info;
$c = 0;
print "<br>"; #css hack ash
foreach my $l (@bips) {
	print qq{
		<div id="blip$c" class=blips onclick="var yon = window.confirm('Really delete?!');if (yon) {js_edit_bl(2,'$l');\$('blip$c').setStyles({'display':'none'});}">$l</div>
	};
	++$c;
}
} #if open

print qq{		
                    </div>
                    <div id=quarter_d class="tm-bg-primary-dark tm-block" style="min-height:27%;width:$wi;$fr">
                        <h2 class="tm-block-title">Save\&Restore</h2>
			<div class=ctrl_btn id="save_button" style="float:left;" onclick="var yon = window.confirm('Really Save?!');if (yon) {data_needs_saving=0;js_ctrl(3);}">Save</div>
			<div class=ctrl_btn id="savereboot_button" style="float:left;" onclick="var yon = window.confirm('Really Save and Reboot?!');if (yon) {data_needs_saving=0;\$('settingsPage').setStyles({'opacity': 0.5 });\$('settingsPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });js_ctrl(4);(function() {location.href='$scriptname?mode=system_panel';}).delay(240000);}">Save\&Reboot</div>
			<div class=ctrl_btn id="reset_button" style="float:left;" onclick="var yon = window.confirm('Really Reset?!');if (yon) {data_needs_saving = 0;js_ctrl(10);}">Reset</div>
			<div class=ctrl_btn id="factory_reset_button" style="float:left;" onclick="var yon = window.confirm('Reset to Factory?!');if (yon) {js_ctrl(5);location.reload();}">Reset to Factory</div>
                    </div>
                </div><!-- right_half -->
            </div><!-- row -->
        </div><!-- container -->
};

} else {
#touch

print qq{
        <div class="container" style="font-size:18px;">

            <!-- row -->
            <div class="row tm-content-row" style="margin-top:20px;text-align:center;">
	       <div id=boxer style="width:90%;margin:0 auto;text-align:left;">

		    <span id=next_eth style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.8;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='block';
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='none';">$next_eth0</span>

		    <span id=next_eth1 style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';document.getElementById('next_eth').style.opacity=0.5;
		    document.getElementById('quarter_aa').style.display='block';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='none';">$next_eth1</span>
		    		    
		    <span id=next_wifi style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_ab').style.display='block';document.getElementById('next_eth').style.opacity=0.5;
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='none';">$next_wifi</span>		    

		    <span id=next_antit style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='block';document.getElementById('next_eth').style.opacity=0.5;
		    document.getElementById('quarter_ad').style.display='none';">$next_antit</span>

		    <span id=next_save style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='block';document.getElementById('next_eth').style.opacity=0.5;">$next_save</span>
		    <br>
                    
		    <div  id=quarter_a class="tm-bg-primary-dark tm-block" style="font-size:18px;min-height:27%;display:$di1;width:$wi;$fl">
                        <div>
				<div style="float:left;">
					<h2 class="tm-block-title">Ethernet eth0</h2>
				</div>
				<div style="float:left;margin-left:15px;">
} unless ($free_media);

print qq{
        <div class="container" style="font-size:18px;">

            <!-- row -->
            <div class="row tm-content-row" style="margin-top:20px;text-align:center;">
	       <div id=boxer style="width:90%;margin:0 auto;text-align:left;">

		    <span id=next_eth style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.8;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='block';
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_bb').style.display='none';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='none';">$next_eth0</span>

		    <span id=next_eth1 style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';document.getElementById('next_eth').style.opacity=0.5;
		    document.getElementById('quarter_aa').style.display='block';
		    document.getElementById('quarter_bb').style.display='none';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='none';">$next_eth1</span>

		    <span id=next_wlan style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';document.getElementById('next_eth').style.opacity=0.5;
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_bb').style.display='block';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='none';">$next_wlan1</span>
		    		    		    
		    <span id=next_wifi style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_bb').style.display='none';
		    document.getElementById('quarter_ab').style.display='block';document.getElementById('next_eth').style.opacity=0.5;
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='none';">$next_wifi</span>		    

		    <span id=next_antit style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_bb').style.display='none';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='block';document.getElementById('next_eth').style.opacity=0.5;
		    document.getElementById('quarter_ad').style.display='none';">$next_antit</span>

		    <span id=next_save style="cursor:pointer;padding:6px 6px 2px 6px;background:#fee;opacity:0.5;" onmouseover="this.style.opacity=0.8;" onmouseout="this.style.opacity=0.5;" 
		    onclick="document.getElementById('quarter_a').style.display='none';
		    document.getElementById('quarter_aa').style.display='none';
		    document.getElementById('quarter_bb').style.display='none';
		    document.getElementById('quarter_ab').style.display='none';
		    document.getElementById('quarter_ac').style.display='none';
		    document.getElementById('quarter_ad').style.display='block';document.getElementById('next_eth').style.opacity=0.5;">$next_save</span>
		    <br>
                    
		    <div  id=quarter_a class="tm-bg-primary-dark tm-block" style="font-size:18px;min-height:27%;display:$di1;width:$wi;$fl">
                        <div>
				<div style="float:left;">
					<h2 class="tm-block-title">Ethernet eth0</h2>
				</div>
				<div style="float:left;margin-left:15px;">
} if ($free_media);
print qq{					<input type=checkbox$checked name=dhtoggler onclick="var now = this.checked == 1 ? false : true;var yesno = this.checked == 1 ? 'yes' : 'no';var yon = window.confirm('WARNING: after REBOOT, <<dhclient>> support, '+yesno+'?');if (yon) {toggle_dh(this.checked);} else {this.checked=now;}">
} if ($ETH0_STR eq $EXT_STR);
print qq{				</div>
				<div style="clear:left;"></div>
			</div>
                        <div id="IP_container"><span class=nw_title_mob>Internal_IP:</span><span id=changer_1 class=nw_change_mob$disp onclick="toggle_add_edit_box(1,1);\$('input_1').focus();">change</span></div>
			<div class=show_input_container id=sic_1>
				<div class=show_div id="show_div_1"><span id="show_1" class=sc2>$ETH0_STR</span></div>
				<div class=input_div id="input_div_1">
					<input id="input_1" class=ic type=text value="$ETH0_STR" onblur="toggle_add_edit_box(1,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(1);js_change_value(1);}}">
				</div>
			</div>
                        <div id="GW_container"><span class=nw_title_mob>Gateway_IP:</span><span id=changer_2 class=nw_change_mob$disp onclick="toggle_add_edit_box(2,1);\$('input_2').focus();">change</span></div>
			<div class=show_input_container id=sic_2>
				<div class=show_div id="show_div_2"><span id="show_2" class=sc2>$GW_STR</span></div>
				<div class=input_div id="input_div_2">
					<input id="input_2" class=ic type=text value="$GW_STR" onblur="toggle_add_edit_box(2,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(2);js_change_value(2);}}">
				</div>
			</div>
                        <div id="EXT_container"><span class=nw_title_mob$with_ext>External_IP:</span><span class=nw_change_mob id=changer_3 onclick="toggle_add_edit_box(3,1);\$('input_3').focus();">change</span></div>
			<div class=show_input_container id=sic_3>
				<div class=show_div id="show_div_3"><span id="show_3" class=sc2>$EXT_STR</span></div>
				<div class=input_div id="input_div_3">
					<input id="input_3" class=ic type=text value="$EXT_STR" onblur="toggle_add_edit_box(3,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(3);js_change_value(3);}}">
				</div>
			</div>
                        <div id="TURN_container"><span class=nw_title$with_coturn>TURN:</span><span id=changer_4 class=nw_change onclick="toggle_add_edit_box(4,1);\$('input_4').focus();">change</span></div>
			<div class=show_input_container id=sic_4>
				<div class=show_div id="show_div_4"><span id="show_4" class=sc2>$TURN_STR</span></div>
				<div class=input_div id="input_div_4">
					<input id="input_4" class=ic type=text value="$TURN_STR" onblur="toggle_add_edit_box(4,0);" onkeydown='var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (true) {blinker(4);js_change_value(4);}}'>
				</div>
			</div>
			
                   </div><!-- quarter_a -->
};
print qq{
                   <div  id=quarter_aa class="tm-bg-primary-dark tm-block" style="font-size:18px;min-height:27%;display:$di2;width:$wi;$fl">
                        <div>
				<div style="float:left;">
					<h2 class="tm-block-title">Ethernet eth1</h2>
				</div>
				<div style="float:left;margin-left:15px;display:$softpac_display;">
					<input type=checkbox$checked_eth1 name=drtoggler onclick="var now = this.checked == 1 ? false : true;var yesno = this.checked == 1 ? 'yes' : 'no';var yon = window.confirm('WARNING: setting default route to ETH1, '+yesno+'?');if (yon) {toggle_dr(this.checked);} else {this.checked=now;}">
				</div>
				<div style="clear:left;"></div>
			</div>
                        <div id="IP_container2"><span class=nw_title_mob>IP:</span><span id=changer_13 class=nw_change_mob onclick="toggle_add_edit_box(13,1);\$('input_13').focus();">change</span></div>
			<div class=show_input_container id=sic_13>
				<div class=show_div id="show_div_13"><span id="show_13" class=sc2>$ETH1_STR</span></div>
				<div class=input_div id="input_div_13">
					<input id="input_13" class=ic type=text value="$ETH1_STR" onblur="toggle_add_edit_box(13,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(13);js_change_value(13);}}">
				</div>
			</div>
                        <div id="NETMASK_container2"><span class=nw_title_mob>Net:</span><span id=changer_14 class=nw_change_mob onclick="toggle_add_edit_box(14,1);\$('input_14').focus();">change</span></div>
			<div class=show_input_container id=sic_14>
				<div class=show_div id="show_div_14"><span id="show_14" class=sc2>$NET1_STR</span></div>
				<div class=input_div id="input_div_14">
					<input id="input_14" class=ic type=text value="$NET1_STR" onblur="toggle_add_edit_box(14,0);" onkeydown='var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (true) {blinker(14);js_change_value(14);}}'>
				</div>
			</div>
                        <div id="GW_container2"><span class=nw_title_mob>Gateway_IP:</span><span id=changer_15 class=nw_change_mob onclick="toggle_add_edit_box(15,1);\$('input_15').focus();">change</span></div>
			<div class=show_input_container id=sic_15>
				<div class=show_div id="show_div_15"><span id="show_15" class=sc2>$GW1_STR</span></div>
				<div class=input_div id="input_div_15">
					<input id="input_15" class=ic type=text value="$GW1_STR" onblur="toggle_add_edit_box(15,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(15);js_change_value(15);}}">
				</div>
			</div>
                   </div><!-- quarter_aa -->
} unless ($free_media || $not_so_free_media);

print qq{
                   <div  id=quarter_aa class="tm-bg-primary-dark tm-block" style="font-size:18px;min-height:27%;display:$di2;width:$wi;$fl">
} if ($free_media || $not_so_free_media);


print qq{
			<div style="margin:10px auto">
				<form action="#">
					<INPUT style="margin:5px 3px;" TYPE=radio name=av VALUE=0 onclick="$av0" /><span style="color:#fff;">AUDIO</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name=av VALUE=1 onclick="$av1" /><span style="color:#fff;">VIDEO</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name=av CHECKED VALUE=? onclick="console.log('?');" /><span style="color:#fff;">?</span>
				</form>
			</div>
} if ($super_free_media && 0);


print qq{			
			<div style="margin:10px auto">
				<form action="#">
					<INPUT style="margin:5px 3px;" TYPE=radio name=oc VALUE=0 onclick="$oc0" /><span style="color:#fff;">OPEN</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name=oc VALUE=1 onclick="$oc1" /><span style="color:#fff;">CLOSE</span>
					<INPUT style="margin:5px 3px;" TYPE=radio name=oc CHECKED VALUE=? onclick="console.log('?');" /><span style="color:#fff;">?</span>
				</form>
			</div>

			<div style="margin:10px auto">
				<form action="#">
					<input id=dbao type=text style="width:120px;margin-left:0px;" onclick="this.value='';" placeholder="Message">
					<input type=button style="width:90px;" onclick="$dbao" value="Change" />
				</form>
			</div>

			<div style="margin:10px auto">
				<form action="#"><input id=perv_name type=text style="width:120px;margin-left:0px;" onclick="this.value='';" placeholder="Loco" required>
					<input type=button onclick="$jb" value="Block" style="width:90px;">
				</form>
			</div>

			<div style="margin:10px auto">
				<form action="#">
					<input type=button onclick="var yon = window.confirm('Really?!');if (yon) {\$('settingsPage').setStyles({'opacity': 0.5 });\$('settingsPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });js_ctrl(21);(function() {location.href='$scriptname?mode=nw_panel';}).delay(2400);}" value="Reset Room" style="width:120px;">
				</form>
			</div>

                   </div><!-- quarter_aa -->
} if ($free_media || $not_so_free_media);

print qq{		   
		    <div id=quarter_bb class="tm-bg-primary-dark tm-block" style="font-size:18px;min-height:27%;display:$di2;width:$wi;$fl">

			<div>
				<div style="float:left;">
					<h2 class="tm-block-title">Vchat Logs</h2>
				</div>
				<div style="clear:left;"></div>
			</div>
                        <div id="Vlog_container"><span class=nw_title>User Logins:</span></div>
			<div style="color:#9cf;min-height:230px;max-height:75%;max-width:240px;overflow:auto;font-family:Courier;font-size:14px;">
				$res
			</div>
                   </div><!-- quarter_bb -->
} if ($free_media || $is_admin);

print qq{
                    <div id=quarter_ab class="tm-bg-primary-dark tm-block" style="font-size:18px;min-height:27%;display:$di3;width:$wi;$fl">
                        <!-- h2 class="tm-block-title">WiFi wlan0</h2 -->
			<div>
				<div style="float:left;">
					<h2 class="tm-block-title">WiFi $wifi_enabled!</h2>
				</div>
				<div style="float:left;margin-left:15px;">
					<input type=checkbox$checked_wf name=wftoggler onclick="var now = this.checked == 1 ? false : true;var yesno = this.checked == 1 ? 'yes' : 'no';var yon = window.confirm('WARNING: enable WiFi, '+yesno+'?');if (yon) {toggle_wf(this.checked);} else {this.checked=now;}">
				</div>
				<div style="clear:left;"></div>
			</div>			
                        <div id="WLAN0_container"><span class=nw_title_mob>Router_IP:</span><span class=nw_change_mob id=changer_5 onclick="toggle_add_edit_box(5,1);\$('input_5').focus();">change</span></div>
			<div class=show_input_container id=sic_5>
				<div class=show_div id="show_div_5"><span id="show_5" class=sc2>$WLAN_STR</span></div>
				<div class=input_div id="input_div_5">
					<input id="input_5" class=ic type=text value="$WLAN_STR" onblur="toggle_add_edit_box(5,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,1)) {blinker(5);js_change_value(5);}}">
				</div>
			</div>
                        <div id="SSID_container"><span class=nw_title_mob>SSID:</span><span class=nw_change_mob id=changer_6 onclick="toggle_add_edit_box(6,1);\$('input_6').focus();">change</span></div>
			<div class=show_input_container id=sic_6>
				<div class=show_div id="show_div_6"><span id="show_6" class=sc2>$SSID_STR</span></div>
				<div class=input_div id="input_div_6">
					<input id="input_6" class=ic type=text value="$SSID_STR" onblur="toggle_add_edit_box(6,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {blinker(6);js_change_value(6);}}">
				</div>
			</div>
                        <div id="WP_container"><span class=nw_title_mob>WiFi key<span class=exclam title="click to see password" onmouseover="this.style.background='#fee';" onmouseout="this.style.background='transparent';" onclick="js_chip(1);//(function() {location.reload();}).delay(1000);">[!]</span>:</span><span class=nw_change_mob id=changer_7 onclick="toggle_add_edit_box(7,1);\$('input_7').focus();">change</span></div>
			<div class=show_input_container id=sic_7>
				<div class=show_div id="show_div_7"><span id="show_7" class=sc2>********</span></div>
				<div class=input_div id="input_div_7">
					<input id="input_7" class=ic type=text value="$WP_STR" onblur="toggle_add_edit_box(7,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {blinker(7);js_change_value(7);js_chip(1,1);}}">
				</div>
			</div>
                        <div id="XP_container"><span class=nw_title_mob>Admin key<span class=exclam title="click to see password" onmouseover="this.style.background='#fee';" onmouseout="this.style.background='transparent';" onclick="js_chip(2);//(function() {location.reload();}).delay(1000);">[!]</span>:</span><span class=nw_change_mob id=changer_8 onclick="toggle_add_edit_box(8,1);\$('input_8').focus();">change</span></div>
			<div class=show_input_container id=sic_8>
				<div class=show_div id="show_div_8"><span id="show_8" class=sc2>********</span></div>
				<div class=input_div id="input_div_8">
					<input id="input_8" class=ic type=text value="$XP_STR" onblur="toggle_add_edit_box(8,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {blinker(8);js_change_value(8);js_chip(2,1);}}">
				</div>
			</div>
                   </div><!-- quarter_ab -->		    

                    <div id=quarter_ac class="tm-bg-primary-dark tm-block" style="font-size:18px;display:$di4;width:$wi;overflow:auto;min-height:27%;$fl">
                        <h2 class="tm-block-title" style="float:left;margin-left:5px;margin-right:10px;$bdimmer"$boncl>Blacklist</h2>
			<h2 class="tm-block-title" style="float:right;margin-right:10px;$wdimmer"$woncl>$antitor_menu_str</h2><span style="clear:all;"></span>
			<div class=nw_change onclick="\$('add_new_blip').setStyles({'display':'block'});\$('add_new_blip').value='';\$('add_new_blip').focus();" style="float:right;margin-right:0px;width:160px;text-align:right;margin-top:-10px;">new</div>
			<input id=add_new_blip type=text value="" style="display:none;width:120px;" onblur="\$('add_new_blip').setStyles({'display':'none'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateIPaddress(this.value,0)) {js_edit_bl(1,this.value); (function() {location.reload();}).delay(1000);}}">
			<div style="clear:all;"><br></div>
};

my $file = "/etc/sysconfig/$current_list";
my @bips = ();

if (open my $info, $file) {

while( my $line = <$info>)  {
	$line =~ s/(\r|\n)//g;  
	push @bips,$line;    
}

close $info;
$c = 0;
foreach my $l (@bips) {
	print qq{
		<div id="blip$c" class=blips onclick="var yon = window.confirm('Really delete?!');if (yon) {js_edit_bl(2,'$l');\$('blip$c').setStyles({'display':'none'});}">$l</div>
	};
	++$c;
}
	
} #if open

print qq{		
                    </div><!-- quarter_ac -->
                    <div id=quarter_ad class="tm-bg-primary-dark tm-block" style="font-size:18px;display:$di5;min-height:27%;text-align:center;width:$wi;$fr">
                        <h2 class="tm-block-title">Save\&Restore</h2>
			<div class=ctrl_btn id="save_button" style="margin:20px auto;" onclick="var yon = window.confirm('Really Save?!');if (yon) {data_needs_saving=0;js_ctrl(3);}">Save</div>
			<div class=ctrl_btn id="savereboot_button" style="margin:20px auto;" onclick="var yon = window.confirm('Really Save and Reboot?!');if (yon) {data_needs_saving=0;\$('settingsPage').setStyles({'opacity': 0.5 });\$('settingsPage').setStyles({'background': 'url(/icon/spinning-wheel3.gif) no-repeat center' });js_ctrl(4);(function() {location.href='$scriptname?mode=system_panel';}).delay(240000);}">Save\&Reboot</div>
			<div class=ctrl_btn id="reset_button" style="margin:20px auto;" onclick="var yon = window.confirm('Really Reset?!');if (yon) {data_needs_saving = 0;js_ctrl(10);}">Reset</div>
			<div class=ctrl_btn id="factory_reset_button" style="margin:20px auto;" onclick="var yon = window.confirm('Reset to Factory?!');if (yon) {js_ctrl(5);location.reload();}">Reset to Factory</div>
                    </div><!-- quarter_ad -->
		</div><!-- boxer -->
            </div><!-- row -->
            <div class="row" style="margin-top:30px;">	    
	    	<div>
			<div style="float:left;margin-left:5px;margin-top:5px;">
				<p class="text-white mb-5">
		    			<span style="float:left;margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_hname :</span>
					<span id=show_9 style="font-weight:bold;color:#9cf;float:left;cursor:pointer;background:#455c71;padding:0px 2px;display:inline;" onclick="\$('show_9').setStyles({'display':'none'});\$('input_9').setStyles({'display':'inline'});\$('input_9').focus();">$HNAME_STR</span>
					<input id=input_9 class=ic style="display:none;float:left;margin-top:-5px;padding:0px 2px;" type=text value='$HNAME_STR' onblur="\$('input_9').setStyles({'display':'none'});\$('show_9').setStyles({'display':'inline'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {var yon = window.confirm('Change HOST name?!');if (yon) {js_change_value(9);\$('input_9').setStyles({'display':'none'});\$('show_9').setStyles({'display':'inline'});}}}">
				</p>
			</div>
			<div style="float:left;margin-left:25px;margin-top:5px;">
				<p class="text-white mb-5">
		    			<span style="float:left;margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_http_s :</span>
		    			<span style="display:inline;font-weight:bold;background:#455c71;padding:3px 2px 2px 2px;color:#9cf;$ccdimmer"$cconcl>HTTP</span>&nbsp;<span style="display:inline;font-weight:bold;background:#455c71;padding:3px 2px 2px 2px;color:#9cf;$cdimmer"$concl>HTTPS</span>
				</p>			
			</div>
};
print qq{
			<div class="col">
			<p class="text-white mb-5" style="margin-left:$ml1;margin-top:48px;">
		    	<span style="float:left;margin:0px 5px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_op_pwd :</span>
			<span id=show_19 style="font-weight:bold;color:#9cf;float:left;cursor:pointer;background:#455c71;padding:0px 2px;" onclick="\$('show_19').setStyles({'display':'none'});\$('input_19').setStyles({'display':'inline'});\$('input_19').focus();">********</span>
			<input id=input_19 class=ic style="display:none;float:left;margin-top:0px;padding:0px 2px;width:90px;" type=text value='********' onblur="\$('input_19').setStyles({'display':'none'});\$('show_19').setStyles({'display':'inline'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {var yon = window.confirm('Change password for op?!');if (yon) {js_change_value(19);\$('input_19').setStyles({'display':'none'});\$('show_19').setStyles({'display':'inline'});}}}">
			</p>
			</div><br>
			<div class="col">
			<p class="text-white mb-5" style="margin-left:$ml1;margin-top:48px;text-align:left;">
		    	<span style="margin:0px 5px;font-weight:bold;background:transparent;width:100%;padding:0px 2px;$colr">$curr_cbase :</span>
			<span id=show_18 style="font-weight:bold;color:#9cf;cursor:pointer;background:#455c71;padding:0px 2px;" onclick="\$('show_18').setStyles({'display':'none'});\$('input_18').setStyles({'display':'inline'});\$('input_18').focus();">$CBASE_STR</span>
			<input id=input_18 class=ic style="display:none;margin-top:0px;padding:0px 2px;width:360px;" type=text value='$CBASE_STR' onblur="\$('input_18').setStyles({'display':'none'});\$('show_18').setStyles({'display':'inline'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateSSIDaddress(this.value)) {var yon = window.confirm('Change COINBASE?!');if (yon) {js_change_value(18);\$('input_18').setStyles({'display':'none'});\$('show_18').setStyles({'display':'inline'});data_needs_saving=0;}}}">
			</p>
                    	<p class="text-white mb-5" style="margin-left:$m1;margin-top:-10px;">
		    	<span style="float:left;margin:0px;font-weight:bold;background:transparent;padding:0px 2px;$colr">$curr_mtarget :</span>
			<span id=show_20 style="margin:0px;font-weight:bold;color:#9cf;float:left;cursor:pointer;background:#455c71;padding:0px 2px;" onclick="\$('show_20').setStyles({'display':'none'});\$('input_20').setStyles({'display':'inline'});\$('input_20').focus();">$MTARGET_STR</span>
			<input id=input_20 class=ic style="display:none;float:left;margin-top:0px;padding:0px 2px;width:180px;" type=text value='$MTARGET_STR' onblur="\$('input_20').setStyles({'display':'none'});\$('show_20').setStyles({'display':'inline'});" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (ValidateURL(this.value)) {var yon = window.confirm('Change MINING TARGET?!');if (yon) {js_change_value(20);\$('input_20').setStyles({'display':'none'});\$('show_20').setStyles({'display':'inline'});}}}">
		    	</p>
			</div>
} if ($softpac eq '3');#miner

print qq{
			<div style="clear:both;"></div>
		</div>
            </div>
        </div><!-- container -->
};

} #touch or desktop

print qq{
	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>
    </div><!-- home -->
</body>
};
print qq{
<script language="JavaScript" type="text/javascript" src="/js_cp/bubbles.js"></script>
} unless ($touch_specific_bro || 1);

print qq{
</html>
};

}

sub print_w_ls_panel {

my $header_str = $language eq "russian" ? koitoutf8("���� ������") : "Proxy Logs";

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<a class=mob_nav href='$scriptname?mode=system_panel'>$info_menu_str</a>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob_active
$users_menu_mob
<a class=mob_nav href='$scriptname?mode=nw_panel'>$settings_menu_str_short</a>
<!-- a class=mob_nav href='$scriptname?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : '';

my $wdth = $touch_specific_bro ? "100%" : "1080px";
my $hght = $touch_specific_bro ? "630px" : "480px";

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*"> 
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
    $bubbles_css
<style>

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}

.mob_nav {color:#ccc;width:15%;padding:5px 2px;}

</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>
<script>
function js_ctrl(par) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_ctrl');
		document.body.appendChild(form);	
		document.getElementById('myForm_js_ctrl').action = '$scriptname?mode=js_ctrl&par='+par;		
		document.getElementById('myForm_js_ctrl').set('send', {onComplete: function(response) { 
			check_response(response);
		}});	
		document.getElementById('myForm_js_ctrl').send();
		document.getElementById('myForm_js_ctrl').dispose();
		
		(function() {location.reload();}).delay(1000);

}

</script>
</head>

<body id="LightsquidPage" style="background:#eee;$onlo">
};
print qq{
<!--Copyright to Shen Huang, you can reach me out at shenhuang@live.ca-->
<div id = "board"></div>
		<sand></sand>
		<water></water>
		<skymask></skymask>
		<boat>
			<mast></mast>
			<sail></sail>
		</boat>
		<tree>
			<branch></branch>
			<leaf1></leaf1>
			<leaf2></leaf2>
			<leaf3></leaf3>
			<leaf4></leaf4>
			<leaf5></leaf5>
			<leaf6></leaf6>
			<coconut1></coconut1>
			<coconut2></coconut2>
			<coconut3></coconut3>
		</tree>
} 
unless ($touch_specific_bro)
;

my $mrg = $touch_specific_bro ? "margin: 20px auto;" : "margin-top:20px;";
my $clr = $touch_specific_bro ? "#369" : "#fff";
my $mt = $touch_specific_bro ? "10px" : "60px";
my $mmt = $touch_specific_bro ? "-10px" : "48px";

print qq{
    <div id="home">
        <nav class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                    <div><div><h1 class="tm-site-title mb-0">$xTER</h1>
			<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a></div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div><div style="clear:all;"></div></div>
			
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=system_panel">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
                        $logs_menu2
			$users_menu
                        <li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                            </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                Admin, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div class="container" style="margin-top:0px;text-align:center;">
            <div class="row" style="margin-top: 0px;text-align:center;">
                <div class="col">
                    <p style="margin-top:$mmt;color:$clr;"><!-- b>$header_str</b --></p>
                </div>
            </div>
            <div class="row tm-content-row" style="text-align:center;">
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="text-align:center;padding-top:0px;$mrg">
     			<object type="text/html" data="$scriptname?mode=ls_panel" style="overflow:auto;width:$wdth;height:$hght;border-radius:60px;margin:0px auto 48px auto;"></object>
    			</object>
                </div>
	    </div>
	 </div>	 
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>	 
    </div>
</body>
};
print qq{
<script language="JavaScript" type="text/javascript" src="/js_cp/bubbles.js"></script>
} unless ($touch_specific_bro);

print qq{
</html>
};
}

sub print_videos_page {

my $ml = $touch_specific_bro ? "margin-left:-30px;" : '';
my $mtt = "-200px";

my $file = defined($query->param('file_name')) ? $query->param('file_name') : '';

my $o = defined($query->param('o')) ? $query->param('o') : '';
check_real_o($o);

my $buffer_state = 0;
my %Coo = TClubMD5::GetCookies('cdAuth');
my $c = substr($Coo{'cdAuth'},8,8);

$buffer_state = 1 if( (-f "/tmp/".$c.$real_o."rec.webm") && (-s "/tmp/".$c.$real_o."rec.webm") > 0);
$buffer_state = 2 if (length($file));

my $BU = $buffer_state == 1 ? "BUFFER <span style=\"color:#900;font-style:italic;cursor:pointer;text-decoration:underline;\" onclick=\"var yon = window.confirm(why); if (yon) {save(0);bu=0;\$(this).closest('div').empty();} return false;\">discard</span>?" : $buffer_state == 2 ? $file : '';

my $wi = $touch_specific_bro || 1 ? "width:95%;" :'';

#print STDERR "Here scriptURL is $scriptURL!\n";

#$scriptURL =~ /:\/\/(.+?):(\d+)/;
my $local = ($scriptURL =~ /:\/\/192\.168/) ?  1 : 0;
my $mt5 = $touch_specific_bro ? "margin-top:5vh;" : '';

print qq{

    <link rel="stylesheet" href="/kure/components/bootstrap/dist/cssg/bootstrap.min.css">
    <link rel="stylesheet" href="/kure/components/demo-console/index.css">
    <link rel="stylesheet" href="/kure/components/ekko-lightbox/dist/ekko-lightbox.min.css">
    <link rel="stylesheet" href="/kure/css/kurento.css">
    <link rel="stylesheet" href="/css_cp/generic.css">

    <script src="/kure/components/webrtc-adapter/release/adapter.js"></script>
    <script src="/kure/components/jquery/dist/jquery.min.js"></script>
    <script src="/kure/components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="/kure/components/co/co.js"></script>
    <script src="/kure/components/setimmediate/setImmediate.js"></script>
    <script src="/kure/components/demo-console/index.js"></script>
    <script src="/kure/components/ekko-lightbox/dist/ekko-lightbox.min.js"></script>

    <script src="/kure/components/kurento-client/js/kurento-client.min.js"></script>
    <script src="/kure/components/kurento-utils/js/kurento-utils.min.js"></script>
};
#printing kurento js inline for easy consts

$scriptURL =~ /:\/\/(.+?)[:\/]/;
my $mainURL = $1.":8468";
#$mainURL = "room-house.com:8467"; #hack ash

print qq{
<script>

function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

function getopts(args, opts)
{
  var result = opts.default || {};
  args.replace(
      new RegExp("([^?=&]+)(=([^&]*))?", "g"),
      function(\$0, \$1, \$2, \$3) { result[\$1] = decodeURI(\$3); });

  return result;
};

var args = getopts(location.search,
{
  default:
  {
    // ws_uri: "ws://" + location.hostname + ":8888/kurento",

    ws_uri: "wss://$mainURL/kurento",
    file_name: 'welcome.webm',
    file_uri: 'file:///',
    o: '',
    p: 0,
    ice_servers: undefined
  }
});

var videoInput;
var videoOutput;
var webRtcPeer;
var client;
var pipeline;
var file_to_play='';
var pref = getCookie('cdAuth');pref=pref.substr(8,8);

const IDLE = 0;
const DISABLED = 1;
const CALLING = 2;
const PLAYING = 3;

function setStatus(nextState){
  switch(nextState){
    case IDLE:
      \$('#start').attr('disabled', false)
      \$('#stop').attr('disabled',  true)
      \$('#play').attr('disabled',  false)
      break;

    case CALLING:
      \$('#start').attr('disabled', true)
      \$('#stop').attr('disabled',  false)
      \$('#play').attr('disabled',  true)
      break;

    case PLAYING:
      \$('#start').attr('disabled', true)
      \$('#stop').attr('disabled',  false)
      \$('#play').attr('disabled',  true)
      break;

    case DISABLED:
      \$('#start').attr('disabled', true)
      \$('#stop').attr('disabled',  true)
      \$('#play').attr('disabled',  true)
      break;
  }
}


function setIceCandidateCallbacks(webRtcPeer, webRtcEp, onerror)
{
  webRtcPeer.on('icecandidate', function(candidate) {
    console.log("Local candidate:",candidate);

    candidate = kurentoClient.getComplexType('IceCandidate')(candidate);

    webRtcEp.addIceCandidate(candidate, onerror)
  });

  webRtcEp.on('IceCandidateFound', function(event) {
    var candidate = event.candidate;

    console.log("Remote candidate:",candidate);

    webRtcPeer.addIceCandidate(candidate, onerror);
  });
}


window.onload = function() {
  console = new Console();

  videoInput = document.getElementById('videoInput');
  videoOutput = document.getElementById('videoOutput');

  setStatus(IDLE);
//console.log('local',local);
}

function start() {
  setStatus(DISABLED);
  showSpinner(videoInput, videoOutput);
  
  var options =
  {
    localVideo: videoOutput,
    remoteVideo: null 
  }

  if (args.ice_servers) {
    console.log("Use ICE servers: " + args.ice_servers);
    options.configuration = {
      iceServers : JSON.parse(args.ice_servers)
    };
  } else {
   // console.log("Use freeice")
  }

  webRtcPeer = kurentoUtils.WebRtcPeer.WebRtcPeerSendrecv(options, function(error)
  {
    if(error) return onError(error)

    this.generateOffer(onStartOffer)
  });
console.log('Preparing to start .. hold on');
}

function stop(err) {
  if (webRtcPeer) {
    webRtcPeer.dispose();
    webRtcPeer = null;
  }

  if(pipeline){
    pipeline.release();
    pipeline = null;
  }

  hideSpinner(videoInput, videoOutput);
  setStatus(IDLE);
  var why = 'Really?';
if (bu == 1) {var ha = err ? '' : '-- BUFFER --';document.getElementById('informer').innerHTML=ha;return false;} if (bu == 2) {if (\$('#myForm_unbuf_vmail')) \$('#myForm_unbuf_vmail').remove();let form = document.createElement('form');
			form.setAttribute('method', 'get');
			form.setAttribute('id', 'myForm_unbuf_vmail');
			document.body.appendChild(form);let frm=\$('#myForm_unbuf_vmail');frm.submit(function(e) {e.preventDefault();\$.ajax({type: frm.attr('method'),url: act_unbuf+'&id='+curr,success: function(response) {check_response(response);console.log('clean buffer:',response);let obj = JSON.parse(response);
			if (obj.result == 'OK') {console.log('buffer cleaned');} else {console.log('could not clean buffer');}}})});frm.trigger('submit');document.getElementById('informer').innerHTML=su;}
}

function play(f){
  setStatus(DISABLED)
  showSpinner(videoOutput);
  document.getElementById('informer').innerHTML='';
  
  file_to_play = f;
 
  var options =
  {
    localVideo: null,
    remoteVideo: videoOutput
  }

  if (args.ice_servers) {
    console.log("Use ICE servers: " + args.ice_servers);
    options.configuration = {
      iceServers : JSON.parse(args.ice_servers)
    };
  } else {
  //  console.log("Use freeice")
  }


  webRtcPeer = kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options, function(error)
  {
    if(error) return onError(error)

    this.generateOffer(onPlayOffer);
  });
}

function onPlayOffer(error, sdpOffer){
  if(error) return onError(error);

  co(function*(){
    try{
      
      var addr = local ? "wss://$mainURL/kurento" : args.ws_uri;
      
      if(!client) client = yield kurentoClient(addr);

      pipeline = yield client.create('MediaPipeline');

      var webRtc = yield pipeline.create('WebRtcEndpoint');
      setIceCandidateCallbacks(webRtcPeer, webRtc, onError)
      
      var f = file_to_play.length ? args.file_uri+'tmp/'+args.o+'/'+pref+'.'+file_to_play : args.file_uri+'tmp/'+pref+args.o+'rec.webm';
//console.log('play file',f);
      var player = yield pipeline.create('PlayerEndpoint', {uri : f});

      player.on('EndOfStream', stop);

      yield player.connect(webRtc);

      var sdpAnswer = yield webRtc.processOffer(sdpOffer);
      webRtc.gatherCandidates(onError);
      webRtcPeer.processAnswer(sdpAnswer);

      yield player.play()

      setStatus(PLAYING)
    }
    catch(e)
    {
      onError(e);
    }
  })();
}

function onStartOffer(error, sdpOffer)
{
  if(error) return onError(error)

  co(function*(){
    try{
    var addr = local ? "wss://$mainURL/kurento" : args.ws_uri;
      if(!client)
        client = yield kurentoClient(addr);

      pipeline = yield client.create('MediaPipeline');

      var webRtc = yield pipeline.create('WebRtcEndpoint');
      setIceCandidateCallbacks(webRtcPeer, webRtc, onError)
      
      var f = args.file_uri+'tmp/'+pref+args.o+'rec.webm';
//console.log('rec file',f);

      var recorder = yield pipeline.create('RecorderEndpoint', {uri: f, mediaProfile:'WEBM'});
      yield webRtc.connect(recorder);
      yield webRtc.connect(webRtc);
      
      yield recorder.record();
      
      var sdpAnswer = yield webRtc.processOffer(sdpOffer);
      webRtc.gatherCandidates(onError);
      webRtcPeer.processAnswer(sdpAnswer)

      setStatus(CALLING);
setTimeout(function(){ alert('RECORDING!'); }, 1000);
console.log('RECORDING...');

    } catch(e){
      onError(e);
    }
  })();
}

function onError(error) {
  if(error)
  {
    console.error(error);
    stop(1);
  }
}

function showSpinner() {
  for (var i = 0; i < arguments.length; i++) {
    arguments[i].poster = '/kure/img/transparent-1px.png';
    arguments[i].style.background = "center transparent url('/kure/img/spinner.gif') no-repeat";
  }
}

function hideSpinner() {
  for (var i = 0; i < arguments.length; i++) {
    arguments[i].src = '';
    arguments[i].poster = '/kure/img/webrtc.png';
    arguments[i].style.background = '';
  }
}

/**
 * Lightbox utility (to display media pipeline image in a modal dialog)
 */
\$(document).delegate('*[data-toggle="lightbox"]', 'click', function(event) {
  event.preventDefault();
  \$(this).ekkoLightbox();
});
</script>
};

print qq{
    <!-- script src="/kure/js/index.js"></script -->
    <!-- script src="/js_cp/jquery.query-object.js"></script -->
	
    <script language="JavaScript" type="text/javascript" src="/js_cp/$genericjs"></script>
    <script>
    	var bu = $buffer_state;
	var fi = '';
	var su = '';
	var curr = 0;
	var act_buf = '/cgi/genc/cp?mode=buf_vmail&t=1';
	var act_unbuf = '/cgi/genc/cp?mode=buf_vmail&t=0';
	var act_save = '/cgi/genc/cp?mode=save_rec';
	var act_del = '/cgi/genc/cp?mode=delete_vmail';
	var act_check = '/cgi/genc/cp?mode=check_vmail';
	var act_rlist = '/cgi/genc/cp?mode=reload_rlist';
	var why = 'Really?';
	var local = $local;
/*
//https://stackoverflow.com/questions/1090948/change-url-parameters/10997390	
	function replaceQueryParam(param, newval, search) {
		var regex = new RegExp("([?;&])" + param + "[^&;]*[;&]?");
		var query = search.replace(regex, "\$1").replace(/&\$/, '');

		return (query.length > 2 ? query + "&" : "?") + (newval ? param + "=" + newval : '');
	}
*/	
	function slide_to_video() {
	
	    var w = (\$(window).width()-270)/2;	
		if (\$(window).width()<641) {
	
	    	\$('html, body').animate({
        		scrollLeft: \$('#vid').offset().left-w
    		}, 'slow');
	
	    }
	}
			
    	function save(ty) {
	   check_my_auth();
          if (ty) {
	   if (bu == 1) {
		var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';	
		\$("#ajax_0").css("position",pos);
		\$("#ajax_0").css("left","50%");
		\$("#ajax_0").css("top","50%");
		\$("#ajax_0").css("margin-left","-240px");
		\$("#ajax_0").css("margin-top","-150px");
		\$("#ajax_0").css("display","block");
  		\$("#ajax_0").fadeIn("slow",function() {console.log('fadedIn');});
		\$('#container_log_ajax_0').css("display","block");
		var log_add_ad = \$('#_ajax_0').empty().addClass('ajax-loading');
		if (\$('#myForm_save_rec')) \$('#myForm_save_rec').remove();
		let form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_save_rec');
		document.body.appendChild(form);
		let frm=\$('#myForm_save_rec');
		frm.submit(function(e) {e.preventDefault();\$.ajax({type:frm.attr('method'),url:act_save+'&t='+ty,success:function(response){check_response(response);
			log_add_ad.removeClass('ajax-loading');
                	log_add_ad.html(response);}})});
		frm.trigger('submit');
		console.log('saved');
    	   } else if (bu == 2) {
	   //save to local?
	   } else {
	   	//alert('buffer empty!');
		document.getElementById('informer').innerHTML='EMPTY BUFFER';
		return;
		
	   } 
          } else {
		if (\$('#myForm_rm_buffer')) \$('#myForm_rm_buffer').remove();
		let form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_rm_buffer');
		document.body.appendChild(form);
		let frm=\$('#myForm_rm_buffer');
		frm.submit(function(e) {e.preventDefault();\$.ajax({type:frm.attr('method'),url:act_save+'&t='+ty,success:function(response){check_response(response);
				console.log('removed buffer');
		}})});
		frm.trigger('submit');	  
          }
    	}

	function sendForm() {
		
		if (\$('#myForm_check_vmail')) \$('#myForm_check_vmail').remove();
		
		let form = document.createElement('form');
		
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_check_vmail');
		document.body.appendChild(form);
		let frm=\$('#myForm_check_vmail');
		frm.submit(function(e) {
			e.preventDefault();
			\$.ajax({type: frm.attr('method'), 
				url: act_check, success: function(response) {
					check_response(response);
					let obj = JSON.parse(response);
					let cur = parseInt(document.getElementById('num_new_vmails').innerHTML);
					let curtot = parseInt(document.getElementById('num_vmails').innerHTML);
					let tot = parseInt(obj.total);
					let nu = parseInt(obj.new);

					if (nu > 0) {
						top.document.title = 'You have '+nu+' new videos!';
					} else if (nu == 0) {
						top.document.title = '$copy_str2';
					}
					if (nu > cur) console.log('Dzzin!',nu,'new');
					if (nu != cur) { //on new
						reload_rlist();
					}
					if (nu == cur && tot != curtot) { //on deleted by author
						reload_rlist();
					}
					setTimeout(sendForm, 3000);
				}
			})
		});
		frm.trigger('submit');
	}
	
	function reload_rlist() {

		if (\$('#myForm_reload_rlist')) \$('#myForm_reload_rlist').remove();
		let log_add_ad = \$('#rlist_container').empty().addClass('ajax-loading');
		let form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_reload_rlist');
		document.body.appendChild(form);
		let frm=\$('#myForm_reload_rlist');
		frm.submit(function(e) {e.preventDefault();\$.ajax({type:frm.attr('method'),url:act_rlist, success:function(response){check_response(response);
                	log_add_ad.removeClass('ajax-loading');
			log_add_ad.html(response);
			}})
		});
		frm.trigger('submit');
	}
    </script>
};

&print_drago;

#ajax form
&print_styled_ajax_box(0,1);

#https://greywyvern.com/?post=323
print qq{
<div id="parent" style="position:relative;right:50%;text-align:center;border:0px solid #009;$mt5">
    <div id=container style="text-align:center;margin-top:-16px;display:inline-block;margin-right:-100%;border:0px solid #900;$wi">
     
      <div id="row1" style="width:842px;margin:0 auto;">
	
        <div style="display:none;">
          <video id="videoInput" autoplay width="480px" height="360px"
            poster="/kure/img/webrtc.png"></video>
        </div><!-- col1 -->
    <div id=widgets style="margin:0 auto;width:860px;white-space:nowrap;border:0px solid #009;">	
      <div class=leri style="width:270px;margin-left:-15px;margin-right:0px;display:inline-block;text-align:center;border:0px solid #900;">	
        <div id=llist_title style="width:270px;margin:0 auto 8px auto;text-align:center;">
		Sent Mail
	</div>
      </div>
        <div id="buttons" style="width:270px;margin:0 8px 8px 10px;border:0px solid #900;display:inline-block;">
          <a id="start" href="#" class="btn btn-danger" onclick="slide_to_video();document.getElementById('informer').innerHTML='RECORDING BUFFER';bu=1;start(); return false;">
            <div class="glyphicon glyphicon-record" style="float:left;margin:5px;"></div></a>

          <a id="stop" href="#" class="btn btn-warning" onclick="stop(0); return false;">
            <div class="glyphicon glyphicon-stop" style="float:left;margin:5px;"></div></a>
	    
          <a id="play" href="#" class="btn btn-success" onclick="slide_to_video();if (bu) {if (bu == 2) {if (\$('#myForm_buf_vmail')) \$('#myForm_buf_vmail').remove(); let form = document.createElement('form');
			form.setAttribute('method', 'get');
			form.setAttribute('id', 'myForm_buf_vmail');
			document.body.appendChild(form);let frm=\$('#myForm_buf_vmail');frm.submit(function(e) {e.preventDefault();\$.ajax({type: frm.attr('method'),url: act_buf+'&id='+curr,success: function(response) {check_response(response);console.log('create buffer:',response);let obj = JSON.parse(response);if (obj.result == 'OK' || obj.result.match('File exists')) {play(fi);} else {alert('could not play');}}})});frm.trigger('submit');} if (bu == 1) play('');} else {document.getElementById('informer').innerHTML='EMPTY BUFFER';} return false;">
            <div class="glyphicon glyphicon-play" style="float:left;margin:5px;"></div></a>

          <a id="ask_save_rec" href="#" class="btn btn-warning" style="background-color:#369;" onclick="save(1);return false;">
            <div class="glyphicon glyphicon-save" style="float:left;margin:5px;"></div></a>
	    
          <div style="clear:left;"></div>
        </div><!-- buttons -->
      <div class=leri style="width:270px;margin-left:0px;display:inline-block;text-align:center;">	
        <div id=rlist_title style="width:270px;margin:0 auto 8px auto;border:0px solid #900;text-align:center;">
		Received Mail
	</div>
      </div>
    </div><!-- widgets -->
      	
	<div id=box style="margin:0 auto;width:860px;white-space:nowrap;border:0px solid #090;">	
          <div class=leri style="width:270px;margin-left:5px;display:inline-block;">
		<div id="llist_container" style="display:none;width:270px;height:300px;background-color:#fed;border:0px solid #090;padding:10px;overflow-y:auto;">
};

&print_llist;
	
print qq{
		</div>
          </div>
          <div id=vid style="width:270px;margin-left:10px;display:inline-block;position:relative;"><div id="informer" style="display:none;position:absolute;top:5px;left:5px;z-index:999;">$BU</div>
		<video id="videoOutput" autoplay width="270px" height="300px" poster="/kure/img/webrtc.png"></video>
          </div>
          <div class=leri style="width:270px;margin-left:10px;margin-right:10px;display:inline-block;">
		<div id=rlist_container style="display:none;width:270px;height:300px;background-color:#fed;border:0px solid #090;padding:10px;overflow-y:auto;">
};

&print_rlist;

print qq{		
		</div>
          </div>
	</div><!-- col3-->
		
      </div><!-- row1 -->
      
      <div id="row2" style="display:none;width:300px;margin:0 auto;padding-left:30px;">
        <div>
          <label class="control-label" for="console">Console</label><br><br>
          <div id="console" class="democonsole">
            <ul></ul>
          </div>
        </div>
      </div><!-- row2 -->
    </div><!-- container -->
</div> <!-- parent -->
<script>

\$(document).ready(function () {
    
	slide_to_video();
    \$('#informer').css('display','block');
    \$('#llist_container').css('display','block');
    \$('#rlist_container').css('display','block');
    sendForm();
});
</script>
};
}

sub print_users_control {

my $o = defined($query->param('o')) ? $query->param('o') : '';
check_real_o($o);

my $whom = $develop == 15 ? "Interpreters" : "Clients";

print qq{
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <title>Clients Area</title>
};
print qq{
    <link rel="apple-touch-icon" sizes="60x60" href="/fronto_favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/fronto_favicon/fronto_favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/fronto_favicon/fronto_favicon-16x16.png">
    <link rel="manifest" href="/fronto_favicon/site.webmanifest">
    <link rel="mask-icon" href="/fronto_favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <link href="/fronto_css/bootstrap.css" rel="stylesheet">
    <link href="/fronto_css/font-awesome.min.css" rel="stylesheet">
    <link href="/fronto_css/index.css" rel="stylesheet">
} if ($develop == 15);

print qq{
</head>
<body onload="checkCoo()">
   <div>
    <div class="admin-content">
        <div class="container">
            <div class="wrapper">
                <table class="table table-new-conf" style="margin-top:40px;">
                    <thead></thead><tbody>
		    <!-- tr>
                        <td colspan="2" style="text-align:center;" >CRUD $whom</td>
                    </tr -->
                    <tr>
                        <td colspan="2">
} if ($develop == 15 || $develop == 16);

print qq{
<style>
.show_div {
display:block;
white-space:nowrap;
}

.input_div {
display:none;
white-space:nowrap;
}

.ic {
margin-left:0px;
width:120px;
margin-top:5px;
}

.sc2 {
display:inline;
background:transparent;
font-weight:bold;
color:#369;
line-height:32px;
}

</style>
};

print qq{
<link rel="stylesheet" href="/css_cp/generic.css">
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>

<script>

function writeCookie(cname,value) {
	var curCookie = escape(cname) + "=" + escape(value) +"; expires=Sat, 01-Jan-2033 00:00:01 GMT;SameSite=None;Secure;"
	document.cookie = curCookie
}

function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

function checkCoo() {
   var coo = getCookie('U_R'); 
   if (coo === 'b') {
	\$('pri_bu').style.background="transparent";
	\$('sec_bu').style.background="#faa";
	\$('pri_tab').style.display="none";
	\$('sec_tab').style.display="block";
   }
}

function check_response(response) {

	var r = new RegExp('DOCTYPE HTML PUBLIC','ig');
	if (typeof(response) != 'undefined' && response != null && response.match(r)) {
		document.body.style.opacity='0.05';
		alert('Authorization Required');
		(function(){location.href='/cgi/genc/cp?mode=login';}).delay(1000);
		return;
	}
}

function js_guru_controls(p) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_ctrl");

		document.body.appendChild(form); 
		\$('myForm_ctrl').action = '?mode=js_guru_ctrl&par='+p;
		//var mycabo = '$mycabo'; if (mycabo.length > 0) \$('myForm_ctrl').action = \$('myForm_ctrl').action + '&mycabo='+mycabo;
		\$('myForm_ctrl').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response); location.reload();			
		}});
		\$('myForm_ctrl').send();
		\$('myForm_ctrl').dispose();
}

function toggle_add_edit_box (num,mode) {

		   \$('show_div_'+num).style.display = mode == 1 ? 'none' : 'block';
		   \$('input_div_'+num).style.display = mode == 1 ? 'block' : 'none';
}

function toggle_r_add_edit_box (num,mode) {

		   \$('show_r_div_'+num).style.display = mode == 1 ? 'none' : 'block';
		   \$('input_r_div_'+num).style.display = mode == 1 ? 'block' : 'none';
}

function toggle_rn_add_edit_box (num,mode) {

		   \$('show_rn_div_'+num).style.display = mode == 1 ? 'none' : 'block';
		   \$('input_rn_div_'+num).style.display = mode == 1 ? 'block' : 'none';
}

function blinker(par) {
\$('input_'+par).fade(0);(function(){\$('input_'+par).fade(1);toggle_add_edit_box(par,0);}.delay(750));
}

function blinker_r(par) {
\$('input_r_'+par).fade(0);(function(){\$('input_r_'+par).fade(1);toggle_r_add_edit_box(par,0);}.delay(750));
}

function js_change_value(f,o) {
		
		var i = 'input_' + f;		
		var s = 'show_' + f;
		
		var v = document.getElementById(i).value;
		document.getElementById(s).innerHTML = v;

		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_au");

		document.body.appendChild(form); 
		\$('myForm_au').action = '/cgi/genc/cp?mode=js_change_value&par=21&val='+v+'&moid='+o;
		\$('myForm_au').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);			
		}});
		\$('myForm_au').send();
		\$('myForm_au').dispose();
}

function Validate(name) {
  if (/^([a-zA-Z0-9_.]+)\$/.test(name)) {  
    return (true)  
  }  
  alert("invalid value - only letters/numbers plz!")  
  return (false)  
}

function Validate_rn(name) {
  if (/^([1-6])\$/.test(name)) {  
    return (true)  
  }  
  alert("one number between 1 and 6!")  
  return (false)  
}

//window.addEvent('domready', function(){if (\$('page')) \$('page').fade(1);});
				
Locale.use('ru-RU');

var is_Admin = $is_admin;
	
</script>

};
print qq{<script language="JavaScript" type="text/javascript" src="/js_cp/generic.js"></script>};
print qq{
<script>
function js_radio_av(a) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_radio_av");

		document.body.appendChild(form); 
		\$('myForm_radio_av').action = '/cgi/genc/cp?mode=js_radio_av&type='+a;

		\$('myForm_radio_av').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				console.log('Type_av:', response);			
		}});
		\$('myForm_radio_av').send();
		\$('myForm_radio_av').dispose();
}

function js_change_logo() {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_change_logo");

		document.body.appendChild(form); 
		\$('myForm_change_logo').action = '/cgi/genc/cp?mode=js_change_logo';
		var new_logo = \$('dbao') ? \$('dbao').value : '';
		if (new_logo.length > 0) \$('myForm_change_logo').action = \$('myForm_change_logo').action + '&dbao='+new_logo;

		\$('myForm_change_logo').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				console.log('Changed logo:', response);			
		}});
		\$('myForm_change_logo').send();
		\$('myForm_change_logo').dispose();
}

function js_ctrl(par) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_ctrl');
		document.body.appendChild(form);	
		\$('myForm_js_ctrl').action = '$scriptname?mode=js_ctrl&par='+par;		
		\$('myForm_js_ctrl').set('send', {onComplete: function(response) { 
			check_response(response);
		}});	
		\$('myForm_js_ctrl').send();
		\$('myForm_js_ctrl').dispose();
}

function js_change_chairs(v) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_au");

		document.body.appendChild(form); 
		\$('myForm_au').action = '/cgi/genc/cp?mode=js_change_value&par=25&val='+v;
		\$('myForm_au').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				console.log('response is', response);			
		}});
		\$('myForm_au').send();
		\$('myForm_au').dispose();
}

function js_change_room(f,o) {
		
		var i = 'input_r_' + f;		
		var s = 'show_r_' + f;
		
		var v = document.getElementById(i).value.toUpperCase();
		//document.getElementById(s).innerHTML = v;

		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_cr");

		document.body.appendChild(form); 
		\$('myForm_cr').action = '/cgi/genc/cp?mode=js_change_value&par=22&val='+v+'&moid='+o;
		\$('myForm_cr').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				location.reload();			
		}});
		\$('myForm_cr').send();
		\$('myForm_cr').dispose();
}

function js_change_rooms_number(f,o) {

		var i = 'input_rn_' + f;
		var s = document.getElementById(i).value;
			
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_crn");
		
		var v = parseInt(s) > 6 ? 6 : parseInt(s) < 1 ? 1 : parseInt(s);
		document.body.appendChild(form); 
		\$('myForm_crn').action = '/cgi/genc/cp?mode=js_change_value&par=30&val='+v+'&moid='+o;
		\$('myForm_crn').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
				location.reload();			
		}});
		\$('myForm_crn').send();
		\$('myForm_crn').dispose();
}

var button_clicked = false;

</script>
} if ($develop == 16);

&print_mbox if ($mBox);
&print_centered_ajax_box("add_jpg");
&print_drago;

print qq {
<div id=log_spinning style="display:none;background:url(/icon/spinning-wheel3.gif) no-repeat center;
position:fixed;top:300px;left:300px;width:200px;height:90px;z-index:2000;"></div>
};

#ajax form
&print_styled_ajax_box(0);
print qq{
	<form id="myForm_add_jpg" action="/cgi/genc/cp?mode=add_jpg" method="get">
	</form>
	<span id=anchor></span>
};

my $sta = 0;
my $stb = 0;
my $sta_icon = "&#128275;";
my $stb_icon = "Normal";
my $action = "lock the room";
my $action_b = "switch to demo";
my $a = 2;
my $b = 4;

my $na = '';
my $LO = "<b>open</b>";
my $bgr = "#b2e6c5";#greenish
my $bgrb = "#b2e6c5";#greenish

my $room_limit_file = "/home/nobody/".$mycabo."_room_limit";
my $room_limit = `cat $room_limit_file`;

if ($develop == 16) {

#create table rooms (id serial, name text, status int2 default 0);
#insert into rooms (name) values ('Hall of Fame');

$comm = "select name, status from rooms where name = '$mycabo'";
&getTable;

$na = $ntuples == 1 ? ${${$listresult}[0]}[0] : $na;
$sta = $ntuples == 1 ? ${${$listresult}[0]}[1] : $sta;

my $l = $is_admin || ($mycabo_master && ($mycabo eq "GREENHALL" || $mycabo eq "REDHALL" || $mycabo eq "BLUEHALL")) ? `grep false /var/www/html/cp/public_html/join_$mycabo.html` : '';
#print STDERR "Here mycabo is $mycabo, is_admin is $is_admin, l is $l!\n";
$stb = length($l) ? 1 : $stb; 

$action = $sta ? "unlock the room" : "lock the room";
$action_b = $stb ? "switch to normal" : $action_b;

$a = $sta ? 3 : 2; #3 - unlock, 2 lock
$b = $stb ? 5 : 4; #5 - to normal, 4 to demo

$sta_icon = $sta ? "&#128274;" : $sta_icon;
$stb_icon = $stb ? "Demo" : $stb_icon;

$LO = $sta ? "<b>locked</b>" : $LO;

$bgr = $sta ? "#fff" : $bgr;
$bgrb = $stb ? "#fff" : $bgrb;
}

my $lh = "var counterRect = \$('add_meme').getBoundingClientRect();var a = counterRect.left-88;var b = counterRect.top-36;";
my $lhr = "var counterRect = \$('add_roome').getBoundingClientRect();var a = counterRect.left-88;var b = counterRect.top-36;";
my $lcr = "var counterRect = \$('ch_passe').getBoundingClientRect();var a = counterRect.left-88;var b = counterRect.top-36;";
my $stu_list = "Users";
my $roo_list = "Aparts";

$stu_list = "INTERPRETERS" if ($develop == 15);

$comm = "select proj_code::int from members where proj_code != 'admin' order by proj_code::int desc";
&getTable;
	
my $next_id = $ntuples ? ${${$listresult}[0]}[0] + 1 : 1;

#my $multicab_addon = $multicabo ? length($mycabo) ? " and room = '$mycabo' and room_master is not true" : " and room_master is not true" : '';

my $multicab_addon  = $is_admin ? " and room = '$mycabo'" : " and room = '$mycabo' and room_master is not true"; #do not show assigned masters
	
my $chu = TClubMD5::md5_hex(time());
$chu =~ y/0-9//cd;
my $random_nick = substr($chu,6,4);
my $random_pass = substr($chu,0,6);

#get all users for house
#select proj_code,pass,a_nkname,room_master,room from members,rooms where members.room=rooms.name and rooms.house = 'milan';

my $mt = $touch_specific_bro ? "-5vh auto 0 auto" : "-42px auto 0 auto";
my $vali = $develop == 12 ? "middle" : "top";

print qq{
<div id=basic_cont style="font-size:18px;position:absolute; display:table; text-align:center; border: 0px solid #666; width:95%; padding:10px; height:90%; margin:$mt;"><!-- tab container -->
<div style="display:table-cell; vertical-align:$vali; border: 0px solid #222; width:50%; margin:0 auto;"><!-- valign tab container -->
<div style="text-align:center; width:100%; max-width: 640px; margin:30px auto 0 auto; text-align:center; border: 0px solid #369; position:relative;"><!-- table_container -->
};

if ($develop == 16) {

my $disp_no = $mycabo_master && ($mycabo eq "GREENHALL" || $mycabo eq "REDHALL" || $mycabo eq "BLUEHALL") ? '' : "display:none"; #hack
my $disp_no2 = $mycabo_master && $mycabo =~ /HALL/ && 0 ? "display:none" : ''; #hack hack

print qq{ 
   <div style="border:0px solid #ccc; width:50%; margin:0 auto 10px auto; min-width:70vw;"><!-- table_menu_container -->
      <div style="text-align:left;"><!-- menu_controls_container -->
		  <div style="float:left; width:40%; padding:5px 3px; background:#eee;"><span style="background:#fff;">$na</span> is $LO:&nbsp;<input type=button style="background:$bgr;border:none;cursor:pointer;" value="$sta_icon" onclick="var yon = window.confirm('Really $action?'); if (yon) {js_guru_controls($a);}" /></div>
		  <div style="float:left; text-align:center; width:25%; padding:5px 3px; min-width:30px; margin-top:0px;"><span style="background:#fff;">chairs:</span>&nbsp;<input type=text style="width:36px; margin-left:3px; padding:2px;" value="$room_limit" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (this.value.length) {js_change_chairs(this.value);}}" /></div>
		  <div style="float:left; text-align:center; width:25% ;padding:5px 3px; background:#eee;$disp_no"><span style="background:#fff;">mode:</span>&nbsp;<input type=button style="background:$bgrb;border:none;cursor:pointer;" value="$stb_icon" onclick="var yon = window.confirm('Really $action_b?'); if (yon) {js_guru_controls($b);}" /></div>
		  <div style="float:left; text-align:center; width:25% ;padding:5px 3px; background:#eee;$disp_no2"><span style="background:#fff;">texture: <span id=ask_add_jpg style="color:#009;text-decoration:underline;cursor:pointer;">upload</span></span></div>
		  <div style="clear:left;"></div>
     </div><!-- menu_controls_container -->
   </div><!-- table_menu_container -->
} if ( length($na) );

}

my $disp_pri = "block";
my $disp_sec = "none";
my $pri_sec = "#faa";
my $sec_pri = "transparent";
my $disph = $is_admin ? '' : "display:none;";

print qq{
   <div style="border:0px solid #ccc; width:70%; margin:0 auto 20px auto; min-width:65vw;"><!-- table_controls_container -->
     <div style="text-align:left;"><!-- controls_container -->
		  <div style="float:left; width:40%; padding:5px 3px; min-width:160px;  background:#eee; position:relative;">
		    
			<div id="pri_bu" style="float:left;background:$pri_sec;padding:3px;cursor:pointer;min-width:60px;width:45%;" onclick="if (!button_clicked && is_Admin) {writeCookie('U_R','a');let a=this.style.background; this.style.background=\$('sec_bu').style.background;\$('sec_bu').style.background=a;let b=\$('pri_tab').style.display;\$('pri_tab').style.display=\$('sec_tab').style.display;\$('sec_tab').style.display=b;}">$stu_list: <input id=add_meme type=button value='+' onclick="button_clicked = true; var form = document.createElement('form');
			form.setAttribute('method', 'get');writeCookie('U_R','a');
			form.setAttribute('id', 'myForm_add_member');
			document.body.appendChild(form);
			\$('myForm_add_member').action = '/cgi/genc/cp?mode=do_add_member&proj_code=$next_id&pass=$random_pass&k_kredit=0&a_nkname=$random_nick';
			var mycabo = '$mycabo'; if (mycabo.length > 0) \$('myForm_add_member').action = \$('myForm_add_member').action + '&mycabo='+mycabo;
		   \$('myForm_add_member').set('send', {onComplete: function(response) {		
		   $lh;
		   var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		   \$('log_spinning').setStyles({'position': pos });
		   \$('log_spinning').setStyles({'left': a });	
		   \$('log_spinning').setStyles({'top': b });
		   \$('log_spinning').setStyles({'display': 'block' });
		   \$('log_spinning').fade(1);
		   (function() {location.reload();}).delay(1000);	
		   }});\$('myForm_add_member').send();\$('myForm_add_member').dispose();console.log('user added');return false;" style="width:24px;font-size:12px;padding:1px 3px;margin-bottom:5px;cursor:pointer;color:#222;">
			</div>
};
print qq{
			<div id="sec_bu" style="float:right;background:$sec_pri;padding:3px;cursor:pointer;min-width:60px;width:45%;$disph" onclick="if (!button_clicked && is_Admin) {writeCookie('U_R','b');let a=this.style.background; this.style.background=\$('pri_bu').style.background;\$('pri_bu').style.background=a;let b=\$('sec_tab').style.display;\$('sec_tab').style.display=\$('pri_tab').style.display;\$('pri_tab').style.display=b;}">$roo_list: <input id=add_roome type=button value='+' onclick="button_clicked = true; var form = document.createElement('form');
			form.setAttribute('method', 'get');writeCookie('U_R','b');
			form.setAttribute('id', 'myForm_add_room');
			document.body.appendChild(form);
			\$('myForm_add_room').action = '/cgi/genc/cp?mode=do_add_room';
			var mycabo = '$mycabo'; if (mycabo.length > 0) \$('myForm_add_room').action = \$('myForm_add_room').action + '&mycabo='+mycabo;
		   \$('myForm_add_room').set('send', {onComplete: function(response) {		
		   $lhr;
		   var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		   \$('log_spinning').setStyles({'position': pos });
		   \$('log_spinning').setStyles({'left': a });	
		   \$('log_spinning').setStyles({'top': b });
		   \$('log_spinning').setStyles({'display': 'block' });
		   \$('log_spinning').fade(1);(function() {location.reload();}).delay(1000);}});\$('myForm_add_room').send();\$('myForm_add_room').dispose();console.log('room added');return false;" style="width:24px;font-size:12px;padding:1px 3px;margin-bottom:5px;cursor:pointer;color:#222;">		   
			</div>
} if ($vg_owner);

if (!$is_admin) {
$comm = "select pass from members where proj_code = '$r_user'";
&getTable;
	
my $passe = $ntuples ? ${${$listresult}[0]}[0] : '';
my $chu = TClubMD5::md5_hex(time());
my $n_pass = substr(TClubMD5::md5_hex($chu),0,6);

print qq{
			<div id="sec_bu" style="float:right;background:$sec_pri;padding:3px;min-width:120px;width:45%;"><small>Your password:</small> <b>$passe</b><input id=ch_passe type=button value='change' onclick="button_clicked = true; var yon = window.confirm('New Password: $n_pass ?! Write and push OK'); if (yon) { let formData = new FormData();formData.append('n_pass', '$n_pass');formData.append('mode', 'do_ch_pass');fetch('/cgi/genc/cp',{body: formData, method: 'post', credentials: 'include'}).then(function(response) {if (response.status !== 200) {console.log('Looks like there was a problem. Status Code: ' +response.status);return;}yon = window.confirm('Username: $r_user Password: $n_pass ! Write it down!!! and push OK'); parent.location.href = '$scriptURL?Submit=Logout';}).catch(function(err) {console.log('Fetch Error', err);});console.log('password changed');return false;}" style="width:90px;font-size:12px;padding:1px 3px;margin-bottom:5px;cursor:pointer;color:#222;float:right;">		   
			</div>
};
}

print qq{	  
		  <div style="clear:both;"></div></div>
		  
		  <div style="float:right; text-align:center; width:25%; max-width:120px; padding:0px 3px; cursor:pointer; margin-top:7px;" onclick="writeCookie('CHAT',1);location.reload();"> ==> <span style="color:#222;" onmouseover="this.style.color='#369';" onmouseout="this.style.color='#222';">TO CHAT</span></div>
		  <div style="clear:both;"></div>
     </div><!-- controls_container -->
   </div><!-- table_controls_container -->		  
};


print qq{
		
   <div id="pri_tab" style="border:0px solid #ccc;width:60%;margin:0 auto 10px auto;min-width:70vw;display:$disp_pri;"><!-- table1 -->
      <div style="text-align:left;padding-top:10px;"><!-- table1_header -->
		  <div style="float:left;width:10%;font-weight:bold;padding:5px 3px;">ID</div>
		  <div style="float:left;width:20%;font-weight:bold;padding:5px 3px;">PASS</div>
		  <div style="float:left;text-align:center;width:25%;font-weight:bold;padding:5px 3px;">NAME</div>
};

print qq{
		  <div style="float:right;text-align:center;width:25%;font-weight:bold;padding:5px 3px;margin-right:20px;">OWNER</div>
} if ($is_admin);

print qq{
		  <div style="clear:left;"></div>
      </div><!-- table1_header -->
};

if ($is_admin) { #show room masters to tower owner

  $comm = "select distinct proj_code, a_nkname, room, house, pass from members, rooms where proj_code != 'admin' and room != '$mycabo' and room_master = 't' and rooms.house = '$mycabo' and members.room=rooms.name";
  my $result=$dbconn->prepare($comm);
  $result->execute;
  &dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
  my $lr = $result->fetchall_arrayref;
  my $ntuples = $result->rows();
  for (my $i=0;$i < $ntuples; $i++) {
	my $id = ${${$lr}[$i]}[0];
	next unless ($id =~ /^\d+$/);#overkill
	my $nk = ${${$lr}[$i]}[1];
	my $roo = ${${$lr}[$i]}[2];
	my $hou = ${${$lr}[$i]}[3];
	
	my $pass = $r_user eq $extra_admin ? ${${$lr}[$i]}[4] : "****";

	print qq{<div style="text-align:left;border:1px solid #eee;"><!-- row -->
		   <div style="float:left;width:10%;padding:5px 3px;">$id</div>
		   <div style="float:left;width:20%;padding:5px 3px;">$pass</div>
		   <div style="float:left;width:25%;">$nk</div>
		   <div style="float:right;width:25%;margin-right:15px;">$roo/$hou</div>
		   <div style="clear:both;"></div>
		 </div><!-- row -->
	};
  }
} #end showing room masters to tower owner

#then show non-masters
$comm = "select proj_code, pass, a_nkname, room_master, id from members where proj_code != 'admin'$multicab_addon order by id desc";
my $result=$dbconn->prepare($comm);
$result->execute;
&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
my $lr = $result->fetchall_arrayref;
my $ntuples = $result->rows();
		
for (my $i=0;$i < $ntuples; $i++) {

my $id = ${${$lr}[$i]}[0];
next unless ($id =~ /^\d+$/);#overkill
my $pass = ${${$lr}[$i]}[1];
my $nk = ${${$lr}[$i]}[2];
#my $checked_wf = ''; $checked_wf = " checked=checked" if (${${$lr}[$i]}[3] eq '1');
my $idd = ${${$lr}[$i]}[4];
my $disp = $id =~ /^\d+$/ ? "block" : "none";


	print qq{<div style="text-align:left;border:1px solid #eee;"><!-- row -->
		  <div style="float:left;width:10%;padding:5px 3px;">$id</div>
		  <div style="float:left;width:20%;padding:5px 3px;">$pass</div>
		  <div style="float:left;width:25%;">
		     <span style="float:left;display:$disp;margin:4px;padding:3px;cursor:pointer;background:#fed;" onclick="var yon = window.confirm('Really DELETE user $nk ?!'); if (yon) {
		        var form = document.createElement('form');
			form.setAttribute('method', 'get');
			form.setAttribute('id', 'myForm_del_member');
			document.body.appendChild(form);
			\$('myForm_del_member').action = '/cgi/genc/cp?mode=do_del_member&moid=$id';
			var mycabo = '$mycabo'; if (mycabo.length > 0) \$('myForm_del_member').action = \$('myForm_del_member').action + '&mycabo='+mycabo;
		        \$('myForm_del_member').set('send', {onComplete: function(response) {		
		        $lh;
		        var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		        \$('log_spinning').setStyles({'position': pos });
		        \$('log_spinning').setStyles({'left': a });	
		        \$('log_spinning').setStyles({'top': b });
		        \$('log_spinning').setStyles({'display': 'block' });
		        \$('log_spinning').fade(1);
		        (function() {location.reload();}).delay(1000);	
		        }});\$('myForm_del_member').send();\$('myForm_del_member').dispose(); console.log('user removed'); return false;
			}">X</span>
		     <div class=show_div id="show_div_$i" onclick="toggle_add_edit_box($i,1);\$('input_$i').focus();"><span id="show_$i" class=sc2>$nk</span></div>
		     <div class=input_div id="input_div_$i">
			<input id="input_$i" class=ic type=text value="$nk" onblur="toggle_add_edit_box($i,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (Validate(this.value)) {blinker($i);js_change_value($i,$id)}}">
		     </div>
		  </div>
	};
	
	if ($is_admin) {
		print qq{
		  <div style="float:right;width:25%;margin-right:15px;">
		};
		print qq{
			<select id=sel_room style="line-height:24px;color:#222;font-size:18px;background:transparent;width:112px;margin-right:8px;" name=room_selector size=1 
			onChange="var yon = window.confirm('Really ASSIGN room ' + this.value + ' to user $nk ?!'); if (yon) {
			yon = window.confirm('SAVE -- USER: $nk -- LOGIN: $id -- PASSWORD: $pass !!! READY?'); if (yon) {var form = document.createElement('form');
			form.setAttribute('method', 'get');
			form.setAttribute('id', 'myForm_sel_room');
			document.body.appendChild(form);
			\$('myForm_sel_room').action = '/cgi/genc/cp?mode=do_sel_room&moid='+this.value + '&u=$idd';
			var mycabo = '$mycabo'; if (mycabo.length > 0) \$('myForm_sel_room').action = \$('myForm_sel_room').action + '&mycabo='+mycabo;
		        \$('myForm_sel_room').set('send', {onComplete: function(response) {		
		        $lhr;
		        var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		        \$('log_spinning').setStyles({'position': pos });
		        \$('log_spinning').setStyles({'left': a });	
		        \$('log_spinning').setStyles({'top': b });
		        \$('log_spinning').setStyles({'display': 'block' });
		        \$('log_spinning').fade(1);
		        (function() {location.reload();console.log('select room' + this.value);}).delay(500);}});
			\$('myForm_sel_room').send();
			\$('myForm_sel_room').dispose();} else {this.value=0}} else {this.value=0}">
		};
		
		$comm = "select id, name from rooms r where house='$mycabo' and not exists (select id from members where room = r.name and room_master = 't') order by id";		
		my $result=$dbconn->prepare($comm);
		$result->execute;
		&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
		my $lr = $result->fetchall_arrayref;
		my $ntuples = $result->rows();
				
		print qq{<option value='0'>-};
		for (my $i=0;$i<$ntuples;$i++) {
			my $id = ${${$lr}[$i]}[0];
			my $n = ${${$lr}[$i]}[1];
			print qq{
				<option value='$id'>$n
			};
		}
		
		print qq{</select></div>};
		  
	}
	print qq{
		  <div style="clear:both;"></div>
		</div><!-- end row -->};
} #for rows
	
print qq{
</div><!-- end table1 -->
};

print qq{
		
   <div id="sec_tab" style="border: 0px solid #ccc;width:60%;margin:0 auto 10px auto;min-width:70vw;display:$disp_sec;"><!-- table2 -->
      <div style="text-align:left;padding-top:10px;"><!-- table2_header -->
		  
		  <div style="float:left;width:16%;font-weight:bold;padding:5px 3px;">ID</div>
		  <div style="float:left;width:16%;font-weight:bold;padding:5px 3px;">N_ROOMS</div>
		  <div style="float:left;width:25%;font-weight:bold;padding:5px 3px;">OWNER</div>
		  <div style="float:right;width:30%;font-weight:bold;padding:5px 3px;">NAME</div>
};


print qq{
		  <div style="clear:left;"></div>
      </div><!-- table2_header -->
};

# only with master
$comm = "select rooms.id, rooms.name, rooms.num_rooms, members.a_nkname from rooms, members where house = '$mycabo' and members.room=rooms.name and members.room_master='t' order by id desc";
my $result=$dbconn->prepare($comm);
$result->execute;
&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
my $lr = $result->fetchall_arrayref;
my $ntuples = $result->rows();	
	
for (my $i=0;$i < $ntuples; $i++) {

my $id = ${${$lr}[$i]}[0];
my $nk = ${${$lr}[$i]}[1];

	print qq{<div style="text-align:left;border:1px solid #eee;"><!-- row -->
		  <div style="float:left;width:16%;padding:5px 3px;">$id</div>
		  <div style="float:left;width:16%;padding:5px 3px;">${${$lr}[$i]}[2]</div>
		  <div style="float:left;width:25%;padding:5px 3px;">${${$lr}[$i]}[3]</div>
		  <div style="float:right;width:30%;"><a href='https://$mycabo.room-house.com/#$nk' target=new>$nk</a></div>
	};

	print qq{
		  <div style="clear:both;"></div>
		</div><!-- end row -->};
} #for rows

#now only without master
$comm = "select id, name, num_rooms from rooms r where house = '$mycabo' and not exists (select id from members where room = r.name) order by id desc;";
#$comm = "select id, name, num_rooms from rooms r where house = '$mycabo' order by id desc;"; #we should show all rooms?
my $result=$dbconn->prepare($comm);
$result->execute;
&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
my $lr = $result->fetchall_arrayref;
my $ntuples = $result->rows();	

for (my $i=0;$i < $ntuples; $i++) {

my $id = ${${$lr}[$i]}[0];
my $nk = ${${$lr}[$i]}[1];
my $nr = ${${$lr}[$i]}[2];

	print qq{<div style="text-align:left;border:1px solid #eee;"><!-- row -->
		  <div style="float:left;width:16%;padding:5px 3px;">$id</div>
		  <!-- div style="float:left;width:16%;padding:5px 3px;">$nr</div -->
		  <div style="float:left;width:16%;padding:5px 3px;">
		  	<div class=show_div id="show_rn_div_$i" onclick="toggle_rn_add_edit_box($i,1);\$('input_rn_$i').focus();"><span id="show_rn_$i" class=sc2>$nr</span></div>
				<div class=input_div id="input_rn_div_$i">
				<input id="input_rn_$i" class=ic style="width:30px" type=text value="$nr" onblur="toggle_rn_add_edit_box($i,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (Validate_rn(this.value)) js_change_rooms_number($i,$id);}">
			</div>
		  </div>
		  <div style="float:left;width:25%;padding:5px 3px;">-</div>
		  <div style="float:right;width:30%;">
		     <span style="float:left;display:$disp;margin:4px;padding:3px;cursor:pointer;background:#fed;" onclick="var yon = window.confirm('Really DELETE room $nk ?!'); if (yon) {
		        var form = document.createElement('form');
			form.setAttribute('method', 'get');
			form.setAttribute('id', 'myForm_del_room');
			document.body.appendChild(form);
			\$('myForm_del_room').action = '/cgi/genc/cp?mode=do_del_room&moid=$id';
			var mycabo = '$mycabo'; if (mycabo.length > 0) \$('myForm_del_room').action = \$('myForm_del_room').action + '&mycabo='+mycabo;
		        \$('myForm_del_room').set('send', {onComplete: function(response) {		
		        $lhr;
		        var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		        \$('log_spinning').setStyles({'position': pos });
		        \$('log_spinning').setStyles({'left': a });	
		        \$('log_spinning').setStyles({'top': b });
		        \$('log_spinning').setStyles({'display': 'block' });
		        \$('log_spinning').fade(1);
		        (function() {location.reload();}).delay(1000);	
		        }});\$('myForm_del_room').send();\$('myForm_del_room').dispose(); console.log('room removed'); return false;
			}">X</span>
		     <div class=show_div id="show_r_div_$i" onclick="toggle_r_add_edit_box($i,1);\$('input_r_$i').focus();"><span id="show_r_$i" class=sc2>$nk</span></div>
		     <div class=input_div id="input_r_div_$i">
			<input id="input_r_$i" class=ic type=text value="$nk" onblur="toggle_r_add_edit_box($i,0);" onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {if (Validate(this.value)) {this.value=this.value.toUpperCase();js_change_room($i,$id);}}">
		     </div>
		  </div>
	};

	print qq{
		  <div style="clear:both;"></div>
		</div><!-- end row -->};
} #for rows
	
print qq{
</div><!-- end table2 -->
};

print qq{
</div></div><!-- containers -->
} 
#unless ($develop == 15 || $develop == 16)
;

print qq{
			
			</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>
</html>

} if ($develop == 15 || $develop == 16);

}

sub print_stats_mode {

my $str = "/usr/bin/curl --silent -X POST --header 'Content-type: application/json' --data '{\"unique_xter_id\":\"$unique_xter_id\", \"status\":\"1\", \"softpac\":\"$softpac\", \"client\":\"$cli\"}' https://cube.$xtertech/cgi/genc/apo3";
print STDERR "Stats curl: ".$str."\n";
$str = `$str`;

my $data = decode_json($str);

my $node_session = $data->{node_session};
my $node_ip = $data->{node_ip};
my $good_minutes = $data->{good_minutes};
my $bad_minutes = $data->{bad_minutes};
my $payout_address = $data->{payout_address};
my $last_pirl_qty = $data->{last_pirl_qty};
my $last_pirl_dte = $data->{last_pirl_dte};
my $total_pirl_qty = $data->{total_pirl_qty};
my $current_balance = $data->{current_balance};
my $ku_traf = $data->{kurento_traffic};
my $paying_ok = $data->{paying_ok};

#print STDERR "Here paying_ok is $paying_ok!\n";

$ku_traf = 3000 if($ku_traf > 3000);

my $next_pirl_qty = $good_minutes*0.02 + ($ku_traf - 100)*0.1;

&make_date($gmtimeshift);
my $next_pirl_dte = $current_date.", 21:00";

$last_pirl_dte = substr($last_pirl_dte, 0, rindex($last_pirl_dte,':'));

my $f1 = $touch_specific_bro ? "24px" : "36px";
my $f1 = $touch_specific_bro ? "16px" : "20px";

$ku_traf = length($ku_traf) ? $ku_traf : 0;
$next_pirl_qty = $next_pirl_qty < 0 ? 0 : $next_pirl_qty;

#my $d = $paying_ok eq '1' || $next_pirl_qty ? '' : "display:none;";
my $d = $next_pirl_qty ? '' : "display:none;";

print qq{
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>
<script>
function check_response(response) {

	var r = new RegExp('DOCTYPE HTML PUBLIC','ig');
	if (typeof(response) != 'undefined' && response != null && response.match(r)) {
		document.body.style.opacity='0.05';
		alert('Authorization Required');
		(function(){location.href='/cgi/genc/cp?mode=login';}).delay(1000);
		return;
	}
}
function js_change_value() {
		

		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_au");

		document.body.appendChild(form); 
		\$('myForm_au').action = '/cgi/genc/cp?mode=js_change_value&par=24&val=0';
		\$('myForm_au').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);
		
		}});
		\$('myForm_au').send();
		\$('myForm_au').dispose();
}
</script>
<div style="width:100%;height:100%;display:table;">
<div id=full style="max-width:50vw;text-align:center;display:table-cell;vertical-align:middle;">
	<button style="width:120px;$d" onclick="var yon = window.confirm('PAYOUT NOW?');if (yon) {js_change_value();\$('full').empty();\$('full').innerHTML='Please wait..'; (function(){var yo = window.confirm('Please push OK');if (yo) {parent.location.href='/cgi/genc/cp?mode=w_uc_stats';}}).delay(6000);}"><span>PAYOUT</span></button>
	<div style="width:50%;margin:5px auto 20px auto;font-size:$f1;">Hi, $node_ip !</div>
	<!-- div style="width:50%;margin:5px auto;font-size:$f2;">Static IP is $node_ip</div -->
	<div style="width:50%;margin:5px auto;font-size:$f2;">Payout address is:</div>
	<div style="width:90%;margin:5px auto;font-size:$f2;">$payout_address</div>
	<div style="width:50%;margin:5px auto;font-size:$f2;">Address balance is $current_balance RHC</div>
	<div style="width:50%;margin:5px auto;font-size:$f2;">Number of good / bad minutes since last payout is $good_minutes&nbsp;/&nbsp;$bad_minutes</div>
	<div style="width:50%;margin:5px auto;font-size:$f2;">KMS port traffic since last payout is $ku_traf Mb</div>
	<div style="width:50%;margin:5px auto;font-size:$f2;">Last payout was $last_pirl_qty RHC on $last_pirl_dte</div>
	<div style="width:50%;margin:5px auto;font-size:$f2;">Next payout is due $next_pirl_qty RHC</div>
	<div style="width:50%;margin:5px auto;font-size:$f2;">Total paid out to date is $total_pirl_qty RHC</div>
</div>
</div>
};
}

sub print_polka_mode {

my $f1 = $touch_specific_bro ? "16px" : "20px";

my $PS_STR = `ps aux | grep polka_binary | grep -v interfaces | grep -v grep | awk '{print \$11}'`;
$PS_STR =~ s/(\r|\n)//g;

my $RSY_STR = `ps aux | grep rsync | grep -v interfaces | grep -v grep | grep -v sender | awk '{print \$15}'`;

my $CLI = `cat /etc/sysconfig/interfaces | grep CLIENTNAME | awk -F '=' '{print \$2}'`; $CLI =~ s/(\r|\n)//g;

my $polka_id = "pirl";

my $DU_STR = `du /opt/nvme/ssd/polka3/chains/$polka_id/db/ | awk {'printf ("%.2f", \$1/(1024*1024))'}`.'G'; $DU_STR = "-" if ($DU_STR eq 'G');

my $node_is_running = $PS_STR eq "/opt/nvme/ssd/polka/polka_binary" ? 1 : 0;

my $node_is_syncing = $RSY_STR =~ /^\/opt\/nvme\/ssd\/polka3\/chains\/pirl\/db\//;

my $NODE_STATUS = $node_is_running ? "Running" : $node_is_syncing ? "Syncing" : "Stopped";

my $disa_start = $node_is_running ? " disabled" : '';
my $disa_stop = $node_is_running ? '' : " disabled";
my $disa_req = $node_is_running ? '' : " disabled";

$disa_start = $node_is_syncing ? " disabled" : $disa_start;
$disa_stop = $node_is_syncing ? '' : $disa_stop;
$disa_req = $node_is_syncing ? " disabled" : $disa_req;
my $disa_res = $node_is_syncing ? " disabled" : '';

my $a_stop_toggler = $node_is_syncing ? "display:none;" : '';
my $b_stop_toggler = $node_is_syncing? '' : "display:none;";

my $res_color = $node_is_syncing ? '' : " style=\"color:#f00;\"";
my $col = $node_is_running ? " style=\"color:#0f0;\"" : '';
my $co = $node_is_running || $node_is_syncing ? "color:#00f;" : '';

my $polka_explorer = "https://skypirl.net";
my $polka_telemetry = "https://skypirl.org";

print qq{
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>
<script>
function check_response(response) {

	var r = new RegExp('DOCTYPE HTML PUBLIC','ig');
	if (typeof(response) != 'undefined' && response != null && response.match(r)) {
		document.body.style.opacity='0.05';
		alert('Authorization Required');
		(function(){location.href='/cgi/genc/cp?mode=login';}).delay(1000);
		return;
	}
}
function js_change_value(f) {
		

		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_au");

		document.body.appendChild(form); 
		\$('myForm_au').action = '/cgi/genc/cp?mode=js_change_value&par='+f+'&val=0';
		\$('myForm_au').set('send', {
		
			$ie_no_cache onSuccess: function(response) {			
				check_response(response);
				location.reload();			
			}
		});

		\$('myForm_au').send();
		\$('myForm_au').dispose();
		

}
function work_polka(n) {
		

		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_req");

		document.body.appendChild(form);

		\$('myForm_req').action = '/cgi/genc/cp?mode=work_polka&par='+n;
						
		\$('myForm_req').set('send', {
		
			$ie_no_cache onSuccess: function(response) {			
				check_response(response);
				//if (n == 4) { alert(response)}
				if (n == 4) \$('myForm_response').innerHTML='Copy this key: ' + response;
				else if (n == 1) console.log('started')
				else 
				location.reload();			
			}
		});

		\$('myForm_req').send();
		\$('myForm_req').dispose();
		if (n == 3) (function() {location.reload()}).delay(500);		
}

</script>
<div style="width:100%;height:100%;display:table;margin-top:0px;">
<div style="max-width:50vw;text-align:center;display:table-cell;vertical-align:middle;">
<span style="width:120px;">Your node \"$CLI\":</span>&nbsp;<span style="width:120px;$co">$NODE_STATUS</span><br><br>
<span style="width:120px;">Chain DB size:</span>&nbsp;<span style="width:120px;">$DU_STR</span><br><br>
<button style="width:120px;"><a href='$polka_explorer' target=new>Explorer</a></button>
<button style="width:120px;"><a href='$polka_telemetry' target=new>Telemetry</a></button><br><br>
	<button$disa_start style="width:120px;" onclick="var yon = window.confirm('START NODE?');if (yon) {work_polka(1);alert('click OK');window.parent.location=window.parent.location;}"><span>START</span></button>
	<button$disa_stop style="width:120px;$a_stop_toggler" onclick="var yon = window.confirm('STOP NODE?');if (yon) {work_polka(2);};"><span>STOP</span></button>
	<button$disa_stop style="width:120px;$b_stop_toggler" onclick="var yon = window.confirm('STOP SYNC?');if (yon) {work_polka(5);};"><span>STOP</span></button>
	<br><br>
	<button$disa_res style="width:120px;" onclick="var yon = window.confirm('RESET DATABASE TO PAST GOOD STATE?');if (yon) {work_polka(3);};"><span$res_color>RESET</span></button>
	<button$disa_req style="width:120px;" onclick="var yon = window.confirm('REQUEST VALIDATOR KEYS?');if (yon) {work_polka(4)();};"><span$col>NEW KEYS</span></button>
</div>
<div id=myForm_response></div>
</div>
};
}

sub print_polka_panel {

my $mo = "polka_mode";

my $header_str = $language eq "russian" ? koitoutf8("��������") : $users_menu_str;

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<a class=mob_nav$hidden_class href='$scriptname?mode=system_panel'>$info_menu_str</a>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob
$users_menu_mob_active
<a class=mob_nav$hidden_class href='$scriptname?mode=nw_panel'>$settings_menu_str_short</a>
<!-- a class=mob_nav href='$scriptname?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : "<div id=touch_nav_bar></div>";

my $wdth = $touch_specific_bro ? "96%" : "530px";

my $mt = $touch_specific_bro ? "-10px" : "12px";
my $mb = $touch_specific_bro ? "-10px" : "12px";

my $fc = $touch_specific_bro ? "black" : "white";
my $fs = $touch_specific_bro ? "24px" : "36px";

my $who = $is_admin ? "Admin" : "User";


my $mhh = $touch_specific_bro ? "75vh" : "60vh";

my $o = substr(TClubMD5::md5_hex($r_user),0,8);
my $obje = "<object onload=\"document.getElementById('wheel').style.display='none';\" type=\"text/html\" data=\"$scriptname?mode=$mo&o=$o\" style=\"width:90%;height:72%;min-height:410px;margin:1vh auto;background-color:#def;border-radius:60px;border:1px solid #fff;overflow:auto;\"></object>";
my $disp = $touch_specific_bro && 0 ? '' : "display:none;";


my $d = $touch_specific_bro ? " style=\"display:none;\"" : '';
$header_str = $touch_specific_bro ? '' : '';
my $mtt = $touch_specific_bro ? '-5vh' : '2vh';

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
<style>

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}

.mob_nav {color:#ccc;width:15%;padding:5px 2px;}

</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
};

my $onl = $touch_specific_bro ? " onload=\"\$('html, body').animate({scrollTop: 75}, 300);\"" : '';

print qq{
<script>

function writeCookie(cname,value) {
	var curCookie = escape(cname) + "=" + escape(value) +"; expires=Mon, 01-Jan-2029 00:00:01 GMT;"
	document.cookie = curCookie
}


</script>
</head>

<!-- body$onl id="UsersPage" style="background:url(/img/sli4.jpg) center center #eee;" -->
<body$onl id="UsersPage" style="background:#eee;">
    <div id="users">
        <nav id=navbar class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                    <div>
		    	<div><h1 class="tm-site-title mb-0">$xTER</h1>
			<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a>
			</div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div>
			<div style="clear:all;"></div>
		    </div>
			
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link"$hidden_class href="$scriptname?mode=system_panel">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
                        $logs_menu
			$users_menu2
                        <li class="nav-item">
                            <a class="nav-link"$hidden_class href="$scriptname?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                           </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                $who, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div id=container class="container" style="border:0px solid #090;text-align:center;">
            <div class="row">
                <div class="col" style="border:0px solid #990;">
                    <p class="text-$fc mb-5" style="font-size:$fs;margin-top:$mtt;margin-left:16px;"><b>$header_str</b></p>
                </div>
            </div>

            <div class="row tm-content-row" style="position:relative;text-align:center;border:0px solid #900;width:100%;margin:0 auto;">
                <div id=wheel style="white-space:nowrap;z-index:1002;position:absolute;height:100%;width:100%;background:transparent;font-size:24px;text-align:center;color:#222;top:40%;">
                        PLEASE WAIT
                </div>
                <div style="position:relative;display:table;width:100%;height:$mhh;text-align:center;background-color:#fed;margin:0 auto;border-radius:60px;border:0px solid #009;">
			<div style="display:table-cell;vertical-align:middle;border:0px solid #fed;margin:0 auto;width:100%;background:transparent;min-height:410px;">
			  $obje
			</div>
                </div>
	    </div>

	 </div><!-- container -->
	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>	 
    </div><!-- users -->
</body>
</html>
};

}

sub print_users_mode {


&wtagcheck if ($wtagcheck);

$is_admin = $mycabo_master ? 1 : $is_admin;

my $mu = $touch_specific_bro ? "0" : "15px";
my $mt = $touch_specific_bro ? "-5vh auto 0 auto" : "0";
my $vali = $develop == 12 ? "middle" : "top";

my $whom = $develop == 15 ? "Interpreters" : "Clients";

print qq{
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <title>Clients Area</title>
};

print qq{
    <link rel="apple-touch-icon" sizes="60x60" href="/fronto_favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/fronto_favicon/fronto_favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/fronto_favicon/fronto_favicon-16x16.png">
    <link rel="manifest" href="/fronto_favicon/site.webmanifest">
    <link rel="mask-icon" href="/fronto_favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <link href="/fronto_css/bootstrap.css" rel="stylesheet">
    <link href="/fronto_css/font-awesome.min.css" rel="stylesheet">
    <link href="/fronto_css/jquery.datetimepicker.min.css" rel="stylesheet">
    <link href="/fronto_css/index.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="/fronto_js/bootstrap.js" defer></script>
    <script src="/fronto_js/jquery.datetimepicker.full.js" defer></script>
    <script src="/fronto_js/moment-locale.js"></script>
    <script src="/fronto_js/const.js" defer></script>
    <script src="/fronto_js/core.js" defer></script>
    <script src="/fronto_js/index.js?" defer></script>
    <script>
       function writeCookie(cname,value) {
	var curCookie = escape(cname) + "=" + escape(value) +"; expires=Sat, 01-Jan-2033 00:00:01 GMT;SameSite=None;Secure;"
	document.cookie = curCookie
       }
    </script>
} if ($develop == 15);


print qq {

<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>

<script>

function writeCookie(cname,value) {
	var curCookie = escape(cname) + "=" + escape(value) +"; expires=Sat, 01-Jan-2033 00:00:01 GMT;SameSite=None;Secure;"
	document.cookie = curCookie
}

function check_response(response) {

	var r = new RegExp('DOCTYPE HTML PUBLIC','ig');
	if (typeof(response) != 'undefined' && response != null && response.match(r)) {
		document.body.style.opacity='0.05';
		alert('Authorization Required');
		(function(){location.href='/cgi/genc/cp?mode=login';}).delay(1000);
		return;
	}
}


function js_guru_controls(p) {
		
		var form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("id", "myForm_ctrl");

		document.body.appendChild(form); 
		\$('myForm_ctrl').action = '?mode=js_guru_ctrl&par='+p;
		//var mycabo = '$mycabo'; if (mycabo.length > 0) \$('myForm_ctrl').action = \$('myForm_ctrl').action + '&mycabo='+mycabo;		
		\$('myForm_ctrl').set('send', {
		
			$ie_no_cache onComplete: function(response) {			
				check_response(response);			
		}});
		\$('myForm_ctrl').send();
		\$('myForm_ctrl').dispose();
}

</script>
} if (($develop == 16 || $not_so_free_media) && $is_admin);

print qq{
</head>
<body>
<div id="page">
    <div class="loading-page">
        <div class="loading-page-gif"></div>
    </div>

    <header>
        <div class="container-fluid">
            <div class="row  d-flex align-items-center text-center">
                <!-- div class="col-md-4">
                    <div class="logo"></div>
                </div>
                <div class="col-md-4">
                    <h3>Conferences</h3>
                </div>
                <div class="col-md-4">
                    <div class="logout">
                        <a href="#">Log Out</a>
                    </div>
                </div -->
            </div>
        </div>
    </header>

    <div class="admin-content">
        <div class="container">
            <div class="wrapper">
                <table class="table table-new-conf">
                    <!-- thead>
                    <tr>
                        <td colspan="2">$whom Chatroom</td>
                    </tr>
                    </thead -->
                    <tbody>
                    <tr>
                        <td colspan="2">
} if ($develop == 15 || $develop == 16);

print qq{
<div style="position:absolute;display:table;text-align:center;border: solid #666 0px;width:95%;padding:10px;height:95%;margin:$mt;"><!-- tab container -->
<div style="display:table-cell;vertical-align:$vali;border: solid #222 0px;width:50%;margin:0 auto;text-align:center;"><!-- valign tab container -->
} 
#if ($develop != 15 && $develop != 16)
;

print qq{<div id=sb_container style="width:237px;height:240px;padding:$mu 5px 5px 0px;margin:30px auto 60px auto;border:0px dotted #900;">};

print qq{
<div style="cursor:pointer; color:#222; width:100%; text-align:center;" onmouseover="this.style.color='#369';" onmouseout="this.style.color='#222';" onclick="writeCookie('CHAT',0);location.reload();">GO TO CONTROLS =></div>
} if ($is_admin);

print qq{
<a style="cursor:pointer;color:#222;" onmouseover="this.style.color='#369';" onmouseout="this.style.color='#222';" href="/cgi/genc/cp?mode=interprete" target=new>TO CONFERENCE =></a>
} if (!$is_admin && $develop == 15 && 0);

unless ($ie && !$ie9) { #pick out the sh*t

	&print_wtag_headers('_new','_mini');
	&do_shoutbox(1,$sb);

	print qq{
	<script>
	document.getElementById('box').style.display='block';
	getChatData();
	</script>
	} if ($sb eq '1');
}

print "</div>"; #sb_container

print qq{
</div></div><!-- containers -->
} 
#if ($develop != 15 && $develop != 16)
;
print qq{
			
			</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>
</html>

} if ($develop == 15 || $develop == 16);


}

sub print_stats_panel {

my $mo = "stats_mode";

my $header_str = $language eq "russian" ? koitoutf8("��������") : $users_menu_str;

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<a class=mob_nav$hidden_class href='$scriptname?mode=system_panel'>$info_menu_str</a>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob
$users_menu_mob_active
<a class=mob_nav$hidden_class href='$scriptname?mode=nw_panel'>$settings_menu_str_short</a>
<!-- a class=mob_nav href='$scriptname?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : "<div id=touch_nav_bar></div>";

my $wdth = $touch_specific_bro ? "96%" : "530px";

my $mt = $touch_specific_bro ? "-10px" : "12px";
my $mb = $touch_specific_bro ? "-10px" : "12px";

my $fc = $touch_specific_bro ? "black" : "white";
my $fs = $touch_specific_bro ? "24px" : "36px";

my $who = $is_admin ? "Admin" : "User";


my $mhh = $touch_specific_bro ? "75vh" : "60vh";

my $o = substr(TClubMD5::md5_hex($r_user),0,8);
my $obje = "<object onload=\"document.getElementById('wheel').style.display='none';\" type=\"text/html\" data=\"$scriptname?mode=$mo&o=$o\" style=\"width:90%;height:72%;min-height:410px;margin:1vh auto;background-color:#def;border-radius:60px;border:1px solid #fff;overflow:auto;\"></object>";
my $disp = $touch_specific_bro && 0 ? '' : "display:none;";


my $d = $touch_specific_bro ? " style=\"display:none;\"" : '';
$header_str = $touch_specific_bro ? '' : '';
my $mtt = $touch_specific_bro ? '-5vh' : '2vh';

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
<style>

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}

.mob_nav {color:#ccc;width:15%;padding:5px 2px;}

</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<script src="/kure/components/jquery/dist/jquery.min.js"></script>

};

my $onl = $touch_specific_bro ? " onload=\"\$('html, body').animate({scrollTop: 75}, 300);\"" : '';

print qq{
<script>

function writeCookie(cname,value) {
	var curCookie = escape(cname) + "=" + escape(value) +"; expires=Sat, 01-Jan-2033 00:00:01 GMT;SameSite=None;Secure;"
	document.cookie = curCookie
}


</script>
</head>

<body$onl id="StatsPage" style="#eee;">
    <div id="users">
        <nav id=navbar class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                    <div>
		    	<div><h1 class="tm-site-title mb-0">$xTER</h1>
			<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a>
			</div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div>
			<div style="clear:all;"></div>
		    </div>
			
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link"$hidden_class href="$scriptname?mode=system_panel">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
                        $logs_menu2
			$users_menu
                        <li class="nav-item">
                            <a class="nav-link"$hidden_class href="$scriptname?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                           </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                $who, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div id=container class="container" style="border:0px solid #090;text-align:center;">
            <div class="row">
                <div class="col" style="border:0px solid #990;">
                    <p class="text-$fc mb-5" style="font-size:$fs;margin-top:$mtt;margin-left:16px;"><b>$header_str</b></p>
                </div>
            </div>

            <div class="row tm-content-row" style="position:relative;text-align:center;border:0px solid #900;width:100%;margin:0 auto;">
                <div id=wheel style="white-space:nowrap;z-index:1002;position:absolute;height:100%;width:100%;background:transparent;font-size:24px;text-align:center;color:#222;top:40%;">
                        PLEASE WAIT<br>..COLLECTING STATS..
                </div>
                <div style="position:relative;display:table;width:100%;height:$mhh;text-align:center;background-color:#fed;margin:0 auto;border-radius:60px;border:0px solid #009;">
			<div style="display:table-cell;vertical-align:middle;border:0px solid #fed;margin:0 auto;width:100%;background:transparent;min-height:410px;">
			  $obje
			</div>
                </div>
	    </div>

	 </div><!-- container -->
	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>	 
    </div><!-- users -->
</body>
</html>
};

}

sub print_users_panel {

if ( ($softpac ne '5' && $softpac ne '7') || ($free_media && $develop != 16) ){
print qq{
<!DOCTYPE html>
<html lang="en">

<head>
</head>
<body>
<script>
var yon = window.confirm('Please UPGRADE to OFFICE EDITION');if (yon) {window.location.href='/cgi/genc/cp?mode=nw_panel';};
</script>
</body>
};
exit;
}

my $who = $is_admin ? "Admin" : "User";
$who = $mycabo_master && !$is_admin ? "Guru" : $who;

$is_admin = $mycabo_master ? 1 : $is_admin;

my $mo = $is_admin ? "users_control" : "users_mode";

$mo .= "&mycabo=$mycabo" if (length($mycabo));

my %Coo = TClubMD5::GetCookies('VID','CHAT');
$mo = "videos_page" if ($Coo{'VID'} == 1);

my $WHERE = $Coo{'VID'} == 1 ? ( $is_admin ? ( $Coo{'CHAT'} == 1 ? "CHAT" : "CONTROLS") : "CHAT") :"VIDEOS";
my $W = $Coo{'VID'} == 1 ? 0 : 1;

my $header_str = $language eq "russian" ? koitoutf8("��������") : $users_menu_str;

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<a class=mob_nav$hidden_class href='$scriptname?mode=system_panel'>$info_menu_str</a>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob
$users_menu_mob_active
<a class=mob_nav$hidden_class href='$scriptname?mode=nw_panel'>$settings_menu_str_short</a>
<!-- a class=mob_nav href='$scriptname?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : "<div id=touch_nav_bar></div>";

my $wdth = $touch_specific_bro ? "96%" : "530px";

my $mt = $touch_specific_bro ? "-10px" : "12px";
my $mb = $touch_specific_bro ? "-10px" : "12px";

my $fc = $touch_specific_bro ? "black" : "white";
my $fs = $touch_specific_bro ? "24px" : "36px";



#my $mh = $touch_specific_bro ? "70vh" : "60vh";

my $mhh = $touch_specific_bro ? "75vh" : "60vh";

my $o = substr(TClubMD5::md5_hex($r_user),0,8);
my $obje = "<object type=\"text/html\" data=\"$scriptname?mode=$mo&o=$o\" style=\"width:90%;height:72%;min-height:410px;margin:1vh auto;background-color:#def;border-radius:60px;border:1px solid #fff;overflow:auto;\"></object>";
my $disp = $touch_specific_bro && 0 ? '' : "display:none;";

my $chat_switcher = "<div style=\"cursor:pointer;color:#222;width:30%;min-width:320px;border:0px solid#900;text-align:center;margin:0 auto 10px auto;\">
<div style=\"float:left;min-width:150px;text-align:left;\" onmouseover=\"this.style.color='#369';\" onmouseout=\"this.style.color='#222';\" onclick=\"writeCookie('VID',$W);window.top.location.reload();\"> <= TO $WHERE</div>
<div id=slider style=\"float:left;max-width:10px;text-align:center;padding:3px;border:1px solid#900;$disp\" onmouseover=\"this.style.color='#369';\" onmouseout=\"this.style.color='#222'; \"onclick='this.fade(0);'\">|</div>
<div style=\"float:right;min-width:150px;text-align:right;\" onmouseover=\"this.style.color='#369';\" onmouseout=\"this.style.color='#222';\" onclick=\"window.open('https://$ENV{SERVER_NAME}');\">TO VIDEO CHAT =></div>
<div style=\"clear:both;\"></div>
 </div>";

$chat_switcher = '' if ($develop == 16);

my $d = $touch_specific_bro ? " style=\"display:none;\"" : '';
$header_str = $touch_specific_bro ? '' : '';
my $mtt = $touch_specific_bro ? '-5vh' : '2vh';

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
<style>

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}

.mob_nav {color:#ccc;width:15%;padding:5px 2px;}

</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<!-- script src="/kure/components/jquery/dist/jquery.min.js"></script -->

};

my $onl = $touch_specific_bro ? " onload=\"\$('html, body').animate({scrollTop: 75}, 300);\"" : '';

print qq{
<script>

function writeCookie(cname,value) {
	var curCookie = escape(cname) + "=" + escape(value) +"; expires=Sat, 01-Jan-2033 00:00:01 GMT;SameSite=None;Secure;"
	document.cookie = curCookie
}


</script>
</head>

<body$onl id="UsersPage" style="background:#eee;">
    <div id="users">
        <nav id=navbar class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                    <div>
		    	<div><h1 class="tm-site-title mb-0">$xTER</h1>
			<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a>
			</div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div>
			<div style="clear:all;"></div>
		    </div>
			
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link"$hidden_class href="$scriptname?mode=system_panel">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
                        $logs_menu
			$users_menu2
                        <li class="nav-item">
                            <a class="nav-link"$hidden_class href="$scriptname?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                           </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                $who, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div id=container class="container" style="border:0px solid #090;text-align:center;">
            <div class="row">
                <div class="col" style="border:0px solid #990;">
                    <p class="text-$fc mb-5" style="font-size:$fs;margin-top:$mtt;margin-left:16px;"><b>$header_str</b></p>
                </div>
            </div>
$chat_switcher
            <div class="row tm-content-row" style="text-align:center;border:0px solid #900;width:100%;margin:0 auto;">
                <div style="position:relative;display:table;width:100%;height:$mhh;text-align:center;background-color:#fed;margin:0 auto;border-radius:60px;border:0px solid #009;">
			<div style="display:table-cell;vertical-align:middle;border:0px solid #fed;margin:0 auto;width:100%;background:transparent;min-height:410px;">
			$obje
			</div>
                </div>
		
		<!-- table style="width:100%;background-color:#fed;">
		<tr>
		<td>hi</td>
		</tr>
		</table -->
	    </div>

	 </div><!-- container -->
	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>	 
    </div><!-- users -->
</body>
</html>
};
}

sub print_w_uc_panel {

if (($softpac ne '5' && $softpac ne '7') || ($free_media && $develop != 16) ){
print qq{
<!DOCTYPE html>
<html lang="en">

<head>
</head>
<body>
<script>
var yon = window.confirm('Please UPGRADE to OFFICE EDITION');if (yon) {window.location.href='/cgi/genc/cp?mode=nw_panel';};
</script>
</body>
};
exit;
}

my $header_str = $language eq "russian" ? koitoutf8("����-������� � ������������� �����������<br>��� ���� � �����") : $users_menu_str;

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<a class=mob_nav$hidden_class href='$scriptname?mode=system_panel'>$info_menu_str</a>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob
$users_menu_mob_active
<a class=mob_nav$hidden_class href='$scriptname?mode=nw_panel'>$settings_menu_str_short</a>
<!-- a class=mob_nav href='$scriptname?mode=w_h_panel'>$help_menu_str</a -->
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : '';

my $wdth = $touch_specific_bro ? "96%" : "530px";

my $mt = $touch_specific_bro ? "-10px" : "12px";
my $mb = $touch_specific_bro ? "-10px" : "12px";

my $fc = $touch_specific_bro ? "black" : "white";
my $fs = $touch_specific_bro ? "24px" : "36px";

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
<style>

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}

.mob_nav {color:#ccc;width:15%;padding:5px 2px;}

</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>
};

print qq{
<script>
function js_ctrl(par) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_ctrl');
		document.body.appendChild(form);	
		document.getElementById('myForm_js_ctrl').action = '$scriptname?mode=js_ctrl&par='+par;		
		document.getElementById('myForm_js_ctrl').set('send', {onComplete: function(response) { 
			check_response(response);
		}});	
		document.getElementById('myForm_js_ctrl').send();
		document.getElementById('myForm_js_ctrl').dispose();
		
		(function() {location.reload();}).delay(1000);

}
</script>
</head>

<body id="UsersPage" style="background:#eee;"$onlo>
    <div id="home">
        <nav class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                    <div>
		    	<div><h1 class="tm-site-title mb-0">$xTER</h1>
			<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a>
			</div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div>
			<div style="clear:all;"></div>
		    </div>
			
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link"$hidden_class href="$scriptname?mode=system_panel">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
                        $logs_menu
			$users_menu2
                        <li class="nav-item">
                            <a class="nav-link"$hidden_class href="$scriptname?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                           </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                Admin, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div class="container">
            <div class="row">
                <div class="col">
                    <p class="text-$fc mb-5" style="font-size:$fs;margin-top:30px;margin-left:16px;"><b>$header_str</b></p>
                </div>
            </div>
            <div class="row tm-content-row">
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="text-align:center;height:440px;float:left;">
    			<object type="text/html" data="$scriptname?mode=uc_panel&part=2" style="overflow:auto;width:$wdth;height:390px;margin-top:$mt;margin-bottom:$mb;text-align:center;border-radius:60px;">
    			</object>
                </div>
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="text-align:center;height:440px;float:left;">
    			<object type="text/html" data="$scriptname?mode=uc_panel&part=1" style="overflow:auto;width:$wdth;height:390px;margin-top:$mt;margin-bottom:$mb;text-align:center;border-radius:60px;">
    			</object>
                </div>
	    </div>

	 </div>
	<br><br><br><br>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>	 
    </div>
</body>
</html>
};
}

sub print_w_h_panel {


my $help_menu_desc = $language eq "russian" ? koitoutf8("�������� xTER") : "Help";

my $header_str = $help_menu_desc;

my $touch_nav_bar = $touch_specific_bro ? "<div style=\"padding:7px;width:100%;background-color: #567086;border:2px #fff solid;text-align:center;margin:0px auto 0px auto;\">
<a class=mob_nav href='$scriptname?mode=system_panel'>$info_menu_str</a>
<a class=mob_nav$disp_class href='$scriptname?mode=video_panel'>$video_menu_str</a>
$logs_menu_mob
$users_menu_mob
<a class=mob_nav href='$scriptname?mode=nw_panel'>$settings_menu_str_short</a>
<a class=mob_nav_active>$help_menu_str</a>
<a class=mob_nav href='$scriptname?Submit=Logout'>$logout</a>
</div>" : '';

my $wdth = $touch_specific_bro ? "100%" : "1080px";
my $hght = $touch_specific_bro ? "630px" : "480px";
my $mt = $touch_specific_bro ? "-108px" : "-36px";
my $ta = $touch_specific_bro ? "text-align:center;" : '';
my $ht = $touch_specific_bro ? "500px" : "484px";
my $pt = $touch_specific_bro ? "0" : "20px";
my $mmt = $touch_specific_bro ? "30px" : "72px";

print qq{
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Cache-Control" content="private, no-cache, no-store, must-revalidate, max-age=0, proxy-revalidate, s-maxage=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Vary" content="*">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>$copy_str2</title>
    <link rel="stylesheet" href="/css_cp/fontroboto.css">
    <link rel="stylesheet" href="/css_cp/fontawesome.min.css">
    <link rel="stylesheet" href="/css_cp/bootstrap.min.css">
    <link rel="stylesheet" href="/css_cp/templatemo-style.css">
    $bubbles_css
<style>

.mob_nav_active, .mob_nav {
color:#fffeee;font-weight:bold;
margin:5px 12px;
}

.mob_nav {color:#ccc;width:15%;padding:5px 2px;}

.scrollable-container {max-height:200px;}
</style>
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js"></script>
<script>
function js_ctrl(par) {

		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_js_ctrl');
		document.body.appendChild(form);	
		document.getElementById('myForm_js_ctrl').action = '$scriptname?mode=js_ctrl&par='+par;		
		document.getElementById('myForm_js_ctrl').set('send', {onComplete: function(response) { 
			check_response(response);
		}});	
		document.getElementById('myForm_js_ctrl').send();
		document.getElementById('myForm_js_ctrl').dispose();
		
		(function() {location.reload();}).delay(1000);

}

</script>
</head>

<body id="HelpPage" style="background:#eee;"$onlo>
};
print qq{
<!--Copyright to Shen Huang, you can reach me out at shenhuang@live.ca-->
<div id = "board"></div>
		<sand></sand>
		<water></water>
		<skymask></skymask>
		<boat>
			<mast></mast>
			<sail></sail>
		</boat>
		<tree>
			<branch></branch>
			<leaf1></leaf1>
			<leaf2></leaf2>
			<leaf3></leaf3>
			<leaf4></leaf4>
			<leaf5></leaf5>
			<leaf6></leaf6>
			<coconut1></coconut1>
			<coconut2></coconut2>
			<coconut3></coconut3>
		</tree>
} 
unless ($touch_specific_bro)
;

my $mrg = $touch_specific_bro ? "margin: 0 auto;" : "margin-top:30px;";
my $clr = $touch_specific_bro ? "#369" : "#fff";

print qq{
    <div id="home">
        <nav class="navbar navbar-expand-xl"$stdn>
            <div class="container h-100">
                    <div><div><h1 class="tm-site-title mb-0">$xTER</h1>
			<a style="color:#9cf;margin-top:4px;margin-left:5px;"$do_logout>$do_logout_text</a></div>
			<div style="font-size:14px;color:#fed;float:top;">$edition</div><div style="clear:all;"></div></div>
			
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=system_panel">
                                <i class="fas fa-tachometer-alt"></i>
                                $info_menu_str
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"$disp_class href="$scriptname?mode=video_panel">
                                <i class="fas fa-video"></i>
                                $video_menu_str
                            </a>
                        </li>
                        $logs_menu
			$users_menu
                        <li class="nav-item">
                            <a class="nav-link" href="$scriptname?mode=nw_panel">
                                <i class="fas fa-cog"></i>
                                $settings_menu_str
                           </a>
                        </li>
                        <!-- li class="nav-item">
                            <a class="nav-link active" href="$scriptname?mode=w_h_panel">
                                <i class="fas fa-question-circle"></i>
                                $help_menu_str
                                <span class="sr-only">(current)</span>
                            </a>
                        </li -->
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="$scriptURL?Submit=Logout">
                                Admin, <b>$logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>$touch_nav_bar
        <div class="container" style="margin-top:-10px;text-align:center;">
            <div class="row" style="margin-top: 0px;text-align:center;">
                <div class="col">
                    <p style="margin-top:$mmt;color:$clr;"><!-- b>$header_str</b --></p>
                </div>
            </div>
            <div class="row tm-content-row" style="text-align:center;">
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col" style="text-align:center;padding-top:0px;$mrg">
    			<object type="text/html" data="$help_site_url" style="overflow:scroll;width:$wdth;height:$hght;border-radius:60px;margin:0px auto 48px auto;padding-top:$pt;">
    			</object>
                </div>
	    </div>
	 </div>
        <footer class="tm-footer row tm-mt-small"$foo_addon>
            <div class="col-12 font-weight-light" style="text-align:center;margin-left:-3%;">
                <p class="text-center text-white mb-0 px-4 small" style="width:75%;margin:0 auto;">$copy_str</p>
            </div>
        </footer>	 
    </div>
</body>
};
print qq{
<script language="JavaScript" type="text/javascript" src="/js_cp/bubbles.js"></script>
} unless ($touch_specific_bro);

print qq{
</html>
};
}

sub k2 { #73
 
    my $var = shift;
    
    if ($language eq "russian" && !$utf) {

		$var = `echo "$var"|$prefix/bin/2k 2>/dev/null`;
		chop($var);
    }
    return $var;
}

sub length_truncate { #76

my $str = shift;
if (length($str) > 300) {
$str = substr($str, 0,300);
};
return $str;
}

sub check_user { #99

my $par = shift || 0;

if ($develop == 14) {
	$comm = "select city, k_kredit from members where proj_code='$r_user'";
	&getTable;
	return (${${$listresult}[0]}[0],${${$listresult}[0]}[1]);
}

if ($develop == 16) {
	$comm = "select room, room_master from members where proj_code='$r_user'";
	&getTable;
	return (${${$listresult}[0]}[0],${${$listresult}[0]}[1]) if ($ntuples == 1);
}

return 0;   
}

sub convert_to_decimal { #107

my $str = shift;
return hex $str;
}

sub conntest2 { #122

my $ip = shift;
my $port = shift;	
	eval {
	local $SIG{ALRM} = sub { die "alarm\n" }; # NB: \n required
	alarm 1;

	my $what = Connect($ip,$port);
	alarm 0;
	return 1 if ($what eq 'good_connect');
                 
	};
	
	if ($@) {

		return 0;

	}
	else {
	# didn't
	}

}

sub write_log_notification { #152

my $text = shift;
my $par = shift;

open(OUTFILE, ">>$messages_log");

flock(OUTFILE,LOCK_EX);
select OUTFILE;
print $text."\n";
select(STDOUT);
flock(OUTFILE,LOCK_UN);
close OUTFILE;
}

sub write_event { #153

#create table juma_events(player text,tbl text,p_vremya_z timestamp,event_type char(1), sport int2);
my $t = shift;
my $etype = shift;

		my $cmd = "insert into juma_events (player, tbl, p_vremya_z,event_type,sport) values (?,?,current_timestamp,?,'$curr_sport');";
			my $result=$dbconn->prepare($cmd);
     			$result->execute($r_user,$t,$etype);
        		&dBaseError($dbconn, $cmd) if (!defined($result));
}

sub get_random { #154

my $n = shift;

my $chip = substr(TClubMD5::md5_hex(gettimeofday()),16,2);
my $result_of_toss = convert_to_decimal($chip);

return $result_of_toss if (!$n);

return ($result_of_toss-(int($result_of_toss/$n))*$n);
}

sub in_list { #160

my $guy = shift;
my $str = shift;
my $comma = shift;

if (defined($comma)) {
return 1 if ($str eq $guy || $str =~ /^$guy\,/ || $str =~ /\,$guy\,/ || $str =~ /\,$guy$/);
return 0;
} else {
return 1 if ($str eq $guy || $str =~ /^$guy\#/ || $str =~ /\#$guy\#/ || $str =~ /\#$guy$/);
return 0;
}
}

sub in_array { #161

my $guy = shift;
my @l  = @_;
my $count = 1;
foreach my $line (@l) {
	return $count if ($guy eq $line);
	$count++;
}
return 0;
}

sub close_and_reload { #181

my $force_close = shift;


if (!$if_no_open_new_windows || $force_close) {
    print q{<script language="JavaScript">
    window.close()
    if (opener) opener.location.reload();
    </script>};
} else {
	&_and_reload;
}

}

sub _and_reload { #182

	my $m = shift;
	my $s = defined($m) ? $scriptname."?mode=".$m : $scriptname;
    print qq{<script language="JavaScript">
    location.href="$s";
    </script>};
};


sub ptf { #219

my $n = shift;
my $v = shift;

my $s = 32;
my $m = 125;

$v = '' if ($v eq $n);

print "<INPUT TYPE=\"text\" NAME=\"" .$n. "\" VALUE=\"".$v."\" SIZE=$s MAXLENGTH=$m>\n";

}

sub pta { #220

my $n = shift;
my $v = shift;


my $o = shift;
my $h = shift;

$h = "60px" if (!defined($h));
my $onclick = defined($o) ? "onmousedown=\"this.innerHTML=''\";" : '';

$v = '' if ($v eq $n);
my $w = "300px";

print qq{<textarea $onclick style="padding:5px;height:$h;background:#ccc;color:#000;font-size:$fs12;" NAME="$n">$v</textarea>};
}

sub print_current_moo { #221

my $oldie = shift;

if (($downgraded) && !$chrome) {
	print q{<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-1.2.4-core.js"></script>
        	<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-1.2.4.2_a-more.js"></script>        
	};

} else {


	my $gz = ".gz" ;
	$gz = '' if (($safari && !$chrome) || $apache2) ;

	if ($oldie) {
		print qq{		<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.3-full-compat-yc.js$gz"></script>
		<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more.js$gz"></script>
		};
	} else {
		print qq{		<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-core-1.4.5-full-compat-yc.js$gz"></script>
		<script language="JavaScript" type="text/javascript" src="/js_cp/mootools-more-1.4.0.1a.js$gz"></script>
		};
	}

}
}

sub do_send_sms { #288

my $phone = shift;
my $cli_tel = shift;
my $eml = shift;


#return if ($phone =~ /9850261594/ || $phone =~ /9851001015/); #for debug

$cli_tel = $cli_tel == '' ? $r_user : $cli_tel;
my $str = " Pz" ;

my $str2 = " to $eml";

my $req = POST 'https://sms.ru/sms/send',[api_id => '114DE85C-4557-EA83-E96D-B0BE8C4A60E2',to => '79850261594',text => $cli_tel.$str2.$str];
$ua = LWP::UserAgent->new;print STDERR $ua->request($req)->as_string;

}

sub hexToDouble{ #293

  my $param = shift;
  $param =~ s/^0x//;
  my $fullnum = 0.0;
  while ($param =~ /(.)/g) {
    my $num = hex($1);
    $fullnum = $fullnum * 16 + $num;
  }
  #$fullnum *= 1e-18;
  return $fullnum;
}

sub isint{ #248

  my $val = shift;
  return ($val =~ m/^\d+$/);
}

sub xSort { #6

    my (@in)  = @_;

    my @out;
    
    foreach my $index (sort keys %fielddisporder) {
        push    @out, $fielddisporder{$index};
        @in = xDel ($fielddisporder{$index}, @in);
    }

    push @out, (sort @in);
    @out;
}


sub xDel { #7

    my ($element, @in) = @_;
    my (@out);

    foreach my $name (@in) {
        push @out, $name unless $element eq $name;
    }
    @out;
}


sub list_controls { #48

my $curr_cat = shift || 0;

my $type = shift || 0;

my $ajax_mode = shift || 0;

my $f = shift || ''; $f =~ s/\s//g;

my $ft = shift || 0;

if ($type == 2 || $type == 4 || $type == 6) {
print qq{
<div style="width:100%"><div style="width:50%;margin:90px auto;font-size:36px;">..under construction</div></div>
};
exit;
}

my $filter = length($f) && ($type eq '5' || $type eq '3') ? " lower(tags.tag) ~ lower('$f') and tags.match_oid=challenges.ID and" : '';
my $taddon = length($f) && ($type eq '5' || $type eq '3') ? ", tags" : '';

if ($ft eq '1' && $type eq '3' && length ($f) ) {$f = nkname_lookup($f,1); $filter = " partner = '$f' and"; $taddon = '';}
if ($ft eq '2') {$filter = $f eq "yesterday" ? " challenges.time_of_selection < current_date and challenges.time_of_selection > current_date-1 and" : $f eq "today" ? " challenges.time_of_selection > current_date and" :''; $taddon = '';}

$curr_sport = defined($curr_cat) && $is_admin ? $curr_cat : $curr_sport;

my $ib = &rad_grad('#e3dac9','#e8e8cc'); 

my $ffam = "Tahoma";

$squares = ( defined($Cookies{'ROUNDS'}) && $Cookies{'ROUNDS'} == 0)   ? 1 : 0;

print STDERR "Called list_controls!\n" if ($debug);

my $sport_and = $curr_sport  eq '0' ? '' : " sport = '$curr_sport' and";
my $city_and = $curr_sport  eq '0' ? '' : " city = '$curr_sport' and";

$comm = "select count(*) from challenges, members where$sport_and challenges.date_and_time > current_timestamp+'$hourshift' and members.proj_code=challenges.owner";

$comm = "select count(*) from challenges, members$taddon where$sport_and$filter challenges.status = 'f' and length(challenges.partner) > 0 and members.proj_code=challenges.owner" if ($type eq '3');
$comm = "select count(*) from challenges, members$taddon where$sport_and$filter challenges.status = 'f' and challenges.partner = '$r_user' and members.proj_code=challenges.owner" if ($type eq '5');

$comm = "select count(*) from members where$city_and u_admin = ''" if ($type == 1);

&getTable;

my $n_cha = ${${$listresult}[0]}[0];

print qq{<script>var num_cur_challenges=$n_cha;</script>};#important


$y_h = koitoutf8("�����");
$y_h_1 = koitoutf8("���");
$y_h_24 = koitoutf8("����");
$now = koitoutf8("������");

$now = koitoutf8("���������") if ($type == 1);
$now = koitoutf8("�������") if ($type == 3);
$now = koitoutf8("�������") if ($type == 5);

my $pokupa = koitoutf8("�����������");
my $pokupa_1 = koitoutf8("����������");
my $pokupa_24 = koitoutf8("����������");

if ($type == 1) {
	$y_h = $pokupa;
	$y_h_1 = $pokupa_1;
	$y_h_24 = $pokupa_24;
}

my $proposals = $y_h;
	
my $rrr = $n_cha - (int($n_cha/1000))*1000;
my $rr = $rrr - (int($rrr/100))*100;
my $r = $rr - (int($rr/10))*10;

$proposals = $y_h_1 if ($r == 1 && $rr != 11);
$proposals = $y_h_24 if ( ($r == 2 || $r == 3 || $r == 4) && $rr != 12 && $rr != 13 && $rr != 14);


print qq{<div id=outer_panel_container style="width:100%;text-align:center;margin-top:0px;">};

my $onms = "onmouseover=\"if (\$('sel_bli')) \$('sel_bli').style.color='#369';\" onmouseout=\"if (\$('sel_bli')) \$('sel_bli').style.color='#222';\"";
$onms = '' if ($ie);

my $brd = ($squares) ? "0px" : "39px";

my $brd30_width = $touch_specific_bro ? "160px":"240px";
my $selector_width = $touch_specific_bro ? "150px":"210px";
my $ml = $touch_specific_bro ? "-20px":"10px";
$ml = $touch_specific_bro  && $type eq '3'? "-36px":$ml;
my $mr = $touch_specific_bro && $type < 2 && $is_admin  ? "45px":"0px";
$mr = $touch_specific_bro && $type eq '3' ? "51px": $mr;

print qq{<div id=left_panel_container style="width:24%;float:left;height:90px;border:0px solid #9cf;margin-bottom:-15px;margin-top:10px;margin-left:$ml;margin-right:$mr;">};
if ($is_admin) {
	  print qq{<div class=brd30 style="width:$brd30_width;height:60px;margin-left:5px;cursor:pointer;padding:5px;background:$ib;border-radius:$brd;text-align:center;$blu_shado;" $onms>};
	
	print "<div id=blinking_sport style=\"text-align:center;margin:10px auto;\">";
		
		print qq{<select id=sel_bli style="font-family:$ffam;line-height:$fs24;color:#222;font-size:$fs18;font-weight:bold;background:transparent;width:$selector_width;" name=sport_selector size=1 onChange="from_interact=1;beginning=1;num_cur_challenges = num_offers[this.value];
		writeSport_and_send(this.value,$ncha_limit_default,$num_order_default);">};
		
		my $bold = $touch_specific_bro || 1 ? ";font-weight:bold" : '';
				
		print qq{<option value=$curr_sport>$sport_labels{$curr_sport}};
		
		for (my $i=0;$i<$num_sports;$i++) {
			my $addon = $num_offers[$i] > 0 ? "&nbsp;($num_offers[$i])" : '';
			$addon = $num_buyers[$i] > 0 ? "&nbsp;($num_buyers[$i])" : '' if ($type eq '1');
			$addon = $num_sells[$i] > 0 ? "&nbsp;($num_sells[$i])" : '' if ($type eq '3');
			$addon = $num_mybuys[$i] > 0 ? "&nbsp;($num_mybuys[$i])" : '' if ($type eq '5');
			
			print qq{<option value=$i>$sport_labels{$i}$addon} 
				if ($i ne $curr_sport && $is_admin);
		}
		print qq{</select>};
		
	print "</div>";#blinking_sport

	print "</div>";#brd30
} else {


	my $region = koitoutf8("������");
	
	my $obl = in_array($curr_sport,(4,5,6,8,9,11,12,13,14,19,20,22,24,28,29,31,35,36,37,38,42,44,45,46,47,48,49,50,49,50,53,55,56,57,59,60,62,64,66,67,68,70,71,72,75,79)) 
	? koitoutf8("�������") : in_array($curr_sport,(3,17,32,33,51,52,65,76)) ? koitoutf8("����") : 
	in_array($curr_sport,(21,26,80,82)) ? koitoutf8("����������") : '';
	
	print qq{<div id=my_region style="margin-top:8px;font-size:16px;">$region:<br>$sport_labels{$curr_sport} $obl</div>};
}
print "</div><!-- left_panel_container -->";

my $bg = &rad_grad('#c6e2ff','#def',50);

my $brd = ($squares) ? "0px" : "30px";

my $fontsize = ($n_cha > 9) ? $fs36 : $fs36;
$fontsize = ($n_cha > 99) ? $fs36 : $fontsize;
$fontsize = ($n_cha > 999) ? $fs18 : $fontsize;

my $w = "60px"; 
my $ht = "60px";
my $mmle = "70px";

my $mg = "margin:4px auto 0 20px;";$mg = "margin:4px auto 0 8px;" if ($n_cha > 9); $mg = "margin:4px auto 0 -4px;" if ($n_cha > 99);

if ($touch_specific_bro) {$now = $proposals = '';};

if (($type eq '3' || $type eq '5') && $desktop) {

	my $vsevremya = koitoutf8("�� ��� �����");
	my $segodnya = koitoutf8("�������");
	my $vchera = koitoutf8("�����");
	
	my %selected_period = ('alltime'=>$vsevremya, 'today'=>$segodnya, 'yesterday'=>$vchera);
	my $curr_tag = $tag;
	if (length($tag) == 0 || !in_array($curr_tag,keys %selected_period) ) {$curr_tag = "alltime"}

	$now = "<select id=tag_adder_2_$aa name=tag style=\"font-family:$ffam;line-height:18px;font-size:$fs18;color:#222;margin-top:4px;\" size=1 
	onChange=\"tag=this.value;tagtable=2;r(current_sport,num_open_cha,num_order,$type,this.value,2);\$('myForm_list_challenges').send();\"><option value=$curr_tag>$selected_period{$curr_tag}";
	
	
	my @clook = xDel($curr_tag, sort keys %selected_period);
	
	foreach my $l (@clook) {
		$now .= "<option value=$l>$selected_period{$l}";
	}
	
	$now .= "</select>";

}

my $wi = $touch_specific_bro  && $type < 2? "50%" : "50%";
my $top = $touch_specific_bro ? "margin-top:10px;" : "margin-top:10px;";
my $mgg = $touch_specific_bro && $type < 2 ? "margin-left:0px;" : '';
my $mggg = $touch_specific_bro && $type < 2 ? "margin-right:-16px;" : '';

print qq{
<div id=center_panel_container style="float:left;width:$wi;height:90px;border:0px solid #396;text-align:center;margin-bottom:-15px;$top">
   <div id=center_panel_wrapper style="width:100%;font-size:16px;font-family:Lucida;height:60px;margin:0px auto;padding:5px;background:transparent;text-align:center;" $onms>
	<div id=now_div style="float:left;width:42%;height:48px;text-align:right;padding-top:12px;font-size:$fs18;">$now</div>
	<div style="float:left;width:16%;height:48px;text-align:center;$mgg">
	   <div class=brd30 id=ncha_div style="text-align:center;position:relative;width:$w;height:$ht;margin:-5px auto 0 auto;font-weight:bold;font-size:$fontsize;color:#222;background:$bg;border-radius:$brd;$blu_shado;$di">
	   	<div style="position:absolute;$mg">$n_cha</div>
	   </div>
	</div>
	<div id=proposals_div style="float:right;width:42%;height:48px;text-align:left;padding-top:12px;font-size:$fs18;">$proposals</div>
	<div id=hashsum style="display:none;clear:all;">$curr_hashsum</div>
   </div><!-- center_panel_wrapper -->
</div><!-- center_panel_container -->
};

my $bg = "#e8e8cc";
my $d = $is_admin ? '': "display:none;";
$d = "display:none;" if ($type eq '3');

$bg = $ib;

my $sym = "<img src=/icon/plus32.png width=32>";

my $tooltip = '';
	
my $brd = ($squares) ? "0px" : "30px";

my $dont = ($nologin) ? "class=mBox-tooltip data-mBox-tooltip=\"$vnachale\"" : '';

$dont = $tooltip if (!length($dont) && length($tooltip) && ($nologin));

$dont = "class=mBox-tooltip data-mBox-tooltip=\"$profile_isnt_active\"" if ($current_status eq "new");

$tooltip = $dont if ($nologin || $current_status eq "new");

my $mr = "11px";

my $wh = "60px";

print qq{
<div id=right_panel_container style="border:solid #9cf 0px;width:10%;float:right;height:90px;margin-bottom:-15px;margin-top:10px;margin-right:15px;$d">
  <div class=brd30 style="float:right;width:$wh;height:$wh;background:$bg;border-radius:$brd;text-align:center;$blu_shado;$mggg">
	<div id=ask_add_ad $tooltip style="width:36px;height:36px;margin:14px auto;">$sym</div>
  </div>
  <div style="clear:right;"></div>
</div><!-- right_panel_container -->
};

if ($type eq '5' || $type eq '3') { #tag search

my $f = defined($query->param('tag')) ?  $query->param('tag') : '';

my $mymode = $type eq '5' ? "stockmybuys_panel" : $type eq '3' ? "stocksells_panel" : "stockboard_panel";

my $srch = koitoutf8("������");
my $srch_str = ''; $srch_str = $f if (length($f) && ($tagtable eq '0' || $tagtable eq '1') );

my $sbros = ( length($f) ) ? "tag = new String();r(current_sport,num_open_cha,num_order,$type,'',0);\$('myForm_list_challenges').send();" : '';

my $fs = "16px"; my $wh = "24px"; my $p = "3px"; my $br = "12px"; my $mi = "96px";

if ($touch_specific_bro) {
$fs = "16px"; $wh = "48px"; $p = "8px"; $br = "24px"; $mi = "72px";
}

my $unsearch = ( length($f) ) ? "<span style=\"font-size:$fs;padding:0 $p;height:$wh;width:$wh;border-radius:$br;border:1px #222 solid;\" onclick=\"$sbros\">X</span>" : '';
my $mr = $touch_specific_bro && $is_admin ? "36px" : "60px";
my $ml = $touch_specific_bro && $type eq '3' ? "-21px" : '0';
print qq{
<div id=right_panel_container2 style="border:solid #9cf 0px;width:10%;float:right;height:90px;margin-bottom:-15px;margin-top:10px;margin-right:$mr;margin-left:$ml;">
	<div class="tagged" style="text-align:center;font-size:16px;font-family:$ffam;font-style:normal;">
		<span style="white-space:nowrap;font-size:$fs18">$srch:</span>
		<div style="white-space:nowrap;">$unsearch
		<input type=text style="width:100%;font-size:16px;text-indent:3px;line-height:24px;margin-left:5px;text-align:left;padding-left:3px;min-width:$mi;" 
		onfocus="this.value='';" value="$srch_str" 
		onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) {tag=this.value;r(current_sport,num_open_cha,num_order,$type,tag,0);\$('myForm_list_challenges').send();}">
		</div>
	</div>
</div><!-- right_panel_container2 -->
};
} #tag search

if ($type eq '0' && !$is_admin) { #auction count


print qq{
<div id=right_panel_container3 style="border:solid #9cf 0px;width:15%;float:right;height:90px;margin-bottom:-15px;margin-top:10px;margin-right:20px;">
};

	my $auc = koitoutf8("�������");
	
	my $comm = "select ID from challenges where price > $default_price and status='t' and (partner ~ '^$r_user,' or partner ~ ',$r_user,') and date_and_time > current_timestamp+'$hourshift'";
	my $result=$dbconn->prepare($comm);
    	$result->execute;
	&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
	my $lr = $result->fetchall_arrayref;
	my $ntuples = $result->rows();
	
#print STDERR "Here comm is $comm!\n";
	
	my $num_of_aucs = $ntuples > 0  ? $ntuples : 0;
	
	print qq{<div id=my_auc style="margin-top:6px;font-size:16px;">$auc: $num_of_aucs</div>};
print qq{
</div><!-- right_panel_container2 -->
};
} #auction counter


print "</div><!-- outer_panel_container -->";


}

sub list_challenges { #48

my $curr_cat = shift || 0;

my $requested_num_cha = shift || $ncha_limit;

my $type = shift || 0;

my $ajax_mode = shift || 0;

my $f = shift || ''; $f =~ s/\s//g;

my $ft = shift || 0;

if ($type == 2 || $type == 4 || $type == 6) {
	exit;
}

my $mymode = $type eq '5' ? "stockmybuys_panel" : $type eq '3' ? "stocksells_panel" : $type eq '1' ? "stockusers_panel" : "stockboard_panel";

my $filter = length($f) && ($type eq '5' || $type eq '3') ? " lower(tags.tag) ~ lower('$f') and tags.match_oid=challenges.ID and" : '';
my $taddon = length($f) && ($type eq '5' || $type eq '3') ? ", tags" : '';

if ($ft eq '1' && $type eq '3' && length ($f) ) {$f = nkname_lookup($f,1); $filter = " partner = '$f' and"; $taddon = '';}
if ($ft eq '2') {$filter = $f eq "yesterday" ? " challenges.time_of_selection < current_date and challenges.time_of_selection > current_date-1 and" : $f eq "today" ? " challenges.time_of_selection > current_date and" :''; $taddon = '';}

$curr_sport = defined($curr_cat) && $is_admin ? $curr_cat : $curr_sport;

my $selected_row = defined($query->param('sr')) ?  $query->param('sr') : 0;

my $new_tips = 1;
my $ib = &rad_grad('#e3dac9','#e8e8cc'); 

my $ffam = "Tahoma";

rint STDERR "Called list_cha!\n" if ($debug);

my $sport_and = $curr_sport  eq '0' ? '' : " sport = '$curr_sport' and";
my $city_and = $curr_sport  eq '0' ? '' : " city = '$curr_sport' and";

my $def_req_order = $type eq '5' ? "challenges.time_of_selection desc" : "challenges.date_and_time desc";
$def_req_order = $type eq '1' ? "members.p_vremya_z" : $def_req_order;

my $requested_order = $num_order == 21 ? "challenges.date_and_time" : $num_order == 20 ? "challenges.date_and_time desc" :
			$num_order == 1 ? "challenges.price" : $num_order == 0 ? "challenges.price desc" :
			$num_order == 11 ? "challenges.place" : $num_order == 10 ? "challenges.place desc" :
			$num_order == 31 ? "challenges.condition" : $num_order == 30 ? "challenges.condition desc" :
			$num_order == 41 ? "challenges.time_of_selection" : $num_order == 40 ? "challenges.time_of_selection desc" : $def_req_order;

if ($type eq '1') {
$requested_order = $num_order == 21 ? "members.p_vremya_z" : $num_order == 20 ? "members.p_vremya_z desc" :
			$num_order == 1 ? "members.a_nkname" : $num_order == 0 ? "members.a_nkname desc" :
			$num_order == 11 ? "members.k_kredit" : $num_order == 10 ? "members.k_kredit desc" :
			$num_order == 31 ? "members.d_spec" : $num_order == 30 ? "members.d_spec" : $def_req_order
}
					
$comm = "select members.ID, challenges.owner, challenges.place, challenges.date_and_time, challenges.condition, members.e_masterst, challenges.ID, challenges.status, challenges.partner, challenges.time_of_selection, challenges.price, challenges.hashed_condition from challenges, members 
where$sport_and challenges.date_and_time > current_timestamp+'$hourshift' and members.proj_code=challenges.owner order by $requested_order, challenges.ID limit $requested_num_cha";

$comm = "select members.ID, challenges.owner, challenges.place, challenges.date_and_time, challenges.condition, members.e_masterst, challenges.ID, challenges.status, challenges.partner, challenges.time_of_selection, challenges.price, challenges.hashed_condition from challenges, members$taddon 
where$sport_and$filter challenges.status = 'f' and length(challenges.partner) > 0 and members.proj_code=challenges.owner order by $requested_order, challenges.ID limit $requested_num_cha" 
	if ($type == 3);
	
$comm = "select members.ID, challenges.owner, challenges.place, challenges.date_and_time, challenges.condition, members.e_masterst, challenges.ID, challenges.status, challenges.partner, challenges.time_of_selection, challenges.price, challenges.hashed_condition from challenges, members$taddon 
where$sport_and$filter challenges.status = 'f' and challenges.partner = '$r_user' and members.proj_code=challenges.owner order by $requested_order, challenges.ID limit $requested_num_cha" 
	if ($type == 5);
#print STDERR $comm."\n" if ($type == 5);

$comm = "select members.ID, '$r_user', members.k_kredit, members.p_vremya_z, members.d_spec, 1, members.ID, null, null, 
null, members.a_nkname from members where$city_and u_admin = '' order by $requested_order, ID limit $requested_num_cha" 
	if ($type == 1);
	
#print STDERR $comm;

&getTable;

my $button_width = "120px";


my $f1 = koitoutf8("����");
my $f2 = koitoutf8("���������");
my $f3 = koitoutf8("��");
my $f4 = koitoutf8("��������");
my $f5 = koitoutf8("��������");

if ($type == 1) {
	$f1 = koitoutf8("���");
	$f2 = koitoutf8("������");
	$f3 = koitoutf8("����� ���");
	$f4 = koitoutf8("�����������");
	$f5 = koitoutf8("��������");
}

if ($type == 3) {

	$f5 = koitoutf8("����������");
}

if ($type == 5) {

	$f5 = koitoutf8("�������");
}

unless ($type eq '2') { #experiment

my $w1 = "20%";
my $w2 = "25%";
my $w5 = "15%";
my $w3 = $w1;
my $w4 = "20%";

print qq{
<!-- myzebra -->
};


my @disp = (my $d0 = "display:none;",my $d1 = "display:none;",my $d10 = "display:none;",my $d11 = "display:none;",
my $d21 = "display:none;",my $d20 = "display:none;",my $d31 = "display:none;",my $d30 = "display:none;",my $d41 = "display:none;",my $d40 = "display:none;");

if ($num_order == 21) {foreach my $l (@disp) {$l = "display:none;";} $d21 = "display:block;";} 
elsif ($num_order == 20) {foreach my $l (@disp) {$l = "display:none;";} $d20 = "display:block;";} 
elsif ($num_order == 1) {foreach my $l (@disp) {$l = "display:none;";} $d1 = "display:block;";} 
elsif ($num_order == 0) {foreach my $l (@disp) {$l = "display:none;";} $d0 = "display:block;";} 
elsif ($num_order == 11) {foreach my $l (@disp) {$l = "display:none;";} $d11 = "display:block;";} 
elsif ($num_order == 10) {foreach my $l (@disp) {$l = "display:none;";} $d10 = "display:block;";} 
elsif ($num_order == 31) {foreach my $l (@disp) {$l = "display:none;";} $d31 = "display:block;";} 
elsif ($num_order == 30) {foreach my $l (@disp) {$l = "display:none;";} $d30 = "display:block;";} 
elsif ($num_order == 41) {foreach my $l (@disp) {$l = "display:none;";} $d41 = "display:block;";} 
elsif ($num_order == 40) {foreach my $l (@disp) {$l = "display:none;";} $d40 = "display:block;";}

my $addon_rur =" <span style=\"font-weight:normal;color:#222;margin-left:-3px;\">&nbsp;$denga</span>";
$addon_rur = '' if ($type eq '1');

my $curr_filter_text = koitoutf8("������");
my $curr_filter = ($tagtable eq '1' && length($tag)) ? "<div>$curr_filter_text:$tag</div>" : '';
print "<table id=myzebra class=\"list-ta mytable\" border=1 style=\"margin:0 auto 60px auto;width:100%;\"><thead id=zebra_head>";
print "<tr id=header_row>
<th style=\"font-size:14px;margin-left:12px;\">$f1$addon_rur<span id=uarr0 class=arrs style=\"$d1\">&uarr;</span><span id=darr0 class=arrs style=\"$d0\">&darr;</span></th>
<th style=\"font-size:14px;\">$f2<span id=uarr1 class=arrs style=\"$d11\">&uarr;</span><span id=darr1 class=arrs style=\"$d10\">&darr;</span></th>
<th style=\"font-size:14px;\">$f3<span id=uarr2 class=arrs style=\"$d21\">&uarr;</span><span id=darr2 class=arrs style=\"$d20\">&darr;</span></th>
<th style=\"font-size:14px;\">$f4<span id=uarr3 class=arrs style=\"$d31\">&uarr;</span><span id=darr3 class=arrs style=\"$d30\">&darr;</span></th>
<th id=buyer_field style=\"font-size:14px;text-align:center;\">$f5<span id=uarr4 class=arrs style=\"$d41\">&uarr;</span><span id=darr4 class=arrs style=\"$d40\">&darr;</span>$curr_filter</th>
</tr>
</thead>
<tbody id=zebra_tbody class='tableBody'>";

my $colvo = $ntuples;

for (my $i=0; $i<$ntuples;$i++) { #rows

	
	my $aa = ${${$listresult}[$i]}[6]; #oid challenges
	my $bb = ${${$listresult}[$i]}[0]; #oid members
	my $cc = $aa."_".$bb; #combi

	#default
	$working_time = 1;
	
	my $is_winner = $r_user eq ${${$listresult}[$i]}[8] ? 1 : 0;
	
	my $is_loser = (!$is_winner && ${${$listresult}[$i]}[7] eq '0') ? 1 : 0;
		
	my $hide_chal = "[x]" if ($is_admin);	
	my $div_hide_mark = "<div id=marker_".$aa." style=\"float:right;background:#faf0f0;padding:2px;font-size:$fs10;font-style:italic;color:#369;\" onclick=\"var yon = window.confirm('Really?! $hide_chal_warn');if (yon) {hide_record(".$aa.")};\">$hide_chal</div>";
	
	$div_hide_mark = '' unless ($is_admin );
	
	my $color_chal = "[oOo]" if ($is_admin);	
	my $color_mark = "<div id=color_".$aa." style=\"float:right;background:#faf0f0;padding:2px;font-size:$fs10;font-style:italic;color:#369;\" onclick=\"var yon = window.confirm('Really?! $color_chal_warn');if (yon) {color_record(".$aa.")};\">$color_chal</div>";
	$color_mark = '' unless ($is_admin);

	my $masterst = "&nbsp;".masterst_parsed(${${$listresult}[$i]}[5]);
	
	my $selclass = $aa eq $selected_row ? " class=highlight" : '';
	
    	print "<tr$selclass><td style=\"vertical-align:middle;\">";
	
	my $pl_of_match = my $cond_of_match = $k_g;
	
	$pl_of_match = ${${$listresult}[$i]}[2];
	$cond_of_match = ${${$listresult}[$i]}[4];	
	
	my $o = ${${$listresult}[$i]}[0];
	my $owner_of_cha = ${${$listresult}[$i]}[0];

	$cond_of_match = &chunk_idiots($cond_of_match);
	
	my $pokazat = koitoutf8("�������� ��� ������");
	my $hp = length(${${$listresult}[$i]}[11]) ? ${${$listresult}[$i]}[11] : "no hash";

	$cond_of_match = "<div class=pokazat data-mBox-tooltip=\"$hp\">$pokazat</div>" unless ($is_admin || $is_winner || $is_loser);
	#$cond_of_match = "-------------------" unless ($is_admin || $is_winner); #juma

	$pl_of_match =~ s/([^\s]),([^\s])/$1, $2/g;
	
	my $price = ${${$listresult}[$i]}[10];
	
	my $t1 = "<div style=\"display:inline;margin-left:12px;font-weight:bold;font-family:$ffam;font-size:$fs16;color:#2233ff;line-height:20px;background:transparent;\" onmouseover=\"this.style.color='#bbb';\" onmouseout=\"this.style.color='#2233ff';\">".$price."</div>";
	print $t1;

	print "</td>
	<td style=\"vertical-align:middle;\">";
	
	my $t2 = "<div style=\"font-family:$ffam;font-size:$fs14;padding-left:5px;text-align:left;\">".$pl_of_match."</div>";
	print $t2;

############### tags name in f2 Categories
if ($type eq '5' || $type eq '3') {

my $add_tag_text = koitoutf8("����� ���");

print qq{
		<div class="postControlsBottom">
			<div class="bottomDiv">
				<div id="tags_2_$aa" class="tags">				
};					
&print_tags($aa,$type,2); #name tag

my $d = $type eq '3' ? "display:none;" : '';

my $khren = koitoutf8("�����");
my $tuhl = koitoutf8("����");
my $super = koitoutf8("�����");
my $vopr = koitoutf8("�������");


print qq{			</div>
				<span style="float:left;margin:10px;color:#369;text-decoration:underline;font-size:12px;cursor:pointer;$d" onclick="\$('tag_adder_wrapper_2_$aa').style.display='block';">$add_tag_text</span>	
				<div id=tag_adder_wrapper_2_$aa style="display:none;">
					<div style="float:left;margin-left:5px;">
						<!-- input type=text id=tag_adder_2_$aa name=tag value="" onfocus="this.value='';" onblur="\$('tag_adder_wrapper_2_$aa').style.display='none';" 
						onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) ajax_get_tags($aa,this.value,0,$type,2);"
						style="width:112px;font-family:$ffam;font-size:12px;padding:3px;" -->
						<select id=tag_adder_2_$aa name=tag style="font-family:$ffam;line-height:$fs16;font-size:$fs14;color:#222;" size=1">
							<option value=$vopr>$vopr
							<option value=$khren>$khren
							<option value=$tuhl>$tuhl
							<option value=$super>$super
						</select>
					</div>
					<div style="float:left;margin-left:5px;">
						<input type=button value='+' onclick="ajax_get_tags($aa,\$('tag_adder_2_$aa').value,0,$type,2);" 
						style="width:24px;font-family:$ffam;font-size:12px;padding:0px 3px 3px 3px;float:left;">
						<input type=button value="x" onclick="\$('tag_adder_wrapper_2_$aa').style.display='none';" 
						style="width:24px;font-family:$ffam;font-size:12px;padding:0px 3px 3px 3px;float:left;">
						<div style="clear:left;"></div
					</div>
					<div style="clear:left;"></div>
				</div>
			</div><!-- bottomDiv -->
		</div><!-- postControlsBottom -->		
};
} #
############### end tags
	
	print "</td>";
	
	print "<td style=\"vertical-align:middle;\">";
	
	my $dti = swap_date(${${$listresult}[$i]}[3],0);
	
	my $t3 = "<div style=\"font-family:$ffam;font-size:$fs14;color:#024;padding-left:7px;\">".$dti.", ".&find_weekday(${${$listresult}[$i]}[3],1)."</div>";
	print $t3;

############### tags date of buy in f3 Date
if ($type eq '5' || $type eq '3') { #my buys and sells


print qq{
		<div class="postControlsBottom">
			<div class="bottomDiv">
				<div id="tags_1_$aa" class="tags">				
};					
&print_tags($aa,$type,1); #date of buy tag

my $d = "display:none;"; #dont show add new tag box for date tag

print qq{			</div>
				<span style="float:left;margin-right:10px;color:#369;text-decoration:underline;font-size:12px;cursor:pointer;$d" onclick="\$('tag_adder_wrapper_1_$aa').style.display='block';">$add_tag_text</span>	
				<div id=tag_adder_wrapper_1_$aa style="display:none;">
					<div style="float:left;margin-left:5px;">
						<input type=text id=tag_adder_1_$aa name=tag value="" onfocus="this.value='';" onblur="\$('tag_adder_wrapper_1_$aa').style.display='none';" 
						onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) ajax_get_tags($aa,this.value,0,$type,1);"
						style="width:112px;font-family:$ffam;font-size:12px;padding:3px;">
					</div>
					<div style="float:left;margin-left:5px;">
						<input type=button value="+" onclick="ajax_get_tags($aa,\$('tag_adder_1_$aa').value,0,$type,1);" 
						style="width:24px;font-family:$ffam;font-size:12px;padding:0px 3px 3px 3px;">
					</div>
					<div style="clear:left;"></div>
				</div>
			</div><!-- bottomDiv -->
		</div><!-- postControlsBottom -->		
};
} # my buys and sells
############### end tags date of buy in f3 Date

	print "</td>";
		
	print "<td style=\"vertical-align:middle;\">";

	my $bg = ($is_winner) ? "#fff" : "transparent";
	my $t4 = "<div style=\"font-family:$ffam;font-size:$fs14;text-align:center;border-radius:3px;background:$bg;padding:3px;\">".$cond_of_match."</div>";
	print $t4;

############### tags name in f4 Contacts
if ($type eq '5' || $type eq '3') { #my buys and sells

my $add_tag_text = koitoutf8("����� ���");

print qq{
		<div class="postControlsBottom">
			<div class="bottomDiv">
				<div id="tags_0_$aa" class="tags">				
};					
&print_tags($aa,$type,0); #name tag

my $d = $type eq '3' ? "display:none;" : '';

print qq{			</div>
				<span style="float:left;margin-right:10px;color:#369;text-decoration:underline;font-size:12px;cursor:pointer;$d" onclick="\$('tag_adder_wrapper_0_$aa').style.display='block';">$add_tag_text</span>	
				<div id=tag_adder_wrapper_0_$aa style="display:none;">
					<div style="float:left;margin-left:5px;">
						<input type=text id=tag_adder_0_$aa name=tag value="" onfocus="this.value='';" onblur="\$('tag_adder_wrapper_0_$aa').style.display='none';" 
						onkeydown="var Ucode=event.keyCode? event.keyCode : event.charCode; if (Ucode == 13) ajax_get_tags($aa,this.value,0,$type,0);"
						style="width:112px;font-family:$ffam;font-size:12px;padding:3px;">
					</div>
					<div style="float:left;margin-left:5px;">
						<input type=button value="+" onclick="ajax_get_tags($aa,\$('tag_adder_0_$aa').value,0,$type,0);" 
						style="width:24px;font-family:$ffam;font-size:12px;padding:0px 3px 3px 3px;">
					</div>
					<div style="clear:left;"></div>
				</div>
			</div><!-- bottomDiv -->
		</div><!-- postControlsBottom -->		
};
} # my buys and sells
############### end tags
	print "</td>";
	
	my $sig = 0;
	my $stat = 0;
	
	if (${${$listresult}[$i]}[7] ne '') {
	 	
		$stat = 1 if (${${$listresult}[$i]}[7] eq '1');
		
	     	my $p_string = ${${$listresult}[$i]}[8];

     		my @p_array = split(',',$p_string);

		$chunk = $t_g.'::';

		$chunk_a = '';
		$chunk = "<table>" unless ($new_tips);
     		$num_vars = 0;

     		foreach my $pline (@p_array) {
		
		my $changing = "#f0f0a0";
		
		my $hh = &nkname_lookup($pline);

		my $hoid = &oid_lookup($pline,1);			
		
		($pline,my $rest) = split('_',$pline) unless ($pline =~ /^visitatore_/);
				
		my $sel = "select comment from comments where author = '$pline' and match_oid = '$aa'";
		my $res = $dbconn->prepare($sel);
		$res->execute;
		&dBaseError($res, $sel."  (".$res->rows()." rows found)") if ($res->rows() == -2);
		my $listres = $res->fetchall_arrayref;
		my $ntpls = $res->rows();
		my $cmnt = ($ntpls == 1) ? ${${$listres}[0]}[0] : '';
		$cmnt =~ s/\s+/ /g;$cmnt =~ s/^\s$//g;
		
		my $thre_is_cmnt = '';$thre_is_cmnt = '<font color=#369><b><s>C</s></b></font>' if ($is_admin &&  length($cmnt));
							
			if ($new_tips) {

				$chunk .= "<div>".$hh;
				$chunk .="&nbsp;$thre_is_cmnt";
				$chunk .= "</div>";
				
				my $if_there_is_tips_then = "";
				$if_there_is_tips_then = " class=tipz title=\"::$cmnt\"" 
					if ( $is_admin &&  length($cmnt));
					
					my $js_show_profile = ''; #we dont show profiles for everybody in auctions
											
					#$js_show_profile = " onclick=\"js_show_profile($hoid);\"";

					
					my $bg_high = length($js_show_profile) ? "color:#2233ff;background:$changing;" : '';
					my $js_high = length($js_show_profile) ? " onmouseover=\"this.style.color='#bbb';\" onmouseout=\"this.style.color='#2233ff';\"" : '';
					
						$chunk_a .= "<div$if_there_is_tips_then style=\"float:left;display:inline;font-family:$ffam;font-size:$fs12;margin:4px;$bg_high\"$js_show_profile$js_high>".$hh."</div>";
					
			} else {
				$chunk .= "<tr><td>".$hh."</td>";
				$chunk .= "</tr>";
			};
			
     			$num_vars++;
			$sig = 1 if ($pline eq $r_user);#this can't be in dev14 as admins own all chals
     		}
		$chunk .= "</table>" unless ($new_tips);

	} #status is not null


	my $ow = ${${$listresult}[$i]}[1];#owner
	my $pa = ${${$listresult}[$i]}[8];#partner
	my $st = ${${$listresult}[$i]}[7]; #status
	my $oi = ${${$listresult}[$i]}[0]; #oid members
		
	my $sta_bg = $st eq '0' ? ($is_admin && length($pa) ? "background:#def;" : $is_winner ? "background:#def;" : '') : !$sig && $r_user ne $ow ? '' : !$stat && ($r_user eq ${${$listresult}[$i]}[1]) ? '' : "background:#b2e6c5;";

	print "<td class=numeric style=\"text-align:center;vertical-align:middle;\">";

#START cases of types of ajax_box

	my $l = "var counterRect = \$('ncha_div').getBoundingClientRect();";
	my $m = "var a = counterRect.left-210;var b = counterRect.top+60;";

if ($st eq '0') {
################################
#challenge status is 0, nothing to do, partner already selected
################################

	print "<div style=\"text-align:center;margin:0 auto;width:100%;height:100%;padding:5px;$sta_bg\">";

	#my $o = &oid_lookup($pa,1);#oid only for js_show_profile
	my $sopernik = &nkname_lookup($pa);	

	my $oncl = "onmouseover=\"bsc=this.style.color;this.style.color='#bbb';\" onmouseout=\"this.style.color=bsc;\"";
	
	if ($is_admin && $type eq '3') {						
		#$sopernik = "<a href=\"?mode=stocksells_panel&tag=$sopernik&tagtable=1\">$sopernik</a>";
		$sopernik = "<a href=\"javascript: function open_tag_link() {tag='$sopernik';tagtable=1;from_interact=1;r(current_sport,num_open_cha,num_order,$type,tag,1);\$('myForm_list_challenges').send();}open_tag_link();\">$sopernik</a>";
	}
	
	$sopernik = '' if $type eq '5';
	if ($is_winner || $is_admin || $is_loser) {

				print "<div style=\"margin:3px auto;text-align:center;\"><div style=\"font-weight:bold;font-family:$ffam;color:#69c;font-size:$fs14;\" $oncl>".$sopernik."</div></div>";


	} else {
			my $kuplen = koitoutf8("�������");
			print "<div style=\"text-align:center;font-size:$fs14;font-family:$ffam;white-space:nowrap;\">>> $kuplen <<</div>";
	}
		
	my $a = substr(${${$listresult}[$i]}[9],0,16) if (length(${${$listresult}[$i]}[9]));
	print "<span style=\"font-size:$fs14;\">".$a."</span>";

	print "</div>";
	
} elsif (!$sig && $r_user ne $ow) { 

################################
#in case we are not the owner, & not in list yet, we can subscribe to candidates
################################
if ($curr_balance >= $price ) {
#$buttons{'contest'} = koitoutf8("������") if ($price eq '1'); #juma
$buttons{'contest'} = koitoutf8("������");
	print "<div style=\"text-align:center;margin:0 auto;width:100%;height:100%;$sta_bg\"><INPUT TYPE=button style=\"$grey_shado;margin:0px auto;font-family:$ffam;padding:2px 2px 4px 2px;width:$button_width;font-size:$fs12;\" id=ask_$cc VALUE=$buttons{'contest'} 
	onclick=\"$l;$m;
		var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';	
		\$('ajax_0').setStyles({'position': pos });
		\$('ajax_0').setStyles({'left': a });	
		\$('ajax_0').setStyles({'top': b });
		\$('ajax_0').setStyles({'display': 'block' });
		\$('ajax_0').fade(1);
		\$('container_log_ajax_0').setStyles({'display': 'block' });	
		var log_ajax_0 = \$('_ajax_0').empty().addClass('ajax-loading');
		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_0');
		document.body.appendChild(form);	
		\$('myForm_0').action = '$scriptname?mode=confirm_yourself_juma&cat=$curr_sport&coid=$aa&member=$bb';
		\$('myForm_0').set('send', {onComplete: function(response) { 
			check_response(response);
			log_ajax_0.removeClass('ajax-loading');
			log_ajax_0.set('html', response);
		}});
		\$('myForm_0').send();
		\$('myForm_0').dispose();\"></div>";
} else {
	print "<div style=\"text-align:center;margin:0 auto;width:100%;height:100%;$sta_bg\">LOW BALANCE!!<br>$curr_balance < $price !</div>";
}
} elsif ( !$stat && ($r_user eq ${${$listresult}[$i]}[1])) { 
my $touch_specific_bro = 0; #hack ash
################################
#IS challenge owner, no candidates
################################

my $act_str = "$scriptname?mode=edit_challenge&coid=".$aa;
$act_str = "$scriptname?mode=edit_member&coid=".$bb if ($type == 1)
;
   unless ($touch_specific_bro) {	   

	print "<div style=\"text-align:center;margin:0 auto;width:100%;height:100%;$sta_bg\"><INPUT TYPE=button id=ask_$aa style=\"$grey_shado;margin:0px auto;font-family:$ffam;padding:2px 2px 5px 2px;width:$button_width;font-size:$fs12;\" VALUE=$buttons{'edit_challenge'} 
	onclick=\"check_my_auth();$l;$m;
	var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		\$('ajax_0').setStyles({'position': pos });
		\$('ajax_0').setStyles({'left': a });	
		\$('ajax_0').setStyles({'top': b });
		\$('ajax_0').setStyles({'display': 'block' });
		\$('ajax_0').fade(1);
		\$('container_log_ajax_0').setStyles({'display': 'block' });	
		var log_ajax_0 = \$('_ajax_0').empty().addClass('ajax-loading');
		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_0');
		document.body.appendChild(form);	
		\$('myForm_0').action = '$act_str';
		\$('myForm_0').set('send', {onComplete: function(response) { 
			check_response(response);
			log_ajax_0.removeClass('ajax-loading');
			log_ajax_0.set('html', response);
		}});
		\$('myForm_0').send();
		\$('myForm_0').dispose();
		\"></div>";

   } else {
	   	print "<div style=\"text-align:center;margin:0 auto;width:100%;height:100%;$sta_bg\"><INPUT TYPE=button style=\"width:$button_width;font-size:$fs12;\" 
		onclick=\"location.href='$act_str'\" VALUE=$buttons{'edit_challenge'}></div>";
   }

	
} elsif ( $r_user eq ${${$listresult}[$i]}[1]) { 

my $touch_specific_bro = 0; #hack ash

################################
#owner is selecting candidate
################################
my $addon = '';
my $t5 = '';
   if ($is_admin) {

		$k_i = koitoutf8("����������");

		$addon = "<br><span style=\"font-size:$fs12;\">$k_i: $num_vars</span>";

		$addon .= "<div id=\"candidates_$aa\" style=\"display:none;margin-right:5px;width:$button_width;font-size:$fs12;\">$chunk_a</div>";	
	
		$addon .= &print_variants_in_tooltip($chunk,0,"show_candidates($aa);",1,1);
		
   }
   
   unless ($touch_specific_bro) {


	$t5 = "<div style=\"text-align:center;margin:0 auto;width:100%;height:100%;$sta_bg\"><INPUT TYPE=button id=ask_$aa style=\"width:$button_width;font-size:$fs16;\" VALUE=$buttons{'select_candidate'} 
	onclick=\"check_my_auth();$l;$m;
	var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		\$('ajax_0').setStyles({'position': pos });
		\$('ajax_0').setStyles({'left': a });	
		\$('ajax_0').setStyles({'top': b });
		\$('ajax_0').setStyles({'display': 'block' });
		\$('ajax_0').fade(1);
		\$('container_log_ajax_0').setStyles({'display': 'block' });	
		var log_ajax_0 = \$('_ajax_0').empty().addClass('ajax-loading');
		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_0');
		document.body.appendChild(form);	
		\$('myForm_0').action = '$scriptname?mode=select_candidate&coid=$aa&par=0';
		\$('myForm_0').set('send', {onComplete: function(response) { 
			check_response(response);
			log_ajax_0.removeClass('ajax-loading');
			log_ajax_0.set('html', response);
		}});
		\$('myForm_0').send();
		\$('myForm_0').dispose();
		\">".$addon."</div>";
   } else {
	   	$t5 = "<div style=\"text-align:center;margin:0 auto;width:100%;height:100%;$sta_bg\"><INPUT TYPE=button style=\"width:$button_width;font-size:$fs16;\" onclick=\"location.href='$scriptname?mode=select_candidate&par=0&coid=".$aa
		."'\" VALUE=$buttons{'select_candidate'}>".$addon."</div>";

   }
   
   print $t5;
	

	
} else { #finally, reject, don't be a candidate any longer


	print "<div style=\"text-align:center;margin:0 auto;width:100%;padding:10px;$sta_bg\"><INPUT TYPE=button id=ask_$cc style=\"width:$button_width;font-size:$fs12;font-family:$ffam;padding:2px 2px 5px 2px;\" VALUE=$buttons{'reject'} 
	onclick=\"$l;$m;var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
		\$('ajax_0').setStyles({'position': pos });
		\$('ajax_0').setStyles({'left': a });	
		\$('ajax_0').setStyles({'top': b });
		\$('ajax_0').setStyles({'display': 'block' });
		\$('ajax_0').fade(1);
		\$('container_log_ajax_0').setStyles({'display': 'block' });	
		var log_ajax_0= \$('_ajax_0').empty().addClass('ajax-loading');
		var form = document.createElement('form');
		form.setAttribute('method', 'get');
		form.setAttribute('id', 'myForm_0');
		document.body.appendChild(form);	
		\$('myForm_0').action = '$scriptname?mode=remove_yourself&cat=$curr_sport&coid=$aa&member=$bb';
		\$('myForm_0').set('send', {onComplete: function(response) { 
			check_response(response);
			log_ajax_0.removeClass('ajax-loading');
			log_ajax_0.set('html', response);
		}});
		\$('myForm_0').send();
		\$('myForm_0').dispose();
		\"></div>";
	
} #END cases of types of ajax_box
	
	
	if ($is_admin && $st ne '0' && $type eq '0') {
		print "<div>";
		print $div_hide_mark;	
		print $color_mark;	
		print qq{<div style="clear:right;"></div>};
		print "</div>";
	}
	
	print "</td></tr>";
} #end for rows


print "</tbody></table>"; #myzebra end

} #experiment type == 2
else {

print qq {


  <table class="mytable" border="1">
    <thead>
      <tr>
        <th>head1</th>
        <th>head2</th>
        <th>head3</th>
        <th>head4</th>
      </tr>
    </thead>
    <tr>
      <td>row 1, cell 1</td>
      <td>row 1, cell 2</td>
      <td>row 1, cell 3</td>
      <td>row 1, cell 4</td>
    </tr>
    <tr>
      <td>row 2, cell 1</td>
      <td>row 2, cell 2</td>
      <td>row 2, cell 3</td>
      <td>row 2, cell 4</td>
    </tr>
    <tr>
      <td>row 3, cell 1</td>
      <td>row 3, cell 2</td>
      <td>row 3, cell 3</td>
      <td>row 3, cell 4</td>
    </tr>
    <tr>
      <td>row 4, cell 1</td>
      <td>row 4, cell 3</td>
      <td>row 4, cell 3</td>
      <td>row 4, cell 4</td>
    </tr>
    <tr>
      <td>row 5, cell 1</td>
      <td>row 5, cell 3</td>
      <td>row 5, cell 3</td>
      <td>row 5, cell 4</td>
    </tr>
    <tr>
      <td>row 6, cell 1</td>
      <td>row 6, cell 3</td>
      <td>row 6, cell 3</td>
      <td>row 6, cell 4</td>
    </tr>
    <tr>
      <td>row 7, cell 1</td>
      <td>row 7, cell 3</td>
      <td>row 7, cell 3</td>
      <td>row 7, cell 4</td>
    </tr>
    <tr>
      <td>row 8, cell 1</td>
      <td>row 8, cell 3</td>
      <td>row 8, cell 3</td>
      <td>row 8, cell 4</td>
    </tr>
    <tr>
      <td>row 9, cell 1</td>
      <td>row 9, cell 3</td>
      <td>row 9, cell 3</td>
      <td>row 9, cell 4</td>
    </tr>
    <tr>
      <td>row 10, cell 1</td>
      <td>row 10, cell 3</td>
      <td>row 10, cell 3</td>
      <td>row 10, cell 4</td>
    </tr>
    <tr>
      <td>row 11, cell 1</td>
      <td>row 11, cell 2</td>
      <td>row 11, cell 3</td>
      <td>row 11, cell 4</td>
    </tr>
    <tr>
      <td>row 12, cell 1</td>
      <td>row 12, cell 2</td>
      <td>row 12, cell 3</td>
      <td>row 12, cell 4</td>
    </tr>
    <tr>
      <td>row 13, cell 1</td>
      <td>row 13, cell 2</td>
      <td>row 13, cell 3</td>
      <td>row 13, cell 4</td>
    </tr>
    <tr>
      <td>row 14, cell 1</td>
      <td>row 14, cell 3</td>
      <td>row 14, cell 3</td>
      <td>row 14, cell 4</td>
    </tr>
    <tr>
      <td>row 15, cell 1</td>
      <td>row 15, cell 3</td>
      <td>row 15, cell 3</td>
      <td>row 15, cell 4</td>
    </tr>
    <tr>
      <td>row 16, cell 1</td>
      <td>row 16, cell 3</td>
      <td>row 16, cell 3</td>
      <td>row 16, cell 4</td>
    </tr>
    <tr>
      <td>row 17, cell 1</td>
      <td>row 17, cell 3</td>
      <td>row 17, cell 3</td>
      <td>row 17, cell 4</td>
    </tr>
    <tr>
      <td>row 18, cell 1</td>
      <td>row 18, cell 3</td>
      <td>row 18, cell 3</td>
      <td>row 18, cell 4</td>
    </tr>
    <tr>
      <td>row 19, cell 1</td>
      <td>row 19, cell 3</td>
      <td>row 19, cell 3</td>
      <td>row 19, cell 4</td>
    </tr>
    <tr>
      <td>row 20, cell 1</td>
      <td>row 20, cell 3</td>
      <td>row 20, cell 3</td>
      <td>row 20, cell 4</td>
    </tr>
  </table>

};

} #end experiment

print qq{

<!-- myzebra -->
<div id="load-more" style="margin-top:5px;"></div>
};


$curr_num_challenges = $curr_num_buyers if ($par == 1);
$curr_num_challenges = $curr_num_sells if ($par == 3);
$curr_num_challenges = $curr_num_mybuys if ($par == 5);

if ($ajax_mode) {
	print "zanzibarrtrafalgarr";
	print $curr_balance;
}

}

sub rad_grad { #264

my $col = shift;
my $defcol = shift;
my $p = shift;
my $bgcol = shift;

my $bg = $col;

$p = $p ? $p.'%' : '50%';
$bgcol = $bgcol ? $bgcol : '#fff';

$bg = "radial-gradient($p $p, $col, $bgcol)";

$bg = "-ms-radial-gradient($p $p, $col, $bgcol)" if ($ie10);

return $bg;
}

sub print_variants_in_tooltip { #71

my ($chunk, $if_sticky, $if_real_func, $nt, $fifthparm) = @_;

$new_tips = 1 if ($nt);

my $ch = $chunk;
$ch =~ s/<table><\/table>//g;

my $flag = 1 if $ch ne '';

my $sticky = "\'\'";
$sticky = "\'$m_a:\',STICKY" if $if_sticky;

if ($flag) {

if ($new_tips) {
	my $addon = $touch_specific_bro ? '' : "class=\"tipz\"";
	$html = "><img onclick=\"this.style.display='none';\" src=\"/icon/view_text.png\" $addon title=\"COMMENTS\" align=middle border=0 alt=\"\" width=16 height=16></a>";

} else {
	$html = " onmouseover=\"return overlib('COMMENTS',CAPTION,$sticky, HAUTO,BELOW)\"  onmouseout=\"nd();\" >
	<img src=\"/icon/view_text.png\" align=middle border=0 alt=\"\" width=16 height=16></a>";
};

$html = "<a href=javascript:$if_real_func".$html;

$html =~ s/COMMENTS/$chunk/g;

} else {
$html = "<img src=\"/icon/view_text.png\" align=middle border=0 alt=\"\" width=16 height=16>";
}

unless ($fifthparm) {
	print $html;
} else {
	return $html;
}

}

sub masterst_parsed { #254

my $masterst = shift;
my $sp = shift;
my $cs = defined($sp) ? $sp.'_' : $curr_sport.'_';
     if ($masterst =~ /$cs(.+?)#/ || $masterst =~ /$cs(.+)$/) {$masterst = $1;} else {$masterst = '';}
     $masterst = $masterst_labels{$masterst};
return $masterst;
}

sub nkname_lookup { #66

my $code = shift;
my $reverse = shift || 0;

#normal xter, no users
return $code if ($develop == 12 && !$not_so_free_media);

	my $comm = "select a_nkname from members where proj_code = '$code'";
	$comm = "select proj_code from members where a_nkname = '$code'" if ($reverse);

#print STDERR "Here comm is $comm!\n";

	my $result=$dbconn->prepare($comm);
    	$result->execute;
	&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
	my $lr1 = $result->fetchall_arrayref;
	my $ntuples = $result->rows();

	if ($ntuples) {

		my $piece = ${${$lr1}[0]}[0];
		$piece =~ s/"//g;
		
		return $piece;
	} else {
		return $code;
	}

}

sub oid_lookup { #65

local ($code) = shift;
local ($par) = shift;

my $comm = "select proj_code from members where ID = '$code'";
$comm = "select ID from members where proj_code = '$code'" if ($par);

my $result=$dbconn->prepare($comm);
$result->execute;
&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
my $l = $result->fetchall_arrayref;
return ${${$l}[0]}[0];

}

sub find_weekday { #144

my $td = shift;
my $par = shift;

$td =~ /^(\d+)-(\d+)-(\d+)/;
my $y = $1;
my $m = $2;
my $d = $3;

my $wd = Day_of_Week($y, $m, $d);
$wd = 0 if ($wd eq '7');

@weekday_abbr = ("Sun","Mon","Tue","Wed","Thu","Fri","Sat") unless ($language eq "russian");
@weekday_abbr = (koitoutf8("��"),koitoutf8("��"),koitoutf8("��"),koitoutf8("��"),koitoutf8("��"),koitoutf8("��"),koitoutf8("��")) if ($language eq "russian");

return $par  ? $weekday_abbr[$wd] : $weekday[$wd];
}

sub swap_date { #260

my $dtm = shift;
my $with_yr = shift;

$dtm =~ /\d\d(\d\d)-(\d\d)-(\d\d)\s(\d\d:\d\d):\d\d/;
return $2."/".$3."<br><b>".$4."</b>&nbsp;MSK" unless ($with_yr);
return $3."/".$2."/".$1 if ($with_yr);

return $dtm;
}

sub chunk_idiots { #199

my $ch = shift;

my @l = split(' ',$ch);
my $r = '';

my $ll = 12;
$ll = 23 if ($utf);

foreach my $line (@l) {

	if (length($line) > $ll) {
		my $c = substr($line,0,$ll);
		my $p = substr($line,$ll);
	}
$r .= $line." "
}
chop $r;
$r =~ s/\./\. /g;
$r =~ s/\,/\, /g;
$r =~ s/\(/ \(/g;
$r =~ s/\)/\) /g;
$r =~ s/\)/\) /g;
$r =~ s/\//\/ /g;
$r =~ s/\-/\- /g;

return $r;
}

sub print_styled_ajax_box { #234

my $aa = shift;
my $ty = shift;

my $closer = $ty ? "jQuery('#ajax_$aa').fadeOut('slow')" : "document.getElementById('ajax_$aa').fade(0)";

if ($new_style_boxes) {

print qq{
<div class="semi_pop semi_pop_s">
<div id="ajax_$aa" style="position:absolute;top:120px;left:480px;display:none;font-size:12px;line-height:24px;font-family:Helvetica;
width:480px;height:300px;background:transparent;color:#4a536d;z-index:1000;">
<div class="semi_header">
	<div class="semi_left"> </div>
	<div class="semi_middle"> </div>
	<div class="semi_right"> </div>
</div>
<div class="semi_body">
<div class="semi_left"> </div>
<div class="semi_content">
<div id="inwrapper_$aa" style="height:284px;background:transparent;">
		
	<div class=log_ajax id="container_log_ajax_$aa" style="display:none;">
		<div class=log_action id="_ajax_$aa" style="line-height:24px;font-size:12px;font-style:italic;"><!-- spanner --></div>	
	</div>
</div>
};
print "</div>";
print qq{
<div class="semi_right"> </div>
</div>
<div class="semi_footer">
	<div class="semi_left"> </div>
	<div class="semi_middle"> </div>
	<div class="semi_right"> </div>
</div>
<div id="ttlbar_$aa" class="semi_titlebar" onmousedown="dragStart(event, 'ajax_$aa')" style="margin-left:17px;width:446px; cursor: move; -moz-user-select: none; display: block;background:$wrapper_colors[$wallpaper_ind];">
	<div class="semi_title" style="width:410px;text-align:center;"><div style="padding:2px;font-weight:bold;font-family:Tahoma;color:#fefafe;line-height:16px;margin-left:auto;font-size:16px;">Control Panel</div></div>
</div>
<div class="semi_close" style="cursor:default;">
<a href="#">
<span class="semi_closetext"></span>
<span class="semi_closebutton" onclick="$closer;return false;">
	<span>Close</span>
</span>
</a>
</div>
</div>
</div>

};
} else {
print qq{	
<div id="ajax_$aa" style="position:absolute;top:120px;left:480px;display:none;font-size:12px;line-height:24px;font-family:Helvetica;
width:480px;height:360px;background-color:#e0e0e0;border-style:solid; border-color:#4a536d;border-width:2px;color:#4a536d;z-index:1000;">
   <div id="inwrapper_$aa" style="margin:8px;height:344px;background:#eee;">
	<div style="position:absolute;left:400px;top:0px;display:inline;font-size:10px;line-height:30px;margin:10px 20px 0 0;z-index:1000;" onclick="$closer">[$t_e]</div>

	<div class=log_ajax id="container_log_ajax_$aa" style="display:none;">
		<div class=log_action id="_ajax_$aa" style="line-height:24px;font-size:12px;font-style:italic;"><!-- spanner --></div>	
	</div>
   </div>
</div>
};

}
}

sub begin_decor { #43

my $par = shift;

print qq{</head>
<body style="background:$wrapper_colors[$wallpaper_ind];padding-top:20%;" LINK="#000080" VLINK="#6060C0" TEXT="#222222">};


if ($par) { 

print qq{<div style="float:left;margin:25px 2px;font-weight:bold;font-family:Tahoma;color:#fff;font-size:36px;"><font color=#f0f0f0>$sport_labels{$curr_sport}</font></div>
<div style="float:left;margin:25px 2px;font-weight:bold;font-family:Tahoma;color:#fff;font-size:36px;"><font color=#f0f0f0>$loco_list{$ru_en}</font></div>
} unless ($develop || $touch_specific_bro);

unless ($is_admin) {
print qq{<div style="float:left;margin-left:12px;margin-top:5px;padding:5px;background:#f0f0f0;">};
#&print_goo_ban4;
print "</div>";

}

print qq{
<span style="font-size:24px;text-align:center;color:#ffa;font-family:Tahoma;font-weight:bold;margin-left:5px;"><a style="color:#ccc;" href=/>$copyright_str</a></span>
} if (0);

print qq{<div style="clear:left;"></div>};
}

print qq {<div style="margin:5px 24px;padding:20px;background:#fff;border-radius:12px;text-align:center;">};

}

sub end_decor { #44

print q{</div>
<!-- center><small>Copyright Motivation, 2006-2019. All Rights Reserved.</small></center -->
};

}

sub email_html_format { #255

my $first = shift;
my $second = shift;
my $rec_oid = shift;
my $proj = shift;
my $cc = shift;
my $ow = shift;

my $w = (defined($proj) && $proj != 0) ? '96px' : '10px';

if ($rec_oid > 0) { #find out the sport of the given challenges
	$comm = "select sport from challenges where ID = $rec_oid";
	&getTable;
	$curr_sport = ( ${${$listresult}[0]}[0] > 0 ) ? ${${$listresult}[0]}[0] : $curr_sport;
}

my $email_message_new = 
"<div style=\"width:640px;background:#ddd;\">
<table style=\"margin:20px auto;BORDER-BOTTOM:#dfdfdf 1px solid;BORDER-LEFT:#dfdfdf 1px solid;PADDING-BOTTOM:20px;BORDER-TOP:#dfdfdf 1px solid;BORDER-RIGHT:#dfdfdf 1px solid;\" bgcolor=\"#ffffff\" cellpadding=\"10\" cellspacing=\"0\" width=\"500\">
<tbody>
<tr>
<td colspan=2><!-- img src=\"some.jpg\" width=\"478\" --></td>
</tr>
<tr>
<td>
<div align=\"left\">
<strong>
<span style=\"FONT-FAMILY:Verdana, Geneva, sans-serif;COLOR:#666;FONT-SIZE:20px;\">$first</span>
</strong>
</div>
</td>
<td rowspan=2>
<div style=\"margin-left:30px;width:$w;\" align=\"left\">
";

if (defined($proj) && $proj eq $r_user) {
	$comm = "select uploaded_file from members where proj_code = '$r_user'";
	&getTable;
	 my $rasterfile = ${${$listresult}[0]}[0]; my $chip = '';
	 my $nff = $rasterfile =~ /\.([a-zA-Z]+)\_([a-z]+)(\d*)$/ ? 1 : 0;
	 
	unless ($nff) {	
		$chip = substr(TClubMD5::md5_hex($rasterfile),0,4);
	} else {
		$chip = substr(TClubMD5::md5_hex($rasterfile),0,8);
	};
 
	my $oids = $chip."_small" if ($rasterfile ne 'none' && $rasterfile ne ''); 	 
	my $fs = "$tmp_doc/db_images/".$chip."_small.jpg";
	
	my $if_gold = "<div style=\"text-align:center;line-height:14px;font-size:10px;font-weight:bold;font-family:Verdana;background:transparent;color:#369;opacity:0.65;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=65);\">TClub Motivation</div>";
	my $d = "<div style=\"margin-left:0px;\"><img src=\"$url_prefix/db_images/$oids.jpg\"></div>$if_gold";
	 if (-f $fs  && -s $fs) {
		$email_message_new .= $d;
	} else {
		$email_message_new .= $if_gold;
	}

} elsif (defined($proj) && $proj != 0) {

	$comm = "select uploaded_file from challenges where raster = '$proj'";
	&getTable;
	 my $rasterfile = ${${$listresult}[0]}[0]; my $chip = '';
	 my $nff = $rasterfile =~ /\.([a-zA-Z]+)\_([a-z]+)(\d*)$/ ? 1 : 0;
	 
	unless ($nff) {	
		$chip = substr(TClubMD5::md5_hex($rasterfile),0,4);
	} else {
		$chip = substr(TClubMD5::md5_hex($rasterfile),0,8);
	};
 
	my $oids = $chip."_small" if ($rasterfile ne 'none' && $rasterfile ne ''); 	 
	my $fs = "$tmp_doc/db_images/".$chip."_small.jpg";
	
	my $d = "<div><img src=\"$url_prefix/db_images/$oids.jpg\" width=96></div>";

	$email_message_new .= $d;

}

my $sport_addon = '';
$sport_addon = "<p><span style=\"margin-left:10px;\"><img src=\"http://tennismatchmachine.com/img/eye.png\"></span><span style=\"COLOR:#999900;font-size:16px;font-family:Tahoma;font-weight:bold;margin:10px;\">$q_q $y_h_24 $at 
<a target=\"_blank\" href=\"$url_prefix/cgi/$ru_en/$scriptname?cat=$curr_sport&simple=1\">$sport_labels{$curr_sport}</a></span>";

$ow = substr(TClubMD5::md5_hex($ow),4,6);

my $vendor_addon = ($curr_sport) ? '' : "&vendor=$ow";

my $rg=0;

my $lab = $sport_labels{$curr_sport};

$email_message_new .= "</div>
</td>
</tr>
<tr>
<td>
<div>
<span style=\"FONT-FAMILY:Verdana, Geneva, sans-serif;COLOR:#666;FONT-SIZE:14px;\">
<span style=\"color:#222;\">$second</span><br>
</div>
<div>$sport_addon</div>
</td>
</tr>
<tr>
<td colspan=2></td>
</tr>
<tr>
<td colspan=2>
<div align=\"left\">
<span style=\"FONT-FAMILY:Verdana, Geneva, sans-serif;COLOR:#666;FONT-SIZE:11px;\">$email_footer 
<a style=\"COLOR:#999900;\" target=\"_blank\" href=\"$url_prefix/cgi/$ru_en/$scriptname?mode=demo\">$copyright_str</a>.</span>
</div>
</td>
</tr>
</tbody>
</table>
</div>";

return $email_message_new;
}

sub check_email_address { #227

my $e = shift;

return $e if ($e =~ /^(\w|\-|\_|\.)+\@((\w|\-|\_)+\.)+[a-zA-Z]{2,}$/ || $e =~ /xn--p1ai/);
return 0;
}


sub add_remove_to_from_list { #162

my $guy = shift;
my $str = shift;
my $par = shift;

my @list = split('#',$str);
if ($par) {
@list = sort($guy,@list);
} else {
@list = &xDel($guy,sort(@list));
}
my $ret = '';

foreach my $line (@list) {
	$ret .= $line."#"
}
chop($ret);
return $ret;
}


########################################## code from dbengine.cgi
####################################################################
# <c> 1999 Ingo Ciechowski
# see closer information at http://www.cis-computer.com/dbengine
#
# thanx to contributions of
# Jaime Cervera Bravo       <jcervera@aq.upm.es>
# John Goerzen              <jgoerzen@complete.org>
# Werner Modenbach          <modenbach@alc.de>
# Rudolf Lippan             <rlippan@elastic.com>

sub getFieldTypes { #8

	
	if (%fielddisporder) { return; }
	


	$comm  = "SELECT a.attname, t.typname, a.attlen, a.atttypmod FROM pg_class c, pg_attribute a, pg_type t  WHERE c.relname = \'$table\'";
	$comm .= " and a.attnum > 0 and a.attrelid = c.oid and a.atttypid = t.oid";
	my $fieldresult=$dbconn->prepare($comm);
	$fieldresult->execute;



    while(my @array = $fieldresult->fetchrow_array()) {
        $fieldtype{$array[0]}   = $array[1];  #rl 
        $fieldlength{$array[0]} = $array[2];  #rl
        $fieldlength{$array[0]} = $array[3]-4 if($fieldtype{$array[0]} eq "bpchar") ;
	}
    &dBaseError($fieldresult, "  (".$fieldresult->rows()." rows found)") if($fieldresult->rows() == 0);
	
}

sub checkFieldContent { #5

    my ($content, $name) = @_;
    if($fieldeval{$name}) {

        @_          = $content;
        print "$name = " . $name . "\n<BR>" if $debug;
        print '"' . $_[0] . '"' . "\n<BR>" if $debug;
        $content    = eval ($fieldeval{$name});
        print "$content = " . $content . "\n" . "<BR>" if $debug;

        unless(defined($content)) {
            print "<H4><FONT COLOR=BLACK><P>Error in field $name:<BR>$@</FONT></H4>";
            die("Error in field: $name:$@ ");
        }
    }
    $content;
}

sub isReservedWord { #14

	my $name = shift;
	my @reserved = ("dbase", "table", "oid", "search", "fields", "mode", "xmin",
	"inach", "ncurr", "vstav", "dtm_time","dtm_date","alternate_table", "reg_passwd", "kuku");
	if(grep /$name/, @reserved) {
		return 1;
	} else {
		return undef;
	}
}

sub local2SQLformat { #15

    my ($var, $field) = @_;
    $var = checkit($var);#yeah, paranoid
    
    
    if($fieldtype{$field} eq "bool") {
        return NULL unless $var;
    } elsif($fieldtype{$field} =~ /float/ || $fieldtype{$field} eq "DECIMAL" || $fieldtype{$field} eq "FLOAT" || $fieldtype{$field} eq "NUMBER") {
        $var =~ s/\,/\./g;
        $var  = "0.0" unless $var;
        $var .= ".0" unless $var =~ /\./;
    } elsif($fieldtype{$field} eq "date" || $fieldtype{$field} eq "time" || $fieldtype{$field} eq "DATE") {
        $var=$dbconn->quote($var);
        return NULL unless $var;
    } elsif($fieldtype{$field} eq "int4" || $fieldtype{$field} eq "INTEGER" || $fieldtype{$field} =~ /LONG/) {
        return NULL unless defined $var;
        return $var if $mode eq "search";
    }	
	
	$var=$dbconn->quote($var);

    return $var;
}

sub checkit { #240

my $str = shift;
$str =~ s/\'//g;
#$str =~ s/\'/\'\'/g;

return $str;
}

sub tclub_doAddRecord { #2


    my ($query, $out) = @_;
    &getFieldTypes($table);

    my $cmd_vals     = "VALUES  ( ";
    my $cmd_fields   = "( ";
    my $owner;
    my $n_ext; my $nname_base;my $nname;my $nname_small;my $raster_oid; my $raster_small_oid;

    
    my $_vals='';my $_sport= 0;
	
	$comm  = "SELECT a.attname, t.typname, a.attlen, a.atttypmod FROM pg_class c, pg_attribute a, pg_type t  WHERE c.relname = \'$table\'";
	$comm .= " and a.attnum > 0 and a.attrelid = c.oid and a.atttypid = t.oid";
	my $fieldresult=$dbconn->prepare($comm);
	$fieldresult->execute;
    
    while(my @row = $fieldresult->fetchrow_array) {
        my $name = $row[0];
        #print $name . "\n<BR>" 
	#if $debug
	#;
my $p = $query->param($name);
print STDERR "Here adding table is $table, name is $name, value is $p!\n" if ($debug);
		
	if ($name eq "proj_code"){
			#$_vals = local2SQLformat(&checkFieldContent($query->param($name), $name), $name);
	}	

        if ($name eq "vremya_z" || $name eq "p_vremya_z" || $name eq "oj_vremya_z" || $name eq "dtm" || $name eq "date_and_time"
	|| $name eq "child_date" || $name eq "regtime" || $name eq "comeback_last_triggered") {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "current_timestamp,";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "name" && $table eq "rooms" ) {

		my $newroomname = substr(TClubMD5::md5_hex(gettimeofday()),0,8);
		$cmd_fields    .= "$name,";
		$cmd_vals      .= "'$newroomname',";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "house" && $table eq "rooms" ) {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "'$mycabo',";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "num_rooms" && $table eq "rooms" ) {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "1,";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "status" && $table eq "rooms" ) {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "0,";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "valid_till" && $table eq "rooms" ) {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "null,";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "room" && $table eq "members" ) {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "'$mycabo',";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "room_master" && $table eq "members" ) {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "false,";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "u_admin" && $table eq "members" ) {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "'',";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "n_date") {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "current_date,";
		$query->param(-name=>$name, -value=>'');

	}
        elsif ($name eq "id") {

		$query->param(-name=>$name, -value=>'');

	} 
	elsif ($name eq "region") {

		$cmd_fields    .= "$name,";
		my $aa = local2SQLformat(&checkFieldContent($query->param($name), $name), $name);
		
		$aa = "\'-1\'" if ($a eq "\'\'");
		
		$cmd_vals      .= $aa . ",";
		
		$query->param(-name=>$name, -value=>'');
       }
       elsif ($name eq "proj_code" && $table eq "members") {
       

		$cmd_fields    .= "$name,";
		my $aa = local2SQLformat(&checkFieldContent($query->param($name), $name), $name);
       		my $bb = defined($query->param('pass')) ? local2SQLformat(&checkFieldContent($query->param('pass'), 'pass'), 'pass') : 'pass';
		$aa =~ s/\'//g; $bb =~ s/\'//g;
		#my $str = "sudo /var/www/html/cp/controls/addUser.pl $aa $bb a\@b.com$uma24";
		#print STDERR "Here $str!\n";
		my $sys_cmd = `sudo /var/www/html/cp/controls/removeUser.pl $aa$uma24` if ( length($aa) && length($bb) ); #or may get creation error in the next; make sure
		$sys_cmd = `sudo /var/www/html/cp/controls/addUser.pl $aa $bb a\@b.com$uma24` if ( length($aa) && length($bb) );
		
		$cmd_vals      .= $aa . ",";
		
		$query->param(-name=>$name, -value=>'');

	}
        elsif ($name eq "vrem_txt" || $name eq "p_vrem_txt" || $name eq "oj_vrem_txt") {

		$cmd_fields    .= "$name,";
		&make_date($gmtimeshift);
		$cmd_vals      .= local2SQLformat("$thisdate\,\ $thistime" ) . ",";
		$query->param(-name=>$name, -value=>'');
	}
        elsif ($name eq "pstats") {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "null,";
		$query->param(-name=>$name, -value=>'');

	} elsif ( ($name eq "status" || $name eq "partner") && ($table eq "challenges" || $table =~ "registration" )) {

		$cmd_fields    .= "$name,";
		if ($name eq "partner" && $table =~ "registration") {
			$cmd_vals      .= "'".decode_local(local2SQLformat(&checkFieldContent($query->param($name), $name), $name))."',";
		} else {
			$cmd_vals      .= "null," 
				unless ($name eq "status" && $table eq "registration" && $real_gold)
			;
			
			#only for open/ladder, not valid for knockout
			$cmd_vals      .= "'f'," 
				if ($name eq "status" && $table eq "registration" && $real_gold)
			;

		}
		$query->param(-name=>$name, -value=>'');		
	
	} elsif ( $name eq "owner" && $table eq "challenges" ){

		my $r = $r_user; 

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "'".$r."',";
		
		
		if ($name eq "owner"){
			$owner = &nkname_lookup($r_user);
		}
		
		$query->param(-name=>$name, -value=>'');
		
		
	} elsif ($name eq "date_and_time" && $table eq "challenges") {

		$cmd_fields    .= "$name,";

		&make_date($gmtimeshift);
		
		if ($query->param(-name=>'dtm_date') ne '') {
			$thisdate = $query->param(-name=>'dtm_date');
			$thistime = $query->param(-name=>'dtm_time');
		}
		
		$time_of_match = $thisdate.", ".$thistime;
		$time_of_match = find_weekday($thisdate,0).", ".$time_of_match;

		$cmd_vals      .= local2SQLformat("$thisdate\,\ $thistime" ) . ",";
		
		$query->param(-name=>$name, -value=>'');
	
	} elsif ($name eq "time_of_selection" && $table eq "challenges") {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= "null,";
		$query->param(-name=>$name, -value=>'');

	} elsif ($name eq "key") {

		my $chid = gettimeofday();
		$cmd_fields    .= "$name,";
		my $c = $node_number*10000000000000000 + $chid*1000000;
		$cmd_vals      .= "$c,";
		$query->param(-name=>$name, -value=>'');
	
	} elsif ($name eq "challenge_id" && $table eq "challenges") {

		$cmd_fields    .= "$name,";
		my $v = $query->param(-name=>'challenge_id');
		$cmd_vals      .= "'$v',";
		#$query->param(-name=>$name, -value=>'');
	
	} elsif ($name eq "viewname") {
            	$cmd_fields    .= "$name,";
		$cmd_vals  .=  
	    	"'". $table . "',";
	
	} elsif ($name eq "date_accepted") {
            	$cmd_fields    .= "$name,";
		$cmd_vals  .=  
	    	"current_date,";
	
	} elsif ($name eq "sport") {
            	$cmd_fields    .= "$name,";
		
		unless ($table eq "forum" ) {
			$cmd_vals  .=  $curr_sport.",";
		} else {
			$cmd_vals  .=  "0,"; #hack ash
		}
		
		$_sport = $curr_sport;
	
	} elsif ($name eq "reply_to_num" && $table eq "forum" ) {

		$cmd_fields    .= "$name,";
		$cmd_vals      .= local2SQLformat(&checkFieldContent($query->param($name), $name), $name) . ",";
		if ($query->param($name) ne '' && $query->param($name) ne "reply_to_num")
		{
			my $cmd = "update $table set is_replied='t' where ID = ".$query->param($name);
			my $result = $dbconn->do("$cmd");
			&dBaseError($dbconn, $cmd) if(!defined($result));
		}		
		$query->param(-name=>$name, -value=>'');
	
	} elsif ($name eq "z_destination" && $table eq "forum" ) {

		$cmd_fields    .= "$name,";
		
		if ($query->param($name) =~ /^\d+$/) {
			unless ($query->param($name) eq '0') {
				$cmd_vals      .= local2SQLformat(&checkFieldContent(&oid_lookup($query->param($name)), $name), $name) . ",";
			} else {
				$cmd_vals      .= local2SQLformat(&checkFieldContent("admin,$r_user", $name), $name) . ",";
			}
		} else {
			$cmd_vals      .= local2SQLformat(&checkFieldContent($query->param($name), $name), $name) . ",";
		}
		$query->param(-name=>$name, -value=>'');

	} elsif (($fieldtype{$name} ne "date" && $fieldtype{$name} ne "timestamp") || (&checkFieldContent($query->param($name), $name) ne '')) {
		
		if ($name ne "uploaded_file" && $fieldtype{$name} ne "oid") {
		$cmd_fields    .= "$name,";
		$cmd_vals      .= local2SQLformat(&checkFieldContent($query->param($name), $name), $name) . ",";
		
		$place_of_match = decode_local(&checkFieldContent($query->param($name), $name) ) 
			if ($name eq "place");
		$condition_of_match = decode_local(&checkFieldContent($query->param($name), $name) )
			if ($name eq "condition");

		$query->param(-name=>$name, -value=>'');
	        }
        }
			
		
        print $query->param($name) . "\n<BR>" if $debug;
             
        print @row if $debug;
    }
	
    chop($cmd_vals);
    chop($cmd_fields);
    
    $cmd_vals =~ s/\\047//g; #magic stuff we dont remove
    $cmd_vals =~ s/\\\//\//g;

    my $cmd  = "INSERT INTO $table $cmd_fields ) $cmd_vals )";
    
    print STDERR "Here inserting ". $cmd."\n<BR>" if $debug;
    
    
$result = $dbconn->do("$cmd");


if(!defined($result)) {
    &dBaseError($dbconn, $cmd);
}


	if ($table eq "members" && ($_vals ne '') && 0) {
	
		$_vals =~ s/\'//g;
		my $mmes = "";

		my $ssubj = "new $logo_name $ru_en user $_vals sport $_sport";

		&send_notification ($eemail, $mmes, $ssubj) if ($use_server);
		$ssubj = utf2koi($ssubj) if ($utf);
		&write_log_notification($ssubj,'12');
		&write_event('members','a');
	}

}

sub tclub_doUpdateRecord { #1

    my ($query, $out) = @_;
    &getFieldTypes($table);
    my $setclause = "set ";
    my $addclause = '';
    foreach my $name ($query->param) {

	
        unless(&isReservedWord($name) || ($table eq "matches" && $name eq "round" && $query->param('round') eq '')
	|| ($table eq "challenges" && $name eq "time_of_selection")
	|| ($table eq "members" && $name eq "newpass")
	|| (($fieldtype{$name} eq "date" || $fieldtype{$name} eq "timestamp") && &checkFieldContent($query->param($name), $name) eq '')) 
	{
            $setclause  .=  "$name = " . &local2SQLformat(&checkFieldContent($query->param($name), $name), $name) . ", ";
        }
	
	
	if (!&isReservedWord($name) && (($fieldtype{$name} eq "timestamp" || $fieldtype{$name} eq "date" ) && 
	&checkFieldContent($query->param($name), $name) eq '')) 
	{
            $setclause  .=  "$name = null, ";
        }


	if ($name eq "a_nkname" && $table eq "members") {

		
		my $ankname = local2SQLformat(&checkFieldContent($query->param($name), $name), $name);
		my $pc = defined($query->param('proj_code')) ? $query->param('proj_code') : '';
		my $newpass = defined($query->param('newpass')) ? $query->param('newpass') : '';
		$pc =~ s/\'//g; $newpass =~ s/\'//g;
		
		my $w1 = koitoutf8("����� ������");
print STDERR "Here pc is $pc , newpass is $newpass!\n";		
		if (length($pc) && length($newpass) && $newpass ne $w1 ) {
			my $sys_cmd = `sudo /var/www/html/cp/controls/removeUser.pl $pc$uma24`;
			$sys_cmd = `sudo /var/www/html/cp/controls/addUser.pl $pc $newpass a\@b.com$uma24`;			
		}
		
		#$setclause  .=  "a_nkname = '$ankname', ";
		$query->param(-name=>$name, -value=>'');

	}

		
	if ($name eq "time_of_selection" && $table eq "challenges") {


            	$setclause  .=  "time_of_selection = current_timestamp, ";
		$query->param(-name=>$name, -value=>'');


        } elsif ($name eq "dtm_time" && $table eq "challenges") {


		$thisdate = $query->param(-name=>'dtm_date');
		$thistime = $query->param(-name=>'dtm_time');

            	$setclause  .=  
	    	"date_and_time = " . local2SQLformat("$thisdate\,\ $thistime" ) .
	    	", " if ($thisdate && $thistime);
		$query->param(-name=>$name, -value=>'');
        }

    }
 	
    chop($setclause); chop($setclause);
    $setclause .= $addclause; 


$setclause =~ s/\\047//g; #magic stuff we don't remove
  
    my $cmd    = "UPDATE $table $setclause WHERE $uniqOID = $oid";
    #print STDERR $cmd if $debug;

if ( ($current_status ne 'new' && $current_status ne 'crap') || $table eq 'members') {

#print STDERR "Here cmd is $cmd!\n";
    
    $result = $dbconn->do("$cmd");

} else {$result = 1;}
    

if(!defined($result)) {
    &dBaseError($dbconn, $cmd);
}
    
}

sub print_edit_profile {


	$comm = "select ID, b_rlname, h_phone, g_email from members where proj_code = '$r_user'";
	&getTable;

	my $o = ${${$listresult}[0]}[0];
	my $bname = ${${$listresult}[0]}[1];
	my $ph = ${${$listresult}[0]}[2];
	my $em = ${${$listresult}[0]}[3];
	
	my $s1 = koitoutf8("���� ��� � ��������");my $s2 = koitoutf8("��� �������");my $s3 = koitoutf8("��� email");
	$bname = length($bname) ? $bname : $s1;
	$ph = length($ph) ? $ph : $s2;
	$em = length($em) ? $em : $s3;
	
	my $ont1 = $bname eq $s1 ? " onmousedown=\"this.value='';\"" : '';
	my $ont2 = $ph eq $s2 ? " onmousedown=\"this.value='';\"" : '';
	my $ont3 = $em eq $s3 ? " onmousedown=\"this.value='';\"" : '';	
	
	my $wdth = "80%"; 
	my $umrgn = "60px";

	print qq{<div id=main_container style="margin:$umrgn auto; border:solid 0px #963;width:$wdth;text-align:center;font-size:16px;">
	};
      

	print qq{<FORM METHOD=POST ACTION=$scriptURL ENCTYPE='application/x-www-form-urlencoded'>
		<input type=hidden name=oid value='$o'>};



	print qq{
	<div id=tinput style="width:30%;height:48px;position:relative;margin:10px auto;background:transparent;min-width:360px;">
	<INPUT id=b_rlname_id NAME="b_rlname" value="$bname" type=text style="position:absolute;top:0px;left:0px;width:100%;height:36px;padding:5px;background:#f0f0f0;color:#222;font-size:24px;"$ont1>
	</div>
	};
	
	print qq{
	<div id=tinput1 style="width:30%;height:48px;position:relative;margin:10px auto;background:transparent;min-width:360px;">
	<INPUT id=phone_id NAME="h_phone" value="$ph" type=text style="position:absolute;top:0px;left:0px;width:100%;height:36px;padding:5px;background:#f0f0f0;color:#222;font-size:24px;"$ont2>
	</div>
	};

	print qq{
	<div id=tinput2 style="width:30%;height:48px;position:relative;margin:10px auto;background:transparent;min-width:360px;">
	<INPUT id=email_id NAME="g_email" value="$em" type=text style="position:absolute;top:0px;left:0px;width:100%;height:36px;padding:5px;background:#f0f0f0;color:#222;font-size:24px;"$ont3>
	</div>
	};


	my $save = koitoutf8("���������");
		
	print "<button type=\"submit\" name=\"mode\" value=\"update_member\" style=\"width:220px;height:40px;margin:10px auto;\">$save</button><br><br>";
		#print  "<input type=reset value=\"Reset\"><br><br>";
	print  "<INPUT style=\"width:220px;margin:0px auto;\" TYPE=button onClick=history.go(-1) VALUE=$__3h>";
	print "</form>";


	print "</div>"; #main_container edit_member

}

sub print_tags { #292

my $o = shift || 0;
my $type = shift || 0;
my $categ = shift || 0;

my $mymode = $type eq '5' ? "stockmybuys_panel" : "stocksells_panel";
		
		#create table tags (tag text, match_oid oid, category int2 default 0) with oids;
		#alter table tags add column category int2 default 0;
		
		$comm = "select tag from tags where match_oid = $o and category = $categ order by ID asc";
		my $sth = $dbconn->prepare($comm);
		$sth->execute;
		my $tags = $sth->fetchall_arrayref;
		my $ntags = $sth->rows();
				
		for (my $j = 0; $j < $ntags; $j++) {
			my $tag = ${${$tags}[$j]}[0];
			my $x = "<span style=\"cursor:pointer;\" onclick=\"var yon = window.confirm('$hide_chal_warn');if (yon) {ajax_get_tags($o,'$tag',1,$type,$categ);}\">[x]</span> ";
			$x = '' if (($j == 0 && $tag =~ /(\d\d\d\d-\d\d-\d\d)/) || $type ne '5' );

			print qq{	
				<a href="javascript: function open_tag_link() {tag='$tag';tagtable=0;from_interact=1;r(current_sport,num_open_cha,num_order,$type,tag,0);\$('myForm_list_challenges').send();}open_tag_link();" class="tag">#$tag</a>$x
			};

		}
		
}

sub print_help_forum {

my $inach = defined( $query->param('inach') ) ? $query->param('inach') : 0;
my $renum = defined( $query->param('forum_renum') ) ? $query->param('forum_renum') : 0;

my $wi = $touch_specific_bro ? "100%" : "60%";
my $hi = $touch_specific_bro ? "480px" : "480px";

print qq{
        <div class="container" style="margin-top:5%;text-align:center;width:100%;height:90%;vertical-align:middle;overflow:auto;">
            <div style="text-align:center;width:100%;height:100%;overflow:auto;">
                <div id=help_forum_container style="overflow:auto;text-align:center;padding-top:0px;margin:0px auto;width:$wi;height:$hi;border:0px #333 solid;background:#def;border-radius:90px;opacity:0.8;">
};
&listForum($inach,$renum);
print qq{
                </div>
	    </div>
	 </div>
};
print qq{
<script language="JavaScript" type="text/javascript" src="/js_cp/bubbles.js"></script>
} unless ($touch_specific_bro || 1);

}

sub print_forum_cycle { #90

my $filter = $_[0];
my $requested_null_counter = $_[1];
my $if_forum_new = $_[2];
my $inach = $_[3];
my $fl = $_[4];

my $iposl = $inach + $n_forum;

my $order = "asc";
$order = "desc" if ( $filter eq "reply_to_num");
$mode_of_order =  "vremya_z";
$mode_of_order =  "child_date desc, vremya_z" if ($fl);
$num_o_c{'reply_to_num'} = 0;

$lil{$filter} = "<img src=/icon/news.gif>";
$lil{$filter} = "<li>" if ( $filter ne 'reply_to_num');


    if ($filter eq "reply_to_num"){
    	$search = "select ID, author, vrem_txt, a_topic, contents, is_replied, who_read, url_picture,
    	z_destination from forum where reply_to_num = 'reply_to_num' order by $mode_of_order desc";
    
    } else {
    	$search = "select ID, author, vrem_txt, a_topic, contents, is_replied, who_read, url_picture,
    	z_destination from forum where reply_to_num = '$filter' order by vremya_z $order";
    }

#print STDERR "Here search is $search!\n";

    $listResult=$dbconn->prepare($search);

    $listResult->execute; 
    &dBaseError($listResult, $search."  (".$listResult->rows()." rows found)") if($listResult->rows() == -2);

    $listResult_data{$filter}=$listResult->fetchall_arrayref;
    $ntuples{$filter}=$listResult->rows;

my $i_first = 0;
my $i_last = $ntuples{$filter};

if ( $filter eq "reply_to_num") {
	$i_first = $inach;
	$i_last = $iposl;
	$i_last = $ntuples{$filter} if ($iposl > $ntuples{$filter});
}

for (my $i=$i_first;$i<$i_last; $i++) {

my $oid = ${${$listResult_data{$filter}}[$i]}[0];
my $who_really = ${${$listResult_data{$filter}}[$i]}[1];
my $who = &nkname_lookup($who_really);
my $when = ${${$listResult_data{$filter}}[$i]}[2];
my $what_about = ${${$listResult_data{$filter}}[$i]}[3];
my $what_length = length(${${$listResult_data{$filter}}[$i]}[4]);
my $is_replied = ${${$listResult_data{$filter}}[$i]}[5];
my $who_read = ${${$listResult_data{$filter}}[$i]}[6];
my $url_picture; $url_picture = $imgimage if (${${$listResult_data{$filter}}[$i]}[7] =~ /http:\/\/(\w+)/) ;
my $destination = ${${$listResult_data{$filter}}[$i]}[8];

my (@privat) = split(",",$destination);

my $common = ($destination eq '' || $destination eq "z_destination") ? 1 : 0;

@privat = ($r_user,@privat) if ($destination eq "z_destination");#hackit

my $div_rm_mark = "<img id=marker_".$oid." src=/icon/emblem-noread.png width=8 onclick=\"var yon = window.confirm('OMG! Really delete?!');if (yon) {rm_record(".$oid.",'forum')};\">";
$div_rm_mark = '' unless ($is_admin);


unless ($who_read =~ /^$r_user,/ || $who_read =~ /,$r_user,/) {
	$lb = "<b>";
	$rb = "</b>";
} else {
	$lb = '';
	$rb = '';
}

if ($requested_null_counter) {
	unless ($who_read =~ /^$r_user,/ || $who_read =~ /,$r_user,/ 
	|| (length($destination) && $r_user ne $destination && !in_array($r_user,@privat))) {
		$who_read .= $r_user.",";
		my $cmd = "update forum set who_read='$who_read' where ID=$oid";
		my $result=$dbconn->prepare($cmd);
		$result->execute;
	}
	$lb = '';
	$rb = '';
}

my $changing = &rad_grad('#E1ECDD','#fff');
$changing = &rad_grad('#def','#fff') if ((int($i/2))*2 < $i);

${${$listResult_data{$filter}}[$i]}[3] =~ s/ //g;
$what_about = $o_c if (${${$listResult_data{$filter}}[$i]}[3] eq '');

$ull{$filter} = "<ul>";
$ull{$filter} = ""  if (($num_o_c{$filter} < $max_of_cycles) || 
(($num_o_c{$filter} == $max_of_cycles) && $i) || $filter eq "reply_to_num");

my $rev_i = $ntuples{$filter} - $i + $n_archived_messages;

if ($common || (!$common && ($r_user eq $destination || in_array($r_user,@privat) || $r_user eq $who_really)) ) { #seen or not

$num_new_messages++ if ($lb eq "<b>");

my $yellow = &rad_grad('#f4f114','#fff');

$changing = $yellow if (!$common);
$changing = &rad_grad('#ff9b9b','#fff') if ($changing eq $yellow && $what_about eq $email_h13);

$changing = "transparent"; #hack ash

$what_about = $o_a if ($what_about eq $email_h13);

if ( $filter eq "reply_to_num") {
	my $fix = "<span style=\"font-size:14px;\">No.".$rev_i."</span>";
	print "<table style=\"margin:3px 7px;\"><tr style=\"background:$changing;\">";
	print "<td name=tcontrol1 id=tcontrol1 style=\"width:2%;\"><b><small><small>$fix</small></small></b>&nbsp;</td>" unless ($fl);
	print "<td><div style=\"text-align:left;font-size:14px;\">";
}

if ( ($filter eq "reply_to_num") && ($r_user eq $who_really) && ($changing eq $yellow)) {

	my $rdest; my @l = split(',',$destination);

	foreach my $li (@l) {
		$rdest .= &nkname_lookup($li) . ', ';
	}
	
	chop $rdest;chop $rdest; $rdest .= "&nbsp;";

	$who = "-<b>&gt;&gt;".$rdest."</b>";
} else {
	$who = "--<b>".$who."</b>";
}

my $hoid = &oid_lookup($who_really,1);
$who = "<span onclick=\"js_show_profile($hoid);\" onmouseover=\"this.style.color='#bbb';\" onmouseout=\"this.style.color='#000';\">".$who."</span>" 
	unless ($downgraded);

my @how_list = ('������','����� �������� ����','����������, ����� ���������','����� � ������','�������',
'������� ��� ������!','�������� �� ����������','������ ������ �������','���� ��������');

my $how = ''; my $kak=2;
my $result_of_toss = get_random(0);

for (my $j = 9; $j > 0; $j--) {
	if ( (int($result_of_toss/$j))*$j == $result_of_toss) {
		$kak = $j-1;$j=0;
	} 
}

$how = "&nbsp;<i>(".koitoutf8($how_list[$kak]).")</i>" if ($who_really eq 'verybadguy');
$who .= $how;

my $lngh = 45;
$lngh = 77 if $utf;

my $what_about_ubtruncated = $what_about;

if (length($what_about) > $lngh)
{
	$what_about = substr($what_about,0,$lngh);
	$what_about = substr($what_about,0,rindex ($what_about,' ')).'..';
}


my $chg = 
#($changing eq $yellow && $filter ne 'reply_to_num') ? $changing : \
"transparent";


if (!$if_forum_new) {
	print $ull{$filter}.$lil{$filter}."<span style=\"font-size:14px;background:$chg;\"><a href=javascript:window.reply_message(".$oid.")>"
	.$lb.$what_about.$rb."</a>&nbsp;".$who."&nbsp;<i>".$when.", "
	.$what_length." $o_d</i>&nbsp;</span>$url_picture";
} else {
	print $ull{$filter}.$lil{$filter}."<span style=\"font-size:14px;background:$chg;\">";
	
	my $d = ($mBox) ? "</div>" : '';
	&print_tooltip(${${$listResult_data{$filter}}[$i]}[4],"window.reply_message(".$oid.")", $what_about_ubtruncated);
	
	print $lb.$what_about.$rb."</a>".$d."&nbsp;".$who."&nbsp;<i>".$when.", "
	.$what_length." $o_d</i>&nbsp;</span>$url_picture";
}



print $div_rm_mark if ($is_replied ne '1' && $is_admin);

print "</div>"; #

#print STDERR "Here oid is $oid, is_replied is $is_replied!\n";

if ($is_replied eq '1') {
	my $asearch = "select count(*) from forum where reply_to_num = '$oid'";
	my $alistResult=$dbconn->prepare($asearch);
	$alistResult->execute; 
	my $alistResult_data =$alistResult->fetchall_arrayref;
	my $num_of_replies = ${${$alistResult_data}[0]}[0];
	print "<small>(+$num_of_replies)</small>";


 $num_o_c{$oid} = $num_o_c{$filter} + 1;
 $max_of_cycles = $num_o_c{$oid};

 
 &print_forum_cycle($oid,$requested_null_counter,1);


 $ulr{$filter} = "";
 for (my $j=0; $j < $max_of_cycles - $num_o_c{$filter}; $j++) {
		$ulr{$filter} = $ulr{$filter}."</ul>";
 }
 
 print $ulr{$filter};
}
 
print "<div style=\"clear:left;\"></div>" if ($mBox);
print "</td></tr></table>" if ( $filter eq "reply_to_num");

} else {
}#end if seen or not
} #end for

$max_of_cycles = $num_o_c{$filter};

}

sub print_tooltip { #72

my ($chunk,$if_real_func,$topic) = @_;

if ($mBox) {
	print_tooltip_mBox(@_);return;
}

my $flag = 1 if $chunk ne '';
$chunk = pretty_it($chunk,1);

$html = ">";
$html = "onmouseover=\"return overlib('COMMENTS',CAPTION,'',HAUTO,ABOVE)\"  onmouseout=\"nd();\" >" 
#unless ($touch_specific_bro)
;

if (!$if_real_func) {
	print qq {
	<a href=javascript:void(0) };
	$html .= "<img src=\"/icon/view_text.png\" align=middle border=0 alt=\"\" 
	width=16 height=16></a>";
} else {
	if ($flag) {
		print qq {<a href=javascript:$if_real_func };
		$html .= "";
	} else {
		print qq {<a style="text-decoration:none;color:#222;" href=javascript:$if_real_func >};
		$html = "";

	}
}
$chunk = '+ 1' if ($chunk eq '+1');

	$html =~ s/COMMENTS/$chunk/g;

	print $html;
	print "<br>" unless ($if_real_func);
}

sub print_tooltip_mBox { #74

my ($chunk,$if_real_func,$topic) = @_;

$if_real_func =~ /\((\d+)\)/; my $o = $1;

$chunk = pretty_it($chunk,1);
$chunk = '+ 1' if ($chunk eq '+1');

if (length($chunk)) {
	$html = "<div id=_$o class=mBox-tooltip data-mBox-tooltip=\"COMMENTS\" style=\"float:left;\">
	<div id=_o_$o style=\"display:none;\">$topic</div>";
	
	$html =~ s/COMMENTS/$chunk/g;
} else {
	$html = "<div id=_$o style=\"float:left;\"><div id=_o_$o style=\"display:none;\">$topic</div>";
}

print $html;


if (!$if_real_func) {
	print qq {
	<!-- a href=javascript:void(0) -->};
} else {

	$if_real_func = "void(0)" if ($mBox);
	
	my $onclick = ($mBox) ? "onclick=\"document.getElementById('repl_coid').value='".$o."';document.getElementById('repl_repl').innerHTML=document.getElementById('_$o').getAttribute('data-mBox-tooltip');var a = document.getElementById('_a_$o').innerHTML;var rowTest = new RegExp('<b>','g');a = a.replace(rowTest,'');rowTest = new RegExp('</b>','g');a = a.replace(rowTest,'');document.getElementById('repl_topic').value='Re: '+a;document.getElementById('repl_repl_a').innerHTML = document.getElementById('_o_$o').innerHTML;\"" : '';
	
	print qq {
	<a id=_a_$o class=fmes $onclick href=javascript:$if_real_func;>} if (length($chunk));
	print qq {
	<a id=_a_$o class=fmes $onclick style="color:#222;text-decoration:none;" href=javascript:$if_real_func>} if (!length($chunk));
}

}

sub pretty_it { #83

my $chunk = $_[0];
my $decor = $_[1];

my $lim=45;
$lim = 2*$lim if ($utf);

my $llen=$lim;

if ($decor eq '1') {
$chunk =~ s/\n//g;
$chunk =~ s/"/&quot;/g;
$chunk =~ s/'/&apos;/g;
} elsif ($decor eq '2') {
$chunk =~ s/"/&quot;/g;
$chunk =~ s/'/&apos;/g;
#$chunk =~ s/</&lt;/g;
#$chunk =~ s/>/&gt;/g;
}

$chunk =~ s/\n/<br>/g;
$chunk =~ s/\r/ /g;
$chunk =~ s/\s/ /g;

	while ($llen < length($chunk)) {
	
		$llen -= 1 if (index($chunk," ", $llen-1) == $llen);
		my $cl = substr($chunk, 0, $llen-length($chunk));
		my $cr = substr($chunk,$llen);
		my ($ccl, $ccr) = split(" ",$cr,2);
		if ($decor) {
		$chunk = $cl.$ccl."<br>".$ccr;		
		} else {
		$chunk = $cl.$ccl."\n".$ccr;
		}
		$llen += ($lim+3);		
	}

$chunk =~ s/\s+/&nbsp;/g if $decor;
$chunk = &parse_url($chunk);
return $chunk;
}

sub parse_url { #146

my $str = shift;
my $par = shift;

return $str if ($str =~ /<iframe/);

$str =~ s/\?/questionmark/g;
foreach my $h ('http','https','ftp') {

my $url = '';
my $buf = '';

$buf = $str;

$buf =~ /$h:\/\/(.*)<br>(.+)/ || $buf =~ /$h:\/\/(.*)[\s\,\(\)<>](.+)/ || $buf =~ /$h:\/\/(.*)\&nbsp;(.+)/;


while ($buf =~ /$h:\/\/(.*)<br>(.*)/ || $buf =~ /$h:\/\/(.*)[\s\,\(\)<>](.*)/ || $buf =~ /$h:\/\/(.*)\&nbsp;(.*)/) 
{


$buf = "$h:\/\/".$1;
my $rest = $2;


if ( ($rest =~ /$h:\/\/(.*)$/)) {

$url = $1;

my $s = $h.":\/\/".$url;
my $t = "<a href=".$s." target=new>{url}<\/a>";

$str =~ s/$s/$t/g;
}

} #end while

if ( ($buf =~ /$h:\/\/(.*)$/)) {

$url = $1;
if ($par) {
$str =~ s/$h:\/\/$url/<a style=\"text-decoration\:none\;color\:\#222266\;font-weight\:normal\;\" href=$h:\/\/$url target=new>$url<\/a>/g;
} else {
$str =~ s/$h:\/\/$url/\{<a href=$h:\/\/$url target=new>url<\/a>\}/g;
}
}

} #end foreach
$str =~ s/questionmark/\?/g;$str =~ s/ampersand/\&/g;
return $str;
}

sub listForum { #84

my $inach = shift || 0;
my $if_renum = shift || 0;

if ($is_admin) {

print qq{
<script>
var action_a = "?mode=rm_record&coid=";

function rm_record(oid,table) {
		var form_a = document.createElement("form");
		form_a.setAttribute("method", "get");
		form_a.setAttribute("id", "myForm_a");
		document.body.appendChild(form_a);
		
		var log = \$('marker_'+oid).empty();
					
		\$('myForm_a').action = action_a + oid + '&ctable=' + table;
		\$('myForm_a').set('send', {onComplete: function(response) {			
			check_response(response);
			log.set('html', response);
			(function() {location.reload()}).delay(200);
		}});
		\$('myForm_a').send();
		\$('myForm_a').dispose();

}
</script>
};

} #js for admins

print qq{<script language="JavaScript" type="text/javascript" src="/js_cp/generic.js"></script>};

&print_mbox if ($mBox);

if (!$mBox) {
	print q{<script language="JavaScript" type="text/javascript" src="/js_cp/over.js"></script>};
} else {
			my $ls = '';
			if ($is_admin) {
				&make_list_of_members(1);
				my @clook = @total_members_list;
				@clook = &xDel(&oid_lookup($r_user,1),@clook);
				@clook = ('', @clook);

				$ls =  "<SELECT NAME=z_destination SIZE=1>";
				
				foreach my $cline (@clook) {

					$ls .= "<OPTION VALUE=\"$cline\">".&nkname_lookup(&oid_lookup($cline)) unless ($cline eq '');
					$ls .= "<OPTION VALUE=\"$cline\">".$zdest_default if ($cline eq '');
				}
				$ls .=  "</SELECT>";
			}

				
my $rand = substr(TClubMD5::md5_hex(gettimeofday()),0,8);

#print STDERR "Here rand is $rand!\n";

my $admin_oid = 0;
my $z_dest = $is_admin ? '' : "'<input name=\"z_destination\" type=\"hidden\" value=\"$admin_oid\" />'+";
my $ls_div = $is_admin ? "'<div style=\"margin-top:15px;\">$bd_i:&nbsp;$ls</div>' + " : '';

my $wi = $touch_specific_bro ? "220px" : "390px";
my $wi1 = $touch_specific_bro ? "180px" : "350px";

print qq{
	<script>


	function null_renum() {
		window.location="?mode=stockhelp_panel&forum_renum=1&inach=$inach";
	}

		window.addEvent('domready', function() {

			new mBox.Tooltip({
    				setContent: 'data-mBox-tooltip',

				attach: 'mBox-tooltip',
				pointer: 'left',
				offset: {y: 3},
				fade: {
					open: false,
					close: true
				},
				fadeDuration: 200
			});

		});
		window.addEvent('domready', function() {
			new mBox.Modal({
			id: 'new_forum',
			title: '$bd_ea',
			content: '<div style="width:$wi; text-align:center;font-size:14px;">'+
				'<form enctype="multipart/form-data" method="post" id="new_mesg_form" action="$scriptname">' +
				'<div style="margin-top:15px">'+
					'<input name="mode" type="hidden" value="post_forum" />'+
					'<input name="url_picture" type="hidden" value="$rand" />'+
					$z_dest
					'<input name="author" type="hidden" value="$r_user" />'+
					'<input name="who_read" type="hidden" value="$r_user," />'+
					'<input name="is_replied" type="hidden" value="f" />'+
					'<input name="sport" type="hidden" value="$curr_sport" />'+
					'<input name="a_topic" type="text" placeholder="$bd_f" style="width:$wi1" /></div>' +
				'<div style="margin-top:15px"><textarea name="contents" style="width:$wi1;color:#222;background:#eee;font-size:14px;" cols="40" rows="10"></textarea></div>' + 
				$ls_div
				'<div style="margin-top:15px; margin-bottom:15px"><button type="submit" style="width:$wi1"><span>$ad_k</span></button></div></form></div>',
			attach: 'valdt'
			});

			new mBox.Modal({
			id: 'repl_forum',
			title: '$r_k',
			content: '<div style="width:$wi; text-align:center;font-size:14px;">'+
				'<div id=repl_repl_a style="margin-top:15px;padding:2px;font-family:Lucida;font-size:14px;width:$wi1;color:#369;"></div>' +
				'<div id=repl_repl style="margin-top:15px;padding:2px;font-family:Lucida;font-size:14px;width:$wi1;"></div>' +
				'<form enctype="multipart/form-data" method="post" id="new_repl_form" action="$scriptname">' +
				'<div style="margin-top:15px">'+
					'<input name="mode" type="hidden" value="repl_forum" />'+
					'<input name="url_picture" type="hidden" value="$rand" />'+
					'<input name="author" type="hidden" value="$r_user" />'+
					'<input name="who_read" type="hidden" value="$r_user," />'+
					'<input name="is_replied" type="hidden" value="f" />'+
					'<input name="reply_to_num" id=repl_coid type="hidden" value="0" />'+
					'<input name="sport" type="hidden" value="$curr_sport" />'+
					'<input name="a_topic" id=repl_topic type="text" style="width:$wi1" onclick="this.value=null;this.onclick=null;"/></div>' +
				'<div style="margin-top:15px"><textarea name="contents" style="width:$wi1;font-size:14px;;color:#222;background:#eee;" cols="40" rows="10"></textarea></div>' + 
				'<div style="margin-top:15px; margin-bottom:15px"><button type="submit" style="width:$wi1"><span>$buttons{'reply_forum_message'}</span></button></div></form></div>',
			attach: 'fmes'
			});			
		});
			
	</script>
		
	};
} #mBox

print q{
<div id="overDiv" style="position:absolute; visibility:hidden; z-index:1000;"></div>};

$search = "select ID from forum where reply_to_num='reply_to_num'";

$listResult=$dbconn->prepare($search);
$listResult->execute; 
&dBaseError($listResult, $search."  (".$listResult->rows()." rows found)") if($listResult->rows() == -2);

my  $ntopics=$listResult->rows;

print "<div id=forum_menu style=\"position:relative;background:transparent;padding:5px;top:10px;margin-bottom:10px;border:0px #333 solid;\">";
print "<table class=zeroborder border=0><tr><td>";


my $js  = ($mBox) ? "javascript:void();" : "javascript:window.add_message();";

print "<td style=\"width:120px;padding-top:20px;\">";

my $ib = &rad_grad('#fafac0','#fff');

my $fsip = "16px";

print qq{
<a id=valdt style="color:#369;font-weight:bold;font-family:Lucida;text-decoration:none;white-space:nowrap;
background:$ib;padding:15px;margin:3px;margin-left:15px;font-size:$fsip;" href=$js>$bd_ea</a>};

print qq{<div id=renum_div style="float:left;margin-left:0px;margin-top:20px;padding:10px;visibility:hidden;background:#fafafa;">
<INPUT TYPE=button onClick="\$('renum_div').fade(0);null_renum();" value="$u_ka"></div>};

print "</td><td>";

my $h = int($ntopics/$n_forum);
$h += 1 if ($ntopics - $h*$n_forum);

my $divider = $android ? 4 : 8;	

for (my $i=0; $i < $h;$i++) {
	my $br = '';
	my $fonta = '';
	my $fontb = '';
	my $l = $n_forum*$i;

	$br = "<br>" if ((int($i/$divider))*$divider == $i );

	my $k = $ntopics - $l + $n_archived_messages;
	my $n = $ntopics - $l - $n_forum + 1 + $n_archived_messages;
	
	$n = $n_archived_messages + 1 if ($n <= $n_archived_messages);

print "$br&nbsp;<span style=\"font-size:14px;\">$fonta<a href=$scriptname?mode=stockhelp_panel&inach=$l>$k-$n</a>$fontb&nbsp;&nbsp;</span>" if ($desktop);
print "$br&nbsp;<span style=\"font-size:14px;\">$fonta<a href=$scriptname?mode=stockhelp_panel&inach=$l>$k</a>$fontb&nbsp;&nbsp;</span>" if ($touch_specific_bro);

}
	
print "</td></tr></table>";

print "</div>";

$max_of_cycles = 0;

print qq{<div id=forum_body style="overflow:auto;width:100%;height:50%;background:#fff;margin:0 auto;">};

if ($ntopics > 0 ) {
	&print_forum_cycle("reply_to_num",$if_renum,1,$inach,$if_forum_float);
} else {
	print qq{<div>
	<div style="float:left;margin:25px 2px;font-weight:bold;color:#222;font-size:24px;">No records found!</div>
	<div style="clear:left;"></div>
	</div>};
}

print "</div>";
print q{
<script>
document.getElementById('renum_div').style.visibility='visible';
</script>
} if($num_new_messages);

}

sub make_list_of_members { #61

my $par = shift;

@total_members_list = ();

	
my $comm = "select a_nkname, ID from members where u_admin = '' order by lower(a_nkname) desc";

my $jj = 1;

	
my $result=$dbconn->prepare($comm);
	
$result->execute;
&dBaseError($result, $comm."  (".$result->rows()." rows found)") if ($result->rows() == -2);
	
my $l = $result->fetchall_arrayref;
my $n = $result->rows();
	
for (my $i=0; $i<$n;$i++) {
	push @total_members_list, ${${$l}[$i]}[$jj];
}

}

sub tclub_create_Dialog { #4

print qq{<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head><title>Parade Allegro</title>
<link rel="shortcut icon" href="/icon/favicon.ico" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
};

my $reg2 = koitoutf8("�����������: ��� 2");
&begin_decor(0);
print "<div style=\"background:#EAF3FE;margin-bottom:2px;\">";
	print "<b>".$reg2."</b>";
	
	print $__58a;
	
print "</div>";
 
print $query->start_multipart_form(-name => 'myForm');
 
    print qq{<div id=form_main_container style="padding:5px;">}; 

    $line   = 0;
    $column = 1;
    
    foreach my $name (xSort(keys %values)) {
    	
	$fielddisp_at_all{$name} = "0";
	
	if ($name eq "d_accept_tos")  {
		$fielddisp_at_all{$name} = "1";
		$fielddispstring{$name} = $__53a.":";		
	} elsif ($name eq "proj_code") {
		$fielddisp_at_all{$name} = "1";
		$fielddispstring{$name} =  $u_r; 
		$this_user = $values{$name};
	}  elsif ($name eq "pass") {
		$fielddisp_at_all{$name} = "1";
		$fielddispstring{$name} = $__53aa;
	}

    } #end foreach
   
    my $lastUsed = 0;
    foreach my $name (xSort(keys %values)) {
    
     if ($fielddisp_at_all{$name}) {
	
	if($fielddispcolumn{$name} <= $column && $fielddispcolumn{$name}) {
                $column = 1;
                if($line) {
                    if ($fielddisplay{$name} !~ /hidden/) {

			print qq {</div></div><div class=row_container><div class=cell_container>};
                    }
                } else {
                    if ($fielddisplay{$name} !~ /hidden/) {

			print qq {<div class=row_container><div class=cell_container>};
                    }
                }
                $line++;
	}
        
	while($fielddispcolumn{$name} > $column) {
		print qq{</div><div class=cell_container>}  unless $lastUsed == $column;
                $column++;
	}
        
	if(!$fielddispcolumn{$name}) {
                $column = 1;
                if($line) {

		    print qq {</div></div><div class=row_container><div class=cell_container>};
                } else {

		    print qq {<div class=row_container><div class=cell_container>};
                }
                $line++;
	}

	if ($fielddisplay{$name} !~ /hidden/) {
                if(defined $fielddispstring{$name}) {
                    print $fielddispstring{$name};
		    print $fielddispimg{$name} if(defined $fielddispimg{$name});
		    
                } else {
                    print "$name";
                }
		print qq{</div><div class=cell_container>};
                $lastUsed   = $column;
	}

	if($fieldtype{$name} eq "bpchar" || $fieldtype{$name} eq "CHAR" || $fieldtype{$name} eq "VARCHAR" || $fieldtype{$name} eq "VARCHAR2") {
		    

                    	my $size = ($fieldlength{$name}>$maxwidth)?$maxwidth:$fieldlength{$name};
                        print "<INPUT TYPE=\"text\" NAME=\"" .$name. "\" VALUE=\"".$values{$name}."\"".
										" SIZE=$size MAXLENGTH=".$fieldlength{$name}.">\n";
			
	} elsif ($fieldtype{$name} eq "bool") {
                        my $wahr   = "CHECKED" if ($values{$name} eq "1");
                        my $falsch = "CHECKED" if ($values{$name} eq "0");
                        my $undefiniert = "CHECKED" if (($values{$name} ne "1") && ($values{$name} ne "0"));

			if ($name eq "d_accept_tos"){
				my $d = "block"; $d = "none" if ($develop && $develop != 4);
				print qq{<div style="margin:0px 5px 5px 5px;display:$d;">
				<div><INPUT TYPE=radio NAME=$name VALUE=t checked>$__53b</div>
				<div><INPUT TYPE=radio NAME=$name VALUE=f>$__53c</div>
				</div>};				
			} else {
				my $if_undef_needed = "<INPUT TYPE=radio NAME=\"$name\" VALUE=\"\" $undefiniert>$buttons{'undef'} \n";
			
				$if_undef_needed = '' if ($name eq 'd_status' || $name eq 's_reklama' || $name eq 'v_permission' || $name eq 'n_permission');
			
				$if_undef_needed = '&nbsp;&nbsp;&nbsp;<a href=javascript:window.edit_bl()>Black List</a>' if ($name eq 'v_permission');
			
				print "<INPUT TYPE=radio NAME=\"$name\" VALUE=t $wahr>$buttons{'true'}<INPUT TYPE=radio NAME=\"$name\" VALUE=f $falsch>$buttons{'false'}".
                        		$if_undef_needed;
							
			}
	
                        ($wahr, $falsch, $undefiniert)="";

	} elsif ($fieldtype{$name} eq "oid") {
		    	
			my $pstr = $values{'uploaded_file'};
			$pstr =~ s/_$r_user(\d*)$//g;
			
			$pstr = koitoutf8("�������� ����������") if ($pstr eq "none" && $develop == 3);
		    	
			if (1) {
			print "<div style=\"margin-bottom:5px;\">";
			print "$__43: $pstr" if ($values{'uploaded_file'} && ($add_only != 6));
			print "</div>";
			}
				 
			#print "&nbsp;";
			if (($add_only == 6 || $add_only == 5) && $with_photo) {
				 
				 $comm = "select uploaded_file from members where ID = $oid";
				 &getTable;
				 my $rasterfile = ${${$listresult}[0]}[0]; 
				 my $nff = $rasterfile =~ /\.([a-zA-Z]+)\_([a-z]+)(\d*)$/ ? 1 : 0;
	 
				 unless ($nff) {
		
					$chip = substr(TClubMD5::md5_hex($rasterfile),0,4);
				 } else {
					$chip = substr(TClubMD5::md5_hex($rasterfile),0,8);
				 };
	  	 
	                         if ($rasterfile ne 'none' && $rasterfile ne '') { 	 
	                         my $oids= $chip."_small"; 	 
	                         my $oidl= $chip."_large"; 	 
	                         	
					printf("<div><a href=$url_prefix/db_images/$oidl.jpg> 	 
	                         		<img src=\"$url_prefix/db_images/$oids.jpg\" align=middle border=0 	 
	                         		alt=\"\"></a></div>") unless ($develop && $develop != 4); 	 
	                         	my $ava = "<div style=\"background:#9cf;width:180px;height:48px;padding:3px 3px 0px 3px;\">$vash_avatar_a:</div>";
					$ava = '' if ($develop == 11);
					
					printf("<div style=\"margin-bottom:10px;overflow:auto;\">
						$ava
						<div style=\"margin:5px 5px 10px 5px;padding:3px;height:90px;width:120px;overflow:auto;\"><img src=/db_images/$oids.jpg></div>
						</div>") if ($develop && $develop != 4); 
				 } 	
				 
			} 

			unless ($add_only == 6) {
				
         			
				print $query->filefield(-name=>'uploaded_file',-size=>24);
			}

	} elsif ($fieldtype{$name} eq "date" || $fieldtype{$name} eq "DATE") {

			print qq {<input type=text name=$name value='$values{$name}' style="width:90px;font-size:12px;" onfocus="this.select();lcs(this);" onclick="event.cancelBubble=true;this.select();lcs(this);" />};





	} elsif ( ($fieldtype{$name} eq "float4" || $fieldtype{$name} eq "DECIMAL" || $fieldtype{$name} eq "FLOAT" || $fieldtype{$name} eq "NUMBER") ){
		    
                     if ($name eq "k_kredit") {
		     my $res = sprintf("%.2f",$values{$name}) if ($add_only == 5);
		     print "<font color=$yellow>".$res."</font>";		     
		     } else { 
		     		     
		     print $query->textfield(-name=>$name, -default=>$values{$name}, 
		     -size=>10, -maxlength=>10) . "\n";
		     }

	} elsif ($fieldtype{$name} eq "text" || $fieldtype{$name} eq "CLOB") {
		    	
	    			
		     &pta($name,$values{$name});
	} else { # type of field is not any of listed above
	}
	
     } # disp_at_all
    } #foreach

    print "</div>"; #form_main_container


	print $query->hidden('oid', $oid);
	print $query->hidden('inach', $inach);
	print $query->hidden('ncurr', $ncurr);
	print $query->hidden('vstav', $vstav);

	my $random_name = substr(TClubMD5::md5_hex(time()),12,6);
	
	print $query->submit(-name=>'mode', -value=>$buttons{'add_reg'}) . "\n";
	print $query->reset($buttons{'reset'}) . "\n";
	print $query->hidden('g_email', $vars{email}) . "\n";
        print $query->hidden('proj_code', $vars{user}) . "\n";
	print $query->hidden('regcookie', $vars{regcookie}) . "\n";
	print $query->hidden('e_masterst', '') . "\n";
	print $query->hidden('n_permission', '') . "\n";
	print $query->hidden('v_permission', '') . "\n";
	print $query->hidden('k_kredit', '0') . "\n";
	print $query->hidden('d_profi_date', '2009-01-01') . "\n" if ($ru_en eq 'ru' || $ru_en eq 'ru_RLX' || $ru_en eq 'ru_BRL');
	print $query->hidden('d_profi_date', '2014-12-31') . "\n" if ($ru_en ne 'ru' && $ru_en ne 'ru_RLX' && $ru_en ne 'ru_BRL');
	print $query->hidden('d_addon_given', 'true') . "\n";
	print $query->hidden('u_admin', '') . "\n";
	print $query->hidden('s_reklama', 't') . "\n";
	print $query->hidden('o_regals', '') . "\n";
	print $query->hidden('reg_passwd', $reg_passwd) . "\n";
	print $query->hidden('d_accept_tos', 't') . "\n" unless ($displayable_reg_field);
	print $query->hidden('when_invited', '2009-01-01') . "\n";
	print $query->hidden('a_nkname', $random_name) . "\n";
	print $query->hidden('blacklist', '') . "\n";
	print $query->hidden('d_spec', $ru_en) . "\n";
	print $query->hidden('city', 41) . "\n";

     my $cur_time = time(); # time returns number of seconds since 1970
     my $sID = TClubMD5::md5_hex( $ip_addr . $cur_time );

     TClubMD5::setHashValue($seed_sessionFile,$sID,$cur_time);
        print $query->hidden('session_id', $sID) . "\n";

    print $query->end_form;
&end_decor;
    print qq{</body></html>};
    
}

sub do_shoutbox { #177

my $decor = shift;
my $with_sb = shift;

my $token = TClubMD5::md5_hex($nikname.$salt);
#print STDERR "Here salt is $salt!\n";
&make_date($gmtimeshift);

my $datestamp =  sprintf("%4d %02d %02d",$thisyear,$mon,$mday);

my $sb = '';
my $lft = '';
my $hgt = "style=\"height:10px;\"";

my $addon = ''; $addon = "if (document.getElementById('arrows')) document.getElementById('arrows').style.display='none';";

if ($decor eq '1') {

#$sb = "ondblclick=\"writeCookie('ShoutBox','0');ajax_counter=301;this.style.display='none';document.getElementById('picture_mask').style.display='block';$addon\"";

$lft = $touch_specific_bro ? "style=\"left:-15px;\"" : "style=\"left:-5px;\"";
$hgt = '' if ($with_friend_invite && !$with_sb);
}


unless ($utf) {
$nikname =~ s/�/�/g;
$nikname =~ s/�/�/g;
}

if ($chars eq 'windows-1251') {
$nikname =~ s/�/�/g;
$nikname =~ s/�/�/g;
}

if ($use_server && $utf) {
$nikname =~ s/Ш/ш/g;
$nikname =~ s/У/у/g;
}

my $onblur = "onblur=\"this.value = (this.value.replace(/�/g,'�')).replace(/�/g,'�');";
$onblur .= "this.value = (this.value.replace(/�/g,'�')).replace(/�/g,'�');"
	if ($chars eq 'windows-1251');
$onblur .= "\"";
$onblur = '' if (($use_server != 1) || $utf); #utf

my $onkeydown = "onkeydown=\"var a = keypress(event); if (a) this.value = (this.value.replace(/�/g,'�')).replace(/�/g,'�');";
$onkeydown .= "if (a) this.value = (this.value.replace(/�/g,'�')).replace(/�/g,'�');"
	if ($chars eq 'windows-1251');
$onkeydown .= "\"";
$onkeydown = '' if (($use_server != 1) || $utf); #utf

my $di = $is_admin ? '' : "display:none;";
my $dis = $is_admin ? "none" : "block";

print qq{
<script>
function keypress(e)
{
     var Ucode=e.keyCode? e.keyCode : e.charCode

     	if (Ucode == 13) return 1;
	return 0;

}
</script>
<!-- 3. Shoutbox code start -->
<div id="bbox" $hgt></div>
};

print qq{

<div id="box" $lft $sb>

<div id="chat">

<div id="scrollArea">
<div id="scroller">
</div>
</div>

<div id="container">
<div id='content'>
</div>
</div>

<div id='form'>
<form id='cform' name='chatform' action="#">
<div id='field_set'>
<input type=button style="width:36px;float:left;top:0;$di" onclick="js_guru_controls(0);" value="!" />
<input type='hidden' id='token' name='token' value='$token' />
<input type='hidden' id='name' name='name' value='somename' />
<input type='hidden' id='myname' name='myname' value='$nikname' />
<input type='hidden' id='room' name='room' value='$mycabo' />
<input style="display:none;" type='text' id='url' name='url' value='http://' />
<textarea rows='4' cols='10' id='message'  name='message' style="resize:none;" $onblur $onkeydown>...</textarea>
</div>
</form>
</div> 

<div id="chat_menu">

<div id ="wtag">
<p>
<!-- You may not remove the copyright link, but you may edit its look and location on your web page -->
<a href="http://spacegirlpippa.co.uk" style="display:$dis;" title="A free mini chat (shoutbox) script">
wTag
</a>
<input type=button style="width:36px;font-size:14px;font-weight:bold;margin-top:-5px;$di" onclick="var yon = window.confirm('Really EMPTY CHAT?!'); if (yon) {js_guru_controls(1);}" value="&#9760" />
</p>
</div>

<div id='refresh' style="display:$dis;">
<p>$v_g</p>
</div>

<div id='emo'>
<ul id="show_sm">
<li>
smileys
<ul id="smiley_box">
<li>
<img class='smileys' src='/wtag/smileys/smile.gif' width='15' height='15' alt=':)' title=':)' onclick = "tagSmiley(':)');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/sad.gif' width='15' height='15' alt=':(' title=':(' onclick = "tagSmiley(':(');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/wink.gif' width='15' height='15' alt=';)' title=';)' onclick = "tagSmiley(';)');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/tongue.gif' width='15' height='15' alt=':-P' title=':-P' onclick = "tagSmiley(':-P');"/>
</li>
<li>
<img class='smileys' src='/wtag/smileys/rolleyes.gif' width='15' height='15' alt='S-)' title='S-)' onclick = "tagSmiley('S-)');"/>
</li>
<li>
<img class='smileys' src='/wtag/smileys/angry.gif' width='15' height='15' alt='>(' title='>(' onclick = "tagSmiley('>(');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/embarassed.gif' width='15' height='15' alt=':*)' title=':*)' onclick = "tagSmiley(':*)');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/grin.gif' width='15' height='15' alt=':-D' title=':-D' onclick = "tagSmiley(':-D');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/cry.gif' width='15' height='15' alt='QQ' title='QQ' onclick = "tagSmiley('QQ');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/shocked.gif' width='15' height='15' alt='=O' title='=O' onclick = "tagSmiley('=O');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/undecided.gif' width='15' height='15' alt='=/' title='=/' onclick = "tagSmiley('=/');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/cool.gif' width='15' height='15' alt='8-)' title='8-)' onclick = "tagSmiley('8-)');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/sealedlips.gif' width='15' height='15' alt=':-X' title=':-X' onclick = "tagSmiley(':-X');" />
</li>
<li>
<img class='smileys' src='/wtag/smileys/angel.gif' width='15' height='15' alt='O:]' title='O:]' onclick = "tagSmiley('O:]');" />
</li>
</ul>
</li>

</ul>
</div>

<div id='submit'>
<p>$v_a</p>
</div>
<div style="clear:all;"></div>
</div><!-- chat_menu -->

</div><!-- chat -->
</div><!-- box -->

<div id="abox"></div>

<!-- 3. Shoutbox code end -->
};

my $d = ($with_sb > 0) ? 'block' : 'none';

if ($touch_specific_bro || 1) {

my $ml = $touch_specific_bro ? "10px" : " auto";

print qq{
<div id="arrows" style="border-color:#ccc;border-width:0px;border-style:solid;width:190px;text-align:center;margin:16px auto 0 $ml;display:$d;">
<div style="float:left;height:24px;width:94px;background:#dadada url(/icon/arrow_up.png) top center no-repeat;" onclick="var b = parseInt(document.getElementById('content').style.top) < -50 ? parseInt(document.getElementById('content').style.top)+50 : 0; document.getElementById('content').style.top = b + 'px';return false;"></div>
<div style="float:left;height:24px;width:94px;background:#fafafa url(/icon/arrow_down.png) top center no-repeat;" onclick="var a = parseInt(document.getElementById('content').style.top) ? parseInt(document.getElementById('content').style.top) : 0; document.getElementById('content').style.top = (a - 50) + 'px';return false;"></div>
<div style="clear:left;"></div></div>
};

} else {

my %Cookies = TClubMD5::GetCookies('ShoutBox');
my $sb = $Cookies{'ShoutBox'} eq '' ? 0 : $Cookies{'ShoutBox'};
my $d = $sb eq '1' ? 'block' : 'none';

print qq{
<div id="arrows" style="text-align:center;color:#369;margin:15px 0px 20px -5px;font-size:12px;display:$d;" ondblclick="writeCookie('ShoutBox','0');ajax_counter=301;document.getElementById('box').style.display='none';this.style.display='none';document.getElementById('picture_mask').style.display='block';" onmouseover="this.style.color='#963';" onmouseout="this.style.color='#369';">$dblclck_back</div>
} unless (($ie && !$ie9) || $with_sb == -1 || $nologin);

}

}

sub print_wtag_headers { #178

my $t = shift;
my $tt = shift;
my $ttt = ($ie6 && !$ie7) ? '_ie' : '';

print q{
<style type="text/css">

#box {
  border-radius:10px;-moz-border-radius:10px;-webkit-border-radius:10px;
}
</style>

<link rel="stylesheet" type="text/css" href="/wtag/css/main.css" />
};
print qq{
<link rel="stylesheet" type="text/css" href="/wtag/css/main-style$t$tt$ttt.css" />
};

print qq{

<script type="text/javascript" src="/wtag/js/dom-drag.js"></script>
<script type="text/javascript" src="/wtag/js/scroll.js"></script>
<script type="text/javascript" src="/wtag/js/conf.js"></script>
<script type="text/javascript" src="/wtag/js/ajax$tt.js"></script>
<script type="text/javascript" src="/wtag/js/drop_down.js"></script>
<script type="text/javascript">

function show_box_npeop(k){
theString="$scriptname?mode=show_peop&showmode="+k
win3=window.open(theString,"",'width=40,height=200, toolbar=0,scrollbars=1,titlebar=0,resizable=1,menubar=0,status=0,location=0')
win3.moveTo(100,180)
}
</script>
} if ($wtag_alive);
}

sub wtagcheck {  #205

&wtagconntest($primary_server,5432) if ($use_server);
&wtagconntest($server_my,5432) if ($use_server == 0); #we have chat on some fast DB - may be as well the same

#print STDERR "Here in wtagcheck, user_server is $use_server!\n";

my $s = "chi";
$s = "ape" if ($wtag_alive);

my $cmd = "ps aux | grep $wtag_limit_token";
open (IN, '-|', $cmd)
	or die ("Can't ps");
my $count = 0;
while (!eof(IN)) {
	my $q = readline (*IN);
	#print $q;
	$count++;
}
close (IN);

$s = "chi" if ($count > $wtag_limit);

##

my $s_call = "/home2/clients/w_motiva/".$s;
system($s_call) if ($use_server);

}

sub wtagconntest { #123

my $ip = shift;
my $port = shift;	
	eval {
	local $SIG{ALRM} = sub { die "alarm\n" }; # NB: \n required
	alarm 5;

	my $what = Connect($ip,$port);
	alarm 0;
	$wtag_alive = 1 if ($what eq 'good_connect');
                 
	};
	
	if ($@) {

		# timed out
		$wtag_alive = 0;

	}
	else {
	# didn't
	}

}

sub Connect { #124

my ($remote,$port, $iaddr, $paddr, $proto, $line);

	   $remote  = shift || 'localhost';
           $port    = shift || 5432;
	   
           if ($port =~ /\D/) { $port = getservbyname($port, 'tcp') }
           return "No port" unless $port;
           $iaddr   = inet_aton($remote)               || return "no host: $remote";
           $paddr   = sockaddr_in($port, $iaddr);

           $proto   = getprotobyname('tcp');
           socket(SOCK, PF_INET, SOCK_STREAM, $proto)  || return "socket: $!";
           connect(SOCK, $paddr)    || return "connect: $!";

           close (SOCK)            || return "close: $!";
	   return "good_connect";
}

sub print_drago {

print qq{
<script type="text/javascript">

//*****************************************************************************
// Do not remove this notice.
//
// Copyright 2001 by Mike Hall.
// See http://www.brainjar.com for terms of use.
//*****************************************************************************

// Determine browser and version.

function myBrowser() {

  var ua, s, i;

  this.isIE    = false;
  this.isNS    = false;
  this.version = null;

  ua = navigator.userAgent;

  s = "MSIE";
  if ((i = ua.indexOf(s)) >= 0) {
    this.isIE = true;
    this.version = parseFloat(ua.substr(i + s.length));
    return;
  }

  s = "Netscape6/";
  if ((i = ua.indexOf(s)) >= 0) {
    this.isNS = true;
    this.version = parseFloat(ua.substr(i + s.length));
    return;
  }

  // Treat any other "Gecko" browser as NS 6.1.

  s = "Gecko";
  if ((i = ua.indexOf(s)) >= 0) {
    this.isNS = true;
    this.version = 6.1;
    return;
  }
}

var browser = new myBrowser();

// Global object to hold drag information.

var dragObj = new Object();
dragObj.zIndex = 0;

function getRelativeClientRect(el) {
  var rect = el.getBoundingClientRect(),
      parentRect = el.offsetParent.getBoundingClientRect();
  return {
    bottom: parentRect.bottom - rect.bottom,
    height: rect.height,
    left: rect.left - parentRect.left,
    right: parentRect.right - rect.right,
    top: rect.top - parentRect.top,
    width: rect.width
  };
}

function dragStart(event, id) {

  var el;
  var x, y;

  // If an element id was given, find it. Otherwise use the element being
  // clicked on.

  if (id)
    dragObj.elNode = document.getElementById(id);
  else {
    if (browser.isIE)
      dragObj.elNode = window.event.srcElement;
    if (browser.isNS)
      dragObj.elNode = event.target;

    // If this is a text node, use its parent element.

    if (dragObj.elNode.nodeType == 3)
      dragObj.elNode = dragObj.elNode.parentNode;
  }

  // Get cursor position with respect to the page.

  if (browser.isIE) {
    x = window.event.clientX + document.documentElement.scrollLeft
      + document.body.scrollLeft;
    y = window.event.clientY + document.documentElement.scrollTop
      + document.body.scrollTop;
  }
  if (browser.isNS) {
    x = event.clientX + window.scrollX;
    y = event.clientY + window.scrollY;
  }

  // Save starting positions of cursor and element.

  dragObj.cursorStartX = x;
  dragObj.cursorStartY = y;
  var rect = dragObj.elNode.getBoundingClientRect();
  dragObj.elStartLeft  = rect.left+240;
  dragObj.elStartTop   = rect.top+150;
//console.log('here left',dragObj.elNode.style.left,'top',dragObj.elNode.style.top)
  if (isNaN(dragObj.elStartLeft)) dragObj.elStartLeft = 0;
  if (isNaN(dragObj.elStartTop))  dragObj.elStartTop  = 0;

  // Update element's z-index.

  //dragObj.elNode.style.zIndex = ++dragObj.zIndex;

  // Capture mousemove and mouseup events on the page.

  if (browser.isIE) {
    document.attachEvent("onmousemove", dragGo);
    document.attachEvent("onmouseup",   dragStop);
    window.event.cancelBubble = true;
    window.event.returnValue = false;
  }
  if (browser.isNS) {
    document.addEventListener("mousemove", dragGo,   true);
    document.addEventListener("mouseup",   dragStop, true);
    event.preventDefault();
  }
}

function dragGo(event) {

  var x, y;

  // Get cursor position with respect to the page.

  if (browser.isIE) {
    x = window.event.clientX + document.documentElement.scrollLeft
      + document.body.scrollLeft;
    y = window.event.clientY + document.documentElement.scrollTop
      + document.body.scrollTop;
  }
  if (browser.isNS) {
    x = event.clientX + window.scrollX;
    y = event.clientY + window.scrollY;
  }

  // Move drag element by the same amount the cursor has moved.

  dragObj.elNode.style.left = (dragObj.elStartLeft + x - dragObj.cursorStartX) + "px";
  dragObj.elNode.style.top  = (dragObj.elStartTop  + y - dragObj.cursorStartY) + "px";

  if (browser.isIE) {
    window.event.cancelBubble = true;
    window.event.returnValue = false;
  }
  if (browser.isNS)
    event.preventDefault();
}

function dragStop(event) {

  // Stop capturing mousemove and mouseup events.

  if (browser.isIE) {
    document.detachEvent("onmousemove", dragGo);
    document.detachEvent("onmouseup",   dragStop);
  }
  if (browser.isNS) {
    document.removeEventListener("mousemove", dragGo,   true);
    document.removeEventListener("mouseup",   dragStop, true);
  }
}

</script>
};
}

sub print_mbox {
print qq{
<script language="JavaScript" type="text/javascript" src="/js_cp/mBox.Core.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mBox.Notice.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mBox.Tooltip.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mBox.Modal.js"></script>
<script language="JavaScript" type="text/javascript" src="/js_cp/mBox.Modal.Confirm.js"></script>
<link rel="stylesheet" href="/css_cp/mBoxCore.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/css_cp/mBoxNotice.css" type="text/css" media="screen" />
<link rel="stylesheet" type="text/css" href="/css_cp/mBoxModal.css" />
<link rel="stylesheet" href="/css_cp/mBoxTooltip.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/css_cp/mBoxTooltip-Gradient.css" type="text/css" media="screen" />
};
}

sub print_centered_ajax_box {

my $str = shift;
print qq{
<script>
window.addEvent('domready', function() {
						
		   	if (\$('ask_$str') ) {
				

				var pos = navigator.userAgent.indexOf('MSIE 6') > 0 ? 'absolute' : 'fixed';
				
				\$('ask_$str').addEvent('click', function(e) {

					e.stop();check_my_auth();
					\$('ajax_0').setStyles({'position': pos });
					\$('ajax_0').setStyles({'left': '50%' });
					\$('ajax_0').setStyles({'top': '50%' });
					\$('ajax_0').setStyles({'margin-left': '-240px' });
					\$('ajax_0').setStyles({'margin-top': '-150px' });
					\$('ajax_0').setStyles({'display': 'block' });
					\$('ajax_0').fade(1);
					\$('container_log_ajax_0').setStyles({'display': 'block' });
					var log_add_ad = \$('_ajax_0').empty().addClass('ajax-loading');
		
					\$('myForm_$str').set('send', {onComplete: function(response) { 
					
						check_response(response);			

						log_add_ad.removeClass('ajax-loading');
						log_add_ad.set('html', response);
					}});
					\$('myForm_$str').send();
				});
		   	}
});
</script>
};
}

sub print_llist {
my $llist = "<table class=\"table table-bordered table-dark\" style=\"width:200px;height:290px;margin:0 auto;\"><tbody>";

$comm = "select id, a_topic, z_destination, store_url, vremya_z, status from vmails where author='$r_user' order by vremya_z desc";
&getTable;

for (my $i=0; $i < $ntuples; $i++) {

#var str=window.location.search;str=replaceQueryParam('file_name', '$fil', str);str=replaceQueryParam('p', 1, str);window.location=window.location.pathname+str;
#var url = location.search;console.log('url',url);var newQuery=''+\$.query.set('file_name', '$fil').set('p',1);console.log('newurl',newQuery);location.search=newQuery;	

	my $id = ${${$listresult}[$i]}[0];
	my $su = ${${$listresult}[$i]}[1];$su =~ s/\s+$//;
	my $to = length($su) ? $su : "<i>no subj</i>";
	my @fi = split('/',${${$listresult}[$i]}[3]);my $fil = $fi[$#fi];my $o = $fi[$#fi-1];
	my $sto = "<span style=\"text-decoration:underline;color:#369;cursor:pointer;\" 
	onclick=\"\$('#stop').trigger('click');fi='$fil';curr=$id;su='-- $to --';bu=2;
	slide_to_video();
	document.getElementById('informer').innerHTML='BUFFERING '+su; 
	\$('#play').trigger('click');\" 
	onmouseover=\"this.style.color='#222';\" onmouseout=\"this.style.color='#369';\">$to</span>";
	my $j=$i+1;
	$llist .= "<tr><th style=\"width:10%;text-align:center;\">$j</th>
	<td style=\"width:80%;text-align:center;\">".$sto."</td>
	<td style=\"width:10%;text-align:center;\"><span class=\"badge badge-primary badge-pill\" onclick=\"var yon = window.confirm('Really DELETE #$j $to?!'); if (yon) {if (\$('#myForm_delete_vmail')) \$('#myForm_delete_vmail').remove();let form = document.createElement('form');
			form.setAttribute('method', 'get');
			form.setAttribute('id', 'myForm_delete_vmail');
			document.body.appendChild(form);let frm=\$('#myForm_delete_vmail');frm.submit(function(e) {e.preventDefault();\$.ajax({type: frm.attr('method'),url: act_del+'&id=$id',success: function(response) {check_response(response);\$('#llist_container').html(response);document.getElementById('informer').innerHTML='';}})});frm.trigger('submit');	
	}\" style=\"cursor:pointer;\">X</span></td></tr>";
}

$llist .= "</tbody></table>";
print $llist;
}

sub print_rlist {
my $rlist = "<table class=\"table table-bordered table-dark\" style=\"width:200px;height:290px;margin:0 auto;\"><tbody style=\"\">";

my $o = substr(TClubMD5::md5_hex($r_user),0,8);

$comm = "select id, a_topic, z_destination, store_url, author, vremya_z, (select count(*) from views where views.z = '$o' and views.v=vmails.id::text), status from vmails where (z_destination = '$o' or z_destination='') and author != '$r_user' order by vremya_z desc";
&getTable;

#CREATE TABLE views (z text, v text, t timestamp);
my $nu = 0; my $tot = 0;
for (my $i=0; $i < $ntuples; $i++) {

	my $au = ${${$listresult}[$i]}[4];
	my $id = ${${$listresult}[$i]}[0];
	my $su = ${${$listresult}[$i]}[1];$su =~ s/\s+$//;
	my $to = length($su) ? $su : "<i>no subj</i>";
	my @fi = split('/',${${$listresult}[$i]}[3]);my $fil = $fi[$#fi];my $o = $fi[$#fi-1];
	my $sto = "<span style=\"text-decoration:underline;color:#369;cursor:pointer;\" 
	onclick=\"\$('#stop').trigger('click');
	fi='$fil';curr=$id;su='-- $to --';bu=2;
	slide_to_video();
	document.getElementById('informer').innerHTML='BUFFERING '+su; let if_nu = (document.getElementById('r$id').innerHTML == 'N');
	document.getElementById('r$id').innerHTML='R';\$('#r$id').css('color','#900');let cur = parseInt(document.getElementById('num_new_vmails').innerHTML);if (if_nu) \$('#num_new_vmails').html(cur-1);
	\$('#play').trigger('click');\" 
	onmouseover=\"this.style.color='#222';\" onmouseout=\"this.style.color='#369';\">$to</span>";	
	my $c = ${${$listresult}[$i]}[6]; my $sta = $c ? "<div id='r$id' style=\"color:#999;\">R</div>" : "<div id='r$id' style=\"color:#009;\">N</div>";
	$nu += 1 if ($c == 0);
	my $who = nkname_lookup($au);
	$rlist .= "<tr><th style=\"width:25%;text-align:center;\">$who</th>
	<td style=\"width:55%;text-align:center;\">".$sto."</td>
	<td style=\"width:10%;text-align:center;\">".$sta."</td>
</tr>";
$tot++;
}

$rlist .= "</tbody></table>";
print $rlist;
print qq{<div id=num_new_vmails style="display:none;">$nu</div>};
print qq{<div id=num_vmails style="display:none;">$tot</div>};
}

sub check_real_o {

my $o = shift;
my $real_o = substr(TClubMD5::md5_hex($r_user),0,8);

if (length($o) && $o ne $real_o) { #cheat
	print qq {
		<html><body>cheat</body></html>
	};
#do something here to alert on cheat
print STDERR "Cheat from$r_user on $o!\n";
	exit;
}
}

#END I18N == END I18N == END I18N
